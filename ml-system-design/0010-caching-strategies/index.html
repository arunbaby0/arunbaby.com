<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.26.2 by Michael Rose
  Copyright 2013-2024 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->

<html lang="en-US" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Caching Strategies for ML Systems - Arun Baby</title>
<meta name="description" content="Design efficient caching layers for ML systems to reduce latency, save compute costs, and improve user experience at scale.">


  <meta name="author" content="Arun Baby">
  
  <meta property="article:author" content="Arun Baby">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Arun Baby">
<meta property="og:title" content="Caching Strategies for ML Systems">
<meta property="og:url" content="https://www.arunbaby.com/ml-system-design/0010-caching-strategies/">


  <meta property="og:description" content="Design efficient caching layers for ML systems to reduce latency, save compute costs, and improve user experience at scale.">



  <meta property="og:image" content="https://www.arunbaby.com/assets/images/profile-photo.png">



  <meta name="twitter:site" content="@arunbaby0">
  <meta name="twitter:title" content="Caching Strategies for ML Systems">
  <meta name="twitter:description" content="Design efficient caching layers for ML systems to reduce latency, save compute costs, and improve user experience at scale.">
  <meta name="twitter:url" content="https://www.arunbaby.com/ml-system-design/0010-caching-strategies/">

  
    <meta name="twitter:card" content="summary">
    
      <meta name="twitter:image" content="https://www.arunbaby.com/assets/images/profile-photo.png">
    
  

  



  <meta property="article:published_time" content="2025-11-18T21:12:02+05:30">





  

  


<link rel="canonical" href="https://www.arunbaby.com/ml-system-design/0010-caching-strategies/">












<!-- end _includes/seo.html -->



  <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Arun Baby Feed">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
  
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css"></noscript>



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single" dir="ltr">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
           
          <span class="site-subtitle">Arun Baby</span>
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a
                href="/about/"
                
                
              >About</a>
            </li><li class="masthead__menu-item">
              <a
                href="/dsa/"
                
                
              >DSA</a>
            </li><li class="masthead__menu-item">
              <a
                href="/ml-system-design/"
                
                
              >ML Systems</a>
            </li><li class="masthead__menu-item">
              <a
                href="/speech-tech/"
                
                
              >Speech Tech</a>
            </li><li class="masthead__menu-item">
              <a
                href="/publications/"
                
                
              >Publications</a>
            </li><li class="masthead__menu-item">
              <a
                href="/statuses/"
                
                
              >Statuses</a>
            </li><li class="masthead__menu-item">
              <a
                href="/contact/"
                
                
              >Contact</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <i class="fas fa-search"></i>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      





<div id="main" role="main" class="no-author-sidebar">
  
  <div class="sidebar sticky">
  
  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Caching Strategies for ML Systems">
    <meta itemprop="description" content="Design efficient caching layers for ML systems to reduce latency, save compute costs, and improve user experience at scale.">
    <meta itemprop="datePublished" content="2025-11-18T21:12:02+05:30">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">
            <a href="https://www.arunbaby.com/ml-system-design/0010-caching-strategies/" itemprop="url">Caching Strategies for ML Systems
</a>
          </h1>
          

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          27 minute read
        
      </span>
    
  </p>


        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right sticky">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> On this page</h4></header>
              <ul class="toc__menu"><li><a href="#introduction">Introduction</a></li><li><a href="#cache-hierarchy">Cache Hierarchy</a></li><li><a href="#cache-eviction-policies">Cache Eviction Policies</a><ul><li><a href="#lru-least-recently-used">LRU (Least Recently Used)</a></li><li><a href="#lfu-least-frequently-used">LFU (Least Frequently Used)</a></li><li><a href="#ttl-time-to-live-cache">TTL (Time-To-Live) Cache</a></li></ul></li><li><a href="#distributed-caching">Distributed Caching</a><ul><li><a href="#redis-based-cache">Redis-Based Cache</a></li><li><a href="#multi-level-cache">Multi-Level Cache</a></li></ul></li><li><a href="#cache-warming-strategies">Cache Warming Strategies</a><ul><li><a href="#proactive-cache-warming">Proactive Cache Warming</a></li></ul></li><li><a href="#cache-invalidation">Cache Invalidation</a><ul><li><a href="#push-based-invalidation">Push-Based Invalidation</a></li></ul></li><li><a href="#feature-store-caching">Feature Store Caching</a></li><li><a href="#connection-to-linked-lists-day-10-dsa">Connection to Linked Lists (Day 10 DSA)</a></li><li><a href="#understanding-cache-performance">Understanding Cache Performance</a><ul><li><a href="#cache-hit-rate-analysis">Cache Hit Rate Analysis</a></li><li><a href="#cache-size-optimization">Cache Size Optimization</a></li></ul></li><li><a href="#advanced-caching-patterns">Advanced Caching Patterns</a><ul><li><a href="#write-through-vs-write-back-cache">Write-Through vs Write-Back Cache</a></li><li><a href="#cache-aside-pattern">Cache Aside Pattern</a></li></ul></li><li><a href="#cache-stampede-prevention">Cache Stampede Prevention</a><ul><li><a href="#problem-thundering-herd">Problem: Thundering Herd</a></li><li><a href="#probabilistic-early-expiration">Probabilistic Early Expiration</a></li></ul></li><li><a href="#distributed-cache-challenges">Distributed Cache Challenges</a><ul><li><a href="#cache-consistency">Cache Consistency</a></li></ul></li><li><a href="#key-takeaways">Key Takeaways</a></li></ul>
            </nav>
          </aside>
        
        <p><strong>Design efficient caching layers for ML systems to reduce latency, save compute costs, and improve user experience at scale.</strong></p>

<h2 id="introduction">Introduction</h2>

<p><strong>Caching</strong> temporarily stores computed results to serve future requests faster. In ML systems, caching is critical for:</p>

<p><strong>Why caching matters:</strong></p>
<ul>
  <li><strong>Latency reduction:</strong> ms instead of seconds for predictions</li>
  <li><strong>Cost savings:</strong> Avoid expensive model inference</li>
  <li><strong>Scalability:</strong> Handle more requests with same resources</li>
  <li><strong>Availability:</strong> Serve cached results if model service is down</li>
</ul>

<p><strong>Common caching scenarios in ML:</strong></p>
<ul>
  <li>Model predictions (feature → prediction)</li>
  <li>Feature computations (raw data → engineered features)</li>
  <li>Embeddings (entity → vector representation)</li>
  <li>Model artifacts (model weights, config)</li>
  <li>Training data (preprocessed datasets)</li>
</ul>

<hr />

<h2 id="cache-hierarchy">Cache Hierarchy</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌────────────────────────────────────────────────────┐
│                   Client/Browser                    │
│              (Local Storage, Cookies)               │
└──────────────────────┬─────────────────────────────┘
                       │
                       ▼
┌────────────────────────────────────────────────────┐
│                   CDN Cache                         │
│            (CloudFlare, Akamai, CloudFront)        │
└──────────────────────┬─────────────────────────────┘
                       │
                       ▼
┌────────────────────────────────────────────────────┐
│                 Application Cache                   │
│              (Redis, Memcached, Local)             │
└──────────────────────┬─────────────────────────────┘
                       │
                       ▼
┌────────────────────────────────────────────────────┐
│                   ML Model Service                  │
│               (TensorFlow Serving, etc.)           │
└──────────────────────┬─────────────────────────────┘
                       │
                       ▼
┌────────────────────────────────────────────────────┐
│                   Database                          │
│            (PostgreSQL, MongoDB, etc.)             │
└────────────────────────────────────────────────────┘
</code></pre></div></div>

<hr />

<h2 id="cache-eviction-policies">Cache Eviction Policies</h2>

<h3 id="lru-least-recently-used">LRU (Least Recently Used)</h3>

<p><strong>Most common for ML systems</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>

<span class="k">class</span> <span class="nc">LRUCache</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    LRU Cache implementation
    
    Evicts least recently used items when capacity is reached
    </span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">capacity</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cache</span> <span class="o">=</span> <span class="nc">OrderedDict</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">capacity</span> <span class="o">=</span> <span class="n">capacity</span>
    
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Get value and mark as recently used
        
        Time: O(1)
        </span><span class="sh">"""</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">cache</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        
        <span class="c1"># Move to end (most recent)
</span>        <span class="n">self</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="nf">move_to_end</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Put key-value pair
        
        Time: O(1)
        </span><span class="sh">"""</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">cache</span><span class="p">:</span>
            <span class="c1"># Update and move to end
</span>            <span class="n">self</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="nf">move_to_end</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        
        <span class="c1"># Evict if over capacity
</span>        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cache</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">self</span><span class="p">.</span><span class="n">capacity</span><span class="p">:</span>
            <span class="c1"># Remove first item (least recently used)
</span>            <span class="n">self</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="nf">popitem</span><span class="p">(</span><span class="n">last</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">stats</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Get cache statistics</span><span class="sh">"""</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">size</span><span class="sh">'</span><span class="p">:</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cache</span><span class="p">),</span>
            <span class="sh">'</span><span class="s">capacity</span><span class="sh">'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">capacity</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">utilization</span><span class="sh">'</span><span class="p">:</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cache</span><span class="p">)</span> <span class="o">/</span> <span class="n">self</span><span class="p">.</span><span class="n">capacity</span>
        <span class="p">}</span>

<span class="c1"># Usage
</span><span class="n">cache</span> <span class="o">=</span> <span class="nc">LRUCache</span><span class="p">(</span><span class="n">capacity</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>

<span class="c1"># Cache predictions
</span><span class="k">def</span> <span class="nf">get_prediction_cached</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
    <span class="n">cache_key</span> <span class="o">=</span> <span class="nf">hash</span><span class="p">(</span><span class="nf">tuple</span><span class="p">(</span><span class="n">features</span><span class="p">))</span>
    
    <span class="c1"># Check cache
</span>    <span class="n">cached_result</span> <span class="o">=</span> <span class="n">cache</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cached_result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">cached_result</span>
    
    <span class="c1"># Compute prediction
</span>    <span class="n">prediction</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="nf">predict</span><span class="p">([</span><span class="n">features</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="c1"># Cache result
</span>    <span class="n">cache</span><span class="p">.</span><span class="nf">put</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="n">prediction</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">prediction</span>
</code></pre></div></div>

<h3 id="lfu-least-frequently-used">LFU (Least Frequently Used)</h3>

<p><strong>Good for skewed access patterns</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">import</span> <span class="n">heapq</span>

<span class="k">class</span> <span class="nc">LFUCache</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    LFU Cache - evicts least frequently used items
    
    Better for </span><span class="sh">"</span><span class="s">hot</span><span class="sh">"</span><span class="s"> items that are accessed repeatedly
    </span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">capacity</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">capacity</span> <span class="o">=</span> <span class="n">capacity</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cache</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># key -&gt; (value, frequency)
</span>        <span class="n">self</span><span class="p">.</span><span class="n">freq_map</span> <span class="o">=</span> <span class="nf">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>  <span class="c1"># frequency -&gt; set of keys
</span>        <span class="n">self</span><span class="p">.</span><span class="n">min_freq</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">access_count</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Get value and increment frequency</span><span class="sh">"""</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">cache</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        
        <span class="n">value</span><span class="p">,</span> <span class="n">freq</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        
        <span class="c1"># Update frequency
</span>        <span class="n">self</span><span class="p">.</span><span class="n">freq_map</span><span class="p">[</span><span class="n">freq</span><span class="p">].</span><span class="nf">remove</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">freq_map</span><span class="p">[</span><span class="n">freq</span><span class="p">]</span> <span class="ow">and</span> <span class="n">freq</span> <span class="o">==</span> <span class="n">self</span><span class="p">.</span><span class="n">min_freq</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">min_freq</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="n">new_freq</span> <span class="o">=</span> <span class="n">freq</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">self</span><span class="p">.</span><span class="n">freq_map</span><span class="p">[</span><span class="n">new_freq</span><span class="p">].</span><span class="nf">add</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">new_freq</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">value</span>
    
    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Put key-value pair</span><span class="sh">"""</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">capacity</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>
        
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">cache</span><span class="p">:</span>
            <span class="c1"># Update existing key
</span>            <span class="n">_</span><span class="p">,</span> <span class="n">freq</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="n">self</span><span class="p">.</span><span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">freq</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>  <span class="c1"># Update frequency
</span>            <span class="k">return</span>
        
        <span class="c1"># Evict if at capacity
</span>        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cache</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">capacity</span><span class="p">:</span>
            <span class="c1"># Remove item with minimum frequency
</span>            <span class="n">evict_key</span> <span class="o">=</span> <span class="nf">next</span><span class="p">(</span><span class="nf">iter</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">freq_map</span><span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">min_freq</span><span class="p">]))</span>
            <span class="n">self</span><span class="p">.</span><span class="n">freq_map</span><span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">min_freq</span><span class="p">].</span><span class="nf">remove</span><span class="p">(</span><span class="n">evict_key</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">self</span><span class="p">.</span><span class="n">cache</span><span class="p">[</span><span class="n">evict_key</span><span class="p">]</span>
        
        <span class="c1"># Add new key
</span>        <span class="n">self</span><span class="p">.</span><span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">freq_map</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">add</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">min_freq</span> <span class="o">=</span> <span class="mi">1</span>
    
    <span class="k">def</span> <span class="nf">get_top_k</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">k</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Get top k most frequently accessed items</span><span class="sh">"""</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">[(</span><span class="n">freq</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">freq</span><span class="p">)</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="nf">items</span><span class="p">()]</span>
        <span class="k">return</span> <span class="n">heapq</span><span class="p">.</span><span class="nf">nlargest</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">items</span><span class="p">)</span>

<span class="c1"># Usage for embeddings (frequently accessed)
</span><span class="n">embedding_cache</span> <span class="o">=</span> <span class="nc">LFUCache</span><span class="p">(</span><span class="n">capacity</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_embedding_cached</span><span class="p">(</span><span class="n">entity_id</span><span class="p">,</span> <span class="n">embedding_model</span><span class="p">):</span>
    <span class="n">cached_emb</span> <span class="o">=</span> <span class="n">embedding_cache</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">entity_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cached_emb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">cached_emb</span>
    
    <span class="n">embedding</span> <span class="o">=</span> <span class="n">embedding_model</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="n">entity_id</span><span class="p">)</span>
    <span class="n">embedding_cache</span><span class="p">.</span><span class="nf">put</span><span class="p">(</span><span class="n">entity_id</span><span class="p">,</span> <span class="n">embedding</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">embedding</span>
</code></pre></div></div>

<h3 id="ttl-time-to-live-cache">TTL (Time-To-Live) Cache</h3>

<p><strong>Good for time-sensitive data</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">time</span>

<span class="k">class</span> <span class="nc">TTLCache</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    TTL Cache - items expire after specified time
    
    Perfect for:
    - User sessions
    - Real-time features (stock prices, weather)
    - Model predictions that become stale
    </span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">default_ttl_seconds</span><span class="o">=</span><span class="mi">3600</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cache</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># key -&gt; (value, expiration_time)
</span>        <span class="n">self</span><span class="p">.</span><span class="n">default_ttl</span> <span class="o">=</span> <span class="n">default_ttl_seconds</span>
    
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Get value if not expired</span><span class="sh">"""</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">cache</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        
        <span class="n">value</span><span class="p">,</span> <span class="n">expiration</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        
        <span class="c1"># Check expiration
</span>        <span class="k">if</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">expiration</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">self</span><span class="p">.</span><span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">return</span> <span class="bp">None</span>
        
        <span class="k">return</span> <span class="n">value</span>
    
    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">ttl</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Put key-value pair with TTL</span><span class="sh">"""</span>
        <span class="k">if</span> <span class="n">ttl</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">ttl</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">default_ttl</span>
        
        <span class="n">expiration</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">+</span> <span class="n">ttl</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">expiration</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Remove expired entries</span><span class="sh">"""</span>
        <span class="n">current_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="n">expired_keys</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">exp</span><span class="p">)</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="nf">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">current_time</span> <span class="o">&gt;</span> <span class="n">exp</span>
        <span class="p">]</span>
        
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">expired_keys</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">self</span><span class="p">.</span><span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="nf">len</span><span class="p">(</span><span class="n">expired_keys</span><span class="p">)</span>

<span class="c1"># Usage for time-sensitive predictions
</span><span class="n">prediction_cache</span> <span class="o">=</span> <span class="nc">TTLCache</span><span class="p">(</span><span class="n">default_ttl_seconds</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>  <span class="c1"># 5 minutes
</span>
<span class="k">def</span> <span class="nf">predict_stock_price</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">Predictions expire quickly for real-time data</span><span class="sh">"""</span>
    <span class="n">cached</span> <span class="o">=</span> <span class="n">prediction_cache</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cached</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">cached</span>
    
    <span class="n">prediction</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="nf">predict</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
    <span class="n">prediction_cache</span><span class="p">.</span><span class="nf">put</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">prediction</span><span class="p">,</span> <span class="n">ttl</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>  <span class="c1"># 1 minute TTL
</span>    
    <span class="k">return</span> <span class="n">prediction</span>
</code></pre></div></div>

<hr />

<h2 id="distributed-caching">Distributed Caching</h2>

<h3 id="redis-based-cache">Redis-Based Cache</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">redis</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">pickle</span>
<span class="kn">import</span> <span class="n">hashlib</span>

<span class="k">class</span> <span class="nc">RedisMLCache</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Redis-based cache for ML predictions
    
    Features:
    - Distributed across multiple servers
    - Persistence
    - TTL support
    - Pub/sub for cache invalidation
    </span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="sh">'</span><span class="s">localhost</span><span class="sh">'</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">6379</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">redis_client</span> <span class="o">=</span> <span class="n">redis</span><span class="p">.</span><span class="nc">Redis</span><span class="p">(</span>
            <span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">,</span>
            <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">,</span>
            <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">,</span>
            <span class="n">decode_responses</span><span class="o">=</span><span class="bp">False</span>
        <span class="p">)</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">hits</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">misses</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="k">def</span> <span class="nf">_serialize</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Serialize Python object</span><span class="sh">"""</span>
        <span class="k">return</span> <span class="n">pickle</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_deserialize</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Deserialize to Python object</span><span class="sh">"""</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="n">pickle</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_make_key</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Generate cache key</span><span class="sh">"""</span>
        <span class="c1"># Hash arguments for consistent key
</span>        <span class="n">key_str</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="sh">'</span><span class="si">:</span><span class="sh">'</span><span class="s">.join(map(str, args))</span><span class="si">}</span><span class="sh">"</span>
        <span class="k">return</span> <span class="n">key_str</span>
    
    <span class="k">def</span> <span class="nf">get_prediction</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">features</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Get cached prediction
        
        Args:
            model_id: Model identifier
            features: Feature vector (hashable)
        
        Returns:
            Cached prediction or None
        </span><span class="sh">"""</span>
        <span class="c1"># Create cache key
</span>        <span class="n">feature_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="p">.</span><span class="nf">md5</span><span class="p">(</span>
            <span class="nf">str</span><span class="p">(</span><span class="n">features</span><span class="p">).</span><span class="nf">encode</span><span class="p">()</span>
        <span class="p">).</span><span class="nf">hexdigest</span><span class="p">()</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_make_key</span><span class="p">(</span><span class="sh">'</span><span class="s">prediction</span><span class="sh">'</span><span class="p">,</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">feature_hash</span><span class="p">)</span>
        
        <span class="c1"># Get from Redis
</span>        <span class="n">cached</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">redis_client</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">cached</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">hits</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="nf">_deserialize</span><span class="p">(</span><span class="n">cached</span><span class="p">)</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">misses</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="bp">None</span>
    
    <span class="k">def</span> <span class="nf">set_prediction</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">prediction</span><span class="p">,</span> <span class="n">ttl</span><span class="o">=</span><span class="mi">3600</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Cache prediction with TTL</span><span class="sh">"""</span>
        <span class="n">feature_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="p">.</span><span class="nf">md5</span><span class="p">(</span>
            <span class="nf">str</span><span class="p">(</span><span class="n">features</span><span class="p">).</span><span class="nf">encode</span><span class="p">()</span>
        <span class="p">).</span><span class="nf">hexdigest</span><span class="p">()</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_make_key</span><span class="p">(</span><span class="sh">'</span><span class="s">prediction</span><span class="sh">'</span><span class="p">,</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">feature_hash</span><span class="p">)</span>
        
        <span class="c1"># Serialize and store
</span>        <span class="n">value</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_serialize</span><span class="p">(</span><span class="n">prediction</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">redis_client</span><span class="p">.</span><span class="nf">setex</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">ttl</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">get_embedding</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">entity_id</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Get cached embedding</span><span class="sh">"""</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_make_key</span><span class="p">(</span><span class="sh">'</span><span class="s">embedding</span><span class="sh">'</span><span class="p">,</span> <span class="n">entity_id</span><span class="p">)</span>
        <span class="n">cached</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">redis_client</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">cached</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">hits</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="c1"># Embeddings stored as JSON arrays
</span>            <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">cached</span><span class="p">)</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">misses</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="bp">None</span>
    
    <span class="k">def</span> <span class="nf">set_embedding</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">entity_id</span><span class="p">,</span> <span class="n">embedding</span><span class="p">,</span> <span class="n">ttl</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Cache embedding</span><span class="sh">"""</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_make_key</span><span class="p">(</span><span class="sh">'</span><span class="s">embedding</span><span class="sh">'</span><span class="p">,</span> <span class="n">entity_id</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">embedding</span><span class="p">.</span><span class="nf">tolist</span><span class="p">()</span> <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">embedding</span><span class="p">,</span> <span class="sh">'</span><span class="s">tolist</span><span class="sh">'</span><span class="p">)</span> <span class="k">else</span> <span class="n">embedding</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">ttl</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">redis_client</span><span class="p">.</span><span class="nf">setex</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">ttl</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">redis_client</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">invalidate_model</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">model_id</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Invalidate all predictions for a model (SCAN + DEL)</span><span class="sh">"""</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_make_key</span><span class="p">(</span><span class="sh">'</span><span class="s">prediction</span><span class="sh">'</span><span class="p">,</span> <span class="n">model_id</span><span class="p">,</span> <span class="sh">'</span><span class="s">*</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">total_deleted</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">cursor</span><span class="p">,</span> <span class="n">keys</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">redis_client</span><span class="p">.</span><span class="nf">scan</span><span class="p">(</span><span class="n">cursor</span><span class="o">=</span><span class="n">cursor</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="n">pattern</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">keys</span><span class="p">:</span>
                <span class="n">total_deleted</span> <span class="o">+=</span> <span class="n">self</span><span class="p">.</span><span class="n">redis_client</span><span class="p">.</span><span class="nf">delete</span><span class="p">(</span><span class="o">*</span><span class="n">keys</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cursor</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>
        
        <span class="k">return</span> <span class="n">total_deleted</span>
    
    <span class="k">def</span> <span class="nf">get_stats</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Get cache statistics</span><span class="sh">"""</span>
        <span class="n">total_requests</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">hits</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">misses</span>
        <span class="n">hit_rate</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">hits</span> <span class="o">/</span> <span class="n">total_requests</span> <span class="k">if</span> <span class="n">total_requests</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">hits</span><span class="sh">'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">hits</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">misses</span><span class="sh">'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">misses</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">hit_rate</span><span class="sh">'</span><span class="p">:</span> <span class="n">hit_rate</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">total_keys</span><span class="sh">'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">redis_client</span><span class="p">.</span><span class="nf">dbsize</span><span class="p">()</span>
        <span class="p">}</span>

<span class="c1"># Usage
</span><span class="n">cache</span> <span class="o">=</span> <span class="nc">RedisMLCache</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="sh">'</span><span class="s">localhost</span><span class="sh">'</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">6379</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">predict_with_cache</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">model_id</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">Predict with Redis caching</span><span class="sh">"""</span>
    <span class="c1"># Check cache
</span>    <span class="n">cached</span> <span class="o">=</span> <span class="n">cache</span><span class="p">.</span><span class="nf">get_prediction</span><span class="p">(</span><span class="n">model_id</span><span class="p">,</span> <span class="n">features</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cached</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">cached</span>
    
    <span class="c1"># Compute prediction
</span>    <span class="n">prediction</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="nf">predict</span><span class="p">([</span><span class="n">features</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="c1"># Cache result
</span>    <span class="n">cache</span><span class="p">.</span><span class="nf">set_prediction</span><span class="p">(</span><span class="n">model_id</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">prediction</span><span class="p">,</span> <span class="n">ttl</span><span class="o">=</span><span class="mi">3600</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">prediction</span>

<span class="c1"># Check cache performance
</span><span class="n">stats</span> <span class="o">=</span> <span class="n">cache</span><span class="p">.</span><span class="nf">get_stats</span><span class="p">()</span>
<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Cache hit rate: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="sh">'</span><span class="s">hit_rate</span><span class="sh">'</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="o">%</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="multi-level-cache">Multi-Level Cache</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">MultiLevelCache</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Multi-level caching with L1 (local) and L2 (Redis)
    
    Pattern:
    1. Check L1 (in-memory, fastest)
    2. If miss, check L2 (Redis, shared)
    3. If miss, compute and populate both levels
    </span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">l1_capacity</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">redis_host</span><span class="o">=</span><span class="sh">'</span><span class="s">localhost</span><span class="sh">'</span><span class="p">):</span>
        <span class="c1"># L1: Local LRU cache
</span>        <span class="n">self</span><span class="p">.</span><span class="n">l1</span> <span class="o">=</span> <span class="nc">LRUCache</span><span class="p">(</span><span class="n">capacity</span><span class="o">=</span><span class="n">l1_capacity</span><span class="p">)</span>
        
        <span class="c1"># L2: Redis cache
</span>        <span class="n">self</span><span class="p">.</span><span class="n">l2</span> <span class="o">=</span> <span class="nc">RedisMLCache</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">redis_host</span><span class="p">)</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">l1_hits</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">l2_hits</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">misses</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Get value from multi-level cache</span><span class="sh">"""</span>
        <span class="c1"># Try L1
</span>        <span class="n">value</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">l1</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">l1_hits</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="n">value</span>
        
        <span class="c1"># Try L2
</span>        <span class="n">value</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">l2</span><span class="p">.</span><span class="n">redis_client</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">l2_hits</span> <span class="o">+=</span> <span class="mi">1</span>
            
            <span class="c1"># Populate L1
</span>            <span class="n">value</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">l2</span><span class="p">.</span><span class="nf">_deserialize</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">l1</span><span class="p">.</span><span class="nf">put</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="n">value</span>
        
        <span class="c1"># Miss
</span>        <span class="n">self</span><span class="p">.</span><span class="n">misses</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="bp">None</span>
    
    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">ttl</span><span class="o">=</span><span class="mi">3600</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Put value in both cache levels</span><span class="sh">"""</span>
        <span class="c1"># Store in L1
</span>        <span class="n">self</span><span class="p">.</span><span class="n">l1</span><span class="p">.</span><span class="nf">put</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        
        <span class="c1"># Store in L2
</span>        <span class="n">self</span><span class="p">.</span><span class="n">l2</span><span class="p">.</span><span class="n">redis_client</span><span class="p">.</span><span class="nf">setex</span><span class="p">(</span>
            <span class="n">key</span><span class="p">,</span>
            <span class="n">ttl</span><span class="p">,</span>
            <span class="n">self</span><span class="p">.</span><span class="n">l2</span><span class="p">.</span><span class="nf">_serialize</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">get_stats</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Get multi-level cache statistics</span><span class="sh">"""</span>
        <span class="n">total</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">l1_hits</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">l2_hits</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">misses</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">l1_hits</span><span class="sh">'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">l1_hits</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">l2_hits</span><span class="sh">'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">l2_hits</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">misses</span><span class="sh">'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">misses</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">total_requests</span><span class="sh">'</span><span class="p">:</span> <span class="n">total</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">l1_hit_rate</span><span class="sh">'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">l1_hits</span> <span class="o">/</span> <span class="n">total</span> <span class="k">if</span> <span class="n">total</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">l2_hit_rate</span><span class="sh">'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">l2_hits</span> <span class="o">/</span> <span class="n">total</span> <span class="k">if</span> <span class="n">total</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">overall_hit_rate</span><span class="sh">'</span><span class="p">:</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">l1_hits</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">l2_hits</span><span class="p">)</span> <span class="o">/</span> <span class="n">total</span> <span class="k">if</span> <span class="n">total</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="p">}</span>

<span class="c1"># Usage
</span><span class="n">ml_cache</span> <span class="o">=</span> <span class="nc">MultiLevelCache</span><span class="p">(</span><span class="n">l1_capacity</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">redis_host</span><span class="o">=</span><span class="sh">'</span><span class="s">localhost</span><span class="sh">'</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_user_embedding</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">embedding_model</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">Get user embedding with multi-level caching</span><span class="sh">"""</span>
    <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">user_emb:</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="sh">"</span>
    
    <span class="c1"># Try cache
</span>    <span class="n">embedding</span> <span class="o">=</span> <span class="n">ml_cache</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">embedding</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">embedding</span>
    
    <span class="c1"># Compute
</span>    <span class="n">embedding</span> <span class="o">=</span> <span class="n">embedding_model</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
    
    <span class="c1"># Cache
</span>    <span class="n">ml_cache</span><span class="p">.</span><span class="nf">put</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">embedding</span><span class="p">,</span> <span class="n">ttl</span><span class="o">=</span><span class="mi">3600</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">embedding</span>
</code></pre></div></div>

<hr />

<h2 id="cache-warming-strategies">Cache Warming Strategies</h2>

<h3 id="proactive-cache-warming">Proactive Cache Warming</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">threading</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">queue</span> <span class="kn">import</span> <span class="n">Queue</span>

<span class="k">class</span> <span class="nc">CacheWarmer</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Proactively warm cache before requests arrive
    
    Strategies:
    1. Popular items (based on historical data)
    2. Scheduled warmup (daily, hourly)
    3. Predictive warmup (ML-based)
    </span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cache</span><span class="p">,</span> <span class="n">compute_fn</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cache</span> <span class="o">=</span> <span class="n">cache</span>
        <span class="n">self</span><span class="p">.</span><span class="n">compute_fn</span> <span class="o">=</span> <span class="n">compute_fn</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">warmup_queue</span> <span class="o">=</span> <span class="nc">Queue</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">is_running</span> <span class="o">=</span> <span class="bp">False</span>
    
    <span class="k">def</span> <span class="nf">warm_popular_items</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">items</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="sh">'</span><span class="s">high</span><span class="sh">'</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Warm cache with popular items</span><span class="sh">"""</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Warming </span><span class="si">{</span><span class="nf">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span><span class="si">}</span><span class="s"> popular items...</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
            <span class="n">key</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">item</span>
            
            <span class="c1"># Check if already cached
</span>            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">continue</span>
            
            <span class="c1"># Compute and cache
</span>            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">compute_fn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
                <span class="n">self</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="nf">put</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Error warming </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">warm_on_schedule</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">items</span><span class="p">,</span> <span class="n">interval_seconds</span><span class="o">=</span><span class="mi">3600</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Periodically warm cache</span><span class="sh">"""</span>
        <span class="k">def</span> <span class="nf">warmup_worker</span><span class="p">():</span>
            <span class="k">while</span> <span class="n">self</span><span class="p">.</span><span class="n">is_running</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">warm_popular_items</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
                <span class="n">time</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="n">interval_seconds</span><span class="p">)</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">is_running</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">worker</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">warmup_worker</span><span class="p">,</span> <span class="n">daemon</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">worker</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Stop scheduled warmup</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="n">is_running</span> <span class="o">=</span> <span class="bp">False</span>

<span class="c1"># Usage
</span><span class="k">def</span> <span class="nf">compute_recommendation</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">Expensive recommendation computation</span><span class="sh">"""</span>
    <span class="k">return</span> <span class="n">model</span><span class="p">.</span><span class="nf">recommend</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="n">cache</span> <span class="o">=</span> <span class="nc">LRUCache</span><span class="p">(</span><span class="n">capacity</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>
<span class="n">warmer</span> <span class="o">=</span> <span class="nc">CacheWarmer</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="n">compute_recommendation</span><span class="p">)</span>

<span class="c1"># Warm cache with top 1000 users
</span><span class="n">popular_users</span> <span class="o">=</span> <span class="nf">get_top_1000_active_users</span><span class="p">()</span>
<span class="n">items</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">rec:</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">recommendation_model</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">user_id</span> <span class="ow">in</span> <span class="n">popular_users</span>
<span class="p">]</span>

<span class="n">warmer</span><span class="p">.</span><span class="nf">warm_popular_items</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>

<span class="c1"># Or schedule periodic warmup
</span><span class="n">warmer</span><span class="p">.</span><span class="nf">warm_on_schedule</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">interval_seconds</span><span class="o">=</span><span class="mi">3600</span><span class="p">)</span>
</code></pre></div></div>

<hr />

<h2 id="cache-invalidation">Cache Invalidation</h2>

<h3 id="push-based-invalidation">Push-Based Invalidation</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">redis</span>

<span class="k">class</span> <span class="nc">CacheInvalidator</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Cache invalidation using Redis Pub/Sub
    
    Pattern:
    - When model updates, publish invalidation message
    - All cache instances subscribe and clear relevant entries
    </span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">redis_host</span><span class="o">=</span><span class="sh">'</span><span class="s">localhost</span><span class="sh">'</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">redis_pub</span> <span class="o">=</span> <span class="n">redis</span><span class="p">.</span><span class="nc">Redis</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">redis_host</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">redis_sub</span> <span class="o">=</span> <span class="n">redis</span><span class="p">.</span><span class="nc">Redis</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">redis_host</span><span class="p">)</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">cache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">invalidation_count</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="k">def</span> <span class="nf">subscribe_to_invalidations</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="sh">'</span><span class="s">cache:invalidate</span><span class="sh">'</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Subscribe to invalidation messages</span><span class="sh">"""</span>
        <span class="n">pubsub</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">redis_sub</span><span class="p">.</span><span class="nf">pubsub</span><span class="p">()</span>
        <span class="n">pubsub</span><span class="p">.</span><span class="nf">subscribe</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span>
        
        <span class="k">def</span> <span class="nf">listen</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">pubsub</span><span class="p">.</span><span class="nf">listen</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">message</span><span class="p">[</span><span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">:</span>
                    <span class="n">self</span><span class="p">.</span><span class="nf">_handle_invalidation</span><span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="sh">'</span><span class="s">data</span><span class="sh">'</span><span class="p">])</span>
        
        <span class="c1"># Start listener thread
</span>        <span class="n">listener</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">listen</span><span class="p">,</span> <span class="n">daemon</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">listener</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">_handle_invalidation</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Handle invalidation message</span><span class="sh">"""</span>
        <span class="c1"># Message format: "model_id:v2"
</span>        <span class="n">invalidation_key</span> <span class="o">=</span> <span class="n">message</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">'</span><span class="s">utf-8</span><span class="sh">'</span><span class="p">)</span>
        
        <span class="c1"># Remove matching cache entries
</span>        <span class="n">keys_to_remove</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="nf">keys</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">k</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="n">invalidation_key</span><span class="p">)</span>
        <span class="p">]</span>
        
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys_to_remove</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">self</span><span class="p">.</span><span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">invalidation_count</span> <span class="o">+=</span> <span class="nf">len</span><span class="p">(</span><span class="n">keys_to_remove</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Invalidated </span><span class="si">{</span><span class="nf">len</span><span class="p">(</span><span class="n">keys_to_remove</span><span class="p">)</span><span class="si">}</span><span class="s"> cache entries</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">invalidate_model</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">model_id</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Publish invalidation message</span><span class="sh">"""</span>
        <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">model_id</span><span class="si">}</span><span class="s">:v</span><span class="sh">"</span>
        <span class="n">self</span><span class="p">.</span><span class="n">redis_pub</span><span class="p">.</span><span class="nf">publish</span><span class="p">(</span><span class="sh">'</span><span class="s">cache:invalidate</span><span class="sh">'</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>

<span class="c1"># Usage
</span><span class="n">invalidator</span> <span class="o">=</span> <span class="nc">CacheInvalidator</span><span class="p">()</span>
<span class="n">invalidator</span><span class="p">.</span><span class="nf">subscribe_to_invalidations</span><span class="p">()</span>

<span class="c1"># When model is updated
</span><span class="k">def</span> <span class="nf">update_model</span><span class="p">(</span><span class="n">model_id</span><span class="p">,</span> <span class="n">new_model</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">Update model and invalidate cache</span><span class="sh">"""</span>
    <span class="c1"># Deploy new model
</span>    <span class="nf">deploy_model</span><span class="p">(</span><span class="n">new_model</span><span class="p">)</span>
    
    <span class="c1"># Invalidate all predictions for this model
</span>    <span class="n">invalidator</span><span class="p">.</span><span class="nf">invalidate_model</span><span class="p">(</span><span class="n">model_id</span><span class="p">)</span>
</code></pre></div></div>

<hr />

<h2 id="feature-store-caching">Feature Store Caching</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">FeatureStoreCache</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Caching layer for feature store
    
    Features:
    - Cache precomputed features
    - Batch feature retrieval
    - Freshness guarantees
    </span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">redis_client</span><span class="p">,</span> <span class="n">ttl</span><span class="o">=</span><span class="mi">3600</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">redis</span> <span class="o">=</span> <span class="n">redis_client</span>
        <span class="n">self</span><span class="p">.</span><span class="n">ttl</span> <span class="o">=</span> <span class="n">ttl</span>
    
    <span class="k">def</span> <span class="nf">get_features</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">entity_ids</span><span class="p">,</span> <span class="n">feature_names</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Get features for multiple entities (batch)
        
        Args:
            entity_ids: List of entity IDs
            feature_names: List of feature names
        
        Returns:
            Dict of entity_id -&gt; feature_dict
        </span><span class="sh">"""</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">cache_misses</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># Try cache first
</span>        <span class="k">for</span> <span class="n">entity_id</span> <span class="ow">in</span> <span class="n">entity_ids</span><span class="p">:</span>
            <span class="n">cache_key</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">features:</span><span class="si">{</span><span class="n">entity_id</span><span class="si">}</span><span class="sh">"</span>
            <span class="n">cached</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">redis</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">cached</span><span class="p">:</span>
                <span class="c1"># Parse cached features
</span>                <span class="n">features</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">cached</span><span class="p">)</span>
                
                <span class="c1"># Filter to requested features
</span>                <span class="n">filtered</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">fname</span><span class="p">:</span> <span class="n">features</span><span class="p">[</span><span class="n">fname</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">feature_names</span>
                    <span class="k">if</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">features</span>
                <span class="p">}</span>
                
                <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">filtered</span><span class="p">)</span> <span class="o">==</span> <span class="nf">len</span><span class="p">(</span><span class="n">feature_names</span><span class="p">):</span>
                    <span class="n">results</span><span class="p">[</span><span class="n">entity_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">filtered</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cache_misses</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">entity_id</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cache_misses</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">entity_id</span><span class="p">)</span>
        
        <span class="c1"># Compute missing features
</span>        <span class="k">if</span> <span class="n">cache_misses</span><span class="p">:</span>
            <span class="n">computed</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_compute_features</span><span class="p">(</span><span class="n">cache_misses</span><span class="p">,</span> <span class="n">feature_names</span><span class="p">)</span>
            
            <span class="c1"># Cache computed features
</span>            <span class="k">for</span> <span class="n">entity_id</span><span class="p">,</span> <span class="n">features</span> <span class="ow">in</span> <span class="n">computed</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_cache_features</span><span class="p">(</span><span class="n">entity_id</span><span class="p">,</span> <span class="n">features</span><span class="p">)</span>
                <span class="n">results</span><span class="p">[</span><span class="n">entity_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">features</span>
        
        <span class="k">return</span> <span class="n">results</span>
    
    <span class="k">def</span> <span class="nf">_compute_features</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">entity_ids</span><span class="p">,</span> <span class="n">feature_names</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Compute features from feature store</span><span class="sh">"""</span>
        <span class="c1"># Call actual feature store
</span>        <span class="k">return</span> <span class="nf">compute_features_batch</span><span class="p">(</span><span class="n">entity_ids</span><span class="p">,</span> <span class="n">feature_names</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_cache_features</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">entity_id</span><span class="p">,</span> <span class="n">features</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Cache features for entity</span><span class="sh">"""</span>
        <span class="n">cache_key</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">features:</span><span class="si">{</span><span class="n">entity_id</span><span class="si">}</span><span class="sh">"</span>
        <span class="n">self</span><span class="p">.</span><span class="n">redis</span><span class="p">.</span><span class="nf">setex</span><span class="p">(</span>
            <span class="n">cache_key</span><span class="p">,</span>
            <span class="n">self</span><span class="p">.</span><span class="n">ttl</span><span class="p">,</span>
            <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
        <span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">invalidate_entity</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">entity_id</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Invalidate features for entity</span><span class="sh">"""</span>
        <span class="n">cache_key</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">features:</span><span class="si">{</span><span class="n">entity_id</span><span class="si">}</span><span class="sh">"</span>
        <span class="n">self</span><span class="p">.</span><span class="n">redis</span><span class="p">.</span><span class="nf">delete</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>

<span class="c1"># Usage
</span><span class="n">feature_cache</span> <span class="o">=</span> <span class="nc">FeatureStoreCache</span><span class="p">(</span><span class="n">redis_client</span><span class="p">,</span> <span class="n">ttl</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>

<span class="c1"># Get features for batch of users
</span><span class="n">user_ids</span> <span class="o">=</span> <span class="p">[</span><span class="mi">123</span><span class="p">,</span> <span class="mi">456</span><span class="p">,</span> <span class="mi">789</span><span class="p">]</span>
<span class="n">feature_names</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">age</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">location</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">purchase_count</span><span class="sh">'</span><span class="p">]</span>

<span class="n">features</span> <span class="o">=</span> <span class="n">feature_cache</span><span class="p">.</span><span class="nf">get_features</span><span class="p">(</span><span class="n">user_ids</span><span class="p">,</span> <span class="n">feature_names</span><span class="p">)</span>
</code></pre></div></div>

<hr />

<h2 id="connection-to-linked-lists-day-10-dsa">Connection to Linked Lists (Day 10 DSA)</h2>

<p>Cache implementations heavily use linked list concepts:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">DoublyLinkedNode</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Node for doubly-linked list (used in LRU)</span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span>
        <span class="n">self</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
        <span class="n">self</span><span class="p">.</span><span class="n">prev</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">self</span><span class="p">.</span><span class="nb">next</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">class</span> <span class="nc">ProductionLRUCache</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Production LRU cache using doubly-linked list
    
    Connection to Day 10 DSA:
    - Uses linked list for maintaining order
    - Pointer manipulation similar to reversal
    - O(1) operations through careful pointer management
    </span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">capacity</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">capacity</span> <span class="o">=</span> <span class="n">capacity</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cache</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="c1"># Dummy head and tail
</span>        <span class="n">self</span><span class="p">.</span><span class="n">head</span> <span class="o">=</span> <span class="nc">DoublyLinkedNode</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">tail</span> <span class="o">=</span> <span class="nc">DoublyLinkedNode</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">head</span><span class="p">.</span><span class="nb">next</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">tail</span>
        <span class="n">self</span><span class="p">.</span><span class="n">tail</span><span class="p">.</span><span class="n">prev</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">head</span>
    
    <span class="k">def</span> <span class="nf">_add_node</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Add node right after head</span><span class="sh">"""</span>
        <span class="n">node</span><span class="p">.</span><span class="n">prev</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">head</span>
        <span class="n">node</span><span class="p">.</span><span class="nb">next</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">head</span><span class="p">.</span><span class="nb">next</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">head</span><span class="p">.</span><span class="nb">next</span><span class="p">.</span><span class="n">prev</span> <span class="o">=</span> <span class="n">node</span>
        <span class="n">self</span><span class="p">.</span><span class="n">head</span><span class="p">.</span><span class="nb">next</span> <span class="o">=</span> <span class="n">node</span>
    
    <span class="k">def</span> <span class="nf">_remove_node</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Remove node from list</span><span class="sh">"""</span>
        <span class="n">prev_node</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">prev</span>
        <span class="n">next_node</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="nb">next</span>
        
        <span class="n">prev_node</span><span class="p">.</span><span class="nb">next</span> <span class="o">=</span> <span class="n">next_node</span>
        <span class="n">next_node</span><span class="p">.</span><span class="n">prev</span> <span class="o">=</span> <span class="n">prev_node</span>
    
    <span class="k">def</span> <span class="nf">_move_to_head</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Move node to head (most recently used)</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_remove_node</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_add_node</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_pop_tail</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Remove least recently used (tail.prev)</span><span class="sh">"""</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">tail</span><span class="p">.</span><span class="n">prev</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_remove_node</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>
    
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Get value</span><span class="sh">"""</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">node</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
        
        <span class="n">self</span><span class="p">.</span><span class="nf">_move_to_head</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">node</span><span class="p">.</span><span class="n">value</span>
    
    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Put key-value</span><span class="sh">"""</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">node</span><span class="p">:</span>
            <span class="n">node</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_move_to_head</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_node</span> <span class="o">=</span> <span class="nc">DoublyLinkedNode</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_node</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_add_node</span><span class="p">(</span><span class="n">new_node</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cache</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">self</span><span class="p">.</span><span class="n">capacity</span><span class="p">:</span>
                <span class="n">tail</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_pop_tail</span><span class="p">()</span>
                <span class="k">del</span> <span class="n">self</span><span class="p">.</span><span class="n">cache</span><span class="p">[</span><span class="n">tail</span><span class="p">.</span><span class="n">key</span><span class="p">]</span>
</code></pre></div></div>

<hr />

<h2 id="understanding-cache-performance">Understanding Cache Performance</h2>

<h3 id="cache-hit-rate-analysis">Cache Hit Rate Analysis</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">CachePerformanceAnalyzer</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Analyze and optimize cache performance
    
    Key metrics:
    - Hit rate: % of requests served from cache
    - Miss rate: % of requests requiring computation
    - Latency reduction: Time saved by caching
    - Memory efficiency: Cache size vs hit rate
    </span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">total_requests</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cache_hits</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cache_misses</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">hit_latencies</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">miss_latencies</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">record_hit</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">latency_ms</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Record cache hit</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cache_hits</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">self</span><span class="p">.</span><span class="n">total_requests</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">self</span><span class="p">.</span><span class="n">hit_latencies</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">latency_ms</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">record_miss</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">latency_ms</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Record cache miss</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cache_misses</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">self</span><span class="p">.</span><span class="n">total_requests</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">self</span><span class="p">.</span><span class="n">miss_latencies</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">latency_ms</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">get_metrics</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Calculate performance metrics</span><span class="sh">"""</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">total_requests</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>
        
        <span class="n">hit_rate</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">cache_hits</span> <span class="o">/</span> <span class="n">self</span><span class="p">.</span><span class="n">total_requests</span>
        <span class="n">miss_rate</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">cache_misses</span> <span class="o">/</span> <span class="n">self</span><span class="p">.</span><span class="n">total_requests</span>
        
        <span class="n">avg_hit_latency</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nf">sum</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">hit_latencies</span><span class="p">)</span> <span class="o">/</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">hit_latencies</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">hit_latencies</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="p">)</span>
        
        <span class="n">avg_miss_latency</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nf">sum</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">miss_latencies</span><span class="p">)</span> <span class="o">/</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">miss_latencies</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">miss_latencies</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="p">)</span>
        
        <span class="c1"># Calculate latency reduction
</span>        <span class="n">avg_latency_with_cache</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">hit_rate</span> <span class="o">*</span> <span class="n">avg_hit_latency</span> <span class="o">+</span> <span class="n">miss_rate</span> <span class="o">*</span> <span class="n">avg_miss_latency</span>
        <span class="p">)</span>
        
        <span class="n">latency_reduction</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">avg_miss_latency</span> <span class="o">-</span> <span class="n">avg_latency_with_cache</span><span class="p">)</span> <span class="o">/</span> <span class="n">avg_miss_latency</span>
            <span class="k">if</span> <span class="n">avg_miss_latency</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">total_requests</span><span class="sh">'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">total_requests</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">cache_hits</span><span class="sh">'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">cache_hits</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">cache_misses</span><span class="sh">'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">cache_misses</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">hit_rate</span><span class="sh">'</span><span class="p">:</span> <span class="n">hit_rate</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">miss_rate</span><span class="sh">'</span><span class="p">:</span> <span class="n">miss_rate</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">avg_hit_latency_ms</span><span class="sh">'</span><span class="p">:</span> <span class="n">avg_hit_latency</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">avg_miss_latency_ms</span><span class="sh">'</span><span class="p">:</span> <span class="n">avg_miss_latency</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">avg_overall_latency_ms</span><span class="sh">'</span><span class="p">:</span> <span class="n">avg_latency_with_cache</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">latency_reduction_pct</span><span class="sh">'</span><span class="p">:</span> <span class="n">latency_reduction</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">print_report</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Print performance report</span><span class="sh">"""</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">get_metrics</span><span class="p">()</span>
        
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="sh">"</span><span class="s">=</span><span class="sh">"</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">CACHE PERFORMANCE REPORT</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=</span><span class="sh">"</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Total Requests:        </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="sh">'</span><span class="s">total_requests</span><span class="sh">'</span><span class="p">]</span><span class="si">:</span><span class="p">,</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Cache Hits:            </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="sh">'</span><span class="s">cache_hits</span><span class="sh">'</span><span class="p">]</span><span class="si">:</span><span class="p">,</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Cache Misses:          </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="sh">'</span><span class="s">cache_misses</span><span class="sh">'</span><span class="p">]</span><span class="si">:</span><span class="p">,</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Hit Rate:              </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="sh">'</span><span class="s">hit_rate</span><span class="sh">'</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="o">%</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Miss Rate:             </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="sh">'</span><span class="s">miss_rate</span><span class="sh">'</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="o">%</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="s">Latency Analysis:</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  Cache Hit:           </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="sh">'</span><span class="s">avg_hit_latency_ms</span><span class="sh">'</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s"> ms</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  Cache Miss:          </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="sh">'</span><span class="s">avg_miss_latency_ms</span><span class="sh">'</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s"> ms</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  Overall Average:     </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="sh">'</span><span class="s">avg_overall_latency_ms</span><span class="sh">'</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s"> ms</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  Latency Reduction:   </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="sh">'</span><span class="s">latency_reduction_pct</span><span class="sh">'</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s">%</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=</span><span class="sh">"</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>

<span class="c1"># Usage example
</span><span class="n">analyzer</span> <span class="o">=</span> <span class="nc">CachePerformanceAnalyzer</span><span class="p">()</span>

<span class="c1"># Simulate requests
</span><span class="kn">import</span> <span class="n">random</span>
<span class="kn">import</span> <span class="n">time</span>

<span class="n">cache</span> <span class="o">=</span> <span class="nc">LRUCache</span><span class="p">(</span><span class="n">capacity</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">):</span>
    <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">key_</span><span class="si">{</span><span class="n">random</span><span class="p">.</span><span class="nf">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">150</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span>
    
    <span class="c1"># Check cache
</span>    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">cache</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="c1"># Cache hit (fast)
</span>        <span class="n">latency</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
        <span class="n">analyzer</span><span class="p">.</span><span class="nf">record_hit</span><span class="p">(</span><span class="n">latency</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Cache miss (slow - simulate computation)
</span>        <span class="n">time</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mf">0.001</span><span class="p">)</span>  <span class="c1"># 1ms computation
</span>        <span class="n">latency</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
        <span class="n">analyzer</span><span class="p">.</span><span class="nf">record_miss</span><span class="p">(</span><span class="n">latency</span><span class="p">)</span>
        
        <span class="c1"># Store in cache
</span>        <span class="n">cache</span><span class="p">.</span><span class="nf">put</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">value_</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="n">analyzer</span><span class="p">.</span><span class="nf">print_report</span><span class="p">()</span>
</code></pre></div></div>

<h3 id="cache-size-optimization">Cache Size Optimization</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">CacheSizeOptimizer</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Find optimal cache size for given workload
    
    Trade-off: Larger cache = higher hit rate but more memory
    </span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">workload</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Args:
            workload: List of access patterns (keys)
        </span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="n">workload</span> <span class="o">=</span> <span class="n">workload</span>
    
    <span class="k">def</span> <span class="nf">find_optimal_size</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">max_size</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Test different cache sizes
        
        Returns optimal size based on diminishing returns
        </span><span class="sh">"""</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Testing cache sizes...</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="sh">'</span><span class="s">Size</span><span class="sh">'</span><span class="si">:</span><span class="o">&lt;</span><span class="mi">10</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="sh">'</span><span class="s">Hit Rate</span><span class="sh">'</span><span class="si">:</span><span class="o">&lt;</span><span class="mi">12</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="sh">'</span><span class="s">Marginal Gain</span><span class="sh">'</span><span class="si">:</span><span class="o">&lt;</span><span class="mi">15</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">-</span><span class="sh">"</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
        
        <span class="n">prev_hit_rate</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">for</span> <span class="n">size</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">max_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
            <span class="n">hit_rate</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_simulate_cache</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
            <span class="n">marginal_gain</span> <span class="o">=</span> <span class="n">hit_rate</span> <span class="o">-</span> <span class="n">prev_hit_rate</span>
            
            <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">'</span><span class="s">size</span><span class="sh">'</span><span class="p">:</span> <span class="n">size</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">hit_rate</span><span class="sh">'</span><span class="p">:</span> <span class="n">hit_rate</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">marginal_gain</span><span class="sh">'</span><span class="p">:</span> <span class="n">marginal_gain</span>
            <span class="p">})</span>
            
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">size</span><span class="si">:</span><span class="o">&lt;</span><span class="mi">10</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">hit_rate</span><span class="si">:</span><span class="o">&lt;</span><span class="mf">12.2</span><span class="o">%</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">marginal_gain</span><span class="si">:</span><span class="o">&lt;</span><span class="mf">15.4</span><span class="o">%</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            
            <span class="n">prev_hit_rate</span> <span class="o">=</span> <span class="n">hit_rate</span>
            
            <span class="c1"># Stop if marginal gain is too small
</span>            <span class="k">if</span> <span class="n">marginal_gain</span> <span class="o">&lt;</span> <span class="mf">0.001</span><span class="p">:</span>  <span class="c1"># 0.1% gain
</span>                <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="s">Diminishing returns detected at size </span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">break</span>
        
        <span class="k">return</span> <span class="n">results</span>
    
    <span class="k">def</span> <span class="nf">_simulate_cache</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Simulate cache with given size</span><span class="sh">"""</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="nc">LRUCache</span><span class="p">(</span><span class="n">capacity</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>
        <span class="n">hits</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">workload</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cache</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">hits</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cache</span><span class="p">.</span><span class="nf">put</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">hits</span> <span class="o">/</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">workload</span><span class="p">)</span>

<span class="c1"># Generate workload (Zipf distribution - realistic for many applications)
</span><span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>

<span class="k">def</span> <span class="nf">generate_zipf_workload</span><span class="p">(</span><span class="n">n_items</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">n_requests</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.5</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    Generate Zipf-distributed workload
    
    Zipf law: Some items are accessed much more frequently
    (80/20 rule, power law distribution)
    </span><span class="sh">"""</span>
    <span class="c1"># Zipf distribution
</span>    <span class="n">probabilities</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span><span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">i</span> <span class="o">**</span> <span class="n">alpha</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_items</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)])</span>
    <span class="n">probabilities</span> <span class="o">/=</span> <span class="n">probabilities</span><span class="p">.</span><span class="nf">sum</span><span class="p">()</span>
    
    <span class="c1"># Generate requests
</span>    <span class="n">workload</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">choice</span><span class="p">(</span>
        <span class="p">[</span><span class="sa">f</span><span class="sh">"</span><span class="s">key_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="sh">"</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">n_items</span><span class="p">)],</span>
        <span class="n">size</span><span class="o">=</span><span class="n">n_requests</span><span class="p">,</span>
        <span class="n">p</span><span class="o">=</span><span class="n">probabilities</span>
    <span class="p">)</span>
    
    <span class="k">return</span> <span class="n">workload</span><span class="p">.</span><span class="nf">tolist</span><span class="p">()</span>

<span class="c1"># Find optimal cache size
</span><span class="n">workload</span> <span class="o">=</span> <span class="nf">generate_zipf_workload</span><span class="p">(</span><span class="n">n_items</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">n_requests</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="nc">CacheSizeOptimizer</span><span class="p">(</span><span class="n">workload</span><span class="p">)</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">optimizer</span><span class="p">.</span><span class="nf">find_optimal_size</span><span class="p">(</span><span class="n">max_size</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>

<span class="c1"># Plot results
</span><span class="kn">import</span> <span class="n">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="n">sizes</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="sh">'</span><span class="s">size</span><span class="sh">'</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>
<span class="n">hit_rates</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="sh">'</span><span class="s">hit_rate</span><span class="sh">'</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">sizes</span><span class="p">,</span> <span class="n">hit_rates</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="sh">'</span><span class="s">o</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Cache Size</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Hit Rate</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sh">'</span><span class="s">Cache Size vs Hit Rate</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">grid</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">savefig</span><span class="p">(</span><span class="sh">'</span><span class="s">cache_size_optimization.png</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div>

<hr />

<h2 id="advanced-caching-patterns">Advanced Caching Patterns</h2>

<h3 id="write-through-vs-write-back-cache">Write-Through vs Write-Back Cache</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">WriteThroughCache</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Write-through cache: Write to cache and database simultaneously
    
    Pros:
    - Data consistency
    - Simple to implement
    
    Cons:
    - Slower writes
    - Every write hits database
    </span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cache</span><span class="p">,</span> <span class="n">database</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cache</span> <span class="o">=</span> <span class="n">cache</span>
        <span class="n">self</span><span class="p">.</span><span class="n">database</span> <span class="o">=</span> <span class="n">database</span>
    
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Read with cache</span><span class="sh">"""</span>
        <span class="c1"># Try cache first
</span>        <span class="n">value</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">value</span>
        
        <span class="c1"># Cache miss: read from database
</span>        <span class="n">value</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">database</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="nf">put</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">value</span>
    
    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Write to both cache and database</span><span class="sh">"""</span>
        <span class="c1"># Write to database first
</span>        <span class="n">self</span><span class="p">.</span><span class="n">database</span><span class="p">.</span><span class="nf">put</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        
        <span class="c1"># Then update cache
</span>        <span class="n">self</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="nf">put</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">WriteBackCache</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Write-back cache: Write to cache only, flush to database later
    
    Pros:
    - Fast writes
    - Batching possible
    
    Cons:
    - Risk of data loss
    - More complex
    </span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cache</span><span class="p">,</span> <span class="n">database</span><span class="p">,</span> <span class="n">flush_interval</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cache</span> <span class="o">=</span> <span class="n">cache</span>
        <span class="n">self</span><span class="p">.</span><span class="n">database</span> <span class="o">=</span> <span class="n">database</span>
        <span class="n">self</span><span class="p">.</span><span class="n">flush_interval</span> <span class="o">=</span> <span class="n">flush_interval</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">dirty_keys</span> <span class="o">=</span> <span class="nf">set</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">last_flush</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Read with cache</span><span class="sh">"""</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">value</span>
        
        <span class="n">value</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">database</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="nf">put</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">value</span>
    
    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Write to cache only</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="nf">put</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">dirty_keys</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        
        <span class="c1"># Check if we need to flush
</span>        <span class="k">if</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">last_flush</span> <span class="o">&gt;</span> <span class="n">self</span><span class="p">.</span><span class="n">flush_interval</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">flush</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Flush dirty keys to database</span><span class="sh">"""</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">dirty_keys</span><span class="p">:</span>
            <span class="k">return</span>
        
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Flushing </span><span class="si">{</span><span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">dirty_keys</span><span class="p">)</span><span class="si">}</span><span class="s"> dirty keys...</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">dirty_keys</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="n">database</span><span class="p">.</span><span class="nf">put</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">dirty_keys</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">last_flush</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>

<span class="c1"># Example database simulation
</span><span class="k">class</span> <span class="nc">SimpleDatabase</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">read_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">write_count</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">read_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">time</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mf">0.001</span><span class="p">)</span>  <span class="c1"># Simulate latency
</span>        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">write_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">time</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mf">0.001</span><span class="p">)</span>  <span class="c1"># Simulate latency
</span>        <span class="n">self</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

<span class="c1"># Compare write-through vs write-back
</span><span class="n">db1</span> <span class="o">=</span> <span class="nc">SimpleDatabase</span><span class="p">()</span>
<span class="n">cache1</span> <span class="o">=</span> <span class="nc">LRUCache</span><span class="p">(</span><span class="n">capacity</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">write_through</span> <span class="o">=</span> <span class="nc">WriteThroughCache</span><span class="p">(</span><span class="n">cache1</span><span class="p">,</span> <span class="n">db1</span><span class="p">)</span>

<span class="n">db2</span> <span class="o">=</span> <span class="nc">SimpleDatabase</span><span class="p">()</span>
<span class="n">cache2</span> <span class="o">=</span> <span class="nc">LRUCache</span><span class="p">(</span><span class="n">capacity</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">write_back</span> <span class="o">=</span> <span class="nc">WriteBackCache</span><span class="p">(</span><span class="n">cache2</span><span class="p">,</span> <span class="n">db2</span><span class="p">)</span>

<span class="c1"># Benchmark writes
</span><span class="kn">import</span> <span class="n">time</span>

<span class="c1"># Write-through
</span><span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
    <span class="n">write_through</span><span class="p">.</span><span class="nf">put</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">key_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">value_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
<span class="n">wt_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>

<span class="c1"># Write-back
</span><span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
    <span class="n">write_back</span><span class="p">.</span><span class="nf">put</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">key_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">value_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
<span class="n">write_back</span><span class="p">.</span><span class="nf">flush</span><span class="p">()</span>  <span class="c1"># Final flush
</span><span class="n">wb_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>

<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Write-through: </span><span class="si">{</span><span class="n">wt_time</span><span class="si">:</span><span class="p">.</span><span class="mi">3</span><span class="n">f</span><span class="si">}</span><span class="s">s, DB writes: </span><span class="si">{</span><span class="n">db1</span><span class="p">.</span><span class="n">write_count</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Write-back:    </span><span class="si">{</span><span class="n">wb_time</span><span class="si">:</span><span class="p">.</span><span class="mi">3</span><span class="n">f</span><span class="si">}</span><span class="s">s, DB writes: </span><span class="si">{</span><span class="n">db2</span><span class="p">.</span><span class="n">write_count</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="cache-aside-pattern">Cache Aside Pattern</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">CacheAsidePattern</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Cache-aside (lazy loading): Application manages cache
    
    Most common pattern for ML systems
    
    Flow:
    1. Check cache
    2. If miss, query database
    3. Store in cache
    4. Return result
    </span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cache</span><span class="p">,</span> <span class="n">database</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cache</span> <span class="o">=</span> <span class="n">cache</span>
        <span class="n">self</span><span class="p">.</span><span class="n">database</span> <span class="o">=</span> <span class="n">database</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">stats</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">reads</span><span class="sh">'</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">cache_hits</span><span class="sh">'</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">cache_misses</span><span class="sh">'</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">writes</span><span class="sh">'</span><span class="p">:</span> <span class="mi">0</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Get with cache-aside pattern
        
        Application is responsible for loading cache
        </span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="n">stats</span><span class="p">[</span><span class="sh">'</span><span class="s">reads</span><span class="sh">'</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="c1"># Try cache first
</span>        <span class="n">value</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">stats</span><span class="p">[</span><span class="sh">'</span><span class="s">cache_hits</span><span class="sh">'</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="n">value</span>
        
        <span class="c1"># Cache miss: load from database
</span>        <span class="n">self</span><span class="p">.</span><span class="n">stats</span><span class="p">[</span><span class="sh">'</span><span class="s">cache_misses</span><span class="sh">'</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">database</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c1"># Populate cache for next time
</span>            <span class="n">self</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="nf">put</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">value</span>
    
    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Write to database, invalidate cache
        
        Simple approach: Just write to DB and remove from cache
        Next read will repopulate
        </span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="n">stats</span><span class="p">[</span><span class="sh">'</span><span class="s">writes</span><span class="sh">'</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="c1"># Write to database
</span>        <span class="n">self</span><span class="p">.</span><span class="n">database</span><span class="p">.</span><span class="nf">put</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        
        <span class="c1"># Invalidate cache entry
</span>        <span class="c1"># (Could also update cache here - depends on use case)
</span>        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="n">cache</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">self</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">get_stats</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Get cache statistics</span><span class="sh">"""</span>
        <span class="n">hit_rate</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">self</span><span class="p">.</span><span class="n">stats</span><span class="p">[</span><span class="sh">'</span><span class="s">cache_hits</span><span class="sh">'</span><span class="p">]</span> <span class="o">/</span> <span class="n">self</span><span class="p">.</span><span class="n">stats</span><span class="p">[</span><span class="sh">'</span><span class="s">reads</span><span class="sh">'</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">stats</span><span class="p">[</span><span class="sh">'</span><span class="s">reads</span><span class="sh">'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="o">**</span><span class="n">self</span><span class="p">.</span><span class="n">stats</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">hit_rate</span><span class="sh">'</span><span class="p">:</span> <span class="n">hit_rate</span>
        <span class="p">}</span>

<span class="c1"># Usage for ML predictions
</span><span class="k">class</span> <span class="nc">MLPredictionService</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    ML prediction service with cache-aside pattern
    </span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">cache_capacity</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cache</span> <span class="o">=</span> <span class="nc">LRUCache</span><span class="p">(</span><span class="n">capacity</span><span class="o">=</span><span class="n">cache_capacity</span><span class="p">)</span>
        
        <span class="c1"># Fake database for persisted predictions
</span>        <span class="n">self</span><span class="p">.</span><span class="n">prediction_db</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">pattern</span> <span class="o">=</span> <span class="nc">CacheAsidePattern</span><span class="p">(</span>
            <span class="n">self</span><span class="p">.</span><span class="n">cache</span><span class="p">,</span>
            <span class="n">self</span><span class="p">.</span><span class="n">prediction_db</span>
        <span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">features</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Predict with caching
        
        Args:
            features: Feature vector (tuple for hashability)
        
        Returns:
            Prediction
        </span><span class="sh">"""</span>
        <span class="c1"># Create cache key from features
</span>        <span class="n">cache_key</span> <span class="o">=</span> <span class="nf">hash</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
        
        <span class="c1"># Try cache-aside pattern
</span>        <span class="n">cached_prediction</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">pattern</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cached_prediction</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cached_prediction</span>
        
        <span class="c1"># Compute prediction (expensive)
</span>        <span class="n">prediction</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">predict</span><span class="p">([</span><span class="n">features</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="c1"># Store in database and cache
</span>        <span class="n">self</span><span class="p">.</span><span class="n">pattern</span><span class="p">.</span><span class="nf">put</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="n">prediction</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">prediction</span>
    
    <span class="k">def</span> <span class="nf">get_cache_stats</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Get caching statistics</span><span class="sh">"""</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">pattern</span><span class="p">.</span><span class="nf">get_stats</span><span class="p">()</span>

<span class="c1"># Example usage
</span><span class="kn">from</span> <span class="n">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestClassifier</span>
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>

<span class="c1"># Train simple model
</span><span class="n">X_train</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">randn</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">y_train</span> <span class="o">=</span> <span class="p">(</span><span class="n">X_train</span><span class="p">.</span><span class="nf">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">).</span><span class="nf">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="nc">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">model</span><span class="p">.</span><span class="nf">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

<span class="c1"># Create prediction service
</span><span class="n">service</span> <span class="o">=</span> <span class="nc">MLPredictionService</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">cache_capacity</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

<span class="c1"># Make predictions (some repeated)
</span><span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">):</span>
    <span class="c1"># Generate features (with some repetition)
</span>    <span class="n">features</span> <span class="o">=</span> <span class="nf">tuple</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">5</span><span class="p">))</span>
    <span class="n">prediction</span> <span class="o">=</span> <span class="n">service</span><span class="p">.</span><span class="nf">predict</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>

<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Cache statistics:</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">service</span><span class="p">.</span><span class="nf">get_cache_stats</span><span class="p">())</span>
</code></pre></div></div>

<hr />

<h2 id="cache-stampede-prevention">Cache Stampede Prevention</h2>

<h3 id="problem-thundering-herd">Problem: Thundering Herd</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">CacheStampedeProtection</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Prevent cache stampede (thundering herd)
    
    Problem:
    - Cache entry expires
    - Many requests try to regenerate simultaneously
    - Database/model gets overwhelmed
    
    Solution:
    - Use locking to ensure only one request regenerates
    - Others wait for that request to complete
    </span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cache</span><span class="p">,</span> <span class="n">compute_fn</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cache</span> <span class="o">=</span> <span class="n">cache</span>
        <span class="n">self</span><span class="p">.</span><span class="n">compute_fn</span> <span class="o">=</span> <span class="n">compute_fn</span>
        
        <span class="c1"># Lock for each key
</span>        <span class="n">self</span><span class="p">.</span><span class="n">locks</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">master_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Get with stampede protection
        
        Uses double-check locking pattern
        </span><span class="sh">"""</span>
        <span class="c1"># First check: Try cache (no lock)
</span>        <span class="n">value</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">value</span>
        
        <span class="c1"># Get or create lock for this key
</span>        <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">master_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">locks</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="n">locks</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>
            <span class="n">key_lock</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">locks</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        
        <span class="c1"># Acquire key-specific lock
</span>        <span class="k">with</span> <span class="n">key_lock</span><span class="p">:</span>
            <span class="c1"># Second check: Try cache again (another thread might have filled it)
</span>            <span class="n">value</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">value</span>
            
            <span class="c1"># Compute value (only one thread does this)
</span>            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Computing value for </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s"> (thread: </span><span class="si">{</span><span class="n">threading</span><span class="p">.</span><span class="nf">current_thread</span><span class="p">().</span><span class="n">name</span><span class="si">}</span><span class="s">)</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">compute_fn</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            
            <span class="c1"># Store in cache
</span>            <span class="n">self</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="nf">put</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="n">value</span>

<span class="c1"># Demo: Simulate stampede
</span><span class="kn">import</span> <span class="n">threading</span>
<span class="kn">import</span> <span class="n">time</span>

<span class="k">def</span> <span class="nf">expensive_computation</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">Simulate expensive computation</span><span class="sh">"""</span>
    <span class="n">time</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>  <span class="c1"># 100ms
</span>    <span class="k">return</span> <span class="sa">f</span><span class="sh">"</span><span class="s">computed_value_for_</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="sh">"</span>

<span class="n">cache</span> <span class="o">=</span> <span class="nc">LRUCache</span><span class="p">(</span><span class="n">capacity</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">protector</span> <span class="o">=</span> <span class="nc">CacheStampedeProtection</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="n">expensive_computation</span><span class="p">)</span>

<span class="c1"># Simulate stampede: 10 threads requesting same key
</span><span class="k">def</span> <span class="nf">make_request</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">protector</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="n">duration</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
    <span class="n">results</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">duration</span>

<span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">10</span>
<span class="n">threads</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Clear cache to force computation
</span><span class="n">cache</span> <span class="o">=</span> <span class="nc">LRUCache</span><span class="p">(</span><span class="n">capacity</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">protector</span><span class="p">.</span><span class="n">cache</span> <span class="o">=</span> <span class="n">cache</span>

<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Simulating cache stampede for key </span><span class="sh">'</span><span class="s">popular_item</span><span class="sh">'</span><span class="s">...</span><span class="sh">"</span><span class="p">)</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Thread</span><span class="p">(</span>
        <span class="n">target</span><span class="o">=</span><span class="n">make_request</span><span class="p">,</span>
        <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="sh">'</span><span class="s">popular_item</span><span class="sh">'</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span>
        <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="sh">"</span><span class="s">Thread-</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="sh">"</span>
    <span class="p">)</span>
    <span class="n">threads</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">t</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>

<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">:</span>
    <span class="n">t</span><span class="p">.</span><span class="nf">join</span><span class="p">()</span>

<span class="n">total_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="s">Total time: </span><span class="si">{</span><span class="n">total_time</span><span class="si">:</span><span class="p">.</span><span class="mi">3</span><span class="n">f</span><span class="si">}</span><span class="s">s</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Average request time: </span><span class="si">{</span><span class="nf">sum</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="o">/</span><span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="si">:</span><span class="p">.</span><span class="mi">3</span><span class="n">f</span><span class="si">}</span><span class="s">s</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Max request time: </span><span class="si">{</span><span class="nf">max</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="si">:</span><span class="p">.</span><span class="mi">3</span><span class="n">f</span><span class="si">}</span><span class="s">s</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Min request time: </span><span class="si">{</span><span class="nf">min</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="si">:</span><span class="p">.</span><span class="mi">3</span><span class="n">f</span><span class="si">}</span><span class="s">s</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">With protection, only one thread computed (others waited)</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="probabilistic-early-expiration">Probabilistic Early Expiration</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ProbabilisticCache</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Probabilistic early expiration to prevent stampede
    
    Idea: Refresh cache before expiration with increasing probability
    This spreads out refresh operations
    </span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cache</span><span class="p">,</span> <span class="n">compute_fn</span><span class="p">,</span> <span class="n">ttl</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Args:
            ttl: Time to live in seconds
            beta: Controls early expiration probability
        </span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cache</span> <span class="o">=</span> <span class="n">cache</span>
        <span class="n">self</span><span class="p">.</span><span class="n">compute_fn</span> <span class="o">=</span> <span class="n">compute_fn</span>
        <span class="n">self</span><span class="p">.</span><span class="n">ttl</span> <span class="o">=</span> <span class="n">ttl</span>
        <span class="n">self</span><span class="p">.</span><span class="n">beta</span> <span class="o">=</span> <span class="n">beta</span>
        
        <span class="c1"># Track insertion times
</span>        <span class="n">self</span><span class="p">.</span><span class="n">insertion_times</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Get with probabilistic early expiration
        
        Formula: Should refresh if:
        current_time - stored_time * beta * log(random) &gt;= ttl
        </span><span class="sh">"""</span>
        <span class="c1"># Check cache
</span>        <span class="n">value</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">insertion_times</span><span class="p">:</span>
            <span class="c1"># Calculate age
</span>            <span class="n">age</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">insertion_times</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            
            <span class="c1"># Probabilistic early expiration
</span>            <span class="kn">import</span> <span class="n">random</span>
            <span class="kn">import</span> <span class="n">math</span>
            
            <span class="c1"># XFetch algorithm
</span>            <span class="n">delta</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">ttl</span> <span class="o">-</span> <span class="n">age</span>
            <span class="k">if</span> <span class="n">delta</span> <span class="o">*</span> <span class="n">self</span><span class="p">.</span><span class="n">beta</span> <span class="o">*</span> <span class="n">math</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="n">random</span><span class="p">.</span><span class="nf">random</span><span class="p">())</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Refresh early
</span>                <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Early refresh for </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s"> (age: </span><span class="si">{</span><span class="n">age</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s">s)</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_refresh</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="n">value</span>
        
        <span class="c1"># Cache miss or expired
</span>        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="nf">_refresh</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_refresh</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Refresh cache entry</span><span class="sh">"""</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">compute_fn</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="nf">put</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">insertion_times</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">value</span>

<span class="c1"># Demo
</span><span class="k">def</span> <span class="nf">compute_value</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
    <span class="n">time</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
    <span class="k">return</span> <span class="sa">f</span><span class="sh">"</span><span class="s">value_</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span>

<span class="n">pcache</span> <span class="o">=</span> <span class="nc">ProbabilisticCache</span><span class="p">(</span>
    <span class="nc">LRUCache</span><span class="p">(</span><span class="n">capacity</span><span class="o">=</span><span class="mi">100</span><span class="p">),</span>
    <span class="n">compute_value</span><span class="p">,</span>
    <span class="n">ttl</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>  <span class="c1"># 5 second TTL
</span>    <span class="n">beta</span><span class="o">=</span><span class="mf">1.0</span>
<span class="p">)</span>

<span class="c1"># Access same key multiple times
</span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">20</span><span class="p">):</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">pcache</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">test_key</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">time</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mf">0.3</span><span class="p">)</span>  <span class="c1"># 300ms between requests
</span></code></pre></div></div>

<hr />

<h2 id="distributed-cache-challenges">Distributed Cache Challenges</h2>

<h3 id="cache-consistency">Cache Consistency</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">DistributedCacheCoordinator</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Coordinate cache across multiple instances
    
    Challenges:
    1. Keeping caches in sync
    2. Handling partial failures
    3. Eventual consistency
    </span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">redis_client</span><span class="p">,</span> <span class="n">instance_id</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">redis</span> <span class="o">=</span> <span class="n">redis_client</span>
        <span class="n">self</span><span class="p">.</span><span class="n">instance_id</span> <span class="o">=</span> <span class="n">instance_id</span>
        
        <span class="c1"># Local L1 cache
</span>        <span class="n">self</span><span class="p">.</span><span class="n">local_cache</span> <span class="o">=</span> <span class="nc">LRUCache</span><span class="p">(</span><span class="n">capacity</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
        
        <span class="c1"># Subscribe to invalidation messages
</span>        <span class="n">self</span><span class="p">.</span><span class="n">pubsub</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">redis</span><span class="p">.</span><span class="nf">pubsub</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">pubsub</span><span class="p">.</span><span class="nf">subscribe</span><span class="p">(</span><span class="sh">'</span><span class="s">cache:invalidate</span><span class="sh">'</span><span class="p">)</span>
        
        <span class="c1"># Start listener thread
</span>        <span class="n">self</span><span class="p">.</span><span class="n">listener_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Thread</span><span class="p">(</span>
            <span class="n">target</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">_listen_for_invalidations</span><span class="p">,</span>
            <span class="n">daemon</span><span class="o">=</span><span class="bp">True</span>
        <span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">listener_thread</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Get from multi-level cache
        
        L1 (local) -&gt; L2 (Redis) -&gt; Compute
        </span><span class="sh">"""</span>
        <span class="c1"># Try local cache
</span>        <span class="n">value</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">local_cache</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">value</span>
        
        <span class="c1"># Try Redis
</span>        <span class="n">value</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">redis</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">pickle</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="c1"># Populate local cache
</span>            <span class="n">self</span><span class="p">.</span><span class="n">local_cache</span><span class="p">.</span><span class="nf">put</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">value</span>
        
        <span class="k">return</span> <span class="bp">None</span>
    
    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">ttl</span><span class="o">=</span><span class="mi">3600</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Put in both levels and notify others
        </span><span class="sh">"""</span>
        <span class="c1"># Store in local cache
</span>        <span class="n">self</span><span class="p">.</span><span class="n">local_cache</span><span class="p">.</span><span class="nf">put</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        
        <span class="c1"># Store in Redis
</span>        <span class="n">self</span><span class="p">.</span><span class="n">redis</span><span class="p">.</span><span class="nf">setex</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">ttl</span><span class="p">,</span> <span class="n">pickle</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
        
        <span class="c1"># Notify other instances to invalidate their L1
</span>        <span class="n">self</span><span class="p">.</span><span class="n">redis</span><span class="p">.</span><span class="nf">publish</span><span class="p">(</span>
            <span class="sh">'</span><span class="s">cache:invalidate</span><span class="sh">'</span><span class="p">,</span>
            <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span>
                <span class="sh">'</span><span class="s">key</span><span class="sh">'</span><span class="p">:</span> <span class="n">key</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">source_instance</span><span class="sh">'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">instance_id</span>
            <span class="p">})</span>
        <span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_listen_for_invalidations</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Listen for invalidation messages</span><span class="sh">"""</span>
        <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">pubsub</span><span class="p">.</span><span class="nf">listen</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">message</span><span class="p">[</span><span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="sh">'</span><span class="s">data</span><span class="sh">'</span><span class="p">])</span>
                
                <span class="c1"># Don't invalidate if we sent the message
</span>                <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="sh">'</span><span class="s">source_instance</span><span class="sh">'</span><span class="p">]</span> <span class="o">!=</span> <span class="n">self</span><span class="p">.</span><span class="n">instance_id</span><span class="p">:</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sh">'</span><span class="s">key</span><span class="sh">'</span><span class="p">]</span>
                    
                    <span class="c1"># Invalidate local cache
</span>                    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">local_cache</span><span class="p">.</span><span class="n">cache</span><span class="p">:</span>
                        <span class="k">del</span> <span class="n">self</span><span class="p">.</span><span class="n">local_cache</span><span class="p">.</span><span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Invalidated </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s"> from local cache</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># Usage across multiple instances
# Instance 1
</span><span class="n">coordinator1</span> <span class="o">=</span> <span class="nc">DistributedCacheCoordinator</span><span class="p">(</span><span class="n">redis_client</span><span class="p">,</span> <span class="n">instance_id</span><span class="o">=</span><span class="sh">'</span><span class="s">instance1</span><span class="sh">'</span><span class="p">)</span>

<span class="c1"># Instance 2
</span><span class="n">coordinator2</span> <span class="o">=</span> <span class="nc">DistributedCacheCoordinator</span><span class="p">(</span><span class="n">redis_client</span><span class="p">,</span> <span class="n">instance_id</span><span class="o">=</span><span class="sh">'</span><span class="s">instance2</span><span class="sh">'</span><span class="p">)</span>

<span class="c1"># Instance 1 writes
</span><span class="n">coordinator1</span><span class="p">.</span><span class="nf">put</span><span class="p">(</span><span class="sh">'</span><span class="s">shared_key</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">value_from_instance1</span><span class="sh">'</span><span class="p">)</span>

<span class="c1"># Instance 2 reads (will get from Redis)
</span><span class="n">value</span> <span class="o">=</span> <span class="n">coordinator2</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">shared_key</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div>

<hr />

<h2 id="key-takeaways">Key Takeaways</h2>

<p>✅ <strong>Multiple eviction policies</strong> - LRU, LFU, TTL for different use cases<br />
✅ <strong>Distributed caching</strong> - Redis for shared cache across services<br />
✅ <strong>Multi-level caching</strong> - L1 (local) + L2 (distributed) for optimal performance<br />
✅ <strong>Cache warming</strong> - Proactive population of hot items<br />
✅ <strong>Invalidation strategies</strong> - Push-based and pull-based<br />
✅ <strong>Linked list connection</strong> - Understanding pointer manipulation helps with cache implementation<br />
✅ <strong>Monitor cache metrics</strong> - Hit rate, latency, memory usage</p>

<hr />

<p><strong>Originally published at:</strong> <a href="https://www.arunbaby.com/ml-system-design/0010-caching-strategies/">arunbaby.com/ml-system-design/0010-caching-strategies</a></p>

<p><em>If you found this helpful, consider sharing it with others who might benefit.</em></p>


        
      </section>

      <footer class="page__meta">
        
        
  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      <a href="/tags/#caching" class="page__taxonomy-item p-category" rel="tag">caching</a><span class="sep">, </span>
    
      <a href="/tags/#distributed-systems" class="page__taxonomy-item p-category" rel="tag">distributed-systems</a><span class="sep">, </span>
    
      <a href="/tags/#memcached" class="page__taxonomy-item p-category" rel="tag">memcached</a><span class="sep">, </span>
    
      <a href="/tags/#performance" class="page__taxonomy-item p-category" rel="tag">performance</a><span class="sep">, </span>
    
      <a href="/tags/#redis" class="page__taxonomy-item p-category" rel="tag">redis</a>
    
    </span>
  </p>




  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      <a href="/categories/#ml-system-design" class="page__taxonomy-item p-category" rel="tag">ml-system-design</a>
    
    </span>
  </p>


        
      </footer>

      <div class="page__related page__related--full">
  <h2 class="page__related-title">Related across topics</h2>
  <style>
    /* Make section span full content width and use 2 equal columns */
    .page__related--full { float: inline-start; width: 100%; padding: 0; }
    .cross-related-grid { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 2rem; }
    @media (max-width: 768px) { .cross-related-grid { grid-template-columns: 1fr; } }
    /* Ensure archive cards stretch nicely in the grid */
    .cross-related-grid .list__item, .cross-related-grid .grid__item { width: auto; float: none; margin: 0; }
  </style>
  <div class="cross-related-grid">
    



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/dsa/0010-reverse-linked-list/" rel="permalink">Reverse Linked List
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          27 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Master linked list manipulation through reversal - a fundamental pattern for understanding pointer logic and in-place algorithms.
</p>
  </article>
</div>




<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/speech-tech/0010-voice-enhancement/" rel="permalink">Voice Enhancement &amp; Noise Reduction
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          17 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Build systems that enhance voice quality by removing noise, improving intelligibility, and optimizing audio for speech applications.
</p>
  </article>
</div>

  </div>
</div>

      <section class="page__share">
  <h4 class="page__share-title">Share on</h4>

  <a href="https://twitter.com/intent/tweet?via=arunbaby0&text=Caching+Strategies+for+ML+Systems%20https%3A%2F%2Fwww.arunbaby.com%2Fml-system-design%2F0010-caching-strategies%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fwww.arunbaby.com%2Fml-system-design%2F0010-caching-strategies%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://www.arunbaby.com/ml-system-design/0010-caching-strategies/" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/ml-system-design/0009-online-learning-systems/" class="pagination--pager" title="Online Learning Systems">Previous</a>
    
    
      <a href="/ml-system-design/0011-content-delivery-network/" class="pagination--pager" title="Content Delivery Networks (CDN)">Next</a>
    
  </nav>


    </div>

    
  </article>

  
  
</div>

      
    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';" role="search">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    
      
        
          <li><a href="https://twitter.com/arunbaby0" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
        
      
        
          <li><a href="https://github.com/arunbaby0" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
        
          <li><a href="https://www.linkedin.com/in/arunbaby0/" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i> LinkedIn</a></li>
        
      
        
          <li><a href="https://scholar.google.co.in/citations?user=6fSYWhkAAAAJ" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-graduation-cap" aria-hidden="true"></i> Google Scholar</a></li>
        
      
    

    
      <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 1990 - 2143 <a href="https://www.arunbaby.com">Arun Baby</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>




  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-0JRJPEC9SS"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-0JRJPEC9SS', { 'anonymize_ip': false});
</script>








  </body>
</html>
