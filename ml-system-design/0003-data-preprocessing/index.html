<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.26.2 by Michael Rose
  Copyright 2013-2024 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->

<html lang="en-US" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Data Preprocessing Pipeline Design - Arun Baby</title>
<meta name="description" content="How to build production-grade pipelines that clean, transform, and validate billions of data points before training.">


  <meta name="author" content="Arun Baby">
  
  <meta property="article:author" content="Arun Baby">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Arun Baby">
<meta property="og:title" content="Data Preprocessing Pipeline Design">
<meta property="og:url" content="https://www.arunbaby.com/ml-system-design/0003-data-preprocessing/">


  <meta property="og:description" content="How to build production-grade pipelines that clean, transform, and validate billions of data points before training.">



  <meta property="og:image" content="https://www.arunbaby.com/assets/images/profile-photo.png">



  <meta name="twitter:site" content="@arunbaby0">
  <meta name="twitter:title" content="Data Preprocessing Pipeline Design">
  <meta name="twitter:description" content="How to build production-grade pipelines that clean, transform, and validate billions of data points before training.">
  <meta name="twitter:url" content="https://www.arunbaby.com/ml-system-design/0003-data-preprocessing/">

  
    <meta name="twitter:card" content="summary">
    
      <meta name="twitter:image" content="https://www.arunbaby.com/assets/images/profile-photo.png">
    
  

  



  <meta property="article:published_time" content="2025-10-14T11:35:35+05:30">





  

  


<link rel="canonical" href="https://www.arunbaby.com/ml-system-design/0003-data-preprocessing/">












<!-- end _includes/seo.html -->



  <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Arun Baby Feed">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
  
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css"></noscript>



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single" dir="ltr">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
           
          <span class="site-subtitle">Arun Baby</span>
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a
                href="/about/"
                
                
              >About</a>
            </li><li class="masthead__menu-item">
              <a
                href="/dsa/"
                
                
              >DSA</a>
            </li><li class="masthead__menu-item">
              <a
                href="/ml-system-design/"
                
                
              >ML Systems</a>
            </li><li class="masthead__menu-item">
              <a
                href="/speech-tech/"
                
                
              >Speech Tech</a>
            </li><li class="masthead__menu-item">
              <a
                href="/publications/"
                
                
              >Publications</a>
            </li><li class="masthead__menu-item">
              <a
                href="/statuses/"
                
                
              >Statuses</a>
            </li><li class="masthead__menu-item">
              <a
                href="/contact/"
                
                
              >Contact</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <i class="fas fa-search"></i>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      





<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person" class="h-card">

  
    <div class="author__avatar">
      <a href="https://www.arunbaby.com/">
        <img src="/assets/images/profile-photo.png" alt="Arun Baby" itemprop="image" class="u-photo">
      </a>
    </div>
  

  <div class="author__content">
    <h3 class="author__name p-name" itemprop="name">
      <a class="u-url" rel="me" href="https://www.arunbaby.com/" itemprop="url">Arun Baby</a>
    </h3>
    
      <div class="author__bio p-note" itemprop="description">
        <p>Becoming <strong>Unlabelable</strong></p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name" class="p-locality">India</span>
        </li>
      

      
        
          
            <li><a href="https://twitter.com/arunbaby0" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i><span class="label">Twitter</span></a></li>
          
        
          
            <li><a href="https://github.com/arunbaby0" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
          
        
          
            <li><a href="https://www.linkedin.com/in/arunbaby0/" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span class="label">LinkedIn</span></a></li>
          
        
          
            <li><a href="https://scholar.google.co.in/citations?user=6fSYWhkAAAAJ" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fas fa-fw fa-graduation-cap" aria-hidden="true"></i><span class="label">Google Scholar</span></a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer me">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Data Preprocessing Pipeline Design">
    <meta itemprop="description" content="How to build production-grade pipelines that clean, transform, and validate billions of data points before training.">
    <meta itemprop="datePublished" content="2025-10-14T11:35:35+05:30">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">
            <a href="https://www.arunbaby.com/ml-system-design/0003-data-preprocessing/" itemprop="url">Data Preprocessing Pipeline Design
</a>
          </h1>
          

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          28 minute read
        
      </span>
    
  </p>


        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right sticky">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> On this page</h4></header>
              <ul class="toc__menu"><li><a href="#introduction">Introduction</a></li><li><a href="#problem-definition">Problem Definition</a><ul><li><a href="#functional-requirements">Functional Requirements</a></li><li><a href="#non-functional-requirements">Non-Functional Requirements</a></li></ul></li><li><a href="#high-level-architecture">High-Level Architecture</a></li><li><a href="#component-1-data-validation">Component 1: Data Validation</a><ul><li><a href="#schema-validation">Schema Validation</a></li><li><a href="#statistical-validation">Statistical Validation</a></li></ul></li><li><a href="#component-2-data-cleaning">Component 2: Data Cleaning</a><ul><li><a href="#missing-value-handling">Missing Value Handling</a></li><li><a href="#outlier-detection--handling">Outlier Detection &amp; Handling</a></li><li><a href="#deduplication">Deduplication</a></li></ul></li><li><a href="#component-3-feature-engineering">Component 3: Feature Engineering</a><ul><li><a href="#numerical-transformations">Numerical Transformations</a></li><li><a href="#categorical-encoding">Categorical Encoding</a></li><li><a href="#temporal-features">Temporal Features</a></li></ul></li><li><a href="#component-4-pipeline-orchestration">Component 4: Pipeline Orchestration</a><ul><li><a href="#apache-beam-pipeline">Apache Beam Pipeline</a></li></ul></li><li><a href="#preventing-trainingserving-skew">Preventing Training/Serving Skew</a><ul><li><a href="#solution-1-unified-preprocessing-library">Solution 1: Unified Preprocessing Library</a></li><li><a href="#solution-2-feature-store">Solution 2: Feature Store</a></li></ul></li><li><a href="#monitoring--data-quality">Monitoring &amp; Data Quality</a></li><li><a href="#real-world-examples">Real-World Examples</a><ul><li><a href="#netflix-data-preprocessing-for-recommendations">Netflix: Data Preprocessing for Recommendations</a></li><li><a href="#uber-preprocessing-for-etas">Uber: Preprocessing for ETAs</a></li><li><a href="#google-search-ranking-data-pipeline">Google: Search Ranking Data Pipeline</a></li></ul></li><li><a href="#distributed-preprocessing-with-spark">Distributed Preprocessing with Spark</a><ul><li><a href="#spark-preprocessing-pipeline">Spark Preprocessing Pipeline</a></li></ul></li><li><a href="#advanced-feature-engineering-patterns">Advanced Feature Engineering Patterns</a><ul><li><a href="#1-time-series-features">1. Time-Series Features</a></li><li><a href="#2-interaction-features">2. Interaction Features</a></li><li><a href="#3-embedding-features">3. Embedding Features</a></li></ul></li><li><a href="#handling-data-drift">Handling Data Drift</a><ul><li><a href="#drift-detection">Drift Detection</a></li></ul></li><li><a href="#production-best-practices">Production Best Practices</a><ul><li><a href="#1-idempotency">1. Idempotency</a></li><li><a href="#2-data-versioning">2. Data Versioning</a></li><li><a href="#3-lineage-tracking">3. Lineage Tracking</a></li></ul></li><li><a href="#common-preprocessing-challenges--solutions">Common Preprocessing Challenges &amp; Solutions</a><ul><li><a href="#challenge-1-imbalanced-classes">Challenge 1: Imbalanced Classes</a></li><li><a href="#challenge-2-high-cardinality-categoricals">Challenge 2: High-Cardinality Categoricals</a></li><li><a href="#challenge-3-streaming-data-preprocessing">Challenge 3: Streaming Data Preprocessing</a></li><li><a href="#challenge-4-privacy--compliance-gdpr-ccpa">Challenge 4: Privacy &amp; Compliance (GDPR, CCPA)</a></li></ul></li><li><a href="#performance-optimization">Performance Optimization</a><ul><li><a href="#1-parallelize-transformations">1. Parallelize Transformations</a></li><li><a href="#2-use-efficient-data-formats">2. Use Efficient Data Formats</a></li><li><a href="#3-cache-intermediate-results">3. Cache Intermediate Results</a></li></ul></li><li><a href="#key-takeaways">Key Takeaways</a></li></ul>
            </nav>
          </aside>
        
        <p><strong>How to build production-grade pipelines that clean, transform, and validate billions of data points before training.</strong></p>

<h2 id="introduction">Introduction</h2>

<p>Data preprocessing is the <strong>most time-consuming yet critical</strong> part of ML systems. Industry surveys show data scientists spend <strong>60-80% of their time</strong> on data preparation, cleaning, transforming, and validating data before training.</p>

<p><strong>Why it matters:</strong></p>
<ul>
  <li><strong>Garbage in, garbage out:</strong> Poor data quality → poor models</li>
  <li><strong>Scale:</strong> Process terabytes/petabytes efficiently</li>
  <li><strong>Repeatability:</strong> Same transformations in training &amp; serving</li>
  <li><strong>Monitoring:</strong> Detect data drift and quality issues</li>
</ul>

<p>This post covers end-to-end preprocessing pipeline design at scale.</p>

<p><strong>What you’ll learn:</strong></p>
<ul>
  <li>Architecture for scalable preprocessing</li>
  <li>Data cleaning and validation strategies</li>
  <li>Feature engineering pipelines</li>
  <li>Training/serving skew prevention</li>
  <li>Monitoring and data quality</li>
  <li>Real-world examples from top companies</li>
</ul>

<hr />

<h2 id="problem-definition">Problem Definition</h2>

<p>Design a scalable data preprocessing pipeline for a machine learning system.</p>

<h3 id="functional-requirements">Functional Requirements</h3>

<ol>
  <li><strong>Data Ingestion</strong>
    <ul>
      <li>Ingest from multiple sources (databases, logs, streams)</li>
      <li>Support batch and streaming data</li>
      <li>Handle structured and unstructured data</li>
    </ul>
  </li>
  <li><strong>Data Cleaning</strong>
    <ul>
      <li>Handle missing values</li>
      <li>Remove duplicates</li>
      <li>Fix inconsistencies</li>
      <li>Outlier detection and handling</li>
    </ul>
  </li>
  <li><strong>Data Transformation</strong>
    <ul>
      <li>Normalization/standardization</li>
      <li>Encoding categorical variables</li>
      <li>Feature extraction</li>
      <li>Feature selection</li>
    </ul>
  </li>
  <li><strong>Data Validation</strong>
    <ul>
      <li>Schema validation</li>
      <li>Statistical validation</li>
      <li>Anomaly detection</li>
      <li>Data drift detection</li>
    </ul>
  </li>
  <li><strong>Feature Engineering</strong>
    <ul>
      <li>Create derived features</li>
      <li>Aggregations (time-based, user-based)</li>
      <li>Interaction features</li>
      <li>Embedding generation</li>
    </ul>
  </li>
</ol>

<h3 id="non-functional-requirements">Non-Functional Requirements</h3>

<ol>
  <li><strong>Scale</strong>
    <ul>
      <li>Process 1TB+ data/day</li>
      <li>Handle billions of records</li>
      <li>Support horizontal scaling</li>
    </ul>
  </li>
  <li><strong>Latency</strong>
    <ul>
      <li>Batch: Process daily data in &lt; 6 hours</li>
      <li>Streaming: &lt; 1 second latency for real-time features</li>
    </ul>
  </li>
  <li><strong>Reliability</strong>
    <ul>
      <li>99.9% pipeline success rate</li>
      <li>Automatic retries on failure</li>
      <li>Data lineage tracking</li>
    </ul>
  </li>
  <li><strong>Consistency</strong>
    <ul>
      <li>Same transformations in training and serving</li>
      <li>Versioned transformation logic</li>
      <li>Reproducible results</li>
    </ul>
  </li>
</ol>

<hr />

<h2 id="high-level-architecture">High-Level Architecture</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌─────────────────────────────────────────────────────────────┐
│                    Data Sources                              │
├─────────────────────────────────────────────────────────────┤
│  Databases  │  Event Logs  │  File Storage  │  APIs         │
└──────┬──────┴──────┬──────┴───────┬─────────┴──────┬────────┘
       │             │              │                │
       └─────────────┼──────────────┼────────────────┘
                     ↓              ↓
              ┌─────────────────────────────┐
              │   Data Ingestion Layer      │
              │  (Kafka, Pub/Sub, Kinesis)  │
              └──────────────┬──────────────┘
                             ↓
              ┌─────────────────────────────┐
              │   Raw Data Storage          │
              │   (Data Lake: S3/GCS)       │
              └──────────────┬──────────────┘
                             ↓
              ┌─────────────────────────────┐
              │  Preprocessing Pipeline     │
              │                             │
              │  ┌──────────────────────┐   │
              │  │ 1. Data Validation   │   │
              │  └──────────────────────┘   │
              │  ┌──────────────────────┐   │
              │  │ 2. Data Cleaning     │   │
              │  └──────────────────────┘   │
              │  ┌──────────────────────┐   │
              │  │ 3. Feature Extraction│   │
              │  └──────────────────────┘   │
              │  ┌──────────────────────┐   │
              │  │ 4. Transformation    │   │
              │  └──────────────────────┘   │
              │  ┌──────────────────────┐   │
              │  │ 5. Quality Checks    │   │
              │  └──────────────────────┘   │
              │                             │
              │  (Spark/Beam/Airflow)       │
              └──────────────┬──────────────┘
                             ↓
              ┌─────────────────────────────┐
              │   Processed Data Storage    │
              │   (Feature Store/DW)        │
              └──────────────┬──────────────┘
                             ↓
              ┌─────────────────────────────┐
              │   Model Training            │
              │   &amp; Serving                 │
              └─────────────────────────────┘
</code></pre></div></div>

<hr />

<h2 id="component-1-data-validation">Component 1: Data Validation</h2>

<p>Validate data quality and schema before processing.</p>

<h3 id="schema-validation">Schema Validation</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="n">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">import</span> <span class="n">pandas</span> <span class="k">as</span> <span class="n">pd</span>

<span class="k">class</span> <span class="nc">DataType</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">INT</span> <span class="o">=</span> <span class="sh">"</span><span class="s">int</span><span class="sh">"</span>
    <span class="n">FLOAT</span> <span class="o">=</span> <span class="sh">"</span><span class="s">float</span><span class="sh">"</span>
    <span class="n">STRING</span> <span class="o">=</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span>
    <span class="n">TIMESTAMP</span> <span class="o">=</span> <span class="sh">"</span><span class="s">timestamp</span><span class="sh">"</span>
    <span class="n">BOOLEAN</span> <span class="o">=</span> <span class="sh">"</span><span class="s">boolean</span><span class="sh">"</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">FieldSchema</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">dtype</span><span class="p">:</span> <span class="n">DataType</span>
    <span class="n">nullable</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">min_value</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">max_value</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">allowed_values</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">class</span> <span class="nc">SchemaValidator</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Validate data against expected schema
    
    Use case: Ensure incoming data matches expectations
    </span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">schema</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">FieldSchema</span><span class="p">]):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">schema</span> <span class="o">=</span> <span class="p">{</span><span class="n">field</span><span class="p">.</span><span class="n">name</span><span class="p">:</span> <span class="n">field</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">schema</span><span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
        <span class="sh">"""</span><span class="s">
        Validate DataFrame against schema
        
        Returns:
            Dict of field_name → list of errors
        </span><span class="sh">"""</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="c1"># Check for missing columns
</span>        <span class="n">expected_cols</span> <span class="o">=</span> <span class="nf">set</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="nf">keys</span><span class="p">())</span>
        <span class="n">actual_cols</span> <span class="o">=</span> <span class="nf">set</span><span class="p">(</span><span class="n">df</span><span class="p">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="n">missing</span> <span class="o">=</span> <span class="n">expected_cols</span> <span class="o">-</span> <span class="n">actual_cols</span>
        <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
            <span class="n">errors</span><span class="p">[</span><span class="sh">'</span><span class="s">_schema</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="sh">"</span><span class="s">Missing columns: </span><span class="si">{</span><span class="n">missing</span><span class="si">}</span><span class="sh">"</span><span class="p">]</span>
        
        <span class="c1"># Validate each field
</span>        <span class="k">for</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">field_schema</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">field_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="p">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">continue</span>
            
            <span class="n">field_errors</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_validate_field</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">field_name</span><span class="p">],</span> <span class="n">field_schema</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">field_errors</span><span class="p">:</span>
                <span class="n">errors</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_errors</span>
        
        <span class="k">return</span> <span class="n">errors</span>
    
    <span class="k">def</span> <span class="nf">validate_record</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">record</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
        <span class="sh">"""</span><span class="s">
        Validate a single record (dict) against schema
        </span><span class="sh">"""</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">([</span><span class="n">record</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="nf">validate</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_validate_field</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">series</span><span class="p">:</span> <span class="n">pd</span><span class="p">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">schema</span><span class="p">:</span> <span class="n">FieldSchema</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">Validate a single field</span><span class="sh">"""</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># Check nulls
</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">schema</span><span class="p">.</span><span class="n">nullable</span> <span class="ow">and</span> <span class="n">series</span><span class="p">.</span><span class="nf">isnull</span><span class="p">().</span><span class="nf">any</span><span class="p">():</span>
            <span class="n">null_count</span> <span class="o">=</span> <span class="n">series</span><span class="p">.</span><span class="nf">isnull</span><span class="p">().</span><span class="nf">sum</span><span class="p">()</span>
            <span class="n">errors</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Found </span><span class="si">{</span><span class="n">null_count</span><span class="si">}</span><span class="s"> null values (not allowed)</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="c1"># Check data type
</span>        <span class="k">if</span> <span class="n">schema</span><span class="p">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">DataType</span><span class="p">.</span><span class="n">INT</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">types</span><span class="p">.</span><span class="nf">is_integer_dtype</span><span class="p">(</span><span class="n">series</span><span class="p">.</span><span class="nf">dropna</span><span class="p">()):</span>
                <span class="n">errors</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">Expected integer type</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">schema</span><span class="p">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">DataType</span><span class="p">.</span><span class="n">FLOAT</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">types</span><span class="p">.</span><span class="nf">is_numeric_dtype</span><span class="p">(</span><span class="n">series</span><span class="p">.</span><span class="nf">dropna</span><span class="p">()):</span>
                <span class="n">errors</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">Expected numeric type</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">schema</span><span class="p">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">DataType</span><span class="p">.</span><span class="n">STRING</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">types</span><span class="p">.</span><span class="nf">is_string_dtype</span><span class="p">(</span><span class="n">series</span><span class="p">.</span><span class="nf">dropna</span><span class="p">()):</span>
                <span class="n">errors</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">Expected string type</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">schema</span><span class="p">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">DataType</span><span class="p">.</span><span class="n">BOOLEAN</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">types</span><span class="p">.</span><span class="nf">is_bool_dtype</span><span class="p">(</span><span class="n">series</span><span class="p">.</span><span class="nf">dropna</span><span class="p">()):</span>
                <span class="n">errors</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">Expected boolean type</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">schema</span><span class="p">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">DataType</span><span class="p">.</span><span class="n">TIMESTAMP</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">types</span><span class="p">.</span><span class="nf">is_datetime64_any_dtype</span><span class="p">(</span><span class="n">series</span><span class="p">.</span><span class="nf">dropna</span><span class="p">()):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">pd</span><span class="p">.</span><span class="nf">to_datetime</span><span class="p">(</span><span class="n">series</span><span class="p">.</span><span class="nf">dropna</span><span class="p">())</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">errors</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">Expected timestamp/datetime type</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="c1"># Check value ranges
</span>        <span class="k">if</span> <span class="n">schema</span><span class="p">.</span><span class="n">min_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">below_min</span> <span class="o">=</span> <span class="p">(</span><span class="n">series</span> <span class="o">&lt;</span> <span class="n">schema</span><span class="p">.</span><span class="n">min_value</span><span class="p">).</span><span class="nf">sum</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">below_min</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">errors</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">below_min</span><span class="si">}</span><span class="s"> values below minimum </span><span class="si">{</span><span class="n">schema</span><span class="p">.</span><span class="n">min_value</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">schema</span><span class="p">.</span><span class="n">max_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">above_max</span> <span class="o">=</span> <span class="p">(</span><span class="n">series</span> <span class="o">&gt;</span> <span class="n">schema</span><span class="p">.</span><span class="n">max_value</span><span class="p">).</span><span class="nf">sum</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">above_max</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">errors</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">above_max</span><span class="si">}</span><span class="s"> values above maximum </span><span class="si">{</span><span class="n">schema</span><span class="p">.</span><span class="n">max_value</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="c1"># Check allowed values
</span>        <span class="k">if</span> <span class="n">schema</span><span class="p">.</span><span class="n">allowed_values</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">invalid</span> <span class="o">=</span> <span class="o">~</span><span class="n">series</span><span class="p">.</span><span class="nf">isin</span><span class="p">(</span><span class="n">schema</span><span class="p">.</span><span class="n">allowed_values</span><span class="p">)</span>
            <span class="n">invalid_count</span> <span class="o">=</span> <span class="n">invalid</span><span class="p">.</span><span class="nf">sum</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">invalid_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">invalid_vals</span> <span class="o">=</span> <span class="n">series</span><span class="p">[</span><span class="n">invalid</span><span class="p">].</span><span class="nf">unique</span><span class="p">()[:</span><span class="mi">5</span><span class="p">]</span>
                <span class="n">errors</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span>
                    <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">invalid_count</span><span class="si">}</span><span class="s"> values not in allowed set. </span><span class="sh">"</span>
                    <span class="sa">f</span><span class="sh">"</span><span class="s">Examples: </span><span class="si">{</span><span class="n">invalid_vals</span><span class="si">}</span><span class="sh">"</span>
                <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">errors</span>

<span class="c1"># Usage
</span><span class="n">user_schema</span> <span class="o">=</span> <span class="p">[</span>
    <span class="nc">FieldSchema</span><span class="p">(</span><span class="sh">"</span><span class="s">user_id</span><span class="sh">"</span><span class="p">,</span> <span class="n">DataType</span><span class="p">.</span><span class="n">INT</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">min_value</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
    <span class="nc">FieldSchema</span><span class="p">(</span><span class="sh">"</span><span class="s">age</span><span class="sh">"</span><span class="p">,</span> <span class="n">DataType</span><span class="p">.</span><span class="n">INT</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">min_value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_value</span><span class="o">=</span><span class="mi">120</span><span class="p">),</span>
    <span class="nc">FieldSchema</span><span class="p">(</span><span class="sh">"</span><span class="s">country</span><span class="sh">"</span><span class="p">,</span> <span class="n">DataType</span><span class="p">.</span><span class="n">STRING</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> 
                <span class="n">allowed_values</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">US</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">UK</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">CA</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">AU</span><span class="sh">"</span><span class="p">]),</span>
    <span class="nc">FieldSchema</span><span class="p">(</span><span class="sh">"</span><span class="s">signup_date</span><span class="sh">"</span><span class="p">,</span> <span class="n">DataType</span><span class="p">.</span><span class="n">TIMESTAMP</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="p">]</span>

<span class="n">validator</span> <span class="o">=</span> <span class="nc">SchemaValidator</span><span class="p">(</span><span class="n">user_schema</span><span class="p">)</span>
<span class="n">errors</span> <span class="o">=</span> <span class="n">validator</span><span class="p">.</span><span class="nf">validate</span><span class="p">(</span><span class="n">user_df</span><span class="p">)</span>

<span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Validation errors found:</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">field_errors</span> <span class="ow">in</span> <span class="n">errors</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  </span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">field_errors</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="statistical-validation">Statistical Validation</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">from</span> <span class="n">scipy</span> <span class="kn">import</span> <span class="n">stats</span>

<span class="k">class</span> <span class="nc">StatisticalValidator</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Detect statistical anomalies in data
    
    Compare current batch against historical baseline
    </span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">baseline_stats</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]):</span>
        <span class="sh">"""</span><span class="s">
        Args:
            baseline_stats: Historical statistics per field
                {
                    </span><span class="sh">'</span><span class="s">age</span><span class="sh">'</span><span class="s">: {</span><span class="sh">'</span><span class="s">mean</span><span class="sh">'</span><span class="s">: 35.2, </span><span class="sh">'</span><span class="s">std</span><span class="sh">'</span><span class="s">: 12.5, </span><span class="sh">'</span><span class="s">median</span><span class="sh">'</span><span class="s">: 33},
                    </span><span class="sh">'</span><span class="s">price</span><span class="sh">'</span><span class="s">: {</span><span class="sh">'</span><span class="s">mean</span><span class="sh">'</span><span class="s">: 99.5, </span><span class="sh">'</span><span class="s">std</span><span class="sh">'</span><span class="s">: 25.0, </span><span class="sh">'</span><span class="s">median</span><span class="sh">'</span><span class="s">: 95}
                }
        </span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="n">baseline</span> <span class="o">=</span> <span class="n">baseline_stats</span>
    
    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">threshold_sigma</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">
        Detect fields with distributions far from baseline
        
        Returns:
            List of warnings
        </span><span class="sh">"""</span>
        <span class="n">warnings</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">baseline</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">baseline</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="p">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">continue</span>
            
            <span class="n">current</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">field</span><span class="p">].</span><span class="nf">dropna</span><span class="p">()</span>
            
            <span class="c1"># Check mean shift
</span>            <span class="n">current_mean</span> <span class="o">=</span> <span class="n">current</span><span class="p">.</span><span class="nf">mean</span><span class="p">()</span>
            <span class="n">expected_mean</span> <span class="o">=</span> <span class="n">baseline</span><span class="p">[</span><span class="sh">'</span><span class="s">mean</span><span class="sh">'</span><span class="p">]</span>
            <span class="n">expected_std</span> <span class="o">=</span> <span class="n">baseline</span><span class="p">[</span><span class="sh">'</span><span class="s">std</span><span class="sh">'</span><span class="p">]</span>
            
            <span class="n">denom</span> <span class="o">=</span> <span class="n">expected_std</span> <span class="k">if</span> <span class="n">expected_std</span> <span class="o">&gt;</span> <span class="mf">1e-9</span> <span class="k">else</span> <span class="mf">1e-9</span>
            <span class="n">z_score</span> <span class="o">=</span> <span class="nf">abs</span><span class="p">(</span><span class="n">current_mean</span> <span class="o">-</span> <span class="n">expected_mean</span><span class="p">)</span> <span class="o">/</span> <span class="n">denom</span>
            
            <span class="k">if</span> <span class="n">z_score</span> <span class="o">&gt;</span> <span class="n">threshold_sigma</span><span class="p">:</span>
                <span class="n">warnings</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span>
                    <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s">: Mean shifted significantly </span><span class="sh">"</span>
                    <span class="sa">f</span><span class="sh">"</span><span class="s">(current=</span><span class="si">{</span><span class="n">current_mean</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">, </span><span class="sh">"</span>
                    <span class="sa">f</span><span class="sh">"</span><span class="s">baseline=</span><span class="si">{</span><span class="n">expected_mean</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">, </span><span class="sh">"</span>
                    <span class="sa">f</span><span class="sh">"</span><span class="s">z-score=</span><span class="si">{</span><span class="n">z_score</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">)</span><span class="sh">"</span>
                <span class="p">)</span>
            
            <span class="c1"># Check distribution shift (KS test)
</span>            <span class="n">baseline_samples</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">normal</span><span class="p">(</span>
                <span class="n">baseline</span><span class="p">[</span><span class="sh">'</span><span class="s">mean</span><span class="sh">'</span><span class="p">],</span> 
                <span class="n">baseline</span><span class="p">[</span><span class="sh">'</span><span class="s">std</span><span class="sh">'</span><span class="p">],</span> 
                <span class="n">size</span><span class="o">=</span><span class="nf">len</span><span class="p">(</span><span class="n">current</span><span class="p">)</span>
            <span class="p">)</span>
            
            <span class="n">ks_stat</span><span class="p">,</span> <span class="n">p_value</span> <span class="o">=</span> <span class="n">stats</span><span class="p">.</span><span class="nf">ks_2samp</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">baseline_samples</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">p_value</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">:</span>  <span class="c1"># Significant difference
</span>                <span class="n">warnings</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span>
                    <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s">: Distribution changed </span><span class="sh">"</span>
                    <span class="sa">f</span><span class="sh">"</span><span class="s">(KS statistic=</span><span class="si">{</span><span class="n">ks_stat</span><span class="si">:</span><span class="p">.</span><span class="mi">3</span><span class="n">f</span><span class="si">}</span><span class="s">, p=</span><span class="si">{</span><span class="n">p_value</span><span class="si">:</span><span class="p">.</span><span class="mi">3</span><span class="n">f</span><span class="si">}</span><span class="s">)</span><span class="sh">"</span>
                <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">warnings</span>
</code></pre></div></div>

<hr />

<h2 id="component-2-data-cleaning">Component 2: Data Cleaning</h2>

<p>Handle missing values, duplicates, and inconsistencies.</p>

<h3 id="missing-value-handling">Missing Value Handling</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">MissingValueHandler</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Handle missing values with different strategies
    </span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">imputers</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">strategies</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]):</span>
        <span class="sh">"""</span><span class="s">
        Fit imputation strategies
        
        Args:
            strategies: {column: strategy}
                strategy options: </span><span class="sh">'</span><span class="s">mean</span><span class="sh">'</span><span class="s">, </span><span class="sh">'</span><span class="s">median</span><span class="sh">'</span><span class="s">, </span><span class="sh">'</span><span class="s">mode</span><span class="sh">'</span><span class="s">, </span><span class="sh">'</span><span class="s">forward_fill</span><span class="sh">'</span><span class="s">, </span><span class="sh">'</span><span class="s">drop</span><span class="sh">'</span><span class="s">
        </span><span class="sh">"""</span>
        <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">strategy</span> <span class="ow">in</span> <span class="n">strategies</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="p">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">continue</span>
            
            <span class="k">if</span> <span class="n">strategy</span> <span class="o">==</span> <span class="sh">'</span><span class="s">mean</span><span class="sh">'</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="n">imputers</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">].</span><span class="nf">mean</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">strategy</span> <span class="o">==</span> <span class="sh">'</span><span class="s">median</span><span class="sh">'</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="n">imputers</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">].</span><span class="nf">median</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">strategy</span> <span class="o">==</span> <span class="sh">'</span><span class="s">mode</span><span class="sh">'</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="n">imputers</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">].</span><span class="nf">mode</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># forward_fill and drop don't need fitting
</span>    
    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">strategies</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">Apply imputation</span><span class="sh">"""</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">copy</span><span class="p">()</span>
        
        <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">strategy</span> <span class="ow">in</span> <span class="n">strategies</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="p">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">continue</span>
            
            <span class="k">if</span> <span class="n">strategy</span> <span class="ow">in</span> <span class="p">[</span><span class="sh">'</span><span class="s">mean</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">median</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">mode</span><span class="sh">'</span><span class="p">]:</span>
                <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">].</span><span class="nf">fillna</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">imputers</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            
            <span class="k">elif</span> <span class="n">strategy</span> <span class="o">==</span> <span class="sh">'</span><span class="s">forward_fill</span><span class="sh">'</span><span class="p">:</span>
                <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">].</span><span class="nf">fillna</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="sh">'</span><span class="s">ffill</span><span class="sh">'</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            
            <span class="k">elif</span> <span class="n">strategy</span> <span class="o">==</span> <span class="sh">'</span><span class="s">backward_fill</span><span class="sh">'</span><span class="p">:</span>
                <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">].</span><span class="nf">fillna</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="sh">'</span><span class="s">bfill</span><span class="sh">'</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            
            <span class="k">elif</span> <span class="n">strategy</span> <span class="o">==</span> <span class="sh">'</span><span class="s">drop</span><span class="sh">'</span><span class="p">:</span>
                <span class="n">df</span><span class="p">.</span><span class="nf">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            
            <span class="k">elif</span> <span class="n">strategy</span> <span class="o">==</span> <span class="sh">'</span><span class="s">constant</span><span class="sh">'</span><span class="p">:</span>
                <span class="c1"># Fill with a constant (e.g., 0, 'Unknown')
</span>                <span class="n">fill_value</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">pd</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">types</span><span class="p">.</span><span class="nf">is_numeric_dtype</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">])</span> <span class="k">else</span> <span class="sh">'</span><span class="s">Unknown</span><span class="sh">'</span>
                <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">].</span><span class="nf">fillna</span><span class="p">(</span><span class="n">fill_value</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">df</span>
</code></pre></div></div>

<h3 id="outlier-detection--handling">Outlier Detection &amp; Handling</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">OutlierHandler</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Detect and handle outliers
    </span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">detect_outliers_iqr</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">series</span><span class="p">:</span> <span class="n">pd</span><span class="p">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">multiplier</span><span class="o">=</span><span class="mf">1.5</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        IQR method: values outside [Q1 - 1.5*IQR, Q3 + 1.5*IQR]
        </span><span class="sh">"""</span>
        <span class="n">Q1</span> <span class="o">=</span> <span class="n">series</span><span class="p">.</span><span class="nf">quantile</span><span class="p">(</span><span class="mf">0.25</span><span class="p">)</span>
        <span class="n">Q3</span> <span class="o">=</span> <span class="n">series</span><span class="p">.</span><span class="nf">quantile</span><span class="p">(</span><span class="mf">0.75</span><span class="p">)</span>
        <span class="n">IQR</span> <span class="o">=</span> <span class="n">Q3</span> <span class="o">-</span> <span class="n">Q1</span>
        
        <span class="n">lower_bound</span> <span class="o">=</span> <span class="n">Q1</span> <span class="o">-</span> <span class="n">multiplier</span> <span class="o">*</span> <span class="n">IQR</span>
        <span class="n">upper_bound</span> <span class="o">=</span> <span class="n">Q3</span> <span class="o">+</span> <span class="n">multiplier</span> <span class="o">*</span> <span class="n">IQR</span>
        
        <span class="n">outliers</span> <span class="o">=</span> <span class="p">(</span><span class="n">series</span> <span class="o">&lt;</span> <span class="n">lower_bound</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">series</span> <span class="o">&gt;</span> <span class="n">upper_bound</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">outliers</span>
    
    <span class="k">def</span> <span class="nf">detect_outliers_zscore</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">series</span><span class="p">:</span> <span class="n">pd</span><span class="p">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Z-score method: |z| &gt; threshold
        </span><span class="sh">"""</span>
        <span class="n">z_scores</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">abs</span><span class="p">(</span><span class="n">stats</span><span class="p">.</span><span class="nf">zscore</span><span class="p">(</span><span class="n">series</span><span class="p">.</span><span class="nf">dropna</span><span class="p">()))</span>
        <span class="n">outliers</span> <span class="o">=</span> <span class="n">z_scores</span> <span class="o">&gt;</span> <span class="n">threshold</span>
        
        <span class="k">return</span> <span class="n">outliers</span>
    
    <span class="k">def</span> <span class="nf">handle_outliers</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">columns</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">method</span><span class="o">=</span><span class="sh">'</span><span class="s">clip</span><span class="sh">'</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Handle outliers
        
        Args:
            method: </span><span class="sh">'</span><span class="s">clip</span><span class="sh">'</span><span class="s">, </span><span class="sh">'</span><span class="s">remove</span><span class="sh">'</span><span class="s">, </span><span class="sh">'</span><span class="s">cap</span><span class="sh">'</span><span class="s">, </span><span class="sh">'</span><span class="s">transform</span><span class="sh">'</span><span class="s">
        </span><span class="sh">"""</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">copy</span><span class="p">()</span>
        
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
            <span class="n">outliers</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">detect_outliers_iqr</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">])</span>
            
            <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="sh">'</span><span class="s">clip</span><span class="sh">'</span><span class="p">:</span>
                <span class="c1"># Clip to [Q1 - 1.5*IQR, Q3 + 1.5*IQR]
</span>                <span class="n">Q1</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">].</span><span class="nf">quantile</span><span class="p">(</span><span class="mf">0.25</span><span class="p">)</span>
                <span class="n">Q3</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">].</span><span class="nf">quantile</span><span class="p">(</span><span class="mf">0.75</span><span class="p">)</span>
                <span class="n">IQR</span> <span class="o">=</span> <span class="n">Q3</span> <span class="o">-</span> <span class="n">Q1</span>
                <span class="n">lower</span> <span class="o">=</span> <span class="n">Q1</span> <span class="o">-</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">IQR</span>
                <span class="n">upper</span> <span class="o">=</span> <span class="n">Q3</span> <span class="o">+</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">IQR</span>
                <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">].</span><span class="nf">clip</span><span class="p">(</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">)</span>
            
            <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="sh">'</span><span class="s">remove</span><span class="sh">'</span><span class="p">:</span>
                <span class="c1"># Remove outlier rows
</span>                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">outliers</span><span class="p">]</span>
            
            <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="sh">'</span><span class="s">cap</span><span class="sh">'</span><span class="p">:</span>
                <span class="c1"># Cap at 99th percentile
</span>                <span class="n">upper</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">].</span><span class="nf">quantile</span><span class="p">(</span><span class="mf">0.99</span><span class="p">)</span>
                <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">].</span><span class="nf">clip</span><span class="p">(</span><span class="n">upper</span><span class="o">=</span><span class="n">upper</span><span class="p">)</span>
            
            <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="sh">'</span><span class="s">transform</span><span class="sh">'</span><span class="p">:</span>
                <span class="c1"># Log transform to reduce skew
</span>                <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">log1p</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">])</span>
        
        <span class="k">return</span> <span class="n">df</span>
</code></pre></div></div>

<h3 id="deduplication">Deduplication</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Deduplicator</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Remove duplicate records
    </span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">deduplicate</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span> 
        <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">,</span> 
        <span class="n">key_columns</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">keep</span><span class="o">=</span><span class="sh">'</span><span class="s">last</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">timestamp_col</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">
        Remove duplicates
        
        Args:
            key_columns: Columns that define uniqueness
            keep: </span><span class="sh">'</span><span class="s">first</span><span class="sh">'</span><span class="s">, </span><span class="sh">'</span><span class="s">last</span><span class="sh">'</span><span class="s">, or False (remove all duplicates)
            timestamp_col: If provided, keep most recent
        </span><span class="sh">"""</span>
        <span class="k">if</span> <span class="n">timestamp_col</span><span class="p">:</span>
            <span class="c1"># Sort by timestamp descending, then drop duplicates keeping first
</span>            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">sort_values</span><span class="p">(</span><span class="n">timestamp_col</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">key_columns</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="sh">'</span><span class="s">first</span><span class="sh">'</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">key_columns</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="n">keep</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">df</span>
</code></pre></div></div>

<hr />

<h2 id="component-3-feature-engineering">Component 3: Feature Engineering</h2>

<p>Transform raw data into ML-ready features.</p>

<h3 id="numerical-transformations">Numerical Transformations</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span><span class="p">,</span> <span class="n">MinMaxScaler</span><span class="p">,</span> <span class="n">RobustScaler</span>

<span class="k">class</span> <span class="nc">NumericalTransformer</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Apply numerical transformations
    </span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">scalers</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">fit_transform</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">transformations</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]):</span>
        <span class="sh">"""</span><span class="s">
        Apply transformations
        
        transformations: {column: transformation_type}
            </span><span class="sh">'</span><span class="s">standard</span><span class="sh">'</span><span class="s">: StandardScaler (mean=0, std=1)
            </span><span class="sh">'</span><span class="s">minmax</span><span class="sh">'</span><span class="s">: MinMaxScaler (range [0, 1])
            </span><span class="sh">'</span><span class="s">robust</span><span class="sh">'</span><span class="s">: RobustScaler (use median, IQR - robust to outliers)
            </span><span class="sh">'</span><span class="s">log</span><span class="sh">'</span><span class="s">: Log transform
            </span><span class="sh">'</span><span class="s">sqrt</span><span class="sh">'</span><span class="s">: Square root transform
        </span><span class="sh">"""</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">copy</span><span class="p">()</span>
        
        <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">transform_type</span> <span class="ow">in</span> <span class="n">transformations</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="p">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">continue</span>
            
            <span class="k">if</span> <span class="n">transform_type</span> <span class="o">==</span> <span class="sh">'</span><span class="s">standard</span><span class="sh">'</span><span class="p">:</span>
                <span class="n">scaler</span> <span class="o">=</span> <span class="nc">StandardScaler</span><span class="p">()</span>
                <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaler</span><span class="p">.</span><span class="nf">fit_transform</span><span class="p">(</span><span class="n">df</span><span class="p">[[</span><span class="n">col</span><span class="p">]])</span>
                <span class="n">self</span><span class="p">.</span><span class="n">scalers</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaler</span>
            
            <span class="k">elif</span> <span class="n">transform_type</span> <span class="o">==</span> <span class="sh">'</span><span class="s">minmax</span><span class="sh">'</span><span class="p">:</span>
                <span class="n">scaler</span> <span class="o">=</span> <span class="nc">MinMaxScaler</span><span class="p">()</span>
                <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaler</span><span class="p">.</span><span class="nf">fit_transform</span><span class="p">(</span><span class="n">df</span><span class="p">[[</span><span class="n">col</span><span class="p">]])</span>
                <span class="n">self</span><span class="p">.</span><span class="n">scalers</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaler</span>
            
            <span class="k">elif</span> <span class="n">transform_type</span> <span class="o">==</span> <span class="sh">'</span><span class="s">robust</span><span class="sh">'</span><span class="p">:</span>
                <span class="n">scaler</span> <span class="o">=</span> <span class="nc">RobustScaler</span><span class="p">()</span>
                <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaler</span><span class="p">.</span><span class="nf">fit_transform</span><span class="p">(</span><span class="n">df</span><span class="p">[[</span><span class="n">col</span><span class="p">]])</span>
                <span class="n">self</span><span class="p">.</span><span class="n">scalers</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaler</span>
            
            <span class="k">elif</span> <span class="n">transform_type</span> <span class="o">==</span> <span class="sh">'</span><span class="s">log</span><span class="sh">'</span><span class="p">:</span>
                <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">log1p</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">])</span>  <span class="c1"># log(1 + x) to handle 0
</span>            
            <span class="k">elif</span> <span class="n">transform_type</span> <span class="o">==</span> <span class="sh">'</span><span class="s">sqrt</span><span class="sh">'</span><span class="p">:</span>
                <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">])</span>
            
            <span class="k">elif</span> <span class="n">transform_type</span> <span class="o">==</span> <span class="sh">'</span><span class="s">boxcox</span><span class="sh">'</span><span class="p">:</span>
                <span class="c1"># Box-Cox transform (requires positive values)
</span>                <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">_</span> <span class="o">=</span> <span class="n">stats</span><span class="p">.</span><span class="nf">boxcox</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># +1 to handle 0
</span>        
        <span class="k">return</span> <span class="n">df</span>
</code></pre></div></div>

<h3 id="categorical-encoding">Categorical Encoding</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">CategoricalEncoder</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Encode categorical variables
    </span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">encoders</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">fit_transform</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">encodings</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]):</span>
        <span class="sh">"""</span><span class="s">
        Apply encodings
        
        encodings: {column: encoding_type}
            </span><span class="sh">'</span><span class="s">onehot</span><span class="sh">'</span><span class="s">: One-hot encoding
            </span><span class="sh">'</span><span class="s">label</span><span class="sh">'</span><span class="s">: Label encoding (0, 1, 2, ...)
            </span><span class="sh">'</span><span class="s">target</span><span class="sh">'</span><span class="s">: Target encoding (mean of target per category)
            </span><span class="sh">'</span><span class="s">frequency</span><span class="sh">'</span><span class="s">: Frequency encoding
            </span><span class="sh">'</span><span class="s">ordinal</span><span class="sh">'</span><span class="s">: Ordinal encoding with custom order
        </span><span class="sh">"""</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">copy</span><span class="p">()</span>
        
        <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">encoding_type</span> <span class="ow">in</span> <span class="n">encodings</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="p">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">continue</span>
            
            <span class="k">if</span> <span class="n">encoding_type</span> <span class="o">==</span> <span class="sh">'</span><span class="s">onehot</span><span class="sh">'</span><span class="p">:</span>
                <span class="c1"># One-hot encoding
</span>                <span class="n">dummies</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">get_dummies</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">prefix</span><span class="o">=</span><span class="n">col</span><span class="p">)</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="n">dummies</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">df</span><span class="p">.</span><span class="nf">drop</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="n">self</span><span class="p">.</span><span class="n">encoders</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">dummies</span><span class="p">.</span><span class="n">columns</span><span class="p">)</span>
            
            <span class="k">elif</span> <span class="n">encoding_type</span> <span class="o">==</span> <span class="sh">'</span><span class="s">label</span><span class="sh">'</span><span class="p">:</span>
                <span class="c1"># Label encoding
</span>                <span class="n">categories</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">].</span><span class="nf">unique</span><span class="p">()</span>
                <span class="n">mapping</span> <span class="o">=</span> <span class="p">{</span><span class="n">cat</span><span class="p">:</span> <span class="n">idx</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">cat</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">categories</span><span class="p">)}</span>
                <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">].</span><span class="nf">map</span><span class="p">(</span><span class="n">mapping</span><span class="p">)</span>
                <span class="n">self</span><span class="p">.</span><span class="n">encoders</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapping</span>
            
            <span class="k">elif</span> <span class="n">encoding_type</span> <span class="o">==</span> <span class="sh">'</span><span class="s">frequency</span><span class="sh">'</span><span class="p">:</span>
                <span class="c1"># Frequency encoding
</span>                <span class="n">freq</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">].</span><span class="nf">value_counts</span><span class="p">(</span><span class="n">normalize</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">].</span><span class="nf">map</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span>
                <span class="n">self</span><span class="p">.</span><span class="n">encoders</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">freq</span>
        
        <span class="k">return</span> <span class="n">df</span>
</code></pre></div></div>

<h3 id="temporal-features">Temporal Features</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">TemporalFeatureExtractor</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Extract features from timestamps
    </span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">extract</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">timestamp_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">
        Extract temporal features from timestamp column
        </span><span class="sh">"""</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">copy</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="n">timestamp_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">timestamp_col</span><span class="p">])</span>
        
        <span class="c1"># Basic temporal features
</span>        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="sh">'</span><span class="si">{</span><span class="n">timestamp_col</span><span class="si">}</span><span class="s">_hour</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">timestamp_col</span><span class="p">].</span><span class="n">dt</span><span class="p">.</span><span class="n">hour</span>
        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="sh">'</span><span class="si">{</span><span class="n">timestamp_col</span><span class="si">}</span><span class="s">_day_of_week</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">timestamp_col</span><span class="p">].</span><span class="n">dt</span><span class="p">.</span><span class="n">dayofweek</span>
        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="sh">'</span><span class="si">{</span><span class="n">timestamp_col</span><span class="si">}</span><span class="s">_day_of_month</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">timestamp_col</span><span class="p">].</span><span class="n">dt</span><span class="p">.</span><span class="n">day</span>
        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="sh">'</span><span class="si">{</span><span class="n">timestamp_col</span><span class="si">}</span><span class="s">_month</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">timestamp_col</span><span class="p">].</span><span class="n">dt</span><span class="p">.</span><span class="n">month</span>
        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="sh">'</span><span class="si">{</span><span class="n">timestamp_col</span><span class="si">}</span><span class="s">_quarter</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">timestamp_col</span><span class="p">].</span><span class="n">dt</span><span class="p">.</span><span class="n">quarter</span>
        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="sh">'</span><span class="si">{</span><span class="n">timestamp_col</span><span class="si">}</span><span class="s">_year</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">timestamp_col</span><span class="p">].</span><span class="n">dt</span><span class="p">.</span><span class="n">year</span>
        
        <span class="c1"># Derived features
</span>        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="sh">'</span><span class="si">{</span><span class="n">timestamp_col</span><span class="si">}</span><span class="s">_is_weekend</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="sh">'</span><span class="si">{</span><span class="n">timestamp_col</span><span class="si">}</span><span class="s">_day_of_week</span><span class="sh">'</span><span class="p">].</span><span class="nf">isin</span><span class="p">([</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]).</span><span class="nf">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="sh">'</span><span class="si">{</span><span class="n">timestamp_col</span><span class="si">}</span><span class="s">_is_business_hours</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="sh">'</span><span class="si">{</span><span class="n">timestamp_col</span><span class="si">}</span><span class="s">_hour</span><span class="sh">'</span><span class="p">].</span><span class="nf">between</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">17</span><span class="p">).</span><span class="nf">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        
        <span class="c1"># Cyclical encoding (for periodic features like hour)
</span>        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="sh">'</span><span class="si">{</span><span class="n">timestamp_col</span><span class="si">}</span><span class="s">_hour_sin</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">sin</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="sh">'</span><span class="si">{</span><span class="n">timestamp_col</span><span class="si">}</span><span class="s">_hour</span><span class="sh">'</span><span class="p">]</span> <span class="o">/</span> <span class="mi">24</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="sh">'</span><span class="si">{</span><span class="n">timestamp_col</span><span class="si">}</span><span class="s">_hour_cos</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">cos</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="sh">'</span><span class="si">{</span><span class="n">timestamp_col</span><span class="si">}</span><span class="s">_hour</span><span class="sh">'</span><span class="p">]</span> <span class="o">/</span> <span class="mi">24</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">df</span>
</code></pre></div></div>

<hr />

<h2 id="component-4-pipeline-orchestration">Component 4: Pipeline Orchestration</h2>

<p>Orchestrate the entire preprocessing workflow.</p>

<h3 id="apache-beam-pipeline">Apache Beam Pipeline</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">apache_beam</span> <span class="k">as</span> <span class="n">beam</span>
<span class="kn">from</span> <span class="n">apache_beam.options.pipeline_options</span> <span class="kn">import</span> <span class="n">PipelineOptions</span>

<span class="k">class</span> <span class="nc">PreprocessingPipeline</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    End-to-end preprocessing pipeline using Apache Beam
    
    Handles:
    - Data validation
    - Cleaning
    - Feature engineering
    - Quality checks
    </span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">pipeline_options</span><span class="p">:</span> <span class="n">PipelineOptions</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">pipeline_options</span>
    
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">input_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Run preprocessing pipeline
        </span><span class="sh">"""</span>
        <span class="k">with</span> <span class="n">beam</span><span class="p">.</span><span class="nc">Pipeline</span><span class="p">(</span><span class="n">options</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">options</span><span class="p">)</span> <span class="k">as</span> <span class="n">pipeline</span><span class="p">:</span>
            <span class="p">(</span>
                <span class="n">pipeline</span>
                <span class="o">|</span> <span class="sh">'</span><span class="s">Read Data</span><span class="sh">'</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="nc">ReadFromText</span><span class="p">(</span><span class="n">input_path</span><span class="p">)</span>
                <span class="o">|</span> <span class="sh">'</span><span class="s">Parse JSON</span><span class="sh">'</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="p">.</span><span class="nc">Map</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">)</span>
                <span class="o">|</span> <span class="sh">'</span><span class="s">Validate Schema</span><span class="sh">'</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="p">.</span><span class="nc">ParDo</span><span class="p">(</span><span class="nc">ValidateSchemaFn</span><span class="p">())</span>
                <span class="o">|</span> <span class="sh">'</span><span class="s">Clean Data</span><span class="sh">'</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="p">.</span><span class="nc">ParDo</span><span class="p">(</span><span class="nc">CleanDataFn</span><span class="p">())</span>
                <span class="o">|</span> <span class="sh">'</span><span class="s">Extract Features</span><span class="sh">'</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="p">.</span><span class="nc">ParDo</span><span class="p">(</span><span class="nc">FeatureExtractionFn</span><span class="p">())</span>
                <span class="o">|</span> <span class="sh">'</span><span class="s">Quality Check</span><span class="sh">'</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="p">.</span><span class="nc">ParDo</span><span class="p">(</span><span class="nc">QualityCheckFn</span><span class="p">())</span>
                <span class="o">|</span> <span class="sh">'</span><span class="s">Write Output</span><span class="sh">'</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="nc">WriteToText</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
            <span class="p">)</span>

<span class="k">class</span> <span class="nc">ValidateSchemaFn</span><span class="p">(</span><span class="n">beam</span><span class="p">.</span><span class="n">DoFn</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">Beam DoFn for schema validation</span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">element</span><span class="p">):</span>
        <span class="c1"># Lazily initialize schema validator (avoid re-creating per element)
</span>        <span class="k">if</span> <span class="ow">not</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="sh">'</span><span class="s">validator</span><span class="sh">'</span><span class="p">):</span>
            <span class="n">self</span><span class="p">.</span><span class="n">validator</span> <span class="o">=</span> <span class="nc">SchemaValidator</span><span class="p">(</span><span class="nf">get_schema</span><span class="p">())</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">validator</span><span class="p">.</span><span class="nf">validate_record</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
            <span class="c1"># Log to dead letter queue
</span>            <span class="k">yield</span> <span class="n">beam</span><span class="p">.</span><span class="n">pvalue</span><span class="p">.</span><span class="nc">TaggedOutput</span><span class="p">(</span><span class="sh">'</span><span class="s">invalid</span><span class="sh">'</span><span class="p">,</span> <span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">errors</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">element</span>

<span class="k">class</span> <span class="nc">CleanDataFn</span><span class="p">(</span><span class="n">beam</span><span class="p">.</span><span class="n">DoFn</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">Beam DoFn for data cleaning</span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">element</span><span class="p">):</span>
        <span class="c1"># Handle missing values
</span>        <span class="n">element</span> <span class="o">=</span> <span class="nf">handle_missing</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
        
        <span class="c1"># Handle outliers
</span>        <span class="n">element</span> <span class="o">=</span> <span class="nf">handle_outliers</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
        
        <span class="c1"># Remove duplicates (stateful processing)
</span>        <span class="c1"># ...
</span>        
        <span class="k">yield</span> <span class="n">element</span>
</code></pre></div></div>

<hr />

<h2 id="preventing-trainingserving-skew">Preventing Training/Serving Skew</h2>

<p><strong>Critical problem:</strong> Different preprocessing in training vs serving leads to poor model performance.</p>

<h3 id="solution-1-unified-preprocessing-library">Solution 1: Unified Preprocessing Library</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">PreprocessorV1</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Versioned preprocessing logic
    
    Same code used in training and serving
    </span><span class="sh">"""</span>
    
    <span class="n">VERSION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">1.0.0</span><span class="sh">"</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="n">self</span><span class="p">.</span><span class="n">fitted_params</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Fit on training data</span><span class="sh">"""</span>
        <span class="c1"># Compute statistics needed for transform
</span>        <span class="n">self</span><span class="p">.</span><span class="n">fitted_params</span><span class="p">[</span><span class="sh">'</span><span class="s">age_mean</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="sh">'</span><span class="s">age</span><span class="sh">'</span><span class="p">].</span><span class="nf">mean</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">fitted_params</span><span class="p">[</span><span class="sh">'</span><span class="s">price_scaler</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="nc">MinMaxScaler</span><span class="p">().</span><span class="nf">fit</span><span class="p">(</span><span class="n">df</span><span class="p">[[</span><span class="sh">'</span><span class="s">price</span><span class="sh">'</span><span class="p">]])</span>
        <span class="c1"># ...
</span>    
    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">Apply same transformations</span><span class="sh">"""</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">copy</span><span class="p">()</span>
        
        <span class="c1"># Use fitted parameters
</span>        <span class="n">df</span><span class="p">[</span><span class="sh">'</span><span class="s">age_normalized</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="sh">'</span><span class="s">age</span><span class="sh">'</span><span class="p">]</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">fitted_params</span><span class="p">[</span><span class="sh">'</span><span class="s">age_mean</span><span class="sh">'</span><span class="p">])</span> <span class="o">/</span> <span class="mi">10</span>
        <span class="n">df</span><span class="p">[</span><span class="sh">'</span><span class="s">price_scaled</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">fitted_params</span><span class="p">[</span><span class="sh">'</span><span class="s">price_scaler</span><span class="sh">'</span><span class="p">].</span><span class="nf">transform</span><span class="p">(</span><span class="n">df</span><span class="p">[[</span><span class="sh">'</span><span class="s">price</span><span class="sh">'</span><span class="p">]])</span>
        
        <span class="k">return</span> <span class="n">df</span>
    
    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Save fitted preprocessor</span><span class="sh">"""</span>
        <span class="kn">import</span> <span class="n">pickle</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sh">'</span><span class="s">wb</span><span class="sh">'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pickle</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
    
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Load fitted preprocessor</span><span class="sh">"""</span>
        <span class="kn">import</span> <span class="n">pickle</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sh">'</span><span class="s">rb</span><span class="sh">'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pickle</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

<span class="c1"># Training
</span><span class="n">preprocessor</span> <span class="o">=</span> <span class="nc">PreprocessorV1</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<span class="n">preprocessor</span><span class="p">.</span><span class="nf">fit</span><span class="p">(</span><span class="n">training_data</span><span class="p">)</span>
<span class="n">preprocessor</span><span class="p">.</span><span class="nf">save</span><span class="p">(</span><span class="sh">'</span><span class="s">models/preprocessor_v1.pkl</span><span class="sh">'</span><span class="p">)</span>
<span class="n">X_train</span> <span class="o">=</span> <span class="n">preprocessor</span><span class="p">.</span><span class="nf">transform</span><span class="p">(</span><span class="n">training_data</span><span class="p">)</span>

<span class="c1"># Serving
</span><span class="n">preprocessor</span> <span class="o">=</span> <span class="n">PreprocessorV1</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="sh">'</span><span class="s">models/preprocessor_v1.pkl</span><span class="sh">'</span><span class="p">)</span>
<span class="n">X_serve</span> <span class="o">=</span> <span class="n">preprocessor</span><span class="p">.</span><span class="nf">transform</span><span class="p">(</span><span class="n">serving_data</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="solution-2-feature-store">Solution 2: Feature Store</h3>

<p>Store pre-computed features, ensuring consistency.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">FeatureStore</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Centralized feature storage
    
    Benefits:
    - Features computed once, used everywhere
    - Versioned features
    - Point-in-time correct joins
    </span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">backend</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">backend</span> <span class="o">=</span> <span class="n">backend</span>
    
    <span class="k">def</span> <span class="nf">write_features</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span> 
        <span class="n">entity_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">features</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">timestamp</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span>
        <span class="n">feature_set_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">version</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Write features for an entity
        </span><span class="sh">"""</span>
        <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">feature_set_name</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">entity_id</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="sh">"</span>
        <span class="n">self</span><span class="p">.</span><span class="n">backend</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">features</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">read_features</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">entity_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">feature_set_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">version</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">as_of_timestamp</span><span class="p">:</span> <span class="n">datetime</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">
        Read features as of a specific timestamp
        
        Point-in-time correctness: Only use features available at inference time
        </span><span class="sh">"""</span>
        <span class="c1"># Query features created before as_of_timestamp
</span>        <span class="n">features</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">backend</span><span class="p">.</span><span class="nf">read_point_in_time</span><span class="p">(</span>
            <span class="n">entity_id</span><span class="p">,</span>
            <span class="n">feature_set_name</span><span class="p">,</span>
            <span class="n">version</span><span class="p">,</span>
            <span class="n">as_of_timestamp</span>
        <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">features</span>
</code></pre></div></div>

<hr />

<h2 id="monitoring--data-quality">Monitoring &amp; Data Quality</h2>

<p>Track data quality metrics over time.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">DataQualityMetrics</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Metrics for a data batch</span><span class="sh">"""</span>
    <span class="n">timestamp</span><span class="p">:</span> <span class="n">datetime</span>
    <span class="n">total_records</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">null_counts</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>
    <span class="n">duplicate_count</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">schema_errors</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">outlier_counts</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>
    <span class="n">statistical_warnings</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">DataQualityMonitor</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Monitor data quality over time
    </span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">metrics_backend</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">backend</span> <span class="o">=</span> <span class="n">metrics_backend</span>
    
    <span class="k">def</span> <span class="nf">compute_metrics</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataQualityMetrics</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">Compute quality metrics for a batch</span><span class="sh">"""</span>
        
        <span class="n">metrics</span> <span class="o">=</span> <span class="nc">DataQualityMetrics</span><span class="p">(</span>
            <span class="n">timestamp</span><span class="o">=</span><span class="n">datetime</span><span class="p">.</span><span class="nf">now</span><span class="p">(),</span>
            <span class="n">total_records</span><span class="o">=</span><span class="nf">len</span><span class="p">(</span><span class="n">df</span><span class="p">),</span>
            <span class="n">null_counts</span><span class="o">=</span><span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">].</span><span class="nf">isnull</span><span class="p">().</span><span class="nf">sum</span><span class="p">()</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="p">.</span><span class="n">columns</span><span class="p">},</span>
            <span class="n">duplicate_count</span><span class="o">=</span><span class="n">df</span><span class="p">.</span><span class="nf">duplicated</span><span class="p">().</span><span class="nf">sum</span><span class="p">(),</span>
            <span class="n">schema_errors</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>  <span class="c1"># From validation
</span>            <span class="n">outlier_counts</span><span class="o">=</span><span class="p">{},</span>
            <span class="n">statistical_warnings</span><span class="o">=</span><span class="p">[]</span>
        <span class="p">)</span>
        
        <span class="c1"># Detect outliers
</span>        <span class="n">outlier_handler</span> <span class="o">=</span> <span class="nc">OutlierHandler</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="p">.</span><span class="nf">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="p">.</span><span class="n">number</span><span class="p">]).</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">outliers</span> <span class="o">=</span> <span class="n">outlier_handler</span><span class="p">.</span><span class="nf">detect_outliers_iqr</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">])</span>
            <span class="n">metrics</span><span class="p">.</span><span class="n">outlier_counts</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">outliers</span><span class="p">.</span><span class="nf">sum</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="n">metrics</span>
    
    <span class="k">def</span> <span class="nf">log_metrics</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">metrics</span><span class="p">:</span> <span class="n">DataQualityMetrics</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Log metrics to monitoring system</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="n">backend</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">alert_on_anomalies</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">metrics</span><span class="p">:</span> <span class="n">DataQualityMetrics</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Alert if metrics deviate significantly</span><span class="sh">"""</span>
        
        <span class="c1"># Alert if &gt; 5% nulls in critical fields
</span>        <span class="n">critical_fields</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">user_id</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">timestamp</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">label</span><span class="sh">'</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">critical_fields</span><span class="p">:</span>
            <span class="n">null_rate</span> <span class="o">=</span> <span class="n">metrics</span><span class="p">.</span><span class="n">null_counts</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">metrics</span><span class="p">.</span><span class="n">total_records</span>
            <span class="k">if</span> <span class="n">null_rate</span> <span class="o">&gt;</span> <span class="mf">0.05</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">send_alert</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">High null rate in </span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">null_rate</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="o">%</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="c1"># Alert if &gt; 10% duplicates
</span>        <span class="n">dup_rate</span> <span class="o">=</span> <span class="n">metrics</span><span class="p">.</span><span class="n">duplicate_count</span> <span class="o">/</span> <span class="n">metrics</span><span class="p">.</span><span class="n">total_records</span>
        <span class="k">if</span> <span class="n">dup_rate</span> <span class="o">&gt;</span> <span class="mf">0.10</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">send_alert</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">High duplicate rate: </span><span class="si">{</span><span class="n">dup_rate</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="o">%</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<hr />

<h2 id="real-world-examples">Real-World Examples</h2>

<h3 id="netflix-data-preprocessing-for-recommendations">Netflix: Data Preprocessing for Recommendations</h3>

<p><strong>Scale:</strong> Billions of viewing events/day</p>

<p><strong>Architecture:</strong></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Event Stream (Kafka)
  ↓
Flink/Spark Streaming
  ↓
Feature Engineering
  - User viewing history aggregations
  - Time-based features
  - Content embeddings
  ↓
Feature Store (Cassandra)
  ↓
Model Training &amp; Serving
</code></pre></div></div>

<p><strong>Key techniques:</strong></p>
<ul>
  <li>Streaming aggregations (last 7 days views, etc.)</li>
  <li>Incremental updates to user profiles</li>
  <li>Point-in-time correct features</li>
</ul>

<h3 id="uber-preprocessing-for-etas">Uber: Preprocessing for ETAs</h3>

<p><strong>Challenge:</strong> Predict arrival times using GPS data</p>

<p><strong>Pipeline:</strong></p>
<ol>
  <li><strong>Map Matching:</strong> Snap GPS points to road network</li>
  <li><strong>Outlier Removal:</strong> Remove impossible speeds</li>
  <li><strong>Feature Extraction:</strong>
    <ul>
      <li>Time of day, day of week</li>
      <li>Traffic conditions</li>
      <li>Historical average speed</li>
    </ul>
  </li>
  <li><strong>Validation:</strong> Check for data drift</li>
</ol>

<p><strong>Latency:</strong> &lt; 100ms for real-time predictions</p>

<h3 id="google-search-ranking-data-pipeline">Google: Search Ranking Data Pipeline</h3>

<p><strong>Scale:</strong> Process billions of queries and web pages</p>

<p><strong>Preprocessing steps:</strong></p>
<ol>
  <li><strong>Query normalization:</strong> Lowercasing, tokenization, spelling correction</li>
  <li><strong>Feature extraction from documents:</strong>
    <ul>
      <li>PageRank scores</li>
      <li>Content embeddings (BERT)</li>
      <li>Click-through rate (CTR) features</li>
    </ul>
  </li>
  <li><strong>User context features:</strong>
    <ul>
      <li>Location</li>
      <li>Device type</li>
      <li>Search history embeddings</li>
    </ul>
  </li>
  <li><strong>Join multiple data sources:</strong>
    <ul>
      <li>User profile data</li>
      <li>Document metadata</li>
      <li>Real-time signals (freshness)</li>
    </ul>
  </li>
</ol>

<p><strong>Key insight:</strong> Distributed processing using MapReduce/Dataflow for petabyte-scale data.</p>

<hr />

<h2 id="distributed-preprocessing-with-spark">Distributed Preprocessing with Spark</h2>

<p>When data doesn’t fit on one machine, use distributed frameworks.</p>

<h3 id="spark-preprocessing-pipeline">Spark Preprocessing Pipeline</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>
<span class="kn">from</span> <span class="n">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">col</span><span class="p">,</span> <span class="n">when</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">stddev</span><span class="p">,</span> <span class="n">count</span>
<span class="kn">from</span> <span class="n">pyspark.ml.feature</span> <span class="kn">import</span> <span class="n">VectorAssembler</span><span class="p">,</span> <span class="n">StandardScaler</span>
<span class="kn">from</span> <span class="n">pyspark.ml</span> <span class="kn">import</span> <span class="n">Pipeline</span>

<span class="k">class</span> <span class="nc">DistributedPreprocessor</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Large-scale preprocessing using Apache Spark
    
    Use case: Process 1TB+ data across cluster
    </span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">spark</span> <span class="o">=</span> <span class="n">SparkSession</span><span class="p">.</span><span class="n">builder</span> \\
            <span class="p">.</span><span class="nf">appName</span><span class="p">(</span><span class="sh">"</span><span class="s">MLPreprocessing</span><span class="sh">"</span><span class="p">)</span> \\
            <span class="p">.</span><span class="nf">getOrCreate</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">load_data</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="sh">'</span><span class="s">parquet</span><span class="sh">'</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Load data from distributed storage</span><span class="sh">"""</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">spark</span><span class="p">.</span><span class="n">read</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="nb">format</span><span class="p">).</span><span class="nf">load</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">clean_data</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Distributed data cleaning</span><span class="sh">"""</span>
        
        <span class="c1"># Remove nulls
</span>        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">user_id</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">timestamp</span><span class="sh">'</span><span class="p">])</span>
        
        <span class="c1"># Handle outliers (clip at 99th percentile)
</span>        <span class="k">for</span> <span class="n">col_name</span> <span class="ow">in</span> <span class="p">[</span><span class="sh">'</span><span class="s">price</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">quantity</span><span class="sh">'</span><span class="p">]:</span>
            <span class="n">quantile_99</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">approxQuantile</span><span class="p">(</span><span class="n">col_name</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.99</span><span class="p">],</span> <span class="mf">0.01</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span>
                <span class="n">col_name</span><span class="p">,</span>
                <span class="nf">when</span><span class="p">(</span><span class="nf">col</span><span class="p">(</span><span class="n">col_name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">quantile_99</span><span class="p">,</span> <span class="n">quantile_99</span><span class="p">).</span><span class="nf">otherwise</span><span class="p">(</span><span class="nf">col</span><span class="p">(</span><span class="n">col_name</span><span class="p">))</span>
            <span class="p">)</span>
        
        <span class="c1"># Remove duplicates
</span>        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">dropDuplicates</span><span class="p">([</span><span class="sh">'</span><span class="s">user_id</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">item_id</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">timestamp</span><span class="sh">'</span><span class="p">])</span>
        
        <span class="k">return</span> <span class="n">df</span>
    
    <span class="k">def</span> <span class="nf">feature_engineering</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Distributed feature engineering</span><span class="sh">"""</span>
        
        <span class="c1"># Time-based features
</span>        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">'</span><span class="s">hour</span><span class="sh">'</span><span class="p">,</span> <span class="nf">hour</span><span class="p">(</span><span class="nf">col</span><span class="p">(</span><span class="sh">'</span><span class="s">timestamp</span><span class="sh">'</span><span class="p">)))</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">'</span><span class="s">day_of_week</span><span class="sh">'</span><span class="p">,</span> <span class="nf">dayofweek</span><span class="p">(</span><span class="nf">col</span><span class="p">(</span><span class="sh">'</span><span class="s">timestamp</span><span class="sh">'</span><span class="p">)))</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">'</span><span class="s">is_weekend</span><span class="sh">'</span><span class="p">,</span> 
                          <span class="nf">when</span><span class="p">(</span><span class="nf">col</span><span class="p">(</span><span class="sh">'</span><span class="s">day_of_week</span><span class="sh">'</span><span class="p">).</span><span class="nf">isin</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">]),</span> <span class="mi">1</span><span class="p">).</span><span class="nf">otherwise</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        
        <span class="c1"># Aggregation features (window functions)
</span>        <span class="kn">from</span> <span class="n">pyspark.sql.window</span> <span class="kn">import</span> <span class="n">Window</span>
        
        <span class="c1"># User's average purchase price (last 30 days)
</span>        <span class="n">window_30d</span> <span class="o">=</span> <span class="n">Window</span><span class="p">.</span><span class="nf">partitionBy</span><span class="p">(</span><span class="sh">'</span><span class="s">user_id</span><span class="sh">'</span><span class="p">)</span> \\
                          <span class="p">.</span><span class="nf">orderBy</span><span class="p">(</span><span class="nf">col</span><span class="p">(</span><span class="sh">'</span><span class="s">timestamp</span><span class="sh">'</span><span class="p">).</span><span class="nf">cast</span><span class="p">(</span><span class="sh">'</span><span class="s">long</span><span class="sh">'</span><span class="p">))</span> \\
                          <span class="p">.</span><span class="nf">rangeBetween</span><span class="p">(</span><span class="o">-</span><span class="mi">30</span><span class="o">*</span><span class="mi">24</span><span class="o">*</span><span class="mi">3600</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">'</span><span class="s">user_avg_price_30d</span><span class="sh">'</span><span class="p">,</span> 
                          <span class="nf">avg</span><span class="p">(</span><span class="sh">'</span><span class="s">price</span><span class="sh">'</span><span class="p">).</span><span class="nf">over</span><span class="p">(</span><span class="n">window_30d</span><span class="p">))</span>
        
        <span class="k">return</span> <span class="n">df</span>
    
    <span class="k">def</span> <span class="nf">normalize_features</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">numeric_cols</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Normalize numeric features</span><span class="sh">"""</span>
        
        <span class="c1"># Assemble features into vector
</span>        <span class="n">assembler</span> <span class="o">=</span> <span class="nc">VectorAssembler</span><span class="p">(</span>
            <span class="n">inputCols</span><span class="o">=</span><span class="n">numeric_cols</span><span class="p">,</span>
            <span class="n">outputCol</span><span class="o">=</span><span class="sh">'</span><span class="s">features_raw</span><span class="sh">'</span>
        <span class="p">)</span>
        
        <span class="c1"># Standard scaling
</span>        <span class="n">scaler</span> <span class="o">=</span> <span class="nc">StandardScaler</span><span class="p">(</span>
            <span class="n">inputCol</span><span class="o">=</span><span class="sh">'</span><span class="s">features_raw</span><span class="sh">'</span><span class="p">,</span>
            <span class="n">outputCol</span><span class="o">=</span><span class="sh">'</span><span class="s">features_scaled</span><span class="sh">'</span><span class="p">,</span>
            <span class="n">withMean</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="n">withStd</span><span class="o">=</span><span class="bp">True</span>
        <span class="p">)</span>
        
        <span class="c1"># Create pipeline
</span>        <span class="n">pipeline</span> <span class="o">=</span> <span class="nc">Pipeline</span><span class="p">(</span><span class="n">stages</span><span class="o">=</span><span class="p">[</span><span class="n">assembler</span><span class="p">,</span> <span class="n">scaler</span><span class="p">])</span>
        
        <span class="c1"># Fit and transform
</span>        <span class="n">model</span> <span class="o">=</span> <span class="n">pipeline</span><span class="p">.</span><span class="nf">fit</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="nf">transform</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">df</span><span class="p">,</span> <span class="n">model</span>
    
    <span class="k">def</span> <span class="nf">save_preprocessed</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">model_path</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Save preprocessed data and fitted model</span><span class="sh">"""</span>
        
        <span class="c1"># Save data (partitioned for efficiency)
</span>        <span class="n">df</span><span class="p">.</span><span class="n">write</span><span class="p">.</span><span class="nf">mode</span><span class="p">(</span><span class="sh">'</span><span class="s">overwrite</span><span class="sh">'</span><span class="p">)</span> \\
          <span class="p">.</span><span class="nf">partitionBy</span><span class="p">(</span><span class="sh">'</span><span class="s">date</span><span class="sh">'</span><span class="p">)</span> \\
          <span class="p">.</span><span class="nf">parquet</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
        
        <span class="c1"># Save preprocessing model for serving
</span>        <span class="c1"># model.save(model_path)
</span>
<span class="c1"># Usage
</span><span class="n">preprocessor</span> <span class="o">=</span> <span class="nc">DistributedPreprocessor</span><span class="p">()</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">preprocessor</span><span class="p">.</span><span class="nf">load_data</span><span class="p">(</span><span class="sh">'</span><span class="s">s3://bucket/raw_data/</span><span class="sh">'</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">preprocessor</span><span class="p">.</span><span class="nf">clean_data</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">preprocessor</span><span class="p">.</span><span class="nf">feature_engineering</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<span class="n">df</span><span class="p">,</span> <span class="n">model</span> <span class="o">=</span> <span class="n">preprocessor</span><span class="p">.</span><span class="nf">normalize_features</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="p">[</span><span class="sh">'</span><span class="s">price</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">quantity</span><span class="sh">'</span><span class="p">])</span>
<span class="n">preprocessor</span><span class="p">.</span><span class="nf">save_preprocessed</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="sh">'</span><span class="s">s3://bucket/processed/</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">s3://bucket/models/</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div>

<hr />

<h2 id="advanced-feature-engineering-patterns">Advanced Feature Engineering Patterns</h2>

<h3 id="1-time-series-features">1. Time-Series Features</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">TimeSeriesFeatureExtractor</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Extract features from time-series data
    
    Use case: User engagement over time, sensor readings, stock prices
    </span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">extract_lag_features</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">value_col</span><span class="p">,</span> <span class="n">lag_periods</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">30</span><span class="p">]):</span>
        <span class="sh">"""</span><span class="s">Create lagged features</span><span class="sh">"""</span>
        <span class="k">for</span> <span class="n">lag</span> <span class="ow">in</span> <span class="n">lag_periods</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="sh">'</span><span class="si">{</span><span class="n">value_col</span><span class="si">}</span><span class="s">_lag_</span><span class="si">{</span><span class="n">lag</span><span class="si">}</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">groupby</span><span class="p">(</span><span class="sh">'</span><span class="s">user_id</span><span class="sh">'</span><span class="p">)[</span><span class="n">value_col</span><span class="p">].</span><span class="nf">shift</span><span class="p">(</span><span class="n">lag</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span>
    
    <span class="k">def</span> <span class="nf">extract_rolling_statistics</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">value_col</span><span class="p">,</span> <span class="n">windows</span><span class="o">=</span><span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">30</span><span class="p">]):</span>
        <span class="sh">"""</span><span class="s">Rolling mean, std, min, max</span><span class="sh">"""</span>
        <span class="k">for</span> <span class="n">window</span> <span class="ow">in</span> <span class="n">windows</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="sh">'</span><span class="si">{</span><span class="n">value_col</span><span class="si">}</span><span class="s">_rolling_mean_</span><span class="si">{</span><span class="n">window</span><span class="si">}</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> \\
                <span class="n">df</span><span class="p">.</span><span class="nf">groupby</span><span class="p">(</span><span class="sh">'</span><span class="s">user_id</span><span class="sh">'</span><span class="p">)[</span><span class="n">value_col</span><span class="p">].</span><span class="nf">transform</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">.</span><span class="nf">rolling</span><span class="p">(</span><span class="n">window</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">1</span><span class="p">).</span><span class="nf">mean</span><span class="p">()</span>
                <span class="p">)</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="sh">'</span><span class="si">{</span><span class="n">value_col</span><span class="si">}</span><span class="s">_rolling_std_</span><span class="si">{</span><span class="n">window</span><span class="si">}</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> \\
                <span class="n">df</span><span class="p">.</span><span class="nf">groupby</span><span class="p">(</span><span class="sh">'</span><span class="s">user_id</span><span class="sh">'</span><span class="p">)[</span><span class="n">value_col</span><span class="p">].</span><span class="nf">transform</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">.</span><span class="nf">rolling</span><span class="p">(</span><span class="n">window</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">1</span><span class="p">).</span><span class="nf">std</span><span class="p">()</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span>
    
    <span class="k">def</span> <span class="nf">extract_trend_features</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">value_col</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Trend: difference from moving average
        </span><span class="sh">"""</span>
        <span class="n">df</span><span class="p">[</span><span class="sh">'</span><span class="s">rolling_mean_7</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">groupby</span><span class="p">(</span><span class="sh">'</span><span class="s">user_id</span><span class="sh">'</span><span class="p">)[</span><span class="n">value_col</span><span class="p">].</span><span class="nf">transform</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">.</span><span class="nf">rolling</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">1</span><span class="p">).</span><span class="nf">mean</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="sh">'</span><span class="si">{</span><span class="n">value_col</span><span class="si">}</span><span class="s">_trend</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">value_col</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="sh">'</span><span class="s">rolling_mean_7</span><span class="sh">'</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">df</span>
</code></pre></div></div>

<h3 id="2-interaction-features">2. Interaction Features</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">InteractionFeatureGenerator</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Create interaction features between variables
    
    Captures relationships not visible in individual features
    </span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">polynomial_features</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">degree</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Create polynomial features
        
        Example: x, y → x, y, x², y², xy
        </span><span class="sh">"""</span>
        <span class="kn">from</span> <span class="n">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">PolynomialFeatures</span>
        
        <span class="n">poly</span> <span class="o">=</span> <span class="nc">PolynomialFeatures</span><span class="p">(</span><span class="n">degree</span><span class="o">=</span><span class="n">degree</span><span class="p">,</span> <span class="n">include_bias</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">poly_features</span> <span class="o">=</span> <span class="n">poly</span><span class="p">.</span><span class="nf">fit_transform</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">cols</span><span class="p">])</span>
        
        <span class="n">feature_names</span> <span class="o">=</span> <span class="n">poly</span><span class="p">.</span><span class="nf">get_feature_names_out</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span>
        <span class="n">poly_df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">(</span><span class="n">poly_features</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">feature_names</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">pd</span><span class="p">.</span><span class="nf">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="n">poly_df</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">ratio_features</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">numerator_cols</span><span class="p">,</span> <span class="n">denominator_cols</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Create ratio features
        
        Example: revenue/cost, clicks/impressions (CTR)
        </span><span class="sh">"""</span>
        <span class="k">for</span> <span class="n">num_col</span> <span class="ow">in</span> <span class="n">numerator_cols</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">den_col</span> <span class="ow">in</span> <span class="n">denominator_cols</span><span class="p">:</span>
                <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="sh">'</span><span class="si">{</span><span class="n">num_col</span><span class="si">}</span><span class="s">_per_</span><span class="si">{</span><span class="n">den_col</span><span class="si">}</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">num_col</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">den_col</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1e-9</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span>
    
    <span class="k">def</span> <span class="nf">categorical_interactions</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">cat_cols</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Combine categorical variables
        
        Example: city=</span><span class="sh">'</span><span class="s">SF</span><span class="sh">'</span><span class="s">, category=</span><span class="sh">'</span><span class="s">Tech</span><span class="sh">'</span><span class="s"> → </span><span class="sh">'</span><span class="s">SF_Tech</span><span class="sh">'</span><span class="s">
        </span><span class="sh">"""</span>
        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">cat_cols</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="sh">'</span><span class="s">_</span><span class="sh">'</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">cat_cols</span><span class="p">)]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">cat_cols</span><span class="p">].</span><span class="nf">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">).</span><span class="nf">agg</span><span class="p">(</span><span class="sh">'</span><span class="s">_</span><span class="sh">'</span><span class="p">.</span><span class="n">join</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span>
</code></pre></div></div>

<h3 id="3-embedding-features">3. Embedding Features</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">EmbeddingFeatureGenerator</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Generate embedding features from high-cardinality categoricals
    
    Use case: user_id, item_id, text
    </span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">train_category_embeddings</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">category_col</span><span class="p">,</span> <span class="n">embedding_dim</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Train embeddings for categorical variable
        
        Uses skip-gram approach: predict co-occurring categories
        </span><span class="sh">"""</span>
        <span class="kn">from</span> <span class="n">gensim.models</span> <span class="kn">import</span> <span class="n">Word2Vec</span>
        
        <span class="c1"># Create sequences (e.g., user's purchase history)
</span>        <span class="n">sequences</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">groupby</span><span class="p">(</span><span class="sh">'</span><span class="s">user_id</span><span class="sh">'</span><span class="p">)[</span><span class="n">category_col</span><span class="p">].</span><span class="nf">apply</span><span class="p">(</span><span class="nb">list</span><span class="p">).</span><span class="nf">tolist</span><span class="p">()</span>
        
        <span class="c1"># Train Word2Vec
</span>        <span class="n">model</span> <span class="o">=</span> <span class="nc">Word2Vec</span><span class="p">(</span>
            <span class="n">sentences</span><span class="o">=</span><span class="n">sequences</span><span class="p">,</span>
            <span class="n">vector_size</span><span class="o">=</span><span class="n">embedding_dim</span><span class="p">,</span>
            <span class="n">window</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
            <span class="n">min_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">workers</span><span class="o">=</span><span class="mi">4</span>
        <span class="p">)</span>
        
        <span class="c1"># Get embeddings
</span>        <span class="n">embeddings</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">category</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="n">category_col</span><span class="p">].</span><span class="nf">unique</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">category</span> <span class="ow">in</span> <span class="n">model</span><span class="p">.</span><span class="n">wv</span><span class="p">:</span>
                <span class="n">embeddings</span><span class="p">[</span><span class="n">category</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="n">wv</span><span class="p">[</span><span class="n">category</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="n">embeddings</span>
    
    <span class="k">def</span> <span class="nf">text_to_embeddings</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">text_col</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="sh">'</span><span class="s">sentence-transformers</span><span class="sh">'</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Convert text to dense embeddings
        
        Use pre-trained models (BERT, etc.)
        </span><span class="sh">"""</span>
        <span class="kn">from</span> <span class="n">sentence_transformers</span> <span class="kn">import</span> <span class="n">SentenceTransformer</span>
        
        <span class="n">model</span> <span class="o">=</span> <span class="nc">SentenceTransformer</span><span class="p">(</span><span class="sh">'</span><span class="s">all-MiniLM-L6-v2</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">embeddings</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">text_col</span><span class="p">].</span><span class="nf">tolist</span><span class="p">())</span>
        
        <span class="c1"># Add as features
</span>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">embeddings</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="sh">'</span><span class="si">{</span><span class="n">text_col</span><span class="si">}</span><span class="s">_emb_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">embeddings</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="n">df</span>
</code></pre></div></div>

<hr />

<h2 id="handling-data-drift">Handling Data Drift</h2>

<p>Data distributions change over time - models degrade if not monitored.</p>

<h3 id="drift-detection">Drift Detection</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">scipy.stats</span> <span class="kn">import</span> <span class="n">ks_2samp</span><span class="p">,</span> <span class="n">chi2_contingency</span>

<span class="k">class</span> <span class="nc">DataDriftDetector</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Detect when data distribution changes
    </span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">reference_data</span><span class="p">:</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Args:
            reference_data: Historical </span><span class="sh">"</span><span class="s">good</span><span class="sh">"</span><span class="s"> data (training distribution)
        </span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="n">reference</span> <span class="o">=</span> <span class="n">reference_data</span>
    
    <span class="k">def</span> <span class="nf">detect_numerical_drift</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">current_data</span><span class="p">:</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.05</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Kolmogorov-Smirnov test for numerical columns
        
        Returns:
            (drifted: bool, p_value: float)
        </span><span class="sh">"""</span>
        <span class="n">ref_values</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">reference</span><span class="p">[</span><span class="n">col</span><span class="p">].</span><span class="nf">dropna</span><span class="p">()</span>
        <span class="n">curr_values</span> <span class="o">=</span> <span class="n">current_data</span><span class="p">[</span><span class="n">col</span><span class="p">].</span><span class="nf">dropna</span><span class="p">()</span>
        
        <span class="n">statistic</span><span class="p">,</span> <span class="n">p_value</span> <span class="o">=</span> <span class="nf">ks_2samp</span><span class="p">(</span><span class="n">ref_values</span><span class="p">,</span> <span class="n">curr_values</span><span class="p">)</span>
        
        <span class="n">drifted</span> <span class="o">=</span> <span class="n">p_value</span> <span class="o">&lt;</span> <span class="n">threshold</span>
        
        <span class="k">return</span> <span class="n">drifted</span><span class="p">,</span> <span class="n">p_value</span>
    
    <span class="k">def</span> <span class="nf">detect_categorical_drift</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">current_data</span><span class="p">:</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.05</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Chi-square test for categorical columns
        </span><span class="sh">"""</span>
        <span class="n">ref_dist</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">reference</span><span class="p">[</span><span class="n">col</span><span class="p">].</span><span class="nf">value_counts</span><span class="p">(</span><span class="n">normalize</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">curr_dist</span> <span class="o">=</span> <span class="n">current_data</span><span class="p">[</span><span class="n">col</span><span class="p">].</span><span class="nf">value_counts</span><span class="p">(</span><span class="n">normalize</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        
        <span class="c1"># Align distributions
</span>        <span class="n">all_categories</span> <span class="o">=</span> <span class="nf">set</span><span class="p">(</span><span class="n">ref_dist</span><span class="p">.</span><span class="n">index</span><span class="p">)</span> <span class="o">|</span> <span class="nf">set</span><span class="p">(</span><span class="n">curr_dist</span><span class="p">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">ref_counts</span> <span class="o">=</span> <span class="p">[</span><span class="n">ref_dist</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">cat</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">reference</span><span class="p">)</span> <span class="k">for</span> <span class="n">cat</span> <span class="ow">in</span> <span class="n">all_categories</span><span class="p">]</span>
        <span class="n">curr_counts</span> <span class="o">=</span> <span class="p">[</span><span class="n">curr_dist</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">cat</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="nf">len</span><span class="p">(</span><span class="n">current_data</span><span class="p">)</span> <span class="k">for</span> <span class="n">cat</span> <span class="ow">in</span> <span class="n">all_categories</span><span class="p">]</span>
        
        <span class="c1"># Chi-square test
</span>        <span class="n">contingency_table</span> <span class="o">=</span> <span class="p">[</span><span class="n">ref_counts</span><span class="p">,</span> <span class="n">curr_counts</span><span class="p">]</span>
        <span class="n">chi2</span><span class="p">,</span> <span class="n">p_value</span><span class="p">,</span> <span class="n">dof</span><span class="p">,</span> <span class="n">expected</span> <span class="o">=</span> <span class="nf">chi2_contingency</span><span class="p">(</span><span class="n">contingency_table</span><span class="p">)</span>
        
        <span class="n">drifted</span> <span class="o">=</span> <span class="n">p_value</span> <span class="o">&lt;</span> <span class="n">threshold</span>
        
        <span class="k">return</span> <span class="n">drifted</span><span class="p">,</span> <span class="n">p_value</span>
    
    <span class="k">def</span> <span class="nf">detect_all_drifts</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">current_data</span><span class="p">:</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Check all columns for drift
        </span><span class="sh">"""</span>
        <span class="n">drifts</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="c1"># Numerical columns
</span>        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">current_data</span><span class="p">.</span><span class="nf">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="p">.</span><span class="n">number</span><span class="p">]).</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">drifted</span><span class="p">,</span> <span class="n">p_value</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">detect_numerical_drift</span><span class="p">(</span><span class="n">current_data</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">drifted</span><span class="p">:</span>
                <span class="n">drifts</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">numerical</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">p_value</span><span class="sh">'</span><span class="p">:</span> <span class="n">p_value</span><span class="p">}</span>
        
        <span class="c1"># Categorical columns
</span>        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">current_data</span><span class="p">.</span><span class="nf">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">object</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">category</span><span class="sh">'</span><span class="p">]).</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">drifted</span><span class="p">,</span> <span class="n">p_value</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">detect_categorical_drift</span><span class="p">(</span><span class="n">current_data</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">drifted</span><span class="p">:</span>
                <span class="n">drifts</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">categorical</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">p_value</span><span class="sh">'</span><span class="p">:</span> <span class="n">p_value</span><span class="p">}</span>
        
        <span class="k">return</span> <span class="n">drifts</span>

<span class="c1"># Usage
</span><span class="n">detector</span> <span class="o">=</span> <span class="nc">DataDriftDetector</span><span class="p">(</span><span class="n">training_data</span><span class="p">)</span>
<span class="n">drifts</span> <span class="o">=</span> <span class="n">detector</span><span class="p">.</span><span class="nf">detect_all_drifts</span><span class="p">(</span><span class="n">current_production_data</span><span class="p">)</span>

<span class="k">if</span> <span class="n">drifts</span><span class="p">:</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">⚠️  Data drift detected in:</span><span class="sh">"</span><span class="p">,</span> <span class="n">drifts</span><span class="p">.</span><span class="nf">keys</span><span class="p">())</span>
    <span class="c1"># Trigger retraining or alert
</span></code></pre></div></div>

<hr />

<h2 id="production-best-practices">Production Best Practices</h2>

<h3 id="1-idempotency">1. Idempotency</h3>

<p>Ensure pipeline can be re-run safely without side effects.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">IdempotentPipeline</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Pipeline that can be safely re-run
    </span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">process_batch</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">batch_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">input_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Process a batch idempotently
        </span><span class="sh">"""</span>
        <span class="c1"># Check if already processed
</span>        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="nf">is_processed</span><span class="p">(</span><span class="n">batch_id</span><span class="p">):</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Batch </span><span class="si">{</span><span class="n">batch_id</span><span class="si">}</span><span class="s"> already processed, skipping</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="c1"># Process
</span>        <span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">input_path</span><span class="p">)</span>
        <span class="n">processed</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">transform</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        
        <span class="c1"># Write with batch ID
</span>        <span class="n">self</span><span class="p">.</span><span class="nf">save_with_checksum</span><span class="p">(</span><span class="n">processed</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">batch_id</span><span class="p">)</span>
        
        <span class="c1"># Mark as complete
</span>        <span class="n">self</span><span class="p">.</span><span class="nf">mark_processed</span><span class="p">(</span><span class="n">batch_id</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">is_processed</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">batch_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">Check if batch already processed</span><span class="sh">"""</span>
        <span class="c1"># Query metadata store
</span>        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">metadata_store</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">batch_id</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">mark_processed</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">batch_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Mark batch as processed</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="n">metadata_store</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">batch_id</span><span class="p">,</span> <span class="n">timestamp</span><span class="o">=</span><span class="n">datetime</span><span class="p">.</span><span class="nf">now</span><span class="p">())</span>
</code></pre></div></div>

<h3 id="2-data-versioning">2. Data Versioning</h3>

<p>Track versions of datasets and transformations.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">VersionedDataset</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Version datasets for reproducibility
    </span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">version</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Save versioned dataset
        
        Path: s3://bucket/{name}/{version}/data.parquet
        </span><span class="sh">"""</span>
        <span class="n">path</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">s3://bucket/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s">/</span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="s">/data.parquet</span><span class="sh">"</span>
        
        <span class="c1"># Save data
</span>        <span class="n">df</span><span class="p">.</span><span class="nf">to_parquet</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        
        <span class="c1"># Save metadata
</span>        <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">version</span><span class="sh">'</span><span class="p">:</span> <span class="n">version</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">timestamp</span><span class="sh">'</span><span class="p">:</span> <span class="n">datetime</span><span class="p">.</span><span class="nf">now</span><span class="p">().</span><span class="nf">isoformat</span><span class="p">(),</span>
            <span class="sh">'</span><span class="s">num_rows</span><span class="sh">'</span><span class="p">:</span> <span class="nf">len</span><span class="p">(</span><span class="n">df</span><span class="p">),</span>
            <span class="sh">'</span><span class="s">num_cols</span><span class="sh">'</span><span class="p">:</span> <span class="nf">len</span><span class="p">(</span><span class="n">df</span><span class="p">.</span><span class="n">columns</span><span class="p">),</span>
            <span class="sh">'</span><span class="s">schema</span><span class="sh">'</span><span class="p">:</span> <span class="n">df</span><span class="p">.</span><span class="n">dtypes</span><span class="p">.</span><span class="nf">to_dict</span><span class="p">(),</span>
            <span class="sh">'</span><span class="s">checksum</span><span class="sh">'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="nf">compute_checksum</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="p">}</span>
        
        <span class="n">self</span><span class="p">.</span><span class="nf">save_metadata</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">version</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">Load specific version</span><span class="sh">"""</span>
        <span class="n">path</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">s3://bucket/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s">/</span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="s">/data.parquet</span><span class="sh">"</span>
        <span class="k">return</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_parquet</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="3-lineage-tracking">3. Lineage Tracking</h3>

<p>Track data transformations for debugging and compliance.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">LineageTracker</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Track data lineage
    </span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">graph</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">record_transformation</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span> 
        <span class="n">input_datasets</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">output_dataset</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">transformation_code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">parameters</span><span class="p">:</span> <span class="n">Dict</span>
    <span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Record a transformation
        </span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="n">graph</span><span class="p">[</span><span class="n">output_dataset</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">inputs</span><span class="sh">'</span><span class="p">:</span> <span class="n">input_datasets</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">transformation</span><span class="sh">'</span><span class="p">:</span> <span class="n">transformation_code</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">parameters</span><span class="sh">'</span><span class="p">:</span> <span class="n">parameters</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">timestamp</span><span class="sh">'</span><span class="p">:</span> <span class="n">datetime</span><span class="p">.</span><span class="nf">now</span><span class="p">()</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">get_lineage</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">
        Get full lineage of a dataset
        
        Returns tree of upstream datasets and transformations
        </span><span class="sh">"""</span>
        <span class="k">if</span> <span class="n">dataset</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">graph</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">'</span><span class="s">dataset</span><span class="sh">'</span><span class="p">:</span> <span class="n">dataset</span><span class="p">,</span> <span class="sh">'</span><span class="s">inputs</span><span class="sh">'</span><span class="p">:</span> <span class="p">[]}</span>
        
        <span class="n">node</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">graph</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">dataset</span><span class="sh">'</span><span class="p">:</span> <span class="n">dataset</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">transformation</span><span class="sh">'</span><span class="p">:</span> <span class="n">node</span><span class="p">[</span><span class="sh">'</span><span class="s">transformation</span><span class="sh">'</span><span class="p">],</span>
            <span class="sh">'</span><span class="s">inputs</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="nf">get_lineage</span><span class="p">(</span><span class="n">inp</span><span class="p">)</span> <span class="k">for</span> <span class="n">inp</span> <span class="ow">in</span> <span class="n">node</span><span class="p">[</span><span class="sh">'</span><span class="s">inputs</span><span class="sh">'</span><span class="p">]]</span>
        <span class="p">}</span>
</code></pre></div></div>

<hr />

<h2 id="common-preprocessing-challenges--solutions">Common Preprocessing Challenges &amp; Solutions</h2>

<h3 id="challenge-1-imbalanced-classes">Challenge 1: Imbalanced Classes</h3>

<p><strong>Problem:</strong> 95% of samples are class 0, 5% are class 1. Model always predicts class 0.</p>

<p><strong>Solutions:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ImbalanceHandler</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Handle class imbalance
    </span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">upsample_minority</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">target_col</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Oversample minority class
        </span><span class="sh">"""</span>
        <span class="kn">from</span> <span class="n">sklearn.utils</span> <span class="kn">import</span> <span class="n">resample</span>
        
        <span class="c1"># Separate majority and minority classes
</span>        <span class="n">df_majority</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">target_col</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">df_minority</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">target_col</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
        
        <span class="c1"># Upsample minority class
</span>        <span class="n">df_minority_upsampled</span> <span class="o">=</span> <span class="nf">resample</span><span class="p">(</span>
            <span class="n">df_minority</span><span class="p">,</span>
            <span class="n">replace</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>  <span class="c1"># Sample with replacement
</span>            <span class="n">n_samples</span><span class="o">=</span><span class="nf">len</span><span class="p">(</span><span class="n">df_majority</span><span class="p">),</span>  <span class="c1"># Match majority class size
</span>            <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
        <span class="p">)</span>
        
        <span class="c1"># Combine
</span>        <span class="n">df_balanced</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">concat</span><span class="p">([</span><span class="n">df_majority</span><span class="p">,</span> <span class="n">df_minority_upsampled</span><span class="p">])</span>
        
        <span class="k">return</span> <span class="n">df_balanced</span>
    
    <span class="k">def</span> <span class="nf">downsample_majority</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">target_col</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Undersample majority class
        </span><span class="sh">"""</span>
        <span class="n">df_majority</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">target_col</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">df_minority</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">target_col</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
        
        <span class="c1"># Downsample majority class
</span>        <span class="n">df_majority_downsampled</span> <span class="o">=</span> <span class="nf">resample</span><span class="p">(</span>
            <span class="n">df_majority</span><span class="p">,</span>
            <span class="n">replace</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
            <span class="n">n_samples</span><span class="o">=</span><span class="nf">len</span><span class="p">(</span><span class="n">df_minority</span><span class="p">),</span>
            <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
        <span class="p">)</span>
        
        <span class="n">df_balanced</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">concat</span><span class="p">([</span><span class="n">df_majority_downsampled</span><span class="p">,</span> <span class="n">df_minority</span><span class="p">])</span>
        
        <span class="k">return</span> <span class="n">df_balanced</span>
    
    <span class="k">def</span> <span class="nf">smote</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Synthetic Minority Over-sampling Technique
        
        Generate synthetic samples for minority class
        </span><span class="sh">"""</span>
        <span class="kn">from</span> <span class="n">imblearn.over_sampling</span> <span class="kn">import</span> <span class="n">SMOTE</span>
        
        <span class="n">smote</span> <span class="o">=</span> <span class="nc">SMOTE</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
        <span class="n">X_resampled</span><span class="p">,</span> <span class="n">y_resampled</span> <span class="o">=</span> <span class="n">smote</span><span class="p">.</span><span class="nf">fit_resample</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">X_resampled</span><span class="p">,</span> <span class="n">y_resampled</span>
</code></pre></div></div>

<h3 id="challenge-2-high-cardinality-categoricals">Challenge 2: High-Cardinality Categoricals</h3>

<p><strong>Problem:</strong> User IDs have 10M unique values. One-hot encoding creates 10M columns.</p>

<p><strong>Solutions:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">HighCardinalityEncoder</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Handle high-cardinality categorical features
    </span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">target_encoding</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">cat_col</span><span class="p">,</span> <span class="n">target_col</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Encode category by mean of target
        
        Example:
          city=</span><span class="sh">'</span><span class="s">SF</span><span class="sh">'</span><span class="s"> → mean(target | city=</span><span class="sh">'</span><span class="s">SF</span><span class="sh">'</span><span class="s">) = 0.65
          city=</span><span class="sh">'</span><span class="s">NY</span><span class="sh">'</span><span class="s"> → mean(target | city=</span><span class="sh">'</span><span class="s">NY</span><span class="sh">'</span><span class="s">) = 0.52
        
        Warning: Risk of overfitting. Use cross-validation encoding.
        </span><span class="sh">"""</span>
        <span class="c1"># Compute target mean per category
</span>        <span class="n">target_means</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">groupby</span><span class="p">(</span><span class="n">cat_col</span><span class="p">)[</span><span class="n">target_col</span><span class="p">].</span><span class="nf">mean</span><span class="p">()</span>
        
        <span class="c1"># Map
</span>        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="sh">'</span><span class="si">{</span><span class="n">cat_col</span><span class="si">}</span><span class="s">_target_enc</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">cat_col</span><span class="p">].</span><span class="nf">map</span><span class="p">(</span><span class="n">target_means</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">df</span>
    
    <span class="k">def</span> <span class="nf">frequency_encoding</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">cat_col</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Encode by frequency
        
        Common categories → higher values
        </span><span class="sh">"""</span>
        <span class="n">freq</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">cat_col</span><span class="p">].</span><span class="nf">value_counts</span><span class="p">(</span><span class="n">normalize</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="sh">'</span><span class="si">{</span><span class="n">cat_col</span><span class="si">}</span><span class="s">_freq</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">cat_col</span><span class="p">].</span><span class="nf">map</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">df</span>
    
    <span class="k">def</span> <span class="nf">hashing_trick</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">cat_col</span><span class="p">,</span> <span class="n">n_features</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Hash categories into fixed number of buckets
        
        Pros: Fixed dimension
        Cons: Hash collisions
        </span><span class="sh">"""</span>
        <span class="kn">from</span> <span class="n">sklearn.feature_extraction</span> <span class="kn">import</span> <span class="n">FeatureHasher</span>
        
        <span class="n">hasher</span> <span class="o">=</span> <span class="nc">FeatureHasher</span><span class="p">(</span><span class="n">n_features</span><span class="o">=</span><span class="n">n_features</span><span class="p">,</span> <span class="n">input_type</span><span class="o">=</span><span class="sh">'</span><span class="s">string</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">hashed</span> <span class="o">=</span> <span class="n">hasher</span><span class="p">.</span><span class="nf">transform</span><span class="p">(</span><span class="n">df</span><span class="p">[[</span><span class="n">cat_col</span><span class="p">]].</span><span class="nf">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">).</span><span class="n">values</span><span class="p">)</span>
        
        <span class="c1"># Convert to DataFrame
</span>        <span class="n">hashed_df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">(</span>
            <span class="n">hashed</span><span class="p">.</span><span class="nf">toarray</span><span class="p">(),</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="sh">'</span><span class="si">{</span><span class="n">cat_col</span><span class="si">}</span><span class="s">_hash_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="sh">'</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">n_features</span><span class="p">)]</span>
        <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">pd</span><span class="p">.</span><span class="nf">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="n">hashed_df</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="challenge-3-streaming-data-preprocessing">Challenge 3: Streaming Data Preprocessing</h3>

<p><strong>Problem:</strong> Need to preprocess real-time streams with low latency.</p>

<p><strong>Solution:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">kafka</span> <span class="kn">import</span> <span class="n">KafkaConsumer</span><span class="p">,</span> <span class="n">KafkaProducer</span>
<span class="kn">import</span> <span class="n">json</span>

<span class="k">class</span> <span class="nc">StreamingPreprocessor</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Real-time preprocessing for streaming data
    </span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">consumer</span> <span class="o">=</span> <span class="nc">KafkaConsumer</span><span class="p">(</span>
            <span class="sh">'</span><span class="s">raw_events</span><span class="sh">'</span><span class="p">,</span>
            <span class="n">bootstrap_servers</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">localhost:9092</span><span class="sh">'</span><span class="p">],</span>
            <span class="n">value_deserializer</span><span class="o">=</span><span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">'</span><span class="s">utf-8</span><span class="sh">'</span><span class="p">))</span>
        <span class="p">)</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">producer</span> <span class="o">=</span> <span class="nc">KafkaProducer</span><span class="p">(</span>
            <span class="n">bootstrap_servers</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">localhost:9092</span><span class="sh">'</span><span class="p">],</span>
            <span class="n">value_serializer</span><span class="o">=</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">v</span><span class="p">).</span><span class="nf">encode</span><span class="p">(</span><span class="sh">'</span><span class="s">utf-8</span><span class="sh">'</span><span class="p">)</span>
        <span class="p">)</span>
        
        <span class="c1"># Load fitted preprocessor (from training)
</span>        <span class="n">self</span><span class="p">.</span><span class="n">preprocessor</span> <span class="o">=</span> <span class="n">PreprocessorV1</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="sh">'</span><span class="s">models/preprocessor_v1.pkl</span><span class="sh">'</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">process_stream</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Process events in real-time
        </span><span class="sh">"""</span>
        <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">consumer</span><span class="p">:</span>
            <span class="n">event</span> <span class="o">=</span> <span class="n">message</span><span class="p">.</span><span class="n">value</span>
            
            <span class="c1"># Preprocess
</span>            <span class="n">processed</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">preprocess_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            
            <span class="c1"># Validate
</span>            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="nf">validate</span><span class="p">(</span><span class="n">processed</span><span class="p">):</span>
                <span class="c1"># Send to processed topic
</span>                <span class="n">self</span><span class="p">.</span><span class="n">producer</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="sh">'</span><span class="s">processed_events</span><span class="sh">'</span><span class="p">,</span> <span class="n">processed</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">preprocess_event</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Preprocess single event (must be fast!)
        </span><span class="sh">"""</span>
        <span class="c1"># Convert to DataFrame
</span>        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">([</span><span class="n">event</span><span class="p">])</span>
        
        <span class="c1"># Apply preprocessing
</span>        <span class="n">df</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">preprocessor</span><span class="p">.</span><span class="nf">transform</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        
        <span class="c1"># Convert back to dict
</span>        <span class="k">return</span> <span class="n">df</span><span class="p">.</span><span class="nf">to_dict</span><span class="p">(</span><span class="sh">'</span><span class="s">records</span><span class="sh">'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Quick validation</span><span class="sh">"""</span>
        <span class="n">required_fields</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">user_id</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">timestamp</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">features</span><span class="sh">'</span><span class="p">]</span>
        <span class="k">return</span> <span class="nf">all</span><span class="p">(</span><span class="n">field</span> <span class="ow">in</span> <span class="n">event</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">required_fields</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="challenge-4-privacy--compliance-gdpr-ccpa">Challenge 4: Privacy &amp; Compliance (GDPR, CCPA)</h3>

<p><strong>Problem:</strong> Need to handle PII (Personally Identifiable Information).</p>

<p><strong>Solutions:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">hashlib</span>

<span class="k">class</span> <span class="nc">PrivacyPreserver</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Handle PII in preprocessing
    </span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">anonymize_user_ids</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">id_col</span><span class="o">=</span><span class="sh">'</span><span class="s">user_id</span><span class="sh">'</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Hash user IDs to anonymize
        </span><span class="sh">"""</span>
        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="sh">'</span><span class="si">{</span><span class="n">id_col</span><span class="si">}</span><span class="s">_anonymized</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">id_col</span><span class="p">].</span><span class="nf">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">hashlib</span><span class="p">.</span><span class="nf">sha256</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">x</span><span class="p">).</span><span class="nf">encode</span><span class="p">()).</span><span class="nf">hexdigest</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">df</span><span class="p">.</span><span class="nf">drop</span><span class="p">(</span><span class="n">id_col</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span>
    
    <span class="k">def</span> <span class="nf">remove_pii</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">pii_cols</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">email</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">phone</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">address</span><span class="sh">'</span><span class="p">]):</span>
        <span class="sh">"""</span><span class="s">
        Remove PII columns
        </span><span class="sh">"""</span>
        <span class="n">df</span><span class="p">.</span><span class="nf">drop</span><span class="p">(</span><span class="n">pii_cols</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="sh">'</span><span class="s">ignore</span><span class="sh">'</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span>
    
    <span class="k">def</span> <span class="nf">differential_privacy_noise</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">numeric_cols</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Add Laplacian noise for differential privacy
        
        Args:
            epsilon: Privacy parameter (lower = more privacy, less utility)
        </span><span class="sh">"""</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">numeric_cols</span><span class="p">:</span>
            <span class="n">sensitivity</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">].</span><span class="nf">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">].</span><span class="nf">min</span><span class="p">()</span>
            <span class="n">noise_scale</span> <span class="o">=</span> <span class="n">sensitivity</span> <span class="o">/</span> <span class="n">epsilon</span>
            
            <span class="n">noise</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">laplace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">noise_scale</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="nf">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>
            <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">+</span> <span class="n">noise</span>
        
        <span class="k">return</span> <span class="n">df</span>
</code></pre></div></div>

<hr />

<h2 id="performance-optimization">Performance Optimization</h2>

<h3 id="1-parallelize-transformations">1. Parallelize Transformations</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">multiprocessing</span> <span class="kn">import</span> <span class="n">Pool</span>
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>

<span class="k">class</span> <span class="nc">ParallelPreprocessor</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Parallelize preprocessing across CPU cores
    </span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">n_workers</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">n_workers</span> <span class="o">=</span> <span class="n">n_workers</span>
    
    <span class="k">def</span> <span class="nf">process_parallel</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">transform_fn</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Apply transformation in parallel
        </span><span class="sh">"""</span>
        <span class="c1"># Split dataframe into chunks
</span>        <span class="n">chunks</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array_split</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">n_workers</span><span class="p">)</span>
        
        <span class="c1"># Process chunks in parallel
</span>        <span class="k">with</span> <span class="nc">Pool</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">n_workers</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
            <span class="n">processed_chunks</span> <span class="o">=</span> <span class="n">pool</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="n">transform_fn</span><span class="p">,</span> <span class="n">chunks</span><span class="p">)</span>
        
        <span class="c1"># Combine results
</span>        <span class="k">return</span> <span class="n">pd</span><span class="p">.</span><span class="nf">concat</span><span class="p">(</span><span class="n">processed_chunks</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="2-use-efficient-data-formats">2. Use Efficient Data Formats</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Bad: CSV (slow to read/write, no compression)
</span><span class="n">df</span><span class="p">.</span><span class="nf">to_csv</span><span class="p">(</span><span class="sh">'</span><span class="s">data.csv</span><span class="sh">'</span><span class="p">)</span>  <span class="c1"># 1 GB file, 60 seconds
</span>
<span class="c1"># Better: Parquet (columnar, compressed)
</span><span class="n">df</span><span class="p">.</span><span class="nf">to_parquet</span><span class="p">(</span><span class="sh">'</span><span class="s">data.parquet</span><span class="sh">'</span><span class="p">)</span>  <span class="c1"># 200 MB file, 5 seconds
</span>
<span class="c1"># Best for streaming: Avro or Protocol Buffers
</span></code></pre></div></div>

<h3 id="3-cache-intermediate-results">3. Cache Intermediate Results</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">CachedPreprocessor</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Cache preprocessing results
    </span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cache_dir</span><span class="o">=</span><span class="sh">'</span><span class="s">./cache</span><span class="sh">'</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cache_dir</span> <span class="o">=</span> <span class="n">cache_dir</span>
    
    <span class="k">def</span> <span class="nf">process_with_cache</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">batch_id</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Check cache before processing
        </span><span class="sh">"""</span>
        <span class="n">cache_path</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">cache_dir</span><span class="si">}</span><span class="s">/</span><span class="si">{</span><span class="n">batch_id</span><span class="si">}</span><span class="s">.parquet</span><span class="sh">"</span>
        
        <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">cache_path</span><span class="p">):</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Loading from cache: </span><span class="si">{</span><span class="n">batch_id</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_parquet</span><span class="p">(</span><span class="n">cache_path</span><span class="p">)</span>
        
        <span class="c1"># Process
</span>        <span class="n">processed</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">preprocess</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        
        <span class="c1"># Save to cache
</span>        <span class="n">processed</span><span class="p">.</span><span class="nf">to_parquet</span><span class="p">(</span><span class="n">cache_path</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">processed</span>
</code></pre></div></div>

<hr />

<h2 id="key-takeaways">Key Takeaways</h2>

<p>✅ <strong>Data quality is critical</strong> - bad data → bad models<br />
✅ <strong>Schema validation</strong> catches errors early before expensive processing<br />
✅ <strong>Handle missing values</strong> with domain-appropriate strategies (mean/median/forward-fill)<br />
✅ <strong>Feature engineering</strong> is where domain knowledge creates value<br />
✅ <strong>Prevent training/serving skew</strong> with unified preprocessing code<br />
✅ <strong>Monitor data quality</strong> continuously - detect drift and anomalies<br />
✅ <strong>Use feature stores</strong> for consistency and reuse at scale<br />
✅ <strong>Distributed processing</strong> (Spark/Beam) required for large-scale data<br />
✅ <strong>Version datasets and transformations</strong> for reproducibility<br />
✅ <strong>Track data lineage</strong> for debugging and compliance<br />
✅ <strong>Handle class imbalance</strong> with resampling or SMOTE<br />
✅ <strong>Encode high-cardinality categoricals</strong> with target/frequency encoding or hashing<br />
✅ <strong>Optimize performance</strong> with parallel processing, efficient formats, caching</p>

<hr />

<p><strong>Originally published at:</strong> <a href="https://www.arunbaby.com/ml-system-design/0003-data-preprocessing/">arunbaby.com/ml-system-design/0003-data-preprocessing</a></p>

<p><em>If you found this helpful, consider sharing it with others who might benefit.</em></p>


        
      </section>

      <footer class="page__meta">
        
        
  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      <a href="/tags/#data-preprocessing" class="page__taxonomy-item p-category" rel="tag">data-preprocessing</a><span class="sep">, </span>
    
      <a href="/tags/#data-quality" class="page__taxonomy-item p-category" rel="tag">data-quality</a><span class="sep">, </span>
    
      <a href="/tags/#feature-engineering" class="page__taxonomy-item p-category" rel="tag">feature-engineering</a>
    
    </span>
  </p>




  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      <a href="/categories/#ml-system-design" class="page__taxonomy-item p-category" rel="tag">ml-system-design</a>
    
    </span>
  </p>


        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time class="dt-published" datetime="2025-10-14T11:35:35+05:30">October 14, 2025</time></p>

      </footer>

      <section class="page__share">
  <h4 class="page__share-title">Share on</h4>

  <a href="https://twitter.com/intent/tweet?via=arunbaby0&text=Data+Preprocessing+Pipeline+Design%20https%3A%2F%2Fwww.arunbaby.com%2Fml-system-design%2F0003-data-preprocessing%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fwww.arunbaby.com%2Fml-system-design%2F0003-data-preprocessing%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://www.arunbaby.com/ml-system-design/0003-data-preprocessing/" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/ml-system-design/0002-classification-pipeline/" class="pagination--pager" title="Classification Pipeline Design">Previous</a>
    
    
      <a href="/ml-system-design/0004-ab-testing-systems/" class="pagination--pager" title="A/B Testing Systems for ML">Next</a>
    
  </nav>


    </div>

    
  </article>

  
  
</div>

      
    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';" role="search">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    
      
        
          <li><a href="https://twitter.com/arunbaby0" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
        
      
        
          <li><a href="https://github.com/arunbaby0" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
        
          <li><a href="https://www.linkedin.com/in/arunbaby0/" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i> LinkedIn</a></li>
        
      
        
          <li><a href="https://scholar.google.co.in/citations?user=6fSYWhkAAAAJ" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-graduation-cap" aria-hidden="true"></i> Google Scholar</a></li>
        
      
    

    
      <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 1990 - 2143 <a href="https://www.arunbaby.com">Arun Baby</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>




  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-0JRJPEC9SS"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-0JRJPEC9SS', { 'anonymize_ip': false});
</script>








  </body>
</html>
