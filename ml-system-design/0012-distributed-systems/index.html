<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.26.2 by Michael Rose
  Copyright 2013-2024 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->

<html lang="en-US" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Distributed ML Systems - Arun Baby</title>
<meta name="description" content="Design distributed ML systems that scale to billions of predictions: Master replication, sharding, consensus, and fault tolerance for production ML.">


  <meta name="author" content="Arun Baby">
  
  <meta property="article:author" content="Arun Baby">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Arun Baby">
<meta property="og:title" content="Distributed ML Systems">
<meta property="og:url" content="https://www.arunbaby.com/ml-system-design/0012-distributed-systems/">


  <meta property="og:description" content="Design distributed ML systems that scale to billions of predictions: Master replication, sharding, consensus, and fault tolerance for production ML.">



  <meta property="og:image" content="https://www.arunbaby.com/assets/images/profile-photo.png">



  <meta name="twitter:site" content="@arunbaby0">
  <meta name="twitter:title" content="Distributed ML Systems">
  <meta name="twitter:description" content="Design distributed ML systems that scale to billions of predictions: Master replication, sharding, consensus, and fault tolerance for production ML.">
  <meta name="twitter:url" content="https://www.arunbaby.com/ml-system-design/0012-distributed-systems/">

  
    <meta name="twitter:card" content="summary">
    
      <meta name="twitter:image" content="https://www.arunbaby.com/assets/images/profile-photo.png">
    
  

  



  <meta property="article:published_time" content="2025-12-05T20:36:26+05:30">





  

  


<link rel="canonical" href="https://www.arunbaby.com/ml-system-design/0012-distributed-systems/">












<!-- end _includes/seo.html -->



  <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Arun Baby Feed">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
  
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css"></noscript>



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single" dir="ltr">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
           
          <span class="site-subtitle">Arun Baby</span>
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a
                href="/about/"
                
                
              >About</a>
            </li><li class="masthead__menu-item">
              <a
                href="/dsa/"
                
                
              >DSA</a>
            </li><li class="masthead__menu-item">
              <a
                href="/ml-system-design/"
                
                
              >ML Systems</a>
            </li><li class="masthead__menu-item">
              <a
                href="/speech-tech/"
                
                
              >Speech Tech</a>
            </li><li class="masthead__menu-item">
              <a
                href="/publications/"
                
                
              >Publications</a>
            </li><li class="masthead__menu-item">
              <a
                href="/statuses/"
                
                
              >Statuses</a>
            </li><li class="masthead__menu-item">
              <a
                href="/contact/"
                
                
              >Contact</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <i class="fas fa-search"></i>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      





<div id="main" role="main" class="no-author-sidebar">
  
  <div class="sidebar sticky">
  
  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Distributed ML Systems">
    <meta itemprop="description" content="Design distributed ML systems that scale to billions of predictions: Master replication, sharding, consensus, and fault tolerance for production ML.">
    <meta itemprop="datePublished" content="2025-12-05T20:36:26+05:30">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">
            <a href="https://www.arunbaby.com/ml-system-design/0012-distributed-systems/" itemprop="url">Distributed ML Systems
</a>
          </h1>
          

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          25 minute read
        
      </span>
    
  </p>


        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right sticky">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> On this page</h4></header>
              <ul class="toc__menu"><li><a href="#problem-statement">Problem Statement</a><ul><li><a href="#why-distributed-systems">Why Distributed Systems?</a></li><li><a href="#real-world-scale-examples">Real-World Scale Examples</a></li></ul></li><li><a href="#understanding-distributed-systems-fundamentals">Understanding Distributed Systems Fundamentals</a><ul><li><a href="#what-makes-systems-distributed">What Makes Systems â€œDistributedâ€?</a></li><li><a href="#the-cap-theorem">The CAP Theorem</a></li><li><a href="#key-concepts-for-junior-engineers">Key Concepts for Junior Engineers</a></li></ul></li><li><a href="#architecture-patterns">Architecture Patterns</a><ul><li><a href="#pattern-1-master-worker-for-training">Pattern 1: Master-Worker (for Training)</a></li><li><a href="#pattern-2-load-balancer--replicas-for-serving">Pattern 2: Load Balancer + Replicas (for Serving)</a></li><li><a href="#pattern-3-pub-sub-for-async-communication">Pattern 3: Pub-Sub for Async Communication</a></li></ul></li><li><a href="#handling-failures">Handling Failures</a><ul><li><a href="#types-of-failures">Types of Failures</a></li><li><a href="#fault-tolerance-strategies">Fault Tolerance Strategies</a></li></ul></li><li><a href="#consistency-models">Consistency Models</a><ul><li><a href="#strong-consistency">Strong Consistency</a></li><li><a href="#eventual-consistency">Eventual Consistency</a></li></ul></li><li><a href="#consensus-algorithms">Consensus Algorithms</a><ul><li><a href="#understanding-the-challenge">Understanding the Challenge</a></li><li><a href="#raft-algorithm-simplified">Raft Algorithm (Simplified)</a></li></ul></li><li><a href="#data-partitioning-strategies">Data Partitioning Strategies</a><ul><li><a href="#strategy-1-range-partitioning">Strategy 1: Range Partitioning</a></li><li><a href="#strategy-2-hash-partitioning">Strategy 2: Hash Partitioning</a></li><li><a href="#strategy-3-consistent-hashing">Strategy 3: Consistent Hashing</a></li></ul></li><li><a href="#real-world-case-study-netflix-recommendation-system">Real-World Case Study: Netflix Recommendation System</a><ul><li><a href="#architecture">Architecture</a></li><li><a href="#key-distributed-systems-principles-used">Key Distributed Systems Principles Used</a></li><li><a href="#numbers">Numbers</a></li></ul></li><li><a href="#key-takeaways">Key Takeaways</a></li></ul>
            </nav>
          </aside>
        
        <p><strong>Design distributed ML systems that scale to billions of predictions: Master replication, sharding, consensus, and fault tolerance for production ML.</strong></p>

<h2 id="problem-statement">Problem Statement</h2>

<p>Design a <strong>distributed machine learning system</strong> that can:</p>
<ol>
  <li>Handle <strong>billions of predictions per day</strong> across multiple regions</li>
  <li>Train models on <strong>terabytes of data</strong> across multiple machines</li>
  <li>Serve models with <strong>low latency</strong> (&lt;100ms) and <strong>high availability</strong> (99.99%)</li>
  <li>Handle <strong>failures gracefully</strong> without data loss or service disruption</li>
  <li>Scale <strong>horizontally</strong> by adding more machines</li>
</ol>

<h3 id="why-distributed-systems">Why Distributed Systems?</h3>

<p><strong>The fundamental constraint</strong>: A single machine canâ€™t handle:</p>

<p><strong>Data:</strong></p>
<ul>
  <li>Training data: 10TB+ (wonâ€™t fit in RAM)</li>
  <li>Model size: 100GB+ (large language models, embeddings)</li>
  <li>Inference load: 100,000 requests/sec (CPU melts ğŸ”¥)</li>
</ul>

<p><strong>Computation:</strong></p>
<ul>
  <li>Training time: Days/weeks on single GPU</li>
  <li>Inference: Canâ€™t serve millions of users from one server</li>
</ul>

<p><strong>Geography:</strong></p>
<ul>
  <li>Users worldwide: Tokyo, London, New York, SÃ£o Paulo</li>
  <li>Latency: Canâ€™t serve Tokyo users from Virginia (150ms+ RTT)</li>
</ul>

<p><strong>Reliability:</strong></p>
<ul>
  <li>Single machine fails â†’ Entire service down âŒ</li>
  <li>Need redundancy and fault tolerance</li>
</ul>

<h3 id="real-world-scale-examples">Real-World Scale Examples</h3>

<table>
  <thead>
    <tr>
      <th>Company</th>
      <th>Scale</th>
      <th>Challenge</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>Google Search</strong></td>
      <td>8.5B searches/day</td>
      <td>Distributed indexing + serving</td>
    </tr>
    <tr>
      <td><strong>Netflix</strong></td>
      <td>200M users, 1B hours/day</td>
      <td>Personalization at scale</td>
    </tr>
    <tr>
      <td><strong>Uber</strong></td>
      <td>19M trips/day</td>
      <td>Real-time matching + prediction</td>
    </tr>
    <tr>
      <td><strong>Meta</strong></td>
      <td>3B users</td>
      <td>Social graph + recommendation</td>
    </tr>
  </tbody>
</table>

<p><strong>Common pattern</strong>: All use distributed ML systems!</p>

<hr />

<h2 id="understanding-distributed-systems-fundamentals">Understanding Distributed Systems Fundamentals</h2>

<h3 id="what-makes-systems-distributed">What Makes Systems â€œDistributedâ€?</h3>

<p><strong>Definition</strong>: Multiple computers working together as one system.</p>

<p><strong>Simple analogy</strong>: Restaurant kitchen</p>
<ul>
  <li><strong>Single machine</strong>: One chef makes everything (slow, bottleneck)</li>
  <li><strong>Distributed</strong>: Multiple chefs, each specializing (fast, parallel)</li>
</ul>

<p>But coordination is hard:</p>
<ul>
  <li>How do chefs know what to cook?</li>
  <li>What if a chef is sick?</li>
  <li>How to avoid making duplicate orders?</li>
</ul>

<p>These are <strong>distributed systems problems</strong>!</p>

<h3 id="the-cap-theorem">The CAP Theorem</h3>

<p><strong>CAP Theorem states</strong>: You can only have 2 of 3:</p>

<ol>
  <li><strong>Consistency (C)</strong>: All nodes see same data at same time</li>
  <li><strong>Availability (A)</strong>: System always responds (even if some nodes down)</li>
  <li><strong>Partition Tolerance (P)</strong>: System works despite network failures</li>
</ol>

<p><strong>In practice</strong>: Network partitions happen, so you must have P.
<strong>Real choice</strong>: Consistency (CP) vs Availability (AP)</p>

<p><strong>Example scenarios:</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Scenario: Network split between US and EU data centers

CP System (Choose Consistency):
- Reject writes until partition healed
- Data stays consistent
- But users in EU can't use system! âŒ

AP System (Choose Availability):
- Accept writes in both regions
- Users happy! âœ“
- But data may conflict later (eventual consistency)
</code></pre></div></div>

<p><strong>For ML systems:</strong></p>
<ul>
  <li><strong>Training</strong>: CP (want consistent data)</li>
  <li><strong>Serving</strong>: AP (availability critical for user experience)</li>
</ul>

<h3 id="key-concepts-for-junior-engineers">Key Concepts for Junior Engineers</h3>

<p><strong>1. Horizontal vs Vertical Scaling</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Vertical Scaling (Scale UP):
  1 machine â†’ Bigger machine
  4 CPU     â†’ 64 CPU
  16GB RAM  â†’ 512GB RAM
  
  Pros: Simple, no code changes
  Cons: Expensive, limited (can't buy infinite RAM), single point of failure

Horizontal Scaling (Scale OUT):
  1 machine â†’ 10 machines
  
  Pros: Cheaper, unlimited, fault-tolerant
  Cons: Complex (distributed systems problems!)
</code></pre></div></div>

<p><strong>ML systems need horizontal scaling</strong> because:</p>
<ul>
  <li>Data too big for one machine</li>
  <li>Training too slow on one machine</li>
  <li>Serving load too high for one machine</li>
</ul>

<p><strong>2. Replication vs Sharding</strong></p>

<p><strong>Replication</strong>: Same data on multiple machines</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Machine 1: [A, B, C, D]
Machine 2: [A, B, C, D]  â† Same data!
Machine 3: [A, B, C, D]

Use case: High availability, load distribution
Example: Model weights replicated to 100 servers
</code></pre></div></div>

<p><strong>Sharding</strong>: Different data on each machine</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Machine 1: [A, B]
Machine 2: [C, D]  â† Different data!
Machine 3: [E, F]

Use case: Data too big for one machine
Example: Training data split across 10 machines
</code></pre></div></div>

<p><strong>3. Synchronous vs Asynchronous</strong></p>

<p><strong>Synchronous</strong>: Wait for response before continuing</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">result</span> <span class="o">=</span> <span class="nf">call_other_service</span><span class="p">()</span>  <span class="c1"># Block here
</span><span class="nf">process</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>  <span class="c1"># Wait until call returns
</span></code></pre></div></div>
<ul>
  <li><strong>Pros</strong>: Simple, consistent</li>
  <li><strong>Cons</strong>: Slow (latency adds up)</li>
</ul>

<p><strong>Asynchronous</strong>: Donâ€™t wait, continue immediately</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">future</span> <span class="o">=</span> <span class="nf">call_other_service_async</span><span class="p">()</span>  <span class="c1"># Don't block
</span><span class="nf">do_other_work</span><span class="p">()</span>  <span class="c1"># Continue immediately
</span><span class="n">result</span> <span class="o">=</span> <span class="n">future</span><span class="p">.</span><span class="nf">get</span><span class="p">()</span>  <span class="c1"># Get result when needed
</span></code></pre></div></div>
<ul>
  <li><strong>Pros</strong>: Fast, better resource usage</li>
  <li><strong>Cons</strong>: Complex, harder to debug</li>
</ul>

<hr />

<h2 id="architecture-patterns">Architecture Patterns</h2>

<h3 id="pattern-1-master-worker-for-training">Pattern 1: Master-Worker (for Training)</h3>

<p><strong>Use case</strong>: Distributed model training</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              MASTER NODE                     â”‚
â”‚  â€¢ Coordinates workers                       â”‚
â”‚  â€¢ Aggregates gradients                      â”‚
â”‚  â€¢ Updates global model                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚          â”‚          â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â” â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â” â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”
    â”‚Worker 1 â”‚ â”‚Worker 2â”‚ â”‚Worker 3â”‚
    â”‚ GPU 1   â”‚ â”‚ GPU 2  â”‚ â”‚ GPU 3  â”‚
    â”‚Batch 1  â”‚ â”‚Batch 2 â”‚ â”‚Batch 3 â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div></div>

<p><strong>How it works:</strong></p>

<ol>
  <li>Master distributes data batches to workers</li>
  <li>Each worker computes gradients on its batch</li>
  <li>Workers send gradients back to master</li>
  <li>Master averages gradients, updates model</li>
  <li>Master broadcasts updated model to workers</li>
  <li>Repeat</li>
</ol>

<p><strong>Python implementation:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">MasterNode</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Master node for distributed training
    
    Coordinates multiple worker nodes
    </span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">workers</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="n">self</span><span class="p">.</span><span class="n">workers</span> <span class="o">=</span> <span class="n">workers</span>
        <span class="n">self</span><span class="p">.</span><span class="n">global_step</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="k">def</span> <span class="nf">train_step</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data_batches</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        One distributed training step
        
        1. Send model to workers
        2. Workers compute gradients
        3. Aggregate gradients
        4. Update model
        </span><span class="sh">"""</span>
        <span class="c1"># Distribute work to workers
</span>        <span class="n">futures</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">worker</span><span class="p">,</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nf">zip</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">workers</span><span class="p">,</span> <span class="n">data_batches</span><span class="p">):</span>
            <span class="c1"># Send model and data to worker
</span>            <span class="n">future</span> <span class="o">=</span> <span class="n">worker</span><span class="p">.</span><span class="nf">compute_gradients_async</span><span class="p">(</span>
                <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">state_dict</span><span class="p">(),</span>
                <span class="n">batch</span>
            <span class="p">)</span>
            <span class="n">futures</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">future</span><span class="p">)</span>
        
        <span class="c1"># Wait for all workers (synchronous)
</span>        <span class="n">gradients</span> <span class="o">=</span> <span class="p">[</span><span class="n">future</span><span class="p">.</span><span class="nf">get</span><span class="p">()</span> <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">futures</span><span class="p">]</span>
        
        <span class="c1"># Aggregate gradients (averaging)
</span>        <span class="n">avg_gradients</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_average_gradients</span><span class="p">(</span><span class="n">gradients</span><span class="p">)</span>
        
        <span class="c1"># Update model
</span>        <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">avg_gradients</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">global_step</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span>
    
    <span class="k">def</span> <span class="nf">_average_gradients</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">gradients_list</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Average gradients from all workers</span><span class="sh">"""</span>
        <span class="n">avg_grads</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="k">for</span> <span class="n">param_name</span> <span class="ow">in</span> <span class="n">gradients_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">keys</span><span class="p">():</span>
            <span class="c1"># Average this parameter's gradients
</span>            <span class="n">param_grads</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">gradients_list</span><span class="p">]</span>
            <span class="n">avg_grads</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span> <span class="o">=</span> <span class="nf">sum</span><span class="p">(</span><span class="n">param_grads</span><span class="p">)</span> <span class="o">/</span> <span class="nf">len</span><span class="p">(</span><span class="n">param_grads</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">avg_grads</span>

<span class="k">class</span> <span class="nc">WorkerNode</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Worker node that computes gradients
    </span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">worker_id</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="sh">'</span><span class="s">cuda</span><span class="sh">'</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">worker_id</span> <span class="o">=</span> <span class="n">worker_id</span>
        <span class="n">self</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>
    
    <span class="k">def</span> <span class="nf">compute_gradients_async</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">model_state</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Compute gradients on local batch
        
        Returns: Future that will contain gradients
        </span><span class="sh">"""</span>
        <span class="kn">import</span> <span class="n">concurrent.futures</span>
        
        <span class="n">executor</span> <span class="o">=</span> <span class="n">concurrent</span><span class="p">.</span><span class="n">futures</span><span class="p">.</span><span class="nc">ThreadPoolExecutor</span><span class="p">()</span>
        <span class="n">future</span> <span class="o">=</span> <span class="n">executor</span><span class="p">.</span><span class="nf">submit</span><span class="p">(</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_compute_gradients</span><span class="p">,</span>
            <span class="n">model_state</span><span class="p">,</span>
            <span class="n">batch</span>
        <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">future</span>
    
    <span class="k">def</span> <span class="nf">_compute_gradients</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">model_state</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Actually compute gradients</span><span class="sh">"""</span>
        <span class="kn">import</span> <span class="n">torch</span>
        
        <span class="c1"># Load model
</span>        <span class="n">model</span> <span class="o">=</span> <span class="nf">load_model</span><span class="p">()</span>
        <span class="n">model</span><span class="p">.</span><span class="nf">load_state_dict</span><span class="p">(</span><span class="n">model_state</span><span class="p">)</span>
        <span class="n">model</span><span class="p">.</span><span class="nf">to</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">device</span><span class="p">)</span>
        
        <span class="c1"># Forward + backward
</span>        <span class="n">loss</span> <span class="o">=</span> <span class="nf">model</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
        <span class="n">loss</span><span class="p">.</span><span class="nf">backward</span><span class="p">()</span>
        
        <span class="c1"># Extract gradients
</span>        <span class="n">gradients</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">name</span><span class="p">:</span> <span class="n">param</span><span class="p">.</span><span class="n">grad</span><span class="p">.</span><span class="nf">cpu</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">model</span><span class="p">.</span><span class="nf">named_parameters</span><span class="p">()</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="n">gradients</span>
</code></pre></div></div>

<p><strong>Challenges:</strong></p>

<ol>
  <li><strong>Straggler problem</strong>: Slowest worker delays everyone
    <ul>
      <li><strong>Solution</strong>: Asynchronous updates, backup tasks</li>
    </ul>
  </li>
  <li><strong>Communication overhead</strong>: Sending gradients is expensive
    <ul>
      <li><strong>Solution</strong>: Gradient compression, local updates</li>
    </ul>
  </li>
  <li><strong>Fault tolerance</strong>: What if worker crashes?
    <ul>
      <li><strong>Solution</strong>: Checkpoint frequently, redistribute work</li>
    </ul>
  </li>
</ol>

<h3 id="pattern-2-load-balancer--replicas-for-serving">Pattern 2: Load Balancer + Replicas (for Serving)</h3>

<p><strong>Use case</strong>: Serving ML predictions at scale</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    Requests â”€â”€â†’  â”‚Load Balancer â”‚
                  â”‚  (Round Robin)â”‚
                  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼                â–¼                â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Replica 1â”‚      â”‚Replica 2â”‚     â”‚Replica 3â”‚
   â”‚  Model  â”‚      â”‚ Model   â”‚     â”‚ Model   â”‚
   â”‚+ Cache  â”‚      â”‚+ Cache  â”‚     â”‚+ Cache  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div></div>

<p><strong>Benefits:</strong></p>

<ul>
  <li><strong>High availability</strong>: If one replica dies, others handle load</li>
  <li><strong>Load distribution</strong>: 10K req/sec across 10 replicas = 1K each</li>
  <li><strong>Zero-downtime deploys</strong>: Update replicas one at a time</li>
</ul>

<p><strong>Implementation:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">LoadBalancer</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Simple round-robin load balancer
    
    Distributes requests across healthy replicas
    </span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">replicas</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">replicas</span> <span class="o">=</span> <span class="n">replicas</span>
        <span class="n">self</span><span class="p">.</span><span class="n">current_index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">health_checker</span> <span class="o">=</span> <span class="nc">HealthChecker</span><span class="p">(</span><span class="n">replicas</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">health_checker</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">route_request</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Route request to healthy replica
        
        Uses round-robin for simplicity
        </span><span class="sh">"""</span>
        <span class="c1"># Get healthy replicas
</span>        <span class="n">healthy</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">health_checker</span><span class="p">.</span><span class="nf">get_healthy_replicas</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">healthy</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">Exception</span><span class="p">(</span><span class="sh">"</span><span class="s">No healthy replicas available!</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="c1"># Round-robin selection
</span>        <span class="n">replica</span> <span class="o">=</span> <span class="n">healthy</span><span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">current_index</span> <span class="o">%</span> <span class="nf">len</span><span class="p">(</span><span class="n">healthy</span><span class="p">)]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">current_index</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="c1"># Forward request
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">replica</span><span class="p">.</span><span class="nf">predict</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">response</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Retry with different replica
</span>            <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="nf">_retry_request</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="p">[</span><span class="n">replica</span><span class="p">])</span>
    
    <span class="k">def</span> <span class="nf">_retry_request</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Retry failed request on different replica</span><span class="sh">"""</span>
        <span class="n">exclude</span> <span class="o">=</span> <span class="n">exclude</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">healthy</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">health_checker</span><span class="p">.</span><span class="nf">get_healthy_replicas</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">r</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclude</span>
        <span class="p">]</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">healthy</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">Exception</span><span class="p">(</span><span class="sh">"</span><span class="s">All replicas failed</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">healthy</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">predict</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">HealthChecker</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Continuously monitor replica health
    
    Marks unhealthy replicas so LB doesn</span><span class="sh">'</span><span class="s">t route to them
    </span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">replicas</span><span class="p">,</span> <span class="n">check_interval</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">replicas</span> <span class="o">=</span> <span class="n">replicas</span>
        <span class="n">self</span><span class="p">.</span><span class="n">check_interval</span> <span class="o">=</span> <span class="n">check_interval</span>
        <span class="n">self</span><span class="p">.</span><span class="n">health_status</span> <span class="o">=</span> <span class="p">{</span><span class="n">r</span><span class="p">:</span> <span class="bp">True</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">replicas</span><span class="p">}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">running</span> <span class="o">=</span> <span class="bp">False</span>
    
    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Start health checking in background</span><span class="sh">"""</span>
        <span class="kn">import</span> <span class="n">threading</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">running</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">self</span><span class="p">.</span><span class="n">thread</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Thread</span><span class="p">(</span>
            <span class="n">target</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">_health_check_loop</span><span class="p">,</span>
            <span class="n">daemon</span><span class="o">=</span><span class="bp">True</span>
        <span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">thread</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">_health_check_loop</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Continuously check replica health</span><span class="sh">"""</span>
        <span class="kn">import</span> <span class="n">time</span>
        
        <span class="k">while</span> <span class="n">self</span><span class="p">.</span><span class="n">running</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">replica</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">replicas</span><span class="p">:</span>
                <span class="n">is_healthy</span> <span class="o">=</span> <span class="n">replica</span><span class="p">.</span><span class="nf">health_check</span><span class="p">()</span>
                <span class="n">self</span><span class="p">.</span><span class="n">health_status</span><span class="p">[</span><span class="n">replica</span><span class="p">]</span> <span class="o">=</span> <span class="n">is_healthy</span>
                
                <span class="k">if</span> <span class="ow">not</span> <span class="n">is_healthy</span><span class="p">:</span>
                    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">âš ï¸ Replica </span><span class="si">{</span><span class="n">replica</span><span class="p">.</span><span class="nb">id</span><span class="si">}</span><span class="s"> unhealthy!</span><span class="sh">"</span><span class="p">)</span>
            
            <span class="n">time</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">check_interval</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">get_healthy_replicas</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Get list of currently healthy replicas</span><span class="sh">"""</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">replica</span> <span class="k">for</span> <span class="n">replica</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">replicas</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">health_status</span><span class="p">[</span><span class="n">replica</span><span class="p">]</span>
        <span class="p">]</span>
</code></pre></div></div>

<h3 id="pattern-3-pub-sub-for-async-communication">Pattern 3: Pub-Sub for Async Communication</h3>

<p><strong>Use case</strong>: Model updates, feature updates, async tasks</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Message Bus  â”‚
                    â”‚    (Kafka)    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â–¼               â–¼               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Subscriber 1 â”‚ â”‚ Subscriber 2 â”‚ â”‚ Subscriber 3 â”‚
    â”‚ Update model â”‚ â”‚ Update cache â”‚ â”‚ Log metrics  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div></div>

<p><strong>When to use:</strong></p>

<ul>
  <li>Model deployment: Notify all servers to reload model</li>
  <li>Feature updates: Broadcast new feature values</li>
  <li>Logging: Send metrics/logs asynchronously</li>
  <li>Training triggers: Data arrives â†’ trigger training job</li>
</ul>

<p><strong>Implementation:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">PubSubSystem</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Publish-Subscribe system for async communication
    
    Publishers send messages, subscribers receive them
    </span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">subscribers</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># topic -&gt; [subscribers]
</span>    
    <span class="k">def</span> <span class="nf">subscribe</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">topic</span><span class="p">,</span> <span class="n">callback</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Subscribe to a topic
        
        Args:
            topic: Topic name (e.g., </span><span class="sh">'</span><span class="s">model.updated</span><span class="sh">'</span><span class="s">)
            callback: Function to call when message received
        </span><span class="sh">"""</span>
        <span class="k">if</span> <span class="n">topic</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">subscribers</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">subscribers</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">subscribers</span><span class="p">[</span><span class="n">topic</span><span class="p">].</span><span class="nf">append</span><span class="p">(</span><span class="n">callback</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">âœ“ Subscribed to </span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">publish</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">topic</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Publish message to topic
        
        All subscribers will receive it asynchronously
        </span><span class="sh">"""</span>
        <span class="k">if</span> <span class="n">topic</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">subscribers</span><span class="p">:</span>
            <span class="k">return</span>
        
        <span class="k">for</span> <span class="n">callback</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">subscribers</span><span class="p">[</span><span class="n">topic</span><span class="p">]:</span>
            <span class="c1"># Call asynchronously (non-blocking)
</span>            <span class="kn">import</span> <span class="n">threading</span>
            <span class="n">thread</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Thread</span><span class="p">(</span>
                <span class="n">target</span><span class="o">=</span><span class="n">callback</span><span class="p">,</span>
                <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">message</span><span class="p">,)</span>
            <span class="p">)</span>
            <span class="n">thread</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
        
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">ğŸ“¢ Published to </span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># Example usage
</span><span class="n">pubsub</span> <span class="o">=</span> <span class="nc">PubSubSystem</span><span class="p">()</span>

<span class="c1"># Subscriber 1: Model server that reloads on updates
</span><span class="k">def</span> <span class="nf">reload_model</span><span class="p">(</span><span class="n">message</span><span class="p">):</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">ğŸ”„ Reloading model: </span><span class="si">{</span><span class="n">message</span><span class="p">[</span><span class="sh">'</span><span class="s">model_version</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="c1"># Load new model...
</span>
<span class="n">pubsub</span><span class="p">.</span><span class="nf">subscribe</span><span class="p">(</span><span class="sh">'</span><span class="s">model.updated</span><span class="sh">'</span><span class="p">,</span> <span class="n">reload_model</span><span class="p">)</span>

<span class="c1"># Subscriber 2: Cache that invalidates on updates
</span><span class="k">def</span> <span class="nf">invalidate_cache</span><span class="p">(</span><span class="n">message</span><span class="p">):</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">ğŸ—‘ï¸ Invalidating cache for: </span><span class="si">{</span><span class="n">message</span><span class="p">[</span><span class="sh">'</span><span class="s">model_version</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="c1"># Clear cache...
</span>
<span class="n">pubsub</span><span class="p">.</span><span class="nf">subscribe</span><span class="p">(</span><span class="sh">'</span><span class="s">model.updated</span><span class="sh">'</span><span class="p">,</span> <span class="n">invalidate_cache</span><span class="p">)</span>

<span class="c1"># Publisher: Training job publishes when done
</span><span class="k">def</span> <span class="nf">training_complete</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span> <span class="n">version</span><span class="p">):</span>
    <span class="n">pubsub</span><span class="p">.</span><span class="nf">publish</span><span class="p">(</span><span class="sh">'</span><span class="s">model.updated</span><span class="sh">'</span><span class="p">,</span> <span class="p">{</span>
        <span class="sh">'</span><span class="s">model_path</span><span class="sh">'</span><span class="p">:</span> <span class="n">model_path</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">model_version</span><span class="sh">'</span><span class="p">:</span> <span class="n">version</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">timestamp</span><span class="sh">'</span><span class="p">:</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
    <span class="p">})</span>

<span class="c1"># Trigger
</span><span class="nf">training_complete</span><span class="p">(</span><span class="sh">'</span><span class="s">s3://models/v123</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">v123</span><span class="sh">'</span><span class="p">)</span>
<span class="c1"># Both subscribers receive message asynchronously!
</span></code></pre></div></div>

<hr />

<h2 id="handling-failures">Handling Failures</h2>

<p><strong>Key principle</strong>: In distributed systems, failures are <strong>normal</strong>, not exceptional!</p>

<h3 id="types-of-failures">Types of Failures</h3>

<ol>
  <li><strong>Machine failure</strong>: Server crashes</li>
  <li><strong>Network partition</strong>: Network splits, canâ€™t communicate</li>
  <li><strong>Slow nodes</strong>: â€œStragglersâ€ delay entire system</li>
  <li><strong>Corrupted data</strong>: Silent data corruption</li>
  <li><strong>Cascading failures</strong>: One failure triggers others</li>
</ol>

<h3 id="fault-tolerance-strategies">Fault Tolerance Strategies</h3>

<p><strong>1. Replication (Multiple Copies)</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ReplicatedStorage</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Store data on multiple nodes
    
    If one fails, others have copy
    </span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">replication_factor</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">nodes</span> <span class="o">=</span> <span class="n">nodes</span>
        <span class="n">self</span><span class="p">.</span><span class="n">replication_factor</span> <span class="o">=</span> <span class="n">replication_factor</span>
    
    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Write to multiple nodes
        
        Succeeds if majority succeed (quorum)
        </span><span class="sh">"""</span>
        <span class="c1"># Pick nodes to write to
</span>        <span class="n">target_nodes</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_pick_nodes</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">replication_factor</span><span class="p">)</span>
        
        <span class="c1"># Write to all (parallel)
</span>        <span class="kn">import</span> <span class="n">concurrent.futures</span>
        <span class="k">with</span> <span class="n">concurrent</span><span class="p">.</span><span class="n">futures</span><span class="p">.</span><span class="nc">ThreadPoolExecutor</span><span class="p">()</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
            <span class="n">futures</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">executor</span><span class="p">.</span><span class="nf">submit</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">write</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">target_nodes</span>
            <span class="p">]</span>
            
            <span class="c1"># Wait for majority
</span>            <span class="n">successes</span> <span class="o">=</span> <span class="nf">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">futures</span> <span class="k">if</span> <span class="n">f</span><span class="p">.</span><span class="nf">result</span><span class="p">())</span>
        
        <span class="c1"># Require majority for success (quorum)
</span>        <span class="n">quorum</span> <span class="o">=</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">replication_factor</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        
        <span class="k">if</span> <span class="n">successes</span> <span class="o">&gt;=</span> <span class="n">quorum</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">Exception</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Write failed: only </span><span class="si">{</span><span class="n">successes</span><span class="si">}</span><span class="s">/</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">replication_factor</span><span class="si">}</span><span class="s"> succeeded</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Read from multiple nodes, return most recent
        
        Handles node failures gracefully
        </span><span class="sh">"""</span>
        <span class="n">target_nodes</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_pick_nodes</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">replication_factor</span><span class="p">)</span>
        
        <span class="c1"># Read from all
</span>        <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">target_nodes</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="n">values</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="c1"># Node failed, skip it
</span>                <span class="k">continue</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">values</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">Exception</span><span class="p">(</span><span class="sh">"</span><span class="s">All replicas failed!</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="c1"># Return most recent (highest version)
</span>        <span class="k">return</span> <span class="nf">max</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="sh">'</span><span class="s">version</span><span class="sh">'</span><span class="p">])</span>
</code></pre></div></div>

<p><strong>2. Checkpointing (Save Progress)</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">CheckpointedTraining</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Save training progress periodically
    
    If crash, resume from last checkpoint
    </span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">checkpoint_dir</span><span class="p">,</span> <span class="n">checkpoint_every</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="n">self</span><span class="p">.</span><span class="n">checkpoint_dir</span> <span class="o">=</span> <span class="n">checkpoint_dir</span>
        <span class="n">self</span><span class="p">.</span><span class="n">checkpoint_every</span> <span class="o">=</span> <span class="n">checkpoint_every</span>
        <span class="n">self</span><span class="p">.</span><span class="n">global_step</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data_loader</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Train with checkpointing</span><span class="sh">"""</span>
        <span class="c1"># Try to resume from checkpoint
</span>        <span class="n">self</span><span class="p">.</span><span class="n">global_step</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_load_checkpoint</span><span class="p">()</span>
        
        <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">data_loader</span><span class="p">:</span>
            <span class="c1"># Skip batches we've already processed
</span>            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">global_step</span> <span class="o">&lt;</span> <span class="n">batch</span><span class="p">.</span><span class="nb">id</span><span class="p">:</span>
                <span class="k">continue</span>
            
            <span class="c1"># Training step
</span>            <span class="n">loss</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">train_step</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">global_step</span> <span class="o">+=</span> <span class="mi">1</span>
            
            <span class="c1"># Checkpoint periodically
</span>            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">global_step</span> <span class="o">%</span> <span class="n">self</span><span class="p">.</span><span class="n">checkpoint_every</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_save_checkpoint</span><span class="p">()</span>
                <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">âœ“ Checkpoint saved at step </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">global_step</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_save_checkpoint</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Save model + training state</span><span class="sh">"""</span>
        <span class="kn">import</span> <span class="n">torch</span>
        
        <span class="n">checkpoint</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">model_state</span><span class="sh">'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">state_dict</span><span class="p">(),</span>
            <span class="sh">'</span><span class="s">global_step</span><span class="sh">'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">global_step</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">timestamp</span><span class="sh">'</span><span class="p">:</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="p">}</span>
        
        <span class="n">path</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">checkpoint_dir</span><span class="si">}</span><span class="s">/ckpt-</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">global_step</span><span class="si">}</span><span class="s">.pt</span><span class="sh">"</span>
        <span class="n">torch</span><span class="p">.</span><span class="nf">save</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_load_checkpoint</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Load latest checkpoint if exists</span><span class="sh">"""</span>
        <span class="kn">import</span> <span class="n">glob</span>
        <span class="kn">import</span> <span class="n">torch</span>
        
        <span class="n">checkpoints</span> <span class="o">=</span> <span class="n">glob</span><span class="p">.</span><span class="nf">glob</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">checkpoint_dir</span><span class="si">}</span><span class="s">/ckpt-*.pt</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">checkpoints</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        
        <span class="c1"># Load latest
</span>        <span class="n">latest</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="n">checkpoints</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="nf">int</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">'</span><span class="s">-</span><span class="sh">'</span><span class="p">)[</span><span class="mi">1</span><span class="p">].</span><span class="nf">split</span><span class="p">(</span><span class="sh">'</span><span class="s">.</span><span class="sh">'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">checkpoint</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">latest</span><span class="p">)</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">load_state_dict</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">[</span><span class="sh">'</span><span class="s">model_state</span><span class="sh">'</span><span class="p">])</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">âœ“ Resumed from step </span><span class="si">{</span><span class="n">checkpoint</span><span class="p">[</span><span class="sh">'</span><span class="s">global_step</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">checkpoint</span><span class="p">[</span><span class="sh">'</span><span class="s">global_step</span><span class="sh">'</span><span class="p">]</span>
</code></pre></div></div>

<p><strong>3. Circuit Breaker (Prevent Cascading Failures)</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">CircuitBreaker</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Prevent cascading failures
    
    If service keeps failing, stop calling it (open circuit)
    Give it time to recover, then try again
    </span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">failure_threshold</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">failure_threshold</span> <span class="o">=</span> <span class="n">failure_threshold</span>
        <span class="n">self</span><span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span>
        <span class="n">self</span><span class="p">.</span><span class="n">failures</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="sh">'</span><span class="s">closed</span><span class="sh">'</span>  <span class="c1"># closed, open, half_open
</span>        <span class="n">self</span><span class="p">.</span><span class="n">last_failure_time</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Call function with circuit breaker protection
        </span><span class="sh">"""</span>
        <span class="kn">import</span> <span class="n">time</span>
        <span class="c1"># Check if circuit is open
</span>        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">state</span> <span class="o">==</span> <span class="sh">'</span><span class="s">open</span><span class="sh">'</span><span class="p">:</span>
            <span class="c1"># Check if timeout passed
</span>            <span class="k">if</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">last_failure_time</span> <span class="o">&gt;</span> <span class="n">self</span><span class="p">.</span><span class="n">timeout</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="sh">'</span><span class="s">half_open</span><span class="sh">'</span>
                <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">ğŸ”„ Circuit half-open, trying again...</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">Exception</span><span class="p">(</span><span class="sh">"</span><span class="s">Circuit breaker OPEN - service unavailable</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="c1"># Try the call
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="nf">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            
            <span class="c1"># Success! Reset if we were half-open
</span>            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">state</span> <span class="o">==</span> <span class="sh">'</span><span class="s">half_open</span><span class="sh">'</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="sh">'</span><span class="s">closed</span><span class="sh">'</span>
                <span class="n">self</span><span class="p">.</span><span class="n">failures</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">âœ“ Circuit closed - service recovered</span><span class="sh">"</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="n">result</span>
        
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Failure
</span>            <span class="n">self</span><span class="p">.</span><span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">self</span><span class="p">.</span><span class="n">last_failure_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
            
            <span class="c1"># Open circuit if too many failures
</span>            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">failures</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">failure_threshold</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="sh">'</span><span class="s">open</span><span class="sh">'</span>
                <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">âš ï¸ Circuit breaker OPEN after </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">failures</span><span class="si">}</span><span class="s"> failures</span><span class="sh">"</span><span class="p">)</span>
            
            <span class="k">raise</span> <span class="n">e</span>

<span class="c1"># Example usage
</span><span class="n">circuit_breaker</span> <span class="o">=</span> <span class="nc">CircuitBreaker</span><span class="p">(</span><span class="n">failure_threshold</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">call_unreliable_service</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">This service sometimes fails</span><span class="sh">"""</span>
    <span class="kn">import</span> <span class="n">random</span>
    <span class="k">if</span> <span class="n">random</span><span class="p">.</span><span class="nf">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nc">Exception</span><span class="p">(</span><span class="sh">"</span><span class="s">Service failed!</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="sh">"</span><span class="s">Success</span><span class="sh">"</span>

<span class="c1"># Try calling with circuit breaker
</span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">circuit_breaker</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">call_unreliable_service</span><span class="p">,</span> <span class="sh">"</span><span class="s">data</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Request </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Request </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="n">time</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>

<hr />

<h2 id="consistency-models">Consistency Models</h2>

<h3 id="strong-consistency">Strong Consistency</h3>

<p><strong>Guarantee</strong>: All reads see the most recent write</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">StronglyConsistentStore</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Every read returns the latest write
    
    Achieved by: Single master, synchronous replication
    </span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">master</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Single source of truth
</span>        <span class="n">self</span><span class="p">.</span><span class="n">replicas</span> <span class="o">=</span> <span class="p">[{},</span> <span class="p">{}]</span>  <span class="c1"># Read replicas
</span>        <span class="n">self</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Write to master, then synchronously replicate
        
        Slow but consistent!
        </span><span class="sh">"""</span>
        <span class="c1"># Update version
</span>        <span class="n">self</span><span class="p">.</span><span class="n">version</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="c1"># Write to master
</span>        <span class="n">self</span><span class="p">.</span><span class="n">master</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">'</span><span class="s">value</span><span class="sh">'</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span> <span class="sh">'</span><span class="s">version</span><span class="sh">'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">version</span><span class="p">}</span>
        
        <span class="c1"># Synchronously replicate to all replicas
</span>        <span class="k">for</span> <span class="n">replica</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">replicas</span><span class="p">:</span>
            <span class="n">replica</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">'</span><span class="s">value</span><span class="sh">'</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span> <span class="sh">'</span><span class="s">version</span><span class="sh">'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">version</span><span class="p">}</span>
        
        <span class="c1"># Only return after all replicas updated
</span>        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">âœ“ Write </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s">=</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s"> replicated to all</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Read from master (always latest)
        </span><span class="sh">"""</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">master</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">value</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div>

<p><strong>Pros</strong>: Simple to reason about
<strong>Cons</strong>: Slow (sync replication), single point of failure</p>

<h3 id="eventual-consistency">Eventual Consistency</h3>

<p><strong>Guarantee</strong>: Reads <strong>eventually</strong> see the latest write (but not immediately)</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">EventuallyConsistentStore</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Reads may see stale data temporarily
    
    Achieved by: Asynchronous replication
    </span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">replicas</span> <span class="o">=</span> <span class="p">[{},</span> <span class="p">{},</span> <span class="p">{}]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Write to one replica, asynchronously propagate
        
        Fast but eventually consistent
        </span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="n">version</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="c1"># Write to first replica immediately
</span>        <span class="n">self</span><span class="p">.</span><span class="n">replicas</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">'</span><span class="s">value</span><span class="sh">'</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span> <span class="sh">'</span><span class="s">version</span><span class="sh">'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">version</span><span class="p">}</span>
        
        <span class="c1"># Asynchronously replicate to others
</span>        <span class="kn">import</span> <span class="n">threading</span>
        <span class="k">for</span> <span class="n">replica</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">replicas</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">thread</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Thread</span><span class="p">(</span>
                <span class="n">target</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">_async_replicate</span><span class="p">,</span>
                <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">replica</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">version</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">thread</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
        
        <span class="c1"># Return immediately (don't wait for replication)
</span>        <span class="k">return</span> <span class="sh">"</span><span class="s">OK</span><span class="sh">"</span>
    
    <span class="k">def</span> <span class="nf">_async_replicate</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">replica</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">version</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Replicate asynchronously</span><span class="sh">"""</span>
        <span class="kn">import</span> <span class="n">time</span>
        <span class="n">time</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>  <span class="c1"># Simulate network delay
</span>        <span class="n">replica</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">'</span><span class="s">value</span><span class="sh">'</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span> <span class="sh">'</span><span class="s">version</span><span class="sh">'</span><span class="p">:</span> <span class="n">version</span><span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Read from random replica
        
        May return stale data if replication not complete!
        </span><span class="sh">"""</span>
        <span class="kn">import</span> <span class="n">random</span>
        <span class="n">replica</span> <span class="o">=</span> <span class="n">random</span><span class="p">.</span><span class="nf">choice</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">replicas</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">replica</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">value</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div>

<p><strong>Pros</strong>: Fast, highly available
<strong>Cons</strong>: Can read stale data temporarily</p>

<p><strong>For ML systems:</strong></p>
<ul>
  <li><strong>Model weights</strong>: Eventual consistency OK (small staleness acceptable)</li>
  <li><strong>Feature store</strong>: Strong consistency for critical features</li>
  <li><strong>Predictions</strong>: No consistency needed (stateless)</li>
</ul>

<hr />

<h2 id="consensus-algorithms">Consensus Algorithms</h2>

<p><strong>Problem</strong>: How do multiple nodes agree on a value when some might fail?</p>

<p><strong>Example</strong>: Leader election - which node should be the master?</p>

<h3 id="understanding-the-challenge">Understanding the Challenge</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Scenario: 3 nodes need to elect a leader

Node A thinks: "I should be leader!"
Node B thinks: "No, I should be leader!"
Node C crashes before voting

Challenge:
- Network delays mean messages arrive out of order
- Nodes might fail mid-process
- Must guarantee exactly ONE leader elected
</code></pre></div></div>

<p><strong>This is the consensus problem!</strong></p>

<h3 id="raft-algorithm-simplified">Raft Algorithm (Simplified)</h3>

<p><strong>Raft</strong> is easier to understand than Paxos, achieving the same goal.</p>

<p><strong>Key concepts:</strong></p>

<ol>
  <li><strong>States</strong>: Each node is in one of three states:
    <ul>
      <li><strong>Follower</strong>: Accepts commands from leader</li>
      <li><strong>Candidate</strong>: Trying to become leader</li>
      <li><strong>Leader</strong>: Sends commands to followers</li>
    </ul>
  </li>
  <li><strong>Terms</strong>: Time divided into terms (like presidencies)
    <ul>
      <li>Each term has at most one leader</li>
      <li>Term number increases after each election</li>
    </ul>
  </li>
  <li><strong>Election process:</strong></li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">RaftNode</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Simplified Raft consensus node
    
    Real implementation is more complex!
    </span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">node_id</span><span class="p">,</span> <span class="n">peers</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">node_id</span> <span class="o">=</span> <span class="n">node_id</span>
        <span class="n">self</span><span class="p">.</span><span class="n">peers</span> <span class="o">=</span> <span class="n">peers</span>
        <span class="n">self</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="sh">'</span><span class="s">follower</span><span class="sh">'</span>
        <span class="n">self</span><span class="p">.</span><span class="n">current_term</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">voted_for</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="kn">import</span> <span class="n">random</span><span class="p">,</span> <span class="n">time</span>
        <span class="n">self</span><span class="p">.</span><span class="n">election_timeout</span> <span class="o">=</span> <span class="n">random</span><span class="p">.</span><span class="nf">uniform</span><span class="p">(</span><span class="mi">150</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span>  <span class="c1"># ms
</span>        <span class="n">self</span><span class="p">.</span><span class="n">last_heartbeat</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">start_election</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Become candidate and request votes
        
        Called when election timeout expires without hearing from leader
        </span><span class="sh">"""</span>
        <span class="c1"># Increment term
</span>        <span class="n">self</span><span class="p">.</span><span class="n">current_term</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">self</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="sh">'</span><span class="s">candidate</span><span class="sh">'</span>
        <span class="n">self</span><span class="p">.</span><span class="n">voted_for</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">node_id</span>  <span class="c1"># Vote for self
</span>        
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Node </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">node_id</span><span class="si">}</span><span class="s">: Starting election for term </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">current_term</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="c1"># Request votes from all peers
</span>        <span class="n">votes_received</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># Self vote
</span>        
        <span class="k">for</span> <span class="n">peer</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">peers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="nf">_request_vote</span><span class="p">(</span><span class="n">peer</span><span class="p">):</span>
                <span class="n">votes_received</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="c1"># Check if won election (majority)
</span>        <span class="n">majority</span> <span class="o">=</span> <span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">peers</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span>
        
        <span class="k">if</span> <span class="n">votes_received</span> <span class="o">&gt;=</span> <span class="n">majority</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_become_leader</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Lost election, revert to follower
</span>            <span class="n">self</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="sh">'</span><span class="s">follower</span><span class="sh">'</span>
    
    <span class="k">def</span> <span class="nf">_request_vote</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">peer</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Request vote from peer
        
        Peer grants vote if:
        - Haven</span><span class="sh">'</span><span class="s">t voted in this term yet
        - Candidate</span><span class="sh">'</span><span class="s">s log is at least as up-to-date
        </span><span class="sh">"""</span>
        <span class="n">request</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">term</span><span class="sh">'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">current_term</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">candidate_id</span><span class="sh">'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">node_id</span>
        <span class="p">}</span>
        
        <span class="n">response</span> <span class="o">=</span> <span class="n">peer</span><span class="p">.</span><span class="nf">handle_vote_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">response</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">vote_granted</span><span class="sh">'</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_become_leader</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Become leader for this term
        
        Start sending heartbeats to maintain leadership
        </span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="sh">'</span><span class="s">leader</span><span class="sh">'</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Node </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">node_id</span><span class="si">}</span><span class="s">: Became leader for term </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">current_term</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="c1"># Send heartbeats to all followers
</span>        <span class="n">self</span><span class="p">.</span><span class="nf">_send_heartbeats</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">_send_heartbeats</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Send periodic heartbeats to prevent new elections
        
        Leader must send heartbeats &lt; election_timeout
        </span><span class="sh">"""</span>
        <span class="kn">import</span> <span class="n">time</span>
        <span class="k">while</span> <span class="n">self</span><span class="p">.</span><span class="n">state</span> <span class="o">==</span> <span class="sh">'</span><span class="s">leader</span><span class="sh">'</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">peer</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">peers</span><span class="p">:</span>
                <span class="n">peer</span><span class="p">.</span><span class="nf">receive_heartbeat</span><span class="p">({</span>
                    <span class="sh">'</span><span class="s">term</span><span class="sh">'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">current_term</span><span class="p">,</span>
                    <span class="sh">'</span><span class="s">leader_id</span><span class="sh">'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">node_id</span>
                <span class="p">})</span>
            
            <span class="n">time</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>  <span class="c1"># 50ms heartbeat interval
</span>    
    <span class="k">def</span> <span class="nf">receive_heartbeat</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Receive heartbeat from leader
        
        Reset election timeout
        </span><span class="sh">"""</span>
        <span class="c1"># Check term
</span>        <span class="k">if</span> <span class="n">message</span><span class="p">[</span><span class="sh">'</span><span class="s">term</span><span class="sh">'</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">current_term</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">current_term</span> <span class="o">=</span> <span class="n">message</span><span class="p">[</span><span class="sh">'</span><span class="s">term</span><span class="sh">'</span><span class="p">]</span>
            <span class="n">self</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="sh">'</span><span class="s">follower</span><span class="sh">'</span>
            <span class="n">self</span><span class="p">.</span><span class="n">last_heartbeat</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
            <span class="c1"># Reset election timeout
</span>        
        <span class="k">return</span> <span class="p">{</span><span class="sh">'</span><span class="s">success</span><span class="sh">'</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">handle_vote_request</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Handle vote request from candidate
        
        Grant vote if haven</span><span class="sh">'</span><span class="s">t voted in this term yet
        </span><span class="sh">"""</span>
        <span class="c1"># Check term
</span>        <span class="k">if</span> <span class="n">request</span><span class="p">[</span><span class="sh">'</span><span class="s">term</span><span class="sh">'</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">self</span><span class="p">.</span><span class="n">current_term</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">'</span><span class="s">vote_granted</span><span class="sh">'</span><span class="p">:</span> <span class="bp">False</span><span class="p">}</span>
        
        <span class="c1"># Check if already voted
</span>        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">voted_for</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">self</span><span class="p">.</span><span class="n">voted_for</span> <span class="o">==</span> <span class="n">request</span><span class="p">[</span><span class="sh">'</span><span class="s">candidate_id</span><span class="sh">'</span><span class="p">]:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">voted_for</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="sh">'</span><span class="s">candidate_id</span><span class="sh">'</span><span class="p">]</span>
            <span class="n">self</span><span class="p">.</span><span class="n">current_term</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="sh">'</span><span class="s">term</span><span class="sh">'</span><span class="p">]</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">'</span><span class="s">vote_granted</span><span class="sh">'</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
        
        <span class="k">return</span> <span class="p">{</span><span class="sh">'</span><span class="s">vote_granted</span><span class="sh">'</span><span class="p">:</span> <span class="bp">False</span><span class="p">}</span>
</code></pre></div></div>

<p><strong>Why this works:</strong></p>

<ol>
  <li><strong>Split votes</strong>: If multiple candidates, may get no majority â†’ retry</li>
  <li><strong>Random timeouts</strong>: Reduces likelihood of split votes</li>
  <li><strong>Term numbers</strong>: Ensures old messages ignored</li>
  <li><strong>Majority requirement</strong>: Ensures at most one leader per term</li>
</ol>

<p><strong>Use in ML systems:</strong></p>

<ul>
  <li><strong>Distributed training</strong>: Elect master node</li>
  <li><strong>Model serving</strong>: Elect coordinator for A/B test assignments</li>
  <li><strong>Feature store</strong>: Elect primary for writes</li>
</ul>

<hr />

<h2 id="data-partitioning-strategies">Data Partitioning Strategies</h2>

<p><strong>Problem</strong>: Training data is 10TB. Canâ€™t fit on one machine!</p>

<p><strong>Solution</strong>: Partition (shard) across multiple machines.</p>

<h3 id="strategy-1-range-partitioning">Strategy 1: Range Partitioning</h3>

<p><strong>Idea</strong>: Split data by key ranges</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>User IDs: 0 - 1,000,000

Partition 1: Users 0 - 250,000
Partition 2: Users 250,001 - 500,000
Partition 3: Users 500,001 - 750,000
Partition 4: Users 750,001 - 1,000,000
</code></pre></div></div>

<p><strong>Pros</strong>: Simple, range queries efficient
<strong>Cons</strong>: Hotspots if data skewed</p>

<p><strong>Example:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">RangePartitioner</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Partition data by key ranges
    </span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">partitions</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">partitions</span> <span class="o">=</span> <span class="n">partitions</span>  <span class="c1"># [(0, 250000, node1), (250001, 500000, node2), ...]
</span>    
    <span class="k">def</span> <span class="nf">get_partition</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Find which partition handles this key
        </span><span class="sh">"""</span>
        <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">partitions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">start</span> <span class="o">&lt;=</span> <span class="n">key</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">node</span>
        
        <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Key </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s"> not in any partition</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Write to appropriate partition</span><span class="sh">"""</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">get_partition</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">node</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Read from appropriate partition</span><span class="sh">"""</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">get_partition</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">node</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

<span class="c1"># Usage
</span><span class="n">partitioner</span> <span class="o">=</span> <span class="nc">RangePartitioner</span><span class="p">([</span>
    <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">250000</span><span class="p">,</span> <span class="n">node1</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">250001</span><span class="p">,</span> <span class="mi">500000</span><span class="p">,</span> <span class="n">node2</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">500001</span><span class="p">,</span> <span class="mi">750000</span><span class="p">,</span> <span class="n">node3</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">750001</span><span class="p">,</span> <span class="mi">1000000</span><span class="p">,</span> <span class="n">node4</span><span class="p">)</span>
<span class="p">])</span>

<span class="c1"># Write user data
</span><span class="n">partitioner</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="mi">123456</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">Alice</span><span class="sh">'</span><span class="p">,</span> <span class="p">...})</span>

<span class="c1"># Read user data
</span><span class="n">user_data</span> <span class="o">=</span> <span class="n">partitioner</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="mi">123456</span><span class="p">)</span>
</code></pre></div></div>

<p><strong>Hotspot problem:</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>If most users have IDs 0-100,000:
  Partition 1: Overloaded! ğŸ“ˆ
  Partition 2-4: Idle ğŸ’¤
  
Unbalanced load!
</code></pre></div></div>

<h3 id="strategy-2-hash-partitioning">Strategy 2: Hash Partitioning</h3>

<p><strong>Idea</strong>: Hash key, use hash to determine partition</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>key â†’ hash(key) â†’ partition

Example:
user_id = 123456
hash(123456) = 42
partition = 42 % 4 = 2
â†’ Send to Partition 2
</code></pre></div></div>

<p><strong>Pros</strong>: Even distribution (no hotspots)
<strong>Cons</strong>: Range queries impossible</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">HashPartitioner</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Partition data by hash of key
    </span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">nodes</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">nodes</span> <span class="o">=</span> <span class="n">nodes</span>
        <span class="n">self</span><span class="p">.</span><span class="n">num_nodes</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">get_partition</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Hash key to determine partition
        </span><span class="sh">"""</span>
        <span class="c1"># Hash key
</span>        <span class="n">hash_value</span> <span class="o">=</span> <span class="nf">hash</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        
        <span class="c1"># Modulo to get partition index
</span>        <span class="n">partition_idx</span> <span class="o">=</span> <span class="n">hash_value</span> <span class="o">%</span> <span class="n">self</span><span class="p">.</span><span class="n">num_nodes</span>
        
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">partition_idx</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">get_partition</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">node</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">get_partition</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">node</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

<span class="c1"># Usage
</span><span class="n">partitioner</span> <span class="o">=</span> <span class="nc">HashPartitioner</span><span class="p">([</span><span class="n">node1</span><span class="p">,</span> <span class="n">node2</span><span class="p">,</span> <span class="n">node3</span><span class="p">,</span> <span class="n">node4</span><span class="p">])</span>

<span class="c1"># Even distribution!
</span><span class="n">partitioner</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="sh">'</span><span class="s">data1</span><span class="sh">'</span><span class="p">)</span>     <span class="c1"># node2
</span><span class="n">partitioner</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="sh">'</span><span class="s">data2</span><span class="sh">'</span><span class="p">)</span>     <span class="c1"># node4
</span><span class="n">partitioner</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="sh">'</span><span class="s">data3</span><span class="sh">'</span><span class="p">)</span>     <span class="c1"># node1
</span><span class="n">partitioner</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="mi">123456</span><span class="p">,</span> <span class="sh">'</span><span class="s">data</span><span class="sh">'</span><span class="p">)</span> <span class="c1"># node2
</span></code></pre></div></div>

<p><strong>Problem with adding/removing nodes:</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>With 4 nodes: hash(key) % 4 = 2 â†’ node2
Add node5 (now 5 nodes): hash(key) % 5 = 4 â†’ node5

All keys need remapping! ğŸ˜±
Expensive!
</code></pre></div></div>

<h3 id="strategy-3-consistent-hashing">Strategy 3: Consistent Hashing</h3>

<p><strong>Idea</strong>: Minimize remapping when adding/removing nodes</p>

<p><strong>How it works:</strong></p>

<ol>
  <li>Hash both keys and nodes to same space (e.g., 0-360Â°)</li>
  <li>Place nodes on circle</li>
  <li>Key goes to next node clockwise</li>
</ol>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Circle (0-360Â°):
         0Â°
         |
    Node B (45Â°)
         |
    Node C (120Â°)
         |
    Node D (200Â°)
         |
    Node A (290Â°)
         |
       360Â° (= 0Â°)

Key x hashes to 100Â° â†’ Goes to Node C (next clockwise at 120Â°)
Key y hashes to 250Â° â†’ Goes to Node A (next clockwise at 290Â°)

Add Node E at 160Â°:
- Only keys between 120Â° and 160Â° move from C to E
- All other keys unchanged!
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">bisect</span>

<span class="k">class</span> <span class="nc">ConsistentHashRing</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Consistent hashing for minimal remapping
    </span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">virtual_nodes</span><span class="o">=</span><span class="mi">150</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">virtual_nodes</span> <span class="o">=</span> <span class="n">virtual_nodes</span>
        <span class="n">self</span><span class="p">.</span><span class="n">ring</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">node_map</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_add_node</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_add_node</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Add node to ring with multiple virtual nodes
        
        Virtual nodes for better distribution
        </span><span class="sh">"""</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">virtual_nodes</span><span class="p">):</span>
            <span class="c1"># Hash node + replica number
</span>            <span class="n">virtual_key</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">node</span><span class="p">.</span><span class="nb">id</span><span class="si">}</span><span class="s">-</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="sh">"</span>
            <span class="n">hash_value</span> <span class="o">=</span> <span class="nf">hash</span><span class="p">(</span><span class="n">virtual_key</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="mi">32</span><span class="p">)</span>
            
            <span class="c1"># Insert into sorted ring
</span>            <span class="n">bisect</span><span class="p">.</span><span class="nf">insort</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">ring</span><span class="p">,</span> <span class="n">hash_value</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">node_map</span><span class="p">[</span><span class="n">hash_value</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span>
    
    <span class="k">def</span> <span class="nf">get_node</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Find node for key
        
        O(log N) lookup using binary search
        </span><span class="sh">"""</span>
        <span class="c1"># Hash key
</span>        <span class="n">hash_value</span> <span class="o">=</span> <span class="nf">hash</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="mi">32</span><span class="p">)</span>
        
        <span class="c1"># Find next node clockwise
</span>        <span class="n">idx</span> <span class="o">=</span> <span class="n">bisect</span><span class="p">.</span><span class="nf">bisect_right</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">ring</span><span class="p">,</span> <span class="n">hash_value</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">ring</span><span class="p">):</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Wrap around
</span>        
        <span class="n">ring_position</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">ring</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">node_map</span><span class="p">[</span><span class="n">ring_position</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">add_node</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Add new node
        
        Only ~1/N keys need remapping!
        </span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_add_node</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Added </span><span class="si">{</span><span class="n">node</span><span class="p">.</span><span class="nb">id</span><span class="si">}</span><span class="s">, only ~</span><span class="si">{</span><span class="mi">100</span><span class="o">/</span><span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">ring</span><span class="p">)</span><span class="o">*</span><span class="n">self</span><span class="p">.</span><span class="n">virtual_nodes</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s">% keys remapped</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">remove_node</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Remove node from ring</span><span class="sh">"""</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">virtual_nodes</span><span class="p">):</span>
            <span class="n">virtual_key</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">node</span><span class="p">.</span><span class="nb">id</span><span class="si">}</span><span class="s">-</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="sh">"</span>
            <span class="n">hash_value</span> <span class="o">=</span> <span class="nf">hash</span><span class="p">(</span><span class="n">virtual_key</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="mi">32</span><span class="p">)</span>
            
            <span class="n">idx</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">ring</span><span class="p">.</span><span class="nf">index</span><span class="p">(</span><span class="n">hash_value</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">self</span><span class="p">.</span><span class="n">ring</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">self</span><span class="p">.</span><span class="n">node_map</span><span class="p">[</span><span class="n">hash_value</span><span class="p">]</span>

<span class="c1"># Usage
</span><span class="n">ring</span> <span class="o">=</span> <span class="nc">ConsistentHashRing</span><span class="p">([</span><span class="n">node1</span><span class="p">,</span> <span class="n">node2</span><span class="p">,</span> <span class="n">node3</span><span class="p">,</span> <span class="n">node4</span><span class="p">])</span>

<span class="c1"># Keys distributed evenly
</span><span class="n">key1_node</span> <span class="o">=</span> <span class="n">ring</span><span class="p">.</span><span class="nf">get_node</span><span class="p">(</span><span class="sh">'</span><span class="s">user_123</span><span class="sh">'</span><span class="p">)</span>
<span class="n">key2_node</span> <span class="o">=</span> <span class="n">ring</span><span class="p">.</span><span class="nf">get_node</span><span class="p">(</span><span class="sh">'</span><span class="s">user_456</span><span class="sh">'</span><span class="p">)</span>

<span class="c1"># Add node - minimal disruption!
</span><span class="n">ring</span><span class="p">.</span><span class="nf">add_node</span><span class="p">(</span><span class="n">node5</span><span class="p">)</span>
</code></pre></div></div>

<p><strong>Use in ML:</strong></p>

<ul>
  <li><strong>Feature store</strong>: Partition features by entity ID</li>
  <li><strong>Training data</strong>: Distribute examples across workers</li>
  <li><strong>Model serving</strong>: Distribute prediction requests</li>
</ul>

<hr />

<h2 id="real-world-case-study-netflix-recommendation-system">Real-World Case Study: Netflix Recommendation System</h2>

<h3 id="architecture">Architecture</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Global Load Balancer                    â”‚
â”‚                         (GeoDNS)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â–¼           â–¼           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  US     â”‚ â”‚  EU    â”‚ â”‚ APAC   â”‚  â† Regional clusters
â”‚ Region  â”‚ â”‚ Region â”‚ â”‚ Region â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
     â”‚          â”‚          â”‚
     â–¼          â–¼          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Cassandra (User Profiles) â”‚  â† Distributed database
â”‚   Replicated across regions â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Recommendation Service     â”‚  â† 1000s of instances
â”‚  (Load balanced)            â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
   â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”
   â–¼        â–¼
â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”
â”‚Cacheâ”‚  â”‚Modelâ”‚  â† Redis cache + Model replicas
â”‚Redisâ”‚  â”‚Serveâ”‚
â””â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”˜
</code></pre></div></div>

<h3 id="key-distributed-systems-principles-used">Key Distributed Systems Principles Used</h3>

<ol>
  <li><strong>Geographic distribution</strong>: Users routed to nearest region (low latency)</li>
  <li><strong>Replication</strong>: User data replicated across 3 regions (high availability)</li>
  <li><strong>Caching</strong>: Hot recommendations cached (reduce compute)</li>
  <li><strong>Load balancing</strong>: Requests distributed across 1000s of servers</li>
  <li><strong>Eventual consistency</strong>: Viewing history can be slightly stale</li>
  <li><strong>Partitioning</strong>: Users partitioned by user_id (horizontal scaling)</li>
</ol>

<h3 id="numbers">Numbers</h3>

<ul>
  <li><strong>200M+ users</strong></li>
  <li><strong>1B+ recommendation requests/day</strong></li>
  <li><strong>3 regions</strong> (US, EU, APAC)</li>
  <li><strong>1000s of servers</strong> per region</li>
  <li><strong>&lt; 100ms</strong> p99 latency for recommendations</li>
</ul>

<p><strong>How they handle failure:</strong></p>

<ul>
  <li><strong>Region failure</strong>: Route traffic to other regions</li>
  <li><strong>Server failure</strong>: Load balancer removes from pool</li>
  <li><strong>Cache miss</strong>: Fall back to model inference</li>
  <li><strong>Database failure</strong>: Serve stale data from replica</li>
</ul>

<hr />

<h2 id="key-takeaways">Key Takeaways</h2>

<p>âœ… <strong>Horizontal scaling</strong> - Add machines, not bigger machines<br />
âœ… <strong>Replication</strong> - Multiple copies for availability<br />
âœ… <strong>Sharding</strong> - Split data for scalability<br />
âœ… <strong>Load balancing</strong> - Distribute requests evenly<br />
âœ… <strong>Fault tolerance</strong> - Design for failure, not perfection<br />
âœ… <strong>Async communication</strong> - Pub-sub for decoupling<br />
âœ… <strong>Consistency trade-offs</strong> - CP vs AP based on use case</p>

<p><strong>Core principles:</strong></p>
<ol>
  <li>Failures are normal - design for them</li>
  <li>Network is unreliable - use retries, timeouts</li>
  <li>Consistency costs performance - choose wisely</li>
  <li>Monitoring is essential - you canâ€™t fix what you canâ€™t see</li>
</ol>

<hr />

<p><strong>Originally published at:</strong> <a href="https://www.arunbaby.com/ml-system-design/0012-distributed-systems/">arunbaby.com/ml-system-design/0012-distributed-systems</a></p>

<p><em>If you found this helpful, consider sharing it with others who might benefit.</em></p>


        
      </section>

      <footer class="page__meta">
        
        
  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      <a href="/tags/#consistency" class="page__taxonomy-item p-category" rel="tag">consistency</a><span class="sep">, </span>
    
      <a href="/tags/#distributed-systems" class="page__taxonomy-item p-category" rel="tag">distributed-systems</a><span class="sep">, </span>
    
      <a href="/tags/#fault-tolerance" class="page__taxonomy-item p-category" rel="tag">fault-tolerance</a><span class="sep">, </span>
    
      <a href="/tags/#load-balancing" class="page__taxonomy-item p-category" rel="tag">load-balancing</a><span class="sep">, </span>
    
      <a href="/tags/#microservices" class="page__taxonomy-item p-category" rel="tag">microservices</a><span class="sep">, </span>
    
      <a href="/tags/#scalability" class="page__taxonomy-item p-category" rel="tag">scalability</a>
    
    </span>
  </p>




  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      <a href="/categories/#ml-system-design" class="page__taxonomy-item p-category" rel="tag">ml-system-design</a>
    
    </span>
  </p>


        
      </footer>

      <div class="page__related page__related--full">
  <h2 class="page__related-title">Related across topics</h2>
  <style>
    /* Make section span full content width and use 2 equal columns */
    .page__related--full { float: inline-start; width: 100%; padding: 0; }
    .cross-related-grid { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 2rem; }
    @media (max-width: 768px) { .cross-related-grid { grid-template-columns: 1fr; } }
    /* Ensure archive cards stretch nicely in the grid */
    .cross-related-grid .list__item, .cross-related-grid .grid__item { width: auto; float: none; margin: 0; }
  </style>
  <div class="cross-related-grid">
    



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/dsa/0012-add-two-numbers/" rel="permalink">Add Two Numbers
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          23 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Master digit-by-digit addition with linked lists: Handle carry propagation elegantly. Classic problem teaching pointer manipulation and edge cases.
</p>
  </article>
</div>




<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/speech-tech/0012-multi-speaker-asr/" rel="permalink">Multi-Speaker ASR
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          8 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Build production multi-speaker ASR systems: Combine speech recognition, speaker diarization, and overlap handling for real-world conversations.
</p>
  </article>
</div>

  </div>
</div>

      <section class="page__share">
  <h4 class="page__share-title">Share on</h4>

  <a href="https://twitter.com/intent/tweet?via=arunbaby0&text=Distributed+ML+Systems%20https%3A%2F%2Fwww.arunbaby.com%2Fml-system-design%2F0012-distributed-systems%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fwww.arunbaby.com%2Fml-system-design%2F0012-distributed-systems%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://www.arunbaby.com/ml-system-design/0012-distributed-systems/" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/ml-system-design/0011-content-delivery-network/" class="pagination--pager" title="Content Delivery Networks (CDN)">Previous</a>
    
    
      <a href="/ml-system-design/0013-resource-allocation-for-ml/" class="pagination--pager" title="Resource Allocation for ML">Next</a>
    
  </nav>


    </div>

    
  </article>

  
  
</div>

      
    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';" role="search">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    
      
        
          <li><a href="https://twitter.com/arunbaby0" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
        
      
        
          <li><a href="https://github.com/arunbaby0" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
        
          <li><a href="https://www.linkedin.com/in/arunbaby0/" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i> LinkedIn</a></li>
        
      
        
          <li><a href="https://scholar.google.co.in/citations?user=6fSYWhkAAAAJ" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-graduation-cap" aria-hidden="true"></i> Google Scholar</a></li>
        
      
    

    
      <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 1990 - 2143 <a href="https://www.arunbaby.com">Arun Baby</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>




  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-0JRJPEC9SS"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-0JRJPEC9SS', { 'anonymize_ip': false});
</script>








  </body>
</html>
