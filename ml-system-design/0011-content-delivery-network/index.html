<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.26.2 by Michael Rose
  Copyright 2013-2024 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->

<html lang="en-US" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Content Delivery Networks (CDN) - Arun Baby</title>
<meta name="description" content="Design a global CDN for ML systems: Edge caching reduces latency from 500ms to 50ms. Critical for real-time predictions worldwide.">


  <meta name="author" content="Arun Baby">
  
  <meta property="article:author" content="Arun Baby">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Arun Baby">
<meta property="og:title" content="Content Delivery Networks (CDN)">
<meta property="og:url" content="https://www.arunbaby.com/ml-system-design/0011-content-delivery-network/">


  <meta property="og:description" content="Design a global CDN for ML systems: Edge caching reduces latency from 500ms to 50ms. Critical for real-time predictions worldwide.">



  <meta property="og:image" content="https://www.arunbaby.com/assets/images/profile-photo.png">



  <meta name="twitter:site" content="@arunbaby0">
  <meta name="twitter:title" content="Content Delivery Networks (CDN)">
  <meta name="twitter:description" content="Design a global CDN for ML systems: Edge caching reduces latency from 500ms to 50ms. Critical for real-time predictions worldwide.">
  <meta name="twitter:url" content="https://www.arunbaby.com/ml-system-design/0011-content-delivery-network/">

  
    <meta name="twitter:card" content="summary">
    
      <meta name="twitter:image" content="https://www.arunbaby.com/assets/images/profile-photo.png">
    
  

  



  <meta property="article:published_time" content="2025-12-26T21:44:08+05:30">





  

  


<link rel="canonical" href="https://www.arunbaby.com/ml-system-design/0011-content-delivery-network/">












<!-- end _includes/seo.html -->



  <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Arun Baby Feed">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
  
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css"></noscript>



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single" dir="ltr">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
           
          <span class="site-subtitle">Arun Baby</span>
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a
                href="/about/"
                
                
              >About</a>
            </li><li class="masthead__menu-item">
              <a
                href="/dsa/"
                
                
              >DSA</a>
            </li><li class="masthead__menu-item">
              <a
                href="/ml-system-design/"
                
                
              >ML Systems</a>
            </li><li class="masthead__menu-item">
              <a
                href="/speech-tech/"
                
                
              >Speech Tech</a>
            </li><li class="masthead__menu-item">
              <a
                href="/ai-agents/"
                
                
              >AI Agents</a>
            </li><li class="masthead__menu-item">
              <a
                href="/publications/"
                
                
              >Publications</a>
            </li><li class="masthead__menu-item">
              <a
                href="/statuses/"
                
                
              >Statuses</a>
            </li><li class="masthead__menu-item">
              <a
                href="/contact/"
                
                
              >Contact</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <i class="fas fa-search"></i>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      





<div id="main" role="main" class="no-author-sidebar">
  
  <div class="sidebar sticky">
  
  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Content Delivery Networks (CDN)">
    <meta itemprop="description" content="Design a global CDN for ML systems: Edge caching reduces latency from 500ms to 50ms. Critical for real-time predictions worldwide.">
    <meta itemprop="datePublished" content="2025-12-26T21:44:08+05:30">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">
            <a href="https://www.arunbaby.com/ml-system-design/0011-content-delivery-network/" itemprop="url">Content Delivery Networks (CDN)
</a>
          </h1>
          

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          22 minute read
        
      </span>
    
  </p>


        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right sticky">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> On this page</h4></header>
              <ul class="toc__menu"><li><a href="#problem-statement">Problem Statement</a><ul><li><a href="#why-do-we-need-a-cdn">Why Do We Need a CDN?</a></li><li><a href="#real-world-impact-on-ml-systems">Real-World Impact on ML Systems</a></li><li><a href="#what-cdn-does-for-you">What CDN Does for You</a></li><li><a href="#requirements">Requirements</a></li></ul></li><li><a href="#high-level-architecture">High-Level Architecture</a></li><li><a href="#core-components">Core Components</a><ul><li><a href="#1-edge-servers">1. Edge Servers</a></li><li><a href="#2-global-load-balancer--geodns">2. Global Load Balancer / GeoDNS</a></li><li><a href="#3-cache-invalidation-system">3. Cache Invalidation System</a></li></ul></li><li><a href="#ml-model-serving-at-edge">ML Model Serving at Edge</a><ul><li><a href="#edge-inference">Edge Inference</a></li><li><a href="#model-distribution-to-edge">Model Distribution to Edge</a></li></ul></li><li><a href="#monitoring--observability">Monitoring &amp; Observability</a><ul><li><a href="#cdn-metrics-dashboard">CDN Metrics Dashboard</a></li></ul></li><li><a href="#cost-optimization">Cost Optimization</a><ul><li><a href="#tiered-caching-strategy">Tiered Caching Strategy</a></li></ul></li><li><a href="#key-takeaways">Key Takeaways</a></li></ul>
            </nav>
          </aside>
        
        <p><strong>Design a global CDN for ML systems: Edge caching reduces latency from 500ms to 50ms. Critical for real-time predictions worldwide.</strong></p>

<h2 id="problem-statement">Problem Statement</h2>

<p>Design a <strong>Content Delivery Network (CDN)</strong> for serving:</p>
<ol>
  <li><strong>ML model inference</strong> (predictions at the edge)</li>
  <li><strong>Static assets</strong> (model weights, configs, embeddings)</li>
  <li><strong>API responses</strong> (cached predictions, feature data)</li>
</ol>

<h3 id="why-do-we-need-a-cdn">Why Do We Need a CDN?</h3>

<p><strong>The Core Problem: Distance Creates Latency</strong></p>

<p>Imagine youâ€™re a user in Tokyo trying to access a website hosted in Virginia, USA:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>User (Tokyo) â”€â”€â”€â”€â”€â”€â”€â”€ 10,000 km â”€â”€â”€â”€â”€â”€â”€â”€ Server (Virginia)
                  ~150ms round-trip time
</code></pre></div></div>

<p><strong>The physics problem:</strong></p>
<ul>
  <li>Light travels at 300,000 km/s</li>
  <li>Signal in fiber: ~200,000 km/s</li>
  <li>Tokyo â†” Virginia: ~10,000 km</li>
  <li><strong>Theoretical minimum:</strong> 50ms</li>
  <li><strong>Reality with routing:</strong> 150-200ms</li>
</ul>

<p><strong>What if we could serve from Tokyo instead?</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>User (Tokyo) â”€â”€ 10 km â”€â”€ Edge Server (Tokyo)
                ~1-2ms!
</code></pre></div></div>

<p>Thatâ€™s a <strong>75-100x improvement</strong> just from being geographically closer!</p>

<h3 id="real-world-impact-on-ml-systems">Real-World Impact on ML Systems</h3>

<p><strong>Scenario: Real-time recommendation system</strong></p>

<table>
  <thead>
    <tr>
      <th>Architecture</th>
      <th>Latency</th>
      <th>User Experience</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>Without CDN</strong>: Request â†’ US â†’ Model Inference â†’ Response</td>
      <td>200ms+</td>
      <td>Noticeable delay, users leave</td>
    </tr>
    <tr>
      <td><strong>With CDN</strong>: Request â†’ Local Edge â†’ Cached/Local Inference â†’ Response</td>
      <td>20-50ms</td>
      <td>Feels instant âœ“</td>
    </tr>
  </tbody>
</table>

<p><strong>The business impact:</strong></p>
<ul>
  <li>Every 100ms of latency = 1% drop in sales (Amazon study)</li>
  <li>For ML systems: Users wonâ€™t wait for slow predictions</li>
  <li>CDN makes your ML system feel instant globally</li>
</ul>

<h3 id="what-cdn-does-for-you">What CDN Does for You</h3>

<p><strong>1. Geographic Distribution</strong>
Cache content at multiple locations worldwide (edge servers)</p>

<p><strong>2. Intelligent Caching</strong>
Store frequently accessed content close to users</p>

<p><strong>3. Smart Routing</strong>
Direct users to the best edge server (closest + healthy + low load)</p>

<p><strong>4. Fault Tolerance</strong>
If one edge fails, route to another</p>

<p><strong>5. Bandwidth Savings</strong>
Serve from edge â†’ Less traffic to origin â†’ Lower costs</p>

<h3 id="requirements">Requirements</h3>

<p><strong>Functional:</strong></p>
<ul>
  <li>Serve content from geographically distributed edge locations</li>
  <li>Cache popular content close to users</li>
  <li>Route requests to nearest/best edge server</li>
  <li>Handle cache invalidation and updates</li>
  <li>Support both static and dynamic content</li>
</ul>

<p><strong>Non-Functional:</strong></p>
<ul>
  <li><strong>Latency:</strong> &lt; 50ms p99 for edge hits (vs 200-500ms from origin)</li>
  <li><strong>Availability:</strong> 99.99% uptime (4 minutes downtime/month)</li>
  <li><strong>Scalability:</strong> Handle 1M+ requests/second globally</li>
  <li><strong>Cache hit rate:</strong> &gt; 80% for static content (fewer origin requests)</li>
  <li><strong>Global coverage:</strong> Presence in 50+ regions</li>
</ul>

<hr />

<h2 id="high-level-architecture">High-Level Architecture</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       USER REQUESTS                          â”‚
â”‚   ğŸŒ Asia    ğŸŒ Europe    ğŸŒ Americas    ğŸŒ Africa          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚            â”‚            â”‚              â”‚
        â†“            â†“            â†“              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   DNS / GLOBAL LOAD BALANCER               â”‚
â”‚  â€¢ GeoDNS routing                                          â”‚
â”‚  â€¢ Health checks                                           â”‚
â”‚  â€¢ Latency-based routing                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚            â”‚            â”‚              â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
    â”‚ Edge    â”‚  â”‚ Edge    â”‚ â”‚ Edge    â”‚   â”‚ Edge    â”‚
    â”‚ Tokyo   â”‚  â”‚ London  â”‚ â”‚ N.Virginiaâ”‚  â”‚ Mumbai  â”‚
    â”‚         â”‚  â”‚         â”‚ â”‚         â”‚   â”‚         â”‚
    â”‚ L1 Cacheâ”‚  â”‚ L1 Cacheâ”‚ â”‚ L1 Cacheâ”‚   â”‚ L1 Cacheâ”‚
    â”‚ (Redis) â”‚  â”‚ (Redis) â”‚ â”‚ (Redis) â”‚   â”‚ (Redis) â”‚
    â”‚         â”‚  â”‚         â”‚ â”‚         â”‚   â”‚         â”‚
    â”‚ ML Modelâ”‚  â”‚ ML Modelâ”‚ â”‚ ML Modelâ”‚   â”‚ ML Modelâ”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
         â”‚            â”‚            â”‚              â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ ORIGIN SERVERS â”‚
              â”‚                â”‚
              â”‚ â€¢ Master modelsâ”‚
              â”‚ â€¢ Databases    â”‚
              â”‚ â€¢ Feature storeâ”‚
              â”‚ â€¢ Object store â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div></div>

<hr />

<h2 id="core-components">Core Components</h2>

<h3 id="1-edge-servers">1. Edge Servers</h3>

<p><strong>Purpose:</strong> Serve content from locations close to users</p>

<p>Before we dive into code, letâ€™s understand the concept:</p>

<p><strong>What is an Edge Server?</strong></p>

<p>Think of edge servers like local convenience stores:</p>
<ul>
  <li><strong>Origin Server</strong> = Central warehouse (far away, has everything)</li>
  <li><strong>Edge Server</strong> = Local store (nearby, has popular items)</li>
</ul>

<p>When you need milk:</p>
<ul>
  <li>Without edge: Drive to warehouse (30 min)</li>
  <li>With edge: Walk to local store (2 min)</li>
</ul>

<p><strong>Multi-Level Cache Strategy</strong></p>

<p>Edge servers use multiple cache layers:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Request â†’ L1 Cache (Redis, in-memory)  â† Fastest, smallest
          â†“ Miss
          L2 Cache (Disk, local SSD)    â† Fast, medium
          â†“ Miss
          Origin Server (Database)      â† Slow, largest
</code></pre></div></div>

<p><strong>Why multiple levels?</strong></p>

<ol>
  <li><strong>L1 (Redis)</strong>: Hot data, 50-100ms access, expensive ($100/GB/month)</li>
  <li><strong>L2 (Disk)</strong>: Warm data, 5-10ms access, cheap ($10/GB/month)</li>
  <li><strong>Origin</strong>: Cold data, 100-500ms access, cheapest ($0.02/GB/month)</li>
</ol>

<p><strong>Trade-off</strong>: Speed vs Cost vs Capacity</p>

<table>
  <thead>
    <tr>
      <th>Cache</th>
      <th>Speed</th>
      <th>Cost</th>
      <th>Capacity</th>
      <th>Use Case</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>L1 (Redis)</td>
      <td>1ms</td>
      <td>High</td>
      <td>Small (10GB)</td>
      <td>Prediction results, hot features</td>
    </tr>
    <tr>
      <td>L2 (Disk)</td>
      <td>10ms</td>
      <td>Medium</td>
      <td>Medium (100GB)</td>
      <td>Model weights, embeddings</td>
    </tr>
    <tr>
      <td>Origin</td>
      <td>200ms</td>
      <td>Low</td>
      <td>Large (TB+)</td>
      <td>Full dataset, historical data</td>
    </tr>
  </tbody>
</table>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">EdgeServer</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    CDN edge server
    
    Components:
    - L1 cache (Redis): Hot content
    - L2 cache (local disk): Warm content
    - ML model: For edge inference
    - Origin client: Fetch misses from origin
    </span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">region</span><span class="p">,</span> <span class="n">origin_url</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">region</span> <span class="o">=</span> <span class="n">region</span>
        <span class="n">self</span><span class="p">.</span><span class="n">origin_url</span> <span class="o">=</span> <span class="n">origin_url</span>
        
        <span class="c1"># Multi-level cache
</span>        <span class="kn">import</span> <span class="n">redis</span>
        <span class="kn">import</span> <span class="n">pickle</span>
        <span class="n">self</span><span class="p">.</span><span class="n">l1_cache</span> <span class="o">=</span> <span class="n">redis</span><span class="p">.</span><span class="nc">Redis</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="sh">'</span><span class="s">localhost</span><span class="sh">'</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">6379</span><span class="p">)</span>
        
        <span class="c1"># Minimal DiskCache stub for illustration
</span>        <span class="k">class</span> <span class="nc">DiskCache</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">size_gb</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
                <span class="n">self</span><span class="p">.</span><span class="n">store</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">store</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
                <span class="n">self</span><span class="p">.</span><span class="n">store</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
                <span class="n">self</span><span class="p">.</span><span class="n">store</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">def</span> <span class="nf">delete_pattern</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">):</span>
                <span class="c1"># naive pattern matcher
</span>                <span class="kn">import</span> <span class="n">fnmatch</span>
                <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">store</span><span class="p">.</span><span class="nf">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">fnmatch</span><span class="p">.</span><span class="nf">fnmatch</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">pattern</span><span class="p">)]</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">store</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">l2_cache</span> <span class="o">=</span> <span class="nc">DiskCache</span><span class="p">(</span><span class="n">size_gb</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
        
        <span class="c1"># ML model for edge inference
</span>        <span class="k">def</span> <span class="nf">load_model</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">return</span> <span class="nf">object</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="nf">load_model</span><span class="p">(</span><span class="sh">'</span><span class="s">model.onnx</span><span class="sh">'</span><span class="p">)</span>
        
        <span class="c1"># Metrics
</span>        <span class="n">self</span><span class="p">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="nc">EdgeMetrics</span><span class="p">()</span>
    
    <span class="k">async</span> <span class="k">def</span> <span class="nf">handle_request</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Handle incoming request
        
        Flow:
        1. Check L1 cache (Redis)
        2. Check L2 cache (disk)
        3. Fetch from origin
        4. Update caches
        </span><span class="sh">"""</span>
        <span class="kn">import</span> <span class="n">time</span><span class="p">,</span> <span class="n">json</span><span class="p">,</span> <span class="n">pickle</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        
        <span class="c1"># Generate cache key
</span>        <span class="n">cache_key</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_generate_cache_key</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        
        <span class="c1"># Try L1 cache
</span>        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_check_l1_cache</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">response</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">metrics</span><span class="p">.</span><span class="nf">record_hit</span><span class="p">(</span><span class="sh">'</span><span class="s">l1</span><span class="sh">'</span><span class="p">,</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">response</span>
        
        <span class="c1"># Try L2 cache
</span>        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_check_l2_cache</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">response</span><span class="p">:</span>
            <span class="c1"># Promote to L1
</span>            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_store_l1_cache</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">metrics</span><span class="p">.</span><span class="nf">record_hit</span><span class="p">(</span><span class="sh">'</span><span class="s">l2</span><span class="sh">'</span><span class="p">,</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">response</span>
        
        <span class="c1"># Cache miss: fetch from origin
</span>        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_fetch_from_origin</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        
        <span class="c1"># Update caches
</span>        <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_store_l1_cache</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_store_l2_cache</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">metrics</span><span class="p">.</span><span class="nf">record_miss</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">response</span>
    
    <span class="k">async</span> <span class="k">def</span> <span class="nf">_check_l1_cache</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Check L1 (Redis) cache</span><span class="sh">"""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">l1_cache</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">pickle</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">L1 cache error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="bp">None</span>
    
    <span class="k">async</span> <span class="k">def</span> <span class="nf">_store_l1_cache</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">ttl</span><span class="o">=</span><span class="mi">300</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Store in L1 cache with TTL</span><span class="sh">"""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">l1_cache</span><span class="p">.</span><span class="nf">setex</span><span class="p">(</span>
                <span class="n">key</span><span class="p">,</span>
                <span class="n">ttl</span><span class="p">,</span>
                <span class="n">pickle</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">L1 cache store error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="k">async</span> <span class="k">def</span> <span class="nf">_check_l2_cache</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Check L2 (disk) cache</span><span class="sh">"""</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">l2_cache</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    
    <span class="k">async</span> <span class="k">def</span> <span class="nf">_store_l2_cache</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Store in L2 cache</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="n">l2_cache</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    
    <span class="k">async</span> <span class="k">def</span> <span class="nf">_fetch_from_origin</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Fetch from origin server</span><span class="sh">"""</span>
        <span class="kn">import</span> <span class="n">aiohttp</span>
        
        <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="p">.</span><span class="nc">ClientSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
            <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span>
                <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">origin_url</span><span class="si">}{</span><span class="n">request</span><span class="p">.</span><span class="n">path</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span>
                <span class="n">json</span><span class="o">=</span><span class="n">request</span><span class="p">.</span><span class="n">data</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">response</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">_generate_cache_key</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Generate cache key from request</span><span class="sh">"""</span>
        <span class="kn">import</span> <span class="n">hashlib</span>
        
        <span class="c1"># Include path and normalized data
</span>        <span class="n">key_data</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">request</span><span class="p">.</span><span class="n">path</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span>
        <span class="k">return</span> <span class="n">hashlib</span><span class="p">.</span><span class="nf">md5</span><span class="p">(</span><span class="n">key_data</span><span class="p">.</span><span class="nf">encode</span><span class="p">()).</span><span class="nf">hexdigest</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">EdgeMetrics</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Track edge server metrics</span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">l1_hits</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">l2_hits</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">misses</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">l1_latencies</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">l2_latencies</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">miss_latencies</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">record_hit</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">latency</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">level</span> <span class="o">==</span> <span class="sh">'</span><span class="s">l1</span><span class="sh">'</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">l1_hits</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">self</span><span class="p">.</span><span class="n">l1_latencies</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">latency</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">level</span> <span class="o">==</span> <span class="sh">'</span><span class="s">l2</span><span class="sh">'</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">l2_hits</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">self</span><span class="p">.</span><span class="n">l2_latencies</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">latency</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">record_miss</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">latency</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">misses</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">self</span><span class="p">.</span><span class="n">miss_latencies</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">latency</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">get_stats</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">total</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">l1_hits</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">l2_hits</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">misses</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">l1_hit_rate</span><span class="sh">'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">l1_hits</span> <span class="o">/</span> <span class="n">total</span> <span class="k">if</span> <span class="n">total</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">l2_hit_rate</span><span class="sh">'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">l2_hits</span> <span class="o">/</span> <span class="n">total</span> <span class="k">if</span> <span class="n">total</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">miss_rate</span><span class="sh">'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">misses</span> <span class="o">/</span> <span class="n">total</span> <span class="k">if</span> <span class="n">total</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">avg_l1_latency_ms</span><span class="sh">'</span><span class="p">:</span> <span class="n">np</span><span class="p">.</span><span class="nf">mean</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">l1_latencies</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span> <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">l1_latencies</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">avg_l2_latency_ms</span><span class="sh">'</span><span class="p">:</span> <span class="n">np</span><span class="p">.</span><span class="nf">mean</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">l2_latencies</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span> <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">l2_latencies</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">avg_miss_latency_ms</span><span class="sh">'</span><span class="p">:</span> <span class="n">np</span><span class="p">.</span><span class="nf">mean</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">miss_latencies</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span> <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">miss_latencies</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
        <span class="p">}</span>

<span class="c1"># Example usage
</span><span class="n">edge</span> <span class="o">=</span> <span class="nc">EdgeServer</span><span class="p">(</span><span class="n">region</span><span class="o">=</span><span class="sh">'</span><span class="s">us-east-1</span><span class="sh">'</span><span class="p">,</span> <span class="n">origin_url</span><span class="o">=</span><span class="sh">'</span><span class="s">https://api.example.com</span><span class="sh">'</span><span class="p">)</span>

<span class="c1"># Simulate requests
</span><span class="k">async</span> <span class="k">def</span> <span class="nf">simulate_requests</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
        <span class="n">request</span> <span class="o">=</span> <span class="nc">Request</span><span class="p">(</span>
            <span class="n">path</span><span class="o">=</span><span class="sh">'</span><span class="s">/predict</span><span class="sh">'</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">features</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]}</span>
        <span class="p">)</span>
        
        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">edge</span><span class="p">.</span><span class="nf">handle_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Request </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">response</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="c1"># Print metrics
</span>    <span class="n">stats</span> <span class="o">=</span> <span class="n">edge</span><span class="p">.</span><span class="n">metrics</span><span class="p">.</span><span class="nf">get_stats</span><span class="p">()</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">Edge Server Metrics:</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">stats</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="sh">'</span><span class="s">rate</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="o">%</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># Run
</span><span class="kn">import</span> <span class="n">asyncio</span>
<span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">simulate_requests</span><span class="p">())</span>
</code></pre></div></div>

<h3 id="2-global-load-balancer--geodns">2. Global Load Balancer / GeoDNS</h3>

<p><strong>Purpose:</strong> Route requests to optimal edge server</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">GlobalLoadBalancer</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Route requests to best edge server
    
    Routing strategies:
    1. Geographic proximity
    2. Server load
    3. Health status
    4. Network latency
    </span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">edge_servers</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_discover_edge_servers</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">health_checker</span> <span class="o">=</span> <span class="nc">HealthChecker</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">edge_servers</span><span class="p">)</span>
        
        <span class="c1"># Start health checking
</span>        <span class="n">self</span><span class="p">.</span><span class="n">health_checker</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">route_request</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">client_ip</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Route request to best edge server
        
        Args:
            client_ip: Client IP address
            request: Request object
        
        Returns:
            Best edge server
        </span><span class="sh">"""</span>
        <span class="c1"># Get client location
</span>        <span class="n">client_location</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_geolocate_ip</span><span class="p">(</span><span class="n">client_ip</span><span class="p">)</span>
        
        <span class="c1"># Get healthy edge servers
</span>        <span class="n">healthy_servers</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">health_checker</span><span class="p">.</span><span class="nf">get_healthy_servers</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">healthy_servers</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">Exception</span><span class="p">(</span><span class="sh">"</span><span class="s">No healthy edge servers available</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="c1"># Score each server
</span>        <span class="n">scores</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">server</span> <span class="ow">in</span> <span class="n">healthy_servers</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_score_server</span><span class="p">(</span>
                <span class="n">server</span><span class="p">,</span>
                <span class="n">client_location</span><span class="p">,</span>
                <span class="n">request</span>
            <span class="p">)</span>
            <span class="n">scores</span><span class="p">.</span><span class="nf">append</span><span class="p">((</span><span class="n">server</span><span class="p">,</span> <span class="n">score</span><span class="p">))</span>
        
        <span class="c1"># Sort by score (higher is better)
</span>        <span class="n">scores</span><span class="p">.</span><span class="nf">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        
        <span class="c1"># Return best server
</span>        <span class="k">return</span> <span class="n">scores</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">_score_server</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="n">client_location</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Score server for given request
        
        Factors:
        - Geographic distance (weight: 0.5)
        - Server load (weight: 0.3)
        - Cache hit rate (weight: 0.2)
        </span><span class="sh">"""</span>
        <span class="c1"># Geographic proximity
</span>        <span class="n">distance</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_calculate_distance</span><span class="p">(</span>
            <span class="n">client_location</span><span class="p">,</span>
            <span class="n">server</span><span class="p">.</span><span class="n">location</span>
        <span class="p">)</span>
        <span class="n">distance_score</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">distance</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span>  <span class="c1"># Normalize
</span>        
        <span class="c1"># Server load
</span>        <span class="n">load</span> <span class="o">=</span> <span class="n">server</span><span class="p">.</span><span class="nf">get_current_load</span><span class="p">()</span>
        <span class="n">load_score</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="nf">min</span><span class="p">(</span><span class="n">load</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
        
        <span class="c1"># Cache hit rate
</span>        <span class="n">hit_rate</span> <span class="o">=</span> <span class="n">server</span><span class="p">.</span><span class="n">metrics</span><span class="p">.</span><span class="nf">get_stats</span><span class="p">()[</span><span class="sh">'</span><span class="s">l1_hit_rate</span><span class="sh">'</span><span class="p">]</span>
        
        <span class="c1"># Weighted score
</span>        <span class="n">score</span> <span class="o">=</span> <span class="p">(</span>
            <span class="mf">0.5</span> <span class="o">*</span> <span class="n">distance_score</span> <span class="o">+</span>
            <span class="mf">0.3</span> <span class="o">*</span> <span class="n">load_score</span> <span class="o">+</span>
            <span class="mf">0.2</span> <span class="o">*</span> <span class="n">hit_rate</span>
        <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">score</span>
    
    <span class="k">def</span> <span class="nf">_geolocate_ip</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">ip</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Get geographic location from IP
        
        Uses MaxMind GeoIP or similar
        </span><span class="sh">"""</span>
        <span class="kn">import</span> <span class="n">geoip2.database</span>
        
        <span class="n">reader</span> <span class="o">=</span> <span class="n">geoip2</span><span class="p">.</span><span class="n">database</span><span class="p">.</span><span class="nc">Reader</span><span class="p">(</span><span class="sh">'</span><span class="s">GeoLite2-City.mmdb</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">reader</span><span class="p">.</span><span class="nf">city</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">lat</span><span class="sh">'</span><span class="p">:</span> <span class="n">response</span><span class="p">.</span><span class="n">location</span><span class="p">.</span><span class="n">latitude</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">lon</span><span class="sh">'</span><span class="p">:</span> <span class="n">response</span><span class="p">.</span><span class="n">location</span><span class="p">.</span><span class="n">longitude</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">city</span><span class="sh">'</span><span class="p">:</span> <span class="n">response</span><span class="p">.</span><span class="n">city</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">country</span><span class="sh">'</span><span class="p">:</span> <span class="n">response</span><span class="p">.</span><span class="n">country</span><span class="p">.</span><span class="n">name</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">_calculate_distance</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">loc1</span><span class="p">,</span> <span class="n">loc2</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Calculate distance between two locations (km)
        
        Uses Haversine formula
        </span><span class="sh">"""</span>
        <span class="kn">from</span> <span class="n">math</span> <span class="kn">import</span> <span class="n">radians</span><span class="p">,</span> <span class="n">sin</span><span class="p">,</span> <span class="n">cos</span><span class="p">,</span> <span class="n">sqrt</span><span class="p">,</span> <span class="n">atan2</span>
        
        <span class="n">R</span> <span class="o">=</span> <span class="mi">6371</span>  <span class="c1"># Earth radius in km
</span>        
        <span class="n">lat1</span><span class="p">,</span> <span class="n">lon1</span> <span class="o">=</span> <span class="nf">radians</span><span class="p">(</span><span class="n">loc1</span><span class="p">[</span><span class="sh">'</span><span class="s">lat</span><span class="sh">'</span><span class="p">]),</span> <span class="nf">radians</span><span class="p">(</span><span class="n">loc1</span><span class="p">[</span><span class="sh">'</span><span class="s">lon</span><span class="sh">'</span><span class="p">])</span>
        <span class="n">lat2</span><span class="p">,</span> <span class="n">lon2</span> <span class="o">=</span> <span class="nf">radians</span><span class="p">(</span><span class="n">loc2</span><span class="p">[</span><span class="sh">'</span><span class="s">lat</span><span class="sh">'</span><span class="p">]),</span> <span class="nf">radians</span><span class="p">(</span><span class="n">loc2</span><span class="p">[</span><span class="sh">'</span><span class="s">lon</span><span class="sh">'</span><span class="p">])</span>
        
        <span class="n">dlat</span> <span class="o">=</span> <span class="n">lat2</span> <span class="o">-</span> <span class="n">lat1</span>
        <span class="n">dlon</span> <span class="o">=</span> <span class="n">lon2</span> <span class="o">-</span> <span class="n">lon1</span>
        
        <span class="n">a</span> <span class="o">=</span> <span class="nf">sin</span><span class="p">(</span><span class="n">dlat</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="nf">cos</span><span class="p">(</span><span class="n">lat1</span><span class="p">)</span> <span class="o">*</span> <span class="nf">cos</span><span class="p">(</span><span class="n">lat2</span><span class="p">)</span> <span class="o">*</span> <span class="nf">sin</span><span class="p">(</span><span class="n">dlon</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">c</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="nf">atan2</span><span class="p">(</span><span class="nf">sqrt</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="nf">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">a</span><span class="p">))</span>
        
        <span class="n">distance</span> <span class="o">=</span> <span class="n">R</span> <span class="o">*</span> <span class="n">c</span>
        
        <span class="k">return</span> <span class="n">distance</span>
    
    <span class="k">def</span> <span class="nf">_discover_edge_servers</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Discover available edge servers</span><span class="sh">"""</span>
        <span class="c1"># In production, this would query service registry
</span>        <span class="k">return</span> <span class="p">[</span>
            <span class="nc">EdgeServerInfo</span><span class="p">(</span><span class="sh">'</span><span class="s">us-east-1</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">https://edge-us-east-1.example.com</span><span class="sh">'</span><span class="p">,</span> <span class="p">{</span><span class="sh">'</span><span class="s">lat</span><span class="sh">'</span><span class="p">:</span> <span class="mf">39.0</span><span class="p">,</span> <span class="sh">'</span><span class="s">lon</span><span class="sh">'</span><span class="p">:</span> <span class="o">-</span><span class="mf">77.5</span><span class="p">}),</span>
            <span class="nc">EdgeServerInfo</span><span class="p">(</span><span class="sh">'</span><span class="s">eu-west-1</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">https://edge-eu-west-1.example.com</span><span class="sh">'</span><span class="p">,</span> <span class="p">{</span><span class="sh">'</span><span class="s">lat</span><span class="sh">'</span><span class="p">:</span> <span class="mf">53.3</span><span class="p">,</span> <span class="sh">'</span><span class="s">lon</span><span class="sh">'</span><span class="p">:</span> <span class="o">-</span><span class="mf">6.3</span><span class="p">}),</span>
            <span class="nc">EdgeServerInfo</span><span class="p">(</span><span class="sh">'</span><span class="s">ap-northeast-1</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">https://edge-ap-northeast-1.example.com</span><span class="sh">'</span><span class="p">,</span> <span class="p">{</span><span class="sh">'</span><span class="s">lat</span><span class="sh">'</span><span class="p">:</span> <span class="mf">35.7</span><span class="p">,</span> <span class="sh">'</span><span class="s">lon</span><span class="sh">'</span><span class="p">:</span> <span class="mf">139.7</span><span class="p">}),</span>
        <span class="p">]</span>

<span class="k">class</span> <span class="nc">HealthChecker</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Monitor health of edge servers
    
    Checks:
    - HTTP health endpoint
    - Response time
    - Error rate
    </span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">servers</span><span class="p">,</span> <span class="n">check_interval</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">servers</span> <span class="o">=</span> <span class="n">servers</span>
        <span class="n">self</span><span class="p">.</span><span class="n">check_interval</span> <span class="o">=</span> <span class="n">check_interval</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">health_status</span> <span class="o">=</span> <span class="p">{</span><span class="n">server</span><span class="p">.</span><span class="n">region</span><span class="p">:</span> <span class="bp">True</span> <span class="k">for</span> <span class="n">server</span> <span class="ow">in</span> <span class="n">servers</span><span class="p">}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">last_check</span> <span class="o">=</span> <span class="p">{</span><span class="n">server</span><span class="p">.</span><span class="n">region</span><span class="p">:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">server</span> <span class="ow">in</span> <span class="n">servers</span><span class="p">}</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">running</span> <span class="o">=</span> <span class="bp">False</span>
    
    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Start health checking in background</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="n">running</span> <span class="o">=</span> <span class="bp">True</span>
        
        <span class="kn">import</span> <span class="n">threading</span>
        <span class="n">self</span><span class="p">.</span><span class="n">thread</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">_health_check_loop</span><span class="p">,</span> <span class="n">daemon</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">thread</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Stop health checking</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="n">running</span> <span class="o">=</span> <span class="bp">False</span>
    
    <span class="k">def</span> <span class="nf">_health_check_loop</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Health check loop</span><span class="sh">"""</span>
        <span class="k">while</span> <span class="n">self</span><span class="p">.</span><span class="n">running</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">server</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">servers</span><span class="p">:</span>
                <span class="n">healthy</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_check_server_health</span><span class="p">(</span><span class="n">server</span><span class="p">)</span>
                <span class="n">self</span><span class="p">.</span><span class="n">health_status</span><span class="p">[</span><span class="n">server</span><span class="p">.</span><span class="n">region</span><span class="p">]</span> <span class="o">=</span> <span class="n">healthy</span>
                <span class="n">self</span><span class="p">.</span><span class="n">last_check</span><span class="p">[</span><span class="n">server</span><span class="p">.</span><span class="n">region</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
            
            <span class="kn">import</span> <span class="n">time</span>
            <span class="n">time</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">check_interval</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_check_server_health</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">server</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Check if server is healthy</span><span class="sh">"""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="n">requests</span>
            
            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span>
                <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">server</span><span class="p">.</span><span class="n">url</span><span class="si">}</span><span class="s">/health</span><span class="sh">"</span><span class="p">,</span>
                <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span>
            <span class="p">)</span>
            
            <span class="k">if</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                <span class="c1"># Check response time
</span>                <span class="k">if</span> <span class="n">response</span><span class="p">.</span><span class="n">elapsed</span><span class="p">.</span><span class="nf">total_seconds</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">True</span>
            
            <span class="k">return</span> <span class="bp">False</span>
        
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Health check failed for </span><span class="si">{</span><span class="n">server</span><span class="p">.</span><span class="n">region</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>
    
    <span class="k">def</span> <span class="nf">get_healthy_servers</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Get list of healthy servers</span><span class="sh">"""</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">server</span> <span class="k">for</span> <span class="n">server</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">servers</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">health_status</span><span class="p">[</span><span class="n">server</span><span class="p">.</span><span class="n">region</span><span class="p">]</span>
        <span class="p">]</span>

<span class="k">class</span> <span class="nc">EdgeServerInfo</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Edge server information</span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">region</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">location</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">region</span> <span class="o">=</span> <span class="n">region</span>
        <span class="n">self</span><span class="p">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">url</span>
        <span class="n">self</span><span class="p">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">location</span>
        <span class="n">self</span><span class="p">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="nc">EdgeMetrics</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">get_current_load</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Get current server load (0-1)</span><span class="sh">"""</span>
        <span class="c1"># In production, query server metrics
</span>        <span class="k">return</span> <span class="mf">0.5</span>  <span class="c1"># Placeholder
</span>
<span class="c1"># Example usage
</span><span class="n">glb</span> <span class="o">=</span> <span class="nc">GlobalLoadBalancer</span><span class="p">()</span>

<span class="c1"># Route request
</span><span class="n">client_ip</span> <span class="o">=</span> <span class="sh">'</span><span class="s">8.8.8.8</span><span class="sh">'</span>  <span class="c1"># Google DNS (US)
</span><span class="n">request</span> <span class="o">=</span> <span class="nc">Request</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="sh">'</span><span class="s">/predict</span><span class="sh">'</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{})</span>

<span class="n">best_server</span> <span class="o">=</span> <span class="n">glb</span><span class="p">.</span><span class="nf">route_request</span><span class="p">(</span><span class="n">client_ip</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Routing to: </span><span class="si">{</span><span class="n">best_server</span><span class="p">.</span><span class="n">region</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="3-cache-invalidation-system">3. Cache Invalidation System</h3>

<p><strong>Purpose:</strong> Propagate updates across edge servers</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">CacheInvalidationSystem</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Propagate cache invalidations to edge servers
    
    Methods:
    1. Push-based: Immediate invalidation
    2. Pull-based: Periodic refresh
    3. TTL-based: Automatic expiration
    </span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">edge_servers</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">edge_servers</span> <span class="o">=</span> <span class="n">edge_servers</span>
        
        <span class="c1"># Message queue for invalidations
</span>        <span class="n">self</span><span class="p">.</span><span class="n">invalidation_queue</span> <span class="o">=</span> <span class="n">redis</span><span class="p">.</span><span class="nc">Redis</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="sh">'</span><span class="s">localhost</span><span class="sh">'</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">6379</span><span class="p">)</span>
        
        <span class="c1"># Pub/sub for real-time propagation
</span>        <span class="n">self</span><span class="p">.</span><span class="n">pubsub</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">invalidation_queue</span><span class="p">.</span><span class="nf">pubsub</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">pubsub</span><span class="p">.</span><span class="nf">subscribe</span><span class="p">(</span><span class="sh">'</span><span class="s">cache:invalidate</span><span class="sh">'</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">invalidate</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Invalidate cache keys across all edge servers
        
        Args:
            keys: List of keys to invalidate
            pattern: If True, treat keys as patterns
        </span><span class="sh">"""</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">keys</span><span class="sh">'</span><span class="p">:</span> <span class="n">keys</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">pattern</span><span class="sh">'</span><span class="p">:</span> <span class="n">pattern</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">timestamp</span><span class="sh">'</span><span class="p">:</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="p">}</span>
        
        <span class="c1"># Publish to all edge servers
</span>        <span class="n">self</span><span class="p">.</span><span class="n">invalidation_queue</span><span class="p">.</span><span class="nf">publish</span><span class="p">(</span>
            <span class="sh">'</span><span class="s">cache:invalidate</span><span class="sh">'</span><span class="p">,</span>
            <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="p">)</span>
        
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Invalidated </span><span class="si">{</span><span class="nf">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span><span class="si">}</span><span class="s"> keys across edge network</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">invalidate_prefix</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Invalidate all keys with given prefix
        
        Example: invalidate_prefix(</span><span class="sh">'</span><span class="s">user:123:*</span><span class="sh">'</span><span class="s">)
        </span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">invalidate</span><span class="p">([</span><span class="n">prefix</span><span class="p">],</span> <span class="n">pattern</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">invalidate_model_update</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">model_id</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Invalidate caches after model update
        
        Invalidates:
        - Model predictions
        - Model metadata
        - Related embeddings
        </span><span class="sh">"""</span>
        <span class="n">patterns</span> <span class="o">=</span> <span class="p">[</span>
            <span class="sa">f</span><span class="sh">"</span><span class="s">model:</span><span class="si">{</span><span class="n">model_id</span><span class="si">}</span><span class="s">:*</span><span class="sh">"</span><span class="p">,</span>
            <span class="sa">f</span><span class="sh">"</span><span class="s">prediction:</span><span class="si">{</span><span class="n">model_id</span><span class="si">}</span><span class="s">:*</span><span class="sh">"</span><span class="p">,</span>
            <span class="sa">f</span><span class="sh">"</span><span class="s">embedding:</span><span class="si">{</span><span class="n">model_id</span><span class="si">}</span><span class="s">:*</span><span class="sh">"</span>
        <span class="p">]</span>
        
        <span class="n">self</span><span class="p">.</span><span class="nf">invalidate</span><span class="p">(</span><span class="n">patterns</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Invalidated caches for model </span><span class="si">{</span><span class="n">model_id</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">EdgeInvalidationListener</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Listen for invalidation messages on edge server
    </span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">edge_server</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">edge_server</span> <span class="o">=</span> <span class="n">edge_server</span>
        
        <span class="c1"># Subscribe to invalidations
</span>        <span class="n">self</span><span class="p">.</span><span class="n">pubsub</span> <span class="o">=</span> <span class="n">redis</span><span class="p">.</span><span class="nc">Redis</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="sh">'</span><span class="s">localhost</span><span class="sh">'</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">6379</span><span class="p">).</span><span class="nf">pubsub</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">pubsub</span><span class="p">.</span><span class="nf">subscribe</span><span class="p">(</span><span class="sh">'</span><span class="s">cache:invalidate</span><span class="sh">'</span><span class="p">)</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">running</span> <span class="o">=</span> <span class="bp">False</span>
    
    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Start listening for invalidations</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="n">running</span> <span class="o">=</span> <span class="bp">True</span>
        
        <span class="kn">import</span> <span class="n">threading</span>
        <span class="n">self</span><span class="p">.</span><span class="n">thread</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">_listen_loop</span><span class="p">,</span> <span class="n">daemon</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">thread</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Stop listening</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="n">running</span> <span class="o">=</span> <span class="bp">False</span>
    
    <span class="k">def</span> <span class="nf">_listen_loop</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Listen for invalidation messages</span><span class="sh">"""</span>
        <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">pubsub</span><span class="p">.</span><span class="nf">listen</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">message</span><span class="p">[</span><span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="sh">'</span><span class="s">data</span><span class="sh">'</span><span class="p">])</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_handle_invalidation</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_handle_invalidation</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Handle invalidation message</span><span class="sh">"""</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sh">'</span><span class="s">keys</span><span class="sh">'</span><span class="p">]</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sh">'</span><span class="s">pattern</span><span class="sh">'</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">pattern</span><span class="p">:</span>
            <span class="c1"># Invalidate by pattern
</span>            <span class="k">for</span> <span class="n">key_pattern</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_invalidate_pattern</span><span class="p">(</span><span class="n">key_pattern</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Invalidate specific keys
</span>            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_invalidate_key</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_invalidate_key</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Invalidate specific key</span><span class="sh">"""</span>
        <span class="c1"># Remove from L1 cache
</span>        <span class="n">self</span><span class="p">.</span><span class="n">edge_server</span><span class="p">.</span><span class="n">l1_cache</span><span class="p">.</span><span class="nf">delete</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        
        <span class="c1"># Remove from L2 cache
</span>        <span class="n">self</span><span class="p">.</span><span class="n">edge_server</span><span class="p">.</span><span class="n">l2_cache</span><span class="p">.</span><span class="nf">delete</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Invalidated key: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_invalidate_pattern</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Invalidate keys matching pattern</span><span class="sh">"""</span>
        <span class="c1"># Scan L1 cache
</span>        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">edge_server</span><span class="p">.</span><span class="n">l1_cache</span><span class="p">.</span><span class="nf">scan_iter</span><span class="p">(</span><span class="n">match</span><span class="o">=</span><span class="n">pattern</span><span class="p">):</span>
            <span class="n">self</span><span class="p">.</span><span class="n">edge_server</span><span class="p">.</span><span class="n">l1_cache</span><span class="p">.</span><span class="nf">delete</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        
        <span class="c1"># Scan L2 cache
</span>        <span class="n">self</span><span class="p">.</span><span class="n">edge_server</span><span class="p">.</span><span class="n">l2_cache</span><span class="p">.</span><span class="nf">delete_pattern</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
        
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Invalidated pattern: </span><span class="si">{</span><span class="n">pattern</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># Example usage
</span><span class="n">edge_servers</span> <span class="o">=</span> <span class="p">[</span>
    <span class="nc">EdgeServer</span><span class="p">(</span><span class="sh">'</span><span class="s">us-east-1</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">https://origin.example.com</span><span class="sh">'</span><span class="p">),</span>
    <span class="nc">EdgeServer</span><span class="p">(</span><span class="sh">'</span><span class="s">eu-west-1</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">https://origin.example.com</span><span class="sh">'</span><span class="p">),</span>
<span class="p">]</span>

<span class="n">invalidation_system</span> <span class="o">=</span> <span class="nc">CacheInvalidationSystem</span><span class="p">(</span><span class="n">edge_servers</span><span class="p">)</span>

<span class="c1"># Start listeners on each edge
</span><span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">edge_servers</span><span class="p">:</span>
    <span class="n">listener</span> <span class="o">=</span> <span class="nc">EdgeInvalidationListener</span><span class="p">(</span><span class="n">edge</span><span class="p">)</span>
    <span class="n">listener</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>

<span class="c1"># Trigger invalidation
</span><span class="n">invalidation_system</span><span class="p">.</span><span class="nf">invalidate_model_update</span><span class="p">(</span><span class="sh">'</span><span class="s">model_v2</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div>

<hr />

<h2 id="ml-model-serving-at-edge">ML Model Serving at Edge</h2>

<h3 id="edge-inference">Edge Inference</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">EdgeMLServer</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Serve ML models at edge for low-latency inference
    
    Benefits:
    - Reduced latency (no round trip to origin)
    - Reduced bandwidth
    - Better privacy (data doesn</span><span class="sh">'</span><span class="s">t leave region)
    </span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">model_path</span><span class="p">):</span>
        <span class="c1"># Load ONNX model for edge inference
</span>        <span class="kn">import</span> <span class="n">onnxruntime</span> <span class="k">as</span> <span class="n">ort</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">ort</span><span class="p">.</span><span class="nc">InferenceSession</span><span class="p">(</span>
            <span class="n">model_path</span><span class="p">,</span>
            <span class="n">providers</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">CPUExecutionProvider</span><span class="sh">'</span><span class="p">]</span>
        <span class="p">)</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">input_name</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">get_inputs</span><span class="p">()[</span><span class="mi">0</span><span class="p">].</span><span class="n">name</span>
        <span class="n">self</span><span class="p">.</span><span class="n">output_name</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">get_outputs</span><span class="p">()[</span><span class="mi">0</span><span class="p">].</span><span class="n">name</span>
        
        <span class="c1"># Cache for predictions
</span>        <span class="n">self</span><span class="p">.</span><span class="n">prediction_cache</span> <span class="o">=</span> <span class="nc">LRUCache</span><span class="p">(</span><span class="n">capacity</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">features</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Predict with caching
        
        Args:
            features: Input features (must be hashable)
        
        Returns:
            Prediction
        </span><span class="sh">"""</span>
        <span class="c1"># Generate cache key
</span>        <span class="n">cache_key</span> <span class="o">=</span> <span class="nf">hash</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
        
        <span class="c1"># Check cache
</span>        <span class="n">cached_prediction</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">prediction_cache</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cached_prediction</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cached_prediction</span>
        
        <span class="c1"># Run inference
</span>        <span class="n">features_array</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span><span class="n">features</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span>
        
        <span class="n">prediction</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span>
            <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">output_name</span><span class="p">],</span>
            <span class="p">{</span><span class="n">self</span><span class="p">.</span><span class="n">input_name</span><span class="p">:</span> <span class="n">features_array</span><span class="p">}</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="c1"># Cache result
</span>        <span class="n">self</span><span class="p">.</span><span class="n">prediction_cache</span><span class="p">.</span><span class="nf">put</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="n">prediction</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">prediction</span>
    
    <span class="k">async</span> <span class="k">def</span> <span class="nf">batch_predict</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">features_list</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Batch prediction for efficiency
        
        Separates cache hits from misses
        </span><span class="sh">"""</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">cache_misses</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cache_miss_indices</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># Check cache
</span>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">features</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">features_list</span><span class="p">):</span>
            <span class="n">cache_key</span> <span class="o">=</span> <span class="nf">hash</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
            <span class="n">cached</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">prediction_cache</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">cached</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">predictions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cached</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cache_misses</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
                <span class="n">cache_miss_indices</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        
        <span class="c1"># Batch inference for cache misses
</span>        <span class="k">if</span> <span class="n">cache_misses</span><span class="p">:</span>
            <span class="n">features_array</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">cache_misses</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span>
            
            <span class="n">batch_predictions</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span>
                <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">output_name</span><span class="p">],</span>
                <span class="p">{</span><span class="n">self</span><span class="p">.</span><span class="n">input_name</span><span class="p">:</span> <span class="n">features_array</span><span class="p">}</span>
            <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            
            <span class="c1"># Store in cache and results
</span>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pred</span> <span class="ow">in</span> <span class="nf">zip</span><span class="p">(</span><span class="n">cache_miss_indices</span><span class="p">,</span> <span class="n">batch_predictions</span><span class="p">):</span>
                <span class="n">cache_key</span> <span class="o">=</span> <span class="nf">hash</span><span class="p">(</span><span class="n">features_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">self</span><span class="p">.</span><span class="n">prediction_cache</span><span class="p">.</span><span class="nf">put</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="n">pred</span><span class="p">)</span>
                <span class="n">predictions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pred</span>
        
        <span class="c1"># Return in original order
</span>        <span class="k">return</span> <span class="p">[</span><span class="n">predictions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">features_list</span><span class="p">))]</span>

<span class="c1"># Example: Edge API server with ML inference
</span><span class="kn">from</span> <span class="n">fastapi</span> <span class="kn">import</span> <span class="n">FastAPI</span>
<span class="kn">import</span> <span class="n">uvicorn</span>

<span class="n">app</span> <span class="o">=</span> <span class="nc">FastAPI</span><span class="p">()</span>

<span class="c1"># Load model at startup
</span><span class="n">edge_ml_server</span> <span class="o">=</span> <span class="nc">EdgeMLServer</span><span class="p">(</span><span class="sh">'</span><span class="s">model.onnx</span><span class="sh">'</span><span class="p">)</span>

<span class="nd">@app.post</span><span class="p">(</span><span class="sh">"</span><span class="s">/predict</span><span class="sh">"</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    Edge prediction endpoint
    
    Returns cached or computed prediction
    </span><span class="sh">"""</span>
    <span class="n">features</span> <span class="o">=</span> <span class="nf">tuple</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="sh">'</span><span class="s">features</span><span class="sh">'</span><span class="p">])</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">prediction</span> <span class="o">=</span> <span class="n">edge_ml_server</span><span class="p">.</span><span class="nf">predict</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">prediction</span><span class="sh">'</span><span class="p">:</span> <span class="nf">float</span><span class="p">(</span><span class="n">prediction</span><span class="p">),</span>
            <span class="sh">'</span><span class="s">cached</span><span class="sh">'</span><span class="p">:</span> <span class="n">edge_ml_server</span><span class="p">.</span><span class="n">prediction_cache</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nf">hash</span><span class="p">(</span><span class="n">features</span><span class="p">))</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">edge_region</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">us-east-1</span><span class="sh">'</span>
        <span class="p">}</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">'</span><span class="s">error</span><span class="sh">'</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)},</span> <span class="mi">500</span>

<span class="nd">@app.post</span><span class="p">(</span><span class="sh">"</span><span class="s">/batch_predict</span><span class="sh">"</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">batch_predict</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    Batch prediction endpoint
    </span><span class="sh">"""</span>
    <span class="n">features_list</span> <span class="o">=</span> <span class="p">[</span><span class="nf">tuple</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">request</span><span class="p">[</span><span class="sh">'</span><span class="s">features</span><span class="sh">'</span><span class="p">]]</span>
    
    <span class="n">predictions</span> <span class="o">=</span> <span class="k">await</span> <span class="n">edge_ml_server</span><span class="p">.</span><span class="nf">batch_predict</span><span class="p">(</span><span class="n">features_list</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="sh">'</span><span class="s">predictions</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="nf">float</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">predictions</span><span class="p">],</span>
        <span class="sh">'</span><span class="s">count</span><span class="sh">'</span><span class="p">:</span> <span class="nf">len</span><span class="p">(</span><span class="n">predictions</span><span class="p">),</span>
        <span class="sh">'</span><span class="s">edge_region</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">us-east-1</span><span class="sh">'</span>
    <span class="p">}</span>

<span class="c1"># Run edge server
# uvicorn.run(app, host='0.0.0.0', port=8000)
</span></code></pre></div></div>

<h3 id="model-distribution-to-edge">Model Distribution to Edge</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ModelDistributionSystem</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Distribute ML models to edge servers
    
    Challenges:
    - Large model sizes (GB)
    - Many edge locations
    - Version management
    - Atomic updates
    </span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">s3_bucket</span><span class="p">,</span> <span class="n">edge_servers</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">s3_bucket</span> <span class="o">=</span> <span class="n">s3_bucket</span>
        <span class="n">self</span><span class="p">.</span><span class="n">edge_servers</span> <span class="o">=</span> <span class="n">edge_servers</span>
        
        <span class="c1"># Track model versions at each edge
</span>        <span class="n">self</span><span class="p">.</span><span class="n">edge_versions</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">server</span><span class="p">.</span><span class="n">region</span><span class="p">:</span> <span class="bp">None</span>
            <span class="k">for</span> <span class="n">server</span> <span class="ow">in</span> <span class="n">edge_servers</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">distribute_model</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">model_path</span><span class="p">,</span> <span class="n">version</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Distribute model to all edge servers
        
        Steps:
        1. Upload to S3
        2. Notify edge servers
        3. Edge servers download
        4. Edge servers validate
        5. Edge servers activate
        </span><span class="sh">"""</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Distributing model </span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="s"> to </span><span class="si">{</span><span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">edge_servers</span><span class="p">)</span><span class="si">}</span><span class="s"> edge servers...</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="c1"># Step 1: Upload to S3
</span>        <span class="n">s3_key</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">models/</span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="s">/model.onnx</span><span class="sh">"</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_upload_to_s3</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span> <span class="n">s3_key</span><span class="p">)</span>
        
        <span class="c1"># Step 2: Notify edge servers
</span>        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">server</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">edge_servers</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_distribute_to_edge</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">s3_key</span><span class="p">,</span> <span class="n">version</span><span class="p">)</span>
            <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">((</span><span class="n">server</span><span class="p">.</span><span class="n">region</span><span class="p">,</span> <span class="n">result</span><span class="p">))</span>
        
        <span class="c1"># Check results
</span>        <span class="n">successful</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span> <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">failed</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="s">Distribution complete:</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  Successful: </span><span class="si">{</span><span class="nf">len</span><span class="p">(</span><span class="n">successful</span><span class="p">)</span><span class="si">}</span><span class="s">/</span><span class="si">{</span><span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">edge_servers</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  Failed: </span><span class="si">{</span><span class="nf">len</span><span class="p">(</span><span class="n">failed</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">failed</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  Failed regions: </span><span class="si">{</span><span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">failed</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="nf">len</span><span class="p">(</span><span class="n">failed</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
    
    <span class="k">def</span> <span class="nf">_upload_to_s3</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">local_path</span><span class="p">,</span> <span class="n">s3_key</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Upload model to S3</span><span class="sh">"""</span>
        <span class="kn">import</span> <span class="n">boto3</span>
        
        <span class="n">s3</span> <span class="o">=</span> <span class="n">boto3</span><span class="p">.</span><span class="nf">client</span><span class="p">(</span><span class="sh">'</span><span class="s">s3</span><span class="sh">'</span><span class="p">)</span>
        
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Uploading </span><span class="si">{</span><span class="n">local_path</span><span class="si">}</span><span class="s"> to s3://</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">s3_bucket</span><span class="si">}</span><span class="s">/</span><span class="si">{</span><span class="n">s3_key</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="n">s3</span><span class="p">.</span><span class="nf">upload_file</span><span class="p">(</span>
            <span class="n">local_path</span><span class="p">,</span>
            <span class="n">self</span><span class="p">.</span><span class="n">s3_bucket</span><span class="p">,</span>
            <span class="n">s3_key</span><span class="p">,</span>
            <span class="n">ExtraArgs</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">ServerSideEncryption</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">AES256</span><span class="sh">'</span><span class="p">}</span>
        <span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_distribute_to_edge</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="n">s3_key</span><span class="p">,</span> <span class="n">version</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Notify edge server to download model
        
        Edge server will:
        1. Download from S3
        2. Validate checksum
        3. Load model
        4. Run health checks
        5. Activate (atomic swap)
        </span><span class="sh">"""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="n">requests</span>
            
            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span>
                <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">server</span><span class="p">.</span><span class="n">url</span><span class="si">}</span><span class="s">/admin/update_model</span><span class="sh">"</span><span class="p">,</span>
                <span class="n">json</span><span class="o">=</span><span class="p">{</span>
                    <span class="sh">'</span><span class="s">s3_bucket</span><span class="sh">'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">s3_bucket</span><span class="p">,</span>
                    <span class="sh">'</span><span class="s">s3_key</span><span class="sh">'</span><span class="p">:</span> <span class="n">s3_key</span><span class="p">,</span>
                    <span class="sh">'</span><span class="s">version</span><span class="sh">'</span><span class="p">:</span> <span class="n">version</span>
                <span class="p">},</span>
                <span class="n">timeout</span><span class="o">=</span><span class="mi">300</span>  <span class="c1"># 5 minutes for large models
</span>            <span class="p">)</span>
            
            <span class="k">if</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="n">edge_versions</span><span class="p">[</span><span class="n">server</span><span class="p">.</span><span class="n">region</span><span class="p">]</span> <span class="o">=</span> <span class="n">version</span>
                <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  âœ“ </span><span class="si">{</span><span class="n">server</span><span class="p">.</span><span class="n">region</span><span class="si">}</span><span class="s">: Updated to </span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  âœ— </span><span class="si">{</span><span class="n">server</span><span class="p">.</span><span class="n">region</span><span class="si">}</span><span class="s">: Failed - </span><span class="si">{</span><span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">False</span>
        
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  âœ— </span><span class="si">{</span><span class="n">server</span><span class="p">.</span><span class="n">region</span><span class="si">}</span><span class="s">: Error - </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>
    
    <span class="k">def</span> <span class="nf">rollback_model</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">target_version</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Rollback to previous model version
        
        Useful if new model has issues
        </span><span class="sh">"""</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Rolling back to version </span><span class="si">{</span><span class="n">target_version</span><span class="si">}</span><span class="s">...</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="n">s3_key</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">models/</span><span class="si">{</span><span class="n">target_version</span><span class="si">}</span><span class="s">/model.onnx</span><span class="sh">"</span>
        
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="nf">distribute_model</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">/tmp/model_</span><span class="si">{</span><span class="n">target_version</span><span class="si">}</span><span class="s">.onnx</span><span class="sh">"</span><span class="p">,</span> <span class="n">target_version</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">get_version_status</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Get model versions deployed at each edge</span><span class="sh">"""</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">edge_versions</span>

<span class="c1"># Example usage
</span><span class="n">edge_servers</span> <span class="o">=</span> <span class="p">[</span>
    <span class="nc">EdgeServerInfo</span><span class="p">(</span><span class="sh">'</span><span class="s">us-east-1</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">https://edge-us-east-1.example.com</span><span class="sh">'</span><span class="p">,</span> <span class="p">{}),</span>
    <span class="nc">EdgeServerInfo</span><span class="p">(</span><span class="sh">'</span><span class="s">eu-west-1</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">https://edge-eu-west-1.example.com</span><span class="sh">'</span><span class="p">,</span> <span class="p">{}),</span>
    <span class="nc">EdgeServerInfo</span><span class="p">(</span><span class="sh">'</span><span class="s">ap-northeast-1</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">https://edge-ap-northeast-1.example.com</span><span class="sh">'</span><span class="p">,</span> <span class="p">{}),</span>
<span class="p">]</span>

<span class="n">distributor</span> <span class="o">=</span> <span class="nc">ModelDistributionSystem</span><span class="p">(</span>
    <span class="n">s3_bucket</span><span class="o">=</span><span class="sh">'</span><span class="s">my-ml-models</span><span class="sh">'</span><span class="p">,</span>
    <span class="n">edge_servers</span><span class="o">=</span><span class="n">edge_servers</span>
<span class="p">)</span>

<span class="c1"># Distribute new model
</span><span class="n">success</span> <span class="o">=</span> <span class="n">distributor</span><span class="p">.</span><span class="nf">distribute_model</span><span class="p">(</span><span class="sh">'</span><span class="s">model_v3.onnx</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">v3</span><span class="sh">'</span><span class="p">)</span>

<span class="k">if</span> <span class="n">success</span><span class="p">:</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">Model distribution successful!</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Current versions:</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">region</span><span class="p">,</span> <span class="n">version</span> <span class="ow">in</span> <span class="n">distributor</span><span class="p">.</span><span class="nf">get_version_status</span><span class="p">().</span><span class="nf">items</span><span class="p">():</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  </span><span class="si">{</span><span class="n">region</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">Model distribution failed, rolling back...</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">distributor</span><span class="p">.</span><span class="nf">rollback_model</span><span class="p">(</span><span class="sh">'</span><span class="s">v2</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div>

<hr />

<h2 id="monitoring--observability">Monitoring &amp; Observability</h2>

<h3 id="cdn-metrics-dashboard">CDN Metrics Dashboard</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">CDNMetricsDashboard</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Aggregate and visualize CDN metrics
    
    Key metrics:
    - Cache hit rate
    - Latency (p50, p95, p99)
    - Bandwidth usage
    - Error rate
    - Request rate
    </span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">edge_servers</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">edge_servers</span> <span class="o">=</span> <span class="n">edge_servers</span>
        
        <span class="c1"># Time series database for metrics
</span>        <span class="kn">from</span> <span class="n">prometheus_client</span> <span class="kn">import</span> <span class="n">Counter</span><span class="p">,</span> <span class="n">Histogram</span><span class="p">,</span> <span class="n">Gauge</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">request_count</span> <span class="o">=</span> <span class="nc">Counter</span><span class="p">(</span>
            <span class="sh">'</span><span class="s">cdn_requests_total</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">Total CDN requests</span><span class="sh">'</span><span class="p">,</span>
            <span class="p">[</span><span class="sh">'</span><span class="s">region</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">status</span><span class="sh">'</span><span class="p">]</span>
        <span class="p">)</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">latency</span> <span class="o">=</span> <span class="nc">Histogram</span><span class="p">(</span>
            <span class="sh">'</span><span class="s">cdn_request_latency_seconds</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">CDN request latency</span><span class="sh">'</span><span class="p">,</span>
            <span class="p">[</span><span class="sh">'</span><span class="s">region</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">cache_level</span><span class="sh">'</span><span class="p">]</span>
        <span class="p">)</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">cache_hit_rate</span> <span class="o">=</span> <span class="nc">Gauge</span><span class="p">(</span>
            <span class="sh">'</span><span class="s">cdn_cache_hit_rate</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">Cache hit rate</span><span class="sh">'</span><span class="p">,</span>
            <span class="p">[</span><span class="sh">'</span><span class="s">region</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">cache_level</span><span class="sh">'</span><span class="p">]</span>
        <span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">collect_metrics</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Collect metrics from all edge servers
        
        Returns aggregated view
        </span><span class="sh">"""</span>
        <span class="n">global_metrics</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">total_requests</span><span class="sh">'</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">total_cache_hits</span><span class="sh">'</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">regions</span><span class="sh">'</span><span class="p">:</span> <span class="p">{}</span>
        <span class="p">}</span>
        
        <span class="k">for</span> <span class="n">server</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">edge_servers</span><span class="p">:</span>
            <span class="n">stats</span> <span class="o">=</span> <span class="n">server</span><span class="p">.</span><span class="n">metrics</span><span class="p">.</span><span class="nf">get_stats</span><span class="p">()</span>
            
            <span class="n">total_requests</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">server</span><span class="p">.</span><span class="n">metrics</span><span class="p">.</span><span class="n">l1_hits</span> <span class="o">+</span>
                <span class="n">server</span><span class="p">.</span><span class="n">metrics</span><span class="p">.</span><span class="n">l2_hits</span> <span class="o">+</span>
                <span class="n">server</span><span class="p">.</span><span class="n">metrics</span><span class="p">.</span><span class="n">misses</span>
            <span class="p">)</span>
            
            <span class="n">total_cache_hits</span> <span class="o">=</span> <span class="n">server</span><span class="p">.</span><span class="n">metrics</span><span class="p">.</span><span class="n">l1_hits</span> <span class="o">+</span> <span class="n">server</span><span class="p">.</span><span class="n">metrics</span><span class="p">.</span><span class="n">l2_hits</span>
            
            <span class="n">global_metrics</span><span class="p">[</span><span class="sh">'</span><span class="s">total_requests</span><span class="sh">'</span><span class="p">]</span> <span class="o">+=</span> <span class="n">total_requests</span>
            <span class="n">global_metrics</span><span class="p">[</span><span class="sh">'</span><span class="s">total_cache_hits</span><span class="sh">'</span><span class="p">]</span> <span class="o">+=</span> <span class="n">total_cache_hits</span>
            
            <span class="n">global_metrics</span><span class="p">[</span><span class="sh">'</span><span class="s">regions</span><span class="sh">'</span><span class="p">][</span><span class="n">server</span><span class="p">.</span><span class="n">region</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">'</span><span class="s">requests</span><span class="sh">'</span><span class="p">:</span> <span class="n">total_requests</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">cache_hits</span><span class="sh">'</span><span class="p">:</span> <span class="n">total_cache_hits</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">stats</span><span class="sh">'</span><span class="p">:</span> <span class="n">stats</span>
            <span class="p">}</span>
        
        <span class="c1"># Calculate global hit rate
</span>        <span class="k">if</span> <span class="n">global_metrics</span><span class="p">[</span><span class="sh">'</span><span class="s">total_requests</span><span class="sh">'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">global_metrics</span><span class="p">[</span><span class="sh">'</span><span class="s">cache_hit_rate</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">global_metrics</span><span class="p">[</span><span class="sh">'</span><span class="s">total_cache_hits</span><span class="sh">'</span><span class="p">]</span> <span class="o">/</span> <span class="n">global_metrics</span><span class="p">[</span><span class="sh">'</span><span class="s">total_requests</span><span class="sh">'</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">global_metrics</span><span class="p">[</span><span class="sh">'</span><span class="s">cache_hit_rate</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">return</span> <span class="n">global_metrics</span>
    
    <span class="k">def</span> <span class="nf">print_dashboard</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Print metrics dashboard</span><span class="sh">"""</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">collect_metrics</span><span class="p">()</span>
        
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="sh">"</span><span class="s">=</span><span class="sh">"</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">CDN METRICS DASHBOARD</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=</span><span class="sh">"</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
        
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="s">Global Metrics:</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  Total Requests:     </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="sh">'</span><span class="s">total_requests</span><span class="sh">'</span><span class="p">]</span><span class="si">:</span><span class="p">,</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  Cache Hit Rate:     </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="sh">'</span><span class="s">cache_hit_rate</span><span class="sh">'</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="o">%</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="s">Regional Breakdown:</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">region</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">[</span><span class="sh">'</span><span class="s">regions</span><span class="sh">'</span><span class="p">].</span><span class="nf">items</span><span class="p">():</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="s">  </span><span class="si">{</span><span class="n">region</span><span class="si">}</span><span class="s">:</span><span class="sh">"</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">    Requests:         </span><span class="si">{</span><span class="n">data</span><span class="p">[</span><span class="sh">'</span><span class="s">requests</span><span class="sh">'</span><span class="p">]</span><span class="si">:</span><span class="p">,</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">    L1 Hit Rate:      </span><span class="si">{</span><span class="n">data</span><span class="p">[</span><span class="sh">'</span><span class="s">stats</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">l1_hit_rate</span><span class="sh">'</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="o">%</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">    L2 Hit Rate:      </span><span class="si">{</span><span class="n">data</span><span class="p">[</span><span class="sh">'</span><span class="s">stats</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">l2_hit_rate</span><span class="sh">'</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="o">%</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">    Miss Rate:        </span><span class="si">{</span><span class="n">data</span><span class="p">[</span><span class="sh">'</span><span class="s">stats</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">miss_rate</span><span class="sh">'</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="o">%</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">    Avg L1 Latency:   </span><span class="si">{</span><span class="n">data</span><span class="p">[</span><span class="sh">'</span><span class="s">stats</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">avg_l1_latency_ms</span><span class="sh">'</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">ms</span><span class="sh">"</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">    Avg Miss Latency: </span><span class="si">{</span><span class="n">data</span><span class="p">[</span><span class="sh">'</span><span class="s">stats</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">avg_miss_latency_ms</span><span class="sh">'</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">ms</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=</span><span class="sh">"</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">plot_latency_distribution</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Plot latency distribution by region</span><span class="sh">"""</span>
        <span class="kn">import</span> <span class="n">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
        
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">edge_servers</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span> <span class="o">*</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">edge_servers</span><span class="p">)))</span>
        
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">server</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">edge_servers</span><span class="p">):</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">edge_servers</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">axes</span>
            
            <span class="c1"># Get latencies
</span>            <span class="n">l1_latencies</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">metrics</span><span class="p">.</span><span class="n">l1_latencies</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>  <span class="c1"># ms
</span>            <span class="n">l2_latencies</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">metrics</span><span class="p">.</span><span class="n">l2_latencies</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
            <span class="n">miss_latencies</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">metrics</span><span class="p">.</span><span class="n">miss_latencies</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
            
            <span class="c1"># Plot histograms
</span>            <span class="n">ax</span><span class="p">.</span><span class="nf">hist</span><span class="p">(</span><span class="n">l1_latencies</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sh">'</span><span class="s">L1 Cache</span><span class="sh">'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">green</span><span class="sh">'</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">.</span><span class="nf">hist</span><span class="p">(</span><span class="n">l2_latencies</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sh">'</span><span class="s">L2 Cache</span><span class="sh">'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">blue</span><span class="sh">'</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">.</span><span class="nf">hist</span><span class="p">(</span><span class="n">miss_latencies</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sh">'</span><span class="s">Origin</span><span class="sh">'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">red</span><span class="sh">'</span><span class="p">)</span>
            
            <span class="n">ax</span><span class="p">.</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Latency (ms)</span><span class="sh">'</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">.</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Frequency</span><span class="sh">'</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">.</span><span class="nf">set_title</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="s">Latency Distribution - </span><span class="si">{</span><span class="n">server</span><span class="p">.</span><span class="n">region</span><span class="si">}</span><span class="sh">'</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">.</span><span class="nf">legend</span><span class="p">()</span>
            <span class="n">ax</span><span class="p">.</span><span class="nf">grid</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        
        <span class="n">plt</span><span class="p">.</span><span class="nf">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="p">.</span><span class="nf">savefig</span><span class="p">(</span><span class="sh">'</span><span class="s">cdn_latency_distribution.png</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">plt</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
        
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Latency distribution plot saved to cdn_latency_distribution.png</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># Example usage
</span><span class="n">edge_servers</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># ... initialize edge servers
</span><span class="p">]</span>

<span class="n">dashboard</span> <span class="o">=</span> <span class="nc">CDNMetricsDashboard</span><span class="p">(</span><span class="n">edge_servers</span><span class="p">)</span>

<span class="c1"># Collect and display metrics
</span><span class="n">dashboard</span><span class="p">.</span><span class="nf">print_dashboard</span><span class="p">()</span>

<span class="c1"># Plot latency distribution
</span><span class="n">dashboard</span><span class="p">.</span><span class="nf">plot_latency_distribution</span><span class="p">()</span>
</code></pre></div></div>

<hr />

<h2 id="cost-optimization">Cost Optimization</h2>

<h3 id="tiered-caching-strategy">Tiered Caching Strategy</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">TieredCachingStrategy</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Optimize costs with tiered caching
    
    Tiers:
    1. Hot (L1 - Redis): Most accessed, expensive, fast
    2. Warm (L2 - Local disk): Frequently accessed, cheap, medium speed
    3. Cold (S3): Rarely accessed, cheapest, slow
    
    Move items between tiers based on access patterns
    </span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">l1_cost_per_gb_per_month</span> <span class="o">=</span> <span class="mi">100</span>  <span class="c1"># Redis
</span>        <span class="n">self</span><span class="p">.</span><span class="n">l2_cost_per_gb_per_month</span> <span class="o">=</span> <span class="mi">10</span>   <span class="c1"># SSD
</span>        <span class="n">self</span><span class="p">.</span><span class="n">l3_cost_per_gb_per_month</span> <span class="o">=</span> <span class="mf">0.02</span>  <span class="c1"># S3
</span>        
        <span class="n">self</span><span class="p">.</span><span class="n">l1_size_gb</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">self</span><span class="p">.</span><span class="n">l2_size_gb</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="n">self</span><span class="p">.</span><span class="n">l3_size_gb</span> <span class="o">=</span> <span class="mi">1000</span>
    
    <span class="k">def</span> <span class="nf">calculate_monthly_cost</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Calculate monthly storage cost</span><span class="sh">"""</span>
        <span class="n">l1_cost</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">l1_size_gb</span> <span class="o">*</span> <span class="n">self</span><span class="p">.</span><span class="n">l1_cost_per_gb_per_month</span>
        <span class="n">l2_cost</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">l2_size_gb</span> <span class="o">*</span> <span class="n">self</span><span class="p">.</span><span class="n">l2_cost_per_gb_per_month</span>
        <span class="n">l3_cost</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">l3_size_gb</span> <span class="o">*</span> <span class="n">self</span><span class="p">.</span><span class="n">l3_cost_per_gb_per_month</span>
        
        <span class="n">total_cost</span> <span class="o">=</span> <span class="n">l1_cost</span> <span class="o">+</span> <span class="n">l2_cost</span> <span class="o">+</span> <span class="n">l3_cost</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">l1_cost</span><span class="sh">'</span><span class="p">:</span> <span class="n">l1_cost</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">l2_cost</span><span class="sh">'</span><span class="p">:</span> <span class="n">l2_cost</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">l3_cost</span><span class="sh">'</span><span class="p">:</span> <span class="n">l3_cost</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">total_cost</span><span class="sh">'</span><span class="p">:</span> <span class="n">total_cost</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">optimize_tier_sizes</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">access_patterns</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Optimize tier sizes based on access patterns
        
        Goal: Minimize cost while maintaining hit rate
        </span><span class="sh">"""</span>
        <span class="c1"># Analyze access frequency
</span>        <span class="n">access_freq</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="k">for</span> <span class="n">item_id</span><span class="p">,</span> <span class="n">accesses</span> <span class="ow">in</span> <span class="n">access_patterns</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="n">access_freq</span><span class="p">[</span><span class="n">item_id</span><span class="p">]</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">accesses</span><span class="p">)</span>
        
        <span class="c1"># Sort by frequency
</span>        <span class="n">sorted_items</span> <span class="o">=</span> <span class="nf">sorted</span><span class="p">(</span>
            <span class="n">access_freq</span><span class="p">.</span><span class="nf">items</span><span class="p">(),</span>
            <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span>
        <span class="p">)</span>
        
        <span class="c1"># Allocate to tiers
</span>        <span class="n">l1_items</span> <span class="o">=</span> <span class="n">sorted_items</span><span class="p">[:</span><span class="mi">100</span><span class="p">]</span>  <span class="c1"># Top 100
</span>        <span class="n">l2_items</span> <span class="o">=</span> <span class="n">sorted_items</span><span class="p">[</span><span class="mi">100</span><span class="p">:</span><span class="mi">1000</span><span class="p">]</span>  <span class="c1"># Next 900
</span>        <span class="n">l3_items</span> <span class="o">=</span> <span class="n">sorted_items</span><span class="p">[</span><span class="mi">1000</span><span class="p">:]</span>  <span class="c1"># Rest
</span>        
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Tier allocation:</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  L1 (Hot):  </span><span class="si">{</span><span class="nf">len</span><span class="p">(</span><span class="n">l1_items</span><span class="p">)</span><span class="si">}</span><span class="s"> items</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  L2 (Warm): </span><span class="si">{</span><span class="nf">len</span><span class="p">(</span><span class="n">l2_items</span><span class="p">)</span><span class="si">}</span><span class="s"> items</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  L3 (Cold): </span><span class="si">{</span><span class="nf">len</span><span class="p">(</span><span class="n">l3_items</span><span class="p">)</span><span class="si">}</span><span class="s"> items</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="c1"># Calculate expected hit rate
</span>        <span class="n">total_accesses</span> <span class="o">=</span> <span class="nf">sum</span><span class="p">(</span><span class="n">access_freq</span><span class="p">.</span><span class="nf">values</span><span class="p">())</span>
        <span class="n">l1_accesses</span> <span class="o">=</span> <span class="nf">sum</span><span class="p">(</span><span class="n">freq</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">freq</span> <span class="ow">in</span> <span class="n">l1_items</span><span class="p">)</span>
        <span class="n">l2_accesses</span> <span class="o">=</span> <span class="nf">sum</span><span class="p">(</span><span class="n">freq</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">freq</span> <span class="ow">in</span> <span class="n">l2_items</span><span class="p">)</span>
        
        <span class="n">l1_hit_rate</span> <span class="o">=</span> <span class="n">l1_accesses</span> <span class="o">/</span> <span class="n">total_accesses</span>
        <span class="n">l2_hit_rate</span> <span class="o">=</span> <span class="n">l2_accesses</span> <span class="o">/</span> <span class="n">total_accesses</span>
        
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="s">Expected hit rates:</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  L1: </span><span class="si">{</span><span class="n">l1_hit_rate</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="o">%</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  L2: </span><span class="si">{</span><span class="n">l2_hit_rate</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="o">%</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  Combined (L1+L2): </span><span class="si">{</span><span class="p">(</span><span class="n">l1_hit_rate</span> <span class="o">+</span> <span class="n">l2_hit_rate</span><span class="p">)</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="o">%</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># Example
</span><span class="n">strategy</span> <span class="o">=</span> <span class="nc">TieredCachingStrategy</span><span class="p">()</span>

<span class="c1"># Calculate costs
</span><span class="n">costs</span> <span class="o">=</span> <span class="n">strategy</span><span class="p">.</span><span class="nf">calculate_monthly_cost</span><span class="p">()</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Monthly CDN storage costs:</span><span class="sh">"</span><span class="p">)</span>
<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">costs</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s">: $</span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># Simulate access patterns
</span><span class="n">access_patterns</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sa">f</span><span class="sh">"</span><span class="s">item_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">random</span><span class="p">.</span><span class="nf">random</span><span class="p">()</span> <span class="o">*</span> <span class="mi">86400</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">random</span><span class="p">.</span><span class="nf">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">))]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">10000</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1"># Optimize
</span><span class="n">strategy</span><span class="p">.</span><span class="nf">optimize_tier_sizes</span><span class="p">(</span><span class="n">access_patterns</span><span class="p">)</span>
</code></pre></div></div>

<hr />

<h2 id="key-takeaways">Key Takeaways</h2>

<p>âœ… <strong>Edge caching</strong> - Serve content close to users for low latency<br />
âœ… <strong>Multi-level cache</strong> - L1 (Redis), L2 (disk), origin (database)<br />
âœ… <strong>Smart routing</strong> - GeoDNS + latency-based + load-based<br />
âœ… <strong>Cache invalidation</strong> - Pub/sub for real-time propagation<br />
âœ… <strong>Edge ML serving</strong> - Deploy models to edge for fast inference<br />
âœ… <strong>Cost optimization</strong> - Tiered storage based on access patterns</p>

<p><strong>Key Metrics:</strong></p>
<ul>
  <li>Cache hit rate: &gt; 80%</li>
  <li>P99 latency: &lt; 50ms for cache hits</li>
  <li>Origin latency: 200-500ms</li>
  <li>Bandwidth savings: 70-90%</li>
</ul>

<hr />

<p><strong>Originally published at:</strong> <a href="https://www.arunbaby.com/ml-system-design/0011-content-delivery-network/">arunbaby.com/ml-system-design/0011-content-delivery-network</a></p>

<p><em>If you found this helpful, consider sharing it with others who might benefit.</em></p>


        
      </section>

      <footer class="page__meta">
        
        
  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      <a href="/tags/#caching" class="page__taxonomy-item p-category" rel="tag">caching</a><span class="sep">, </span>
    
      <a href="/tags/#cdn" class="page__taxonomy-item p-category" rel="tag">cdn</a><span class="sep">, </span>
    
      <a href="/tags/#edge-computing" class="page__taxonomy-item p-category" rel="tag">edge-computing</a><span class="sep">, </span>
    
      <a href="/tags/#global-distribution" class="page__taxonomy-item p-category" rel="tag">global-distribution</a><span class="sep">, </span>
    
      <a href="/tags/#latency-optimization" class="page__taxonomy-item p-category" rel="tag">latency-optimization</a><span class="sep">, </span>
    
      <a href="/tags/#load-balancing" class="page__taxonomy-item p-category" rel="tag">load-balancing</a><span class="sep">, </span>
    
      <a href="/tags/#model-serving" class="page__taxonomy-item p-category" rel="tag">model-serving</a>
    
    </span>
  </p>




  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      <a href="/categories/#ml-system-design" class="page__taxonomy-item p-category" rel="tag">ml-system-design</a>
    
    </span>
  </p>


        
      </footer>

      <div class="page__related page__related--full">
  <h2 class="page__related-title">Related across topics</h2>
  <style>
    /* Make section span full content width and use 2 equal columns */
    .page__related--full { float: inline-start; width: 100%; padding: 0; }
    .cross-related-grid { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 2rem; }
    @media (max-width: 768px) { .cross-related-grid { grid-template-columns: 1fr; } }
    /* Ensure archive cards stretch nicely in the grid */
    .cross-related-grid .list__item, .cross-related-grid .grid__item { width: auto; float: none; margin: 0; }
  </style>
  <div class="cross-related-grid">
    



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/dsa/0011-lru-cache/" rel="permalink">LRU Cache
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          27 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Master LRU cache design: O(1) get/put with hash map + doubly linked list. Critical for interviews and production caching systems.
</p>
  </article>
</div>




<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/speech-tech/0011-speech-separation/" rel="permalink">Speech Separation
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          20 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Separate overlapping speakers with 99%+ accuracy: Deep learning solves the cocktail party problem for meeting transcription and voice assistants.
</p>
  </article>
</div>




<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/ai-agents/0011-vector-search-for-agents/" rel="permalink">Vector Search for Agents
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          17 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">â€œFinding a Needle in a High-Dimensional Haystack: The Mathematics of Recall.â€
</p>
  </article>
</div>

  </div>
</div>

      <section class="page__share">
  <h4 class="page__share-title">Share on</h4>

  <a href="https://twitter.com/intent/tweet?via=arunbaby0&text=Content+Delivery+Networks+%28CDN%29%20https%3A%2F%2Fwww.arunbaby.com%2Fml-system-design%2F0011-content-delivery-network%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fwww.arunbaby.com%2Fml-system-design%2F0011-content-delivery-network%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://www.arunbaby.com/ml-system-design/0011-content-delivery-network/" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/ml-system-design/0010-caching-strategies/" class="pagination--pager" title="Caching Strategies for ML Systems">Previous</a>
    
    
      <a href="/ml-system-design/0012-distributed-systems/" class="pagination--pager" title="Distributed ML Systems">Next</a>
    
  </nav>


    </div>

    
  </article>

  
  
</div>

      
    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';" role="search">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    
      
        
          <li><a href="https://twitter.com/arunbaby0" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
        
      
        
          <li><a href="https://github.com/arunbaby0" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
        
          <li><a href="https://www.linkedin.com/in/arunbaby0/" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i> LinkedIn</a></li>
        
      
        
          <li><a href="https://scholar.google.co.in/citations?user=6fSYWhkAAAAJ" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-graduation-cap" aria-hidden="true"></i> Google Scholar</a></li>
        
      
    

    
      <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 1990 - 2143 <a href="https://www.arunbaby.com">Arun Baby</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>




  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-0JRJPEC9SS"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-0JRJPEC9SS', { 'anonymize_ip': false});
</script>








  </body>
</html>
