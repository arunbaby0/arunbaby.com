<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.26.2 by Michael Rose
  Copyright 2013-2024 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->

<html lang="en-US" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Recommendation System: Candidate Retrieval - Arun Baby</title>
<meta name="description" content="How do you narrow down 10 million items to 1000 candidates in under 50ms? The art of fast retrieval at scale.">


  <meta name="author" content="Arun Baby">
  
  <meta property="article:author" content="Arun Baby">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Arun Baby">
<meta property="og:title" content="Recommendation System: Candidate Retrieval">
<meta property="og:url" content="https://www.arunbaby.com/ml-system-design/0001-recommendation-system/">


  <meta property="og:description" content="How do you narrow down 10 million items to 1000 candidates in under 50ms? The art of fast retrieval at scale.">



  <meta property="og:image" content="https://www.arunbaby.com/assets/images/profile-photo.png">



  <meta name="twitter:site" content="@arunbaby0">
  <meta name="twitter:title" content="Recommendation System: Candidate Retrieval">
  <meta name="twitter:description" content="How do you narrow down 10 million items to 1000 candidates in under 50ms? The art of fast retrieval at scale.">
  <meta name="twitter:url" content="https://www.arunbaby.com/ml-system-design/0001-recommendation-system/">

  
    <meta name="twitter:card" content="summary">
    
      <meta name="twitter:image" content="https://www.arunbaby.com/assets/images/profile-photo.png">
    
  

  



  <meta property="article:published_time" content="2025-12-21T18:25:51+05:30">





  

  


<link rel="canonical" href="https://www.arunbaby.com/ml-system-design/0001-recommendation-system/">












<!-- end _includes/seo.html -->



  <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Arun Baby Feed">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
  
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css"></noscript>



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single" dir="ltr">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
           
          <span class="site-subtitle">Arun Baby</span>
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a
                href="/about/"
                
                
              >About</a>
            </li><li class="masthead__menu-item">
              <a
                href="/dsa/"
                
                
              >DSA</a>
            </li><li class="masthead__menu-item">
              <a
                href="/ml-system-design/"
                
                
              >ML Systems</a>
            </li><li class="masthead__menu-item">
              <a
                href="/speech-tech/"
                
                
              >Speech Tech</a>
            </li><li class="masthead__menu-item">
              <a
                href="/ai-agents/"
                
                
              >AI Agents</a>
            </li><li class="masthead__menu-item">
              <a
                href="/publications/"
                
                
              >Publications</a>
            </li><li class="masthead__menu-item">
              <a
                href="/statuses/"
                
                
              >Statuses</a>
            </li><li class="masthead__menu-item">
              <a
                href="/contact/"
                
                
              >Contact</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <i class="fas fa-search"></i>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      





<div id="main" role="main" class="no-author-sidebar">
  
  <div class="sidebar sticky">
  
  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Recommendation System: Candidate Retrieval">
    <meta itemprop="description" content="How do you narrow down 10 million items to 1000 candidates in under 50ms? The art of fast retrieval at scale.">
    <meta itemprop="datePublished" content="2025-12-21T18:25:51+05:30">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">
            <a href="https://www.arunbaby.com/ml-system-design/0001-recommendation-system/" itemprop="url">Recommendation System: Candidate Retrieval
</a>
          </h1>
          

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          29 minute read
        
      </span>
    
  </p>


        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right sticky">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> On this page</h4></header>
              <ul class="toc__menu"><li><a href="#introduction">Introduction</a></li><li><a href="#problem-definition">Problem Definition</a><ul><li><a href="#functional-requirements">Functional Requirements</a></li><li><a href="#non-functional-requirements">Non-Functional Requirements</a></li><li><a href="#out-of-scope-clarify-these">Out of Scope (Clarify These)</a></li></ul></li><li><a href="#high-level-architecture">High-Level Architecture</a><ul><li><a href="#component-architecture">Component Architecture</a></li></ul></li><li><a href="#core-component-1-user-and-item-embeddings">Core Component 1: User and Item Embeddings</a><ul><li><a href="#what-are-embeddings">What are Embeddings?</a></li><li><a href="#two-tower-architecture">Two-Tower Architecture</a></li><li><a href="#training-the-model">Training the Model</a></li><li><a href="#why-two-tower-works">Why Two-Tower Works</a></li></ul></li><li><a href="#core-component-2-approximate-nearest-neighbor-ann-search">Core Component 2: Approximate Nearest Neighbor (ANN) Search</a><ul><li><a href="#the-problem">The Problem</a></li><li><a href="#approximate-nearest-neighbor-ann">Approximate Nearest Neighbor (ANN)</a></li><li><a href="#hnsw-hierarchical-navigable-small-world">HNSW (Hierarchical Navigable Small World)</a></li><li><a href="#parameter-tuning">Parameter Tuning</a></li><li><a href="#alternative-product-quantization">Alternative: Product Quantization</a></li></ul></li><li><a href="#core-component-3-multiple-retrieval-strategies">Core Component 3: Multiple Retrieval Strategies</a><ul><li><a href="#strategy-1-collaborative-filtering-40-of-candidates">Strategy 1: Collaborative Filtering (40% of candidates)</a></li><li><a href="#strategy-2-content-based-filtering-30-of-candidates">Strategy 2: Content-Based Filtering (30% of candidates)</a></li><li><a href="#strategy-3-trending-20-of-candidates">Strategy 3: Trending (20% of candidates)</a></li><li><a href="#strategy-4-social-10-of-candidates">Strategy 4: Social (10% of candidates)</a></li><li><a href="#merging-strategies">Merging Strategies</a></li></ul></li><li><a href="#core-component-4-caching-strategy">Core Component 4: Caching Strategy</a><ul><li><a href="#three-level-cache-architecture">Three-Level Cache Architecture</a></li><li><a href="#implementation">Implementation</a></li><li><a href="#cache-warming-strategy">Cache Warming Strategy</a></li><li><a href="#cache-invalidation">Cache Invalidation</a></li><li><a href="#cache-hit-rate-monitoring">Cache Hit Rate Monitoring</a></li></ul></li><li><a href="#handling-cold-start">Handling Cold Start</a><ul><li><a href="#new-user-problem">New User Problem</a></li><li><a href="#new-item-problem">New Item Problem</a></li></ul></li><li><a href="#real-world-examples">Real-World Examples</a><ul><li><a href="#youtube-recommendations">YouTube Recommendations</a></li><li><a href="#pinterest-pinsage">Pinterest (PinSage)</a></li><li><a href="#spotify-recommendations">Spotify Recommendations</a></li></ul></li><li><a href="#monitoring-and-evaluation">Monitoring and Evaluation</a><ul><li><a href="#online-metrics">Online Metrics</a></li><li><a href="#offline-metrics">Offline Metrics</a></li><li><a href="#ab-testing">A/B Testing</a></li></ul></li><li><a href="#key-takeaways">Key Takeaways</a></li><li><a href="#further-reading">Further Reading</a></li><li><a href="#conclusion">Conclusion</a></li></ul>
            </nav>
          </aside>
        
        <p><strong>How do you narrow down 10 million items to 1000 candidates in under 50ms? The art of fast retrieval at scale.</strong></p>

<h2 id="introduction">Introduction</h2>

<p>Every day, you interact with recommendation systems dozens of times: YouTube suggests videos, Netflix recommends shows, Amazon suggests products, Spotify curates playlists, and Instagram fills your feed. Behind each recommendation is a sophisticated system that must:</p>

<ul>
  <li>Search through <strong>millions</strong> of items in <strong>milliseconds</strong></li>
  <li>Personalize results for <strong>hundreds of millions</strong> of users</li>
  <li>Balance relevance, diversity, and freshness</li>
  <li>Handle new users and new content gracefully</li>
  <li>Scale horizontally to serve billions of requests per day</li>
</ul>

<p>The naive approach computing scores for all items for each user is mathematically impossible at scale. If we have 100M users and 10M items, that’s 1 quadrillion (10^15) combinations to score. Even at 1 billion computations per second, this would take <strong>11+ days per request</strong>.</p>

<p>This post focuses on the <strong>candidate generation</strong> (or retrieval) stage: how we efficiently narrow millions of items down to hundreds of candidates that might interest a user. This is the first and most critical stage of any recommendation system, as it determines the maximum possible quality of recommendations while constraining latency and cost.</p>

<p><strong>What you’ll learn:</strong></p>
<ul>
  <li>Why most recommendation systems use a funnel architecture</li>
  <li>How embedding-based retrieval enables personalization at scale</li>
  <li>Approximate nearest neighbor (ANN) search algorithms</li>
  <li>Multiple retrieval strategies and how to combine them</li>
  <li>Caching patterns for sub-50ms latency</li>
  <li>Cold start problem solutions</li>
  <li>Real production architectures from YouTube, Pinterest, and Spotify</li>
</ul>

<hr />

<h2 id="problem-definition">Problem Definition</h2>

<p>Design the <strong>candidate generation stage</strong> of a recommendation system that:</p>

<h3 id="functional-requirements">Functional Requirements</h3>

<ol>
  <li><strong>Personalized Retrieval</strong>
    <ul>
      <li>Different candidates for each user based on their preferences</li>
      <li>Not just “popular items for everyone”</li>
      <li>Must capture user’s interests, behavior patterns, and context</li>
    </ul>
  </li>
  <li><strong>Multiple Retrieval Strategies</strong>
    <ul>
      <li>Collaborative filtering (users with similar taste)</li>
      <li>Content-based filtering (items similar to what user liked)</li>
      <li>Trending/popular items (what’s hot right now)</li>
      <li>Social signals (what friends are engaging with)</li>
    </ul>
  </li>
  <li><strong>Diversity</strong>
    <ul>
      <li>Avoid filter bubbles (all items too similar)</li>
      <li>Show variety of content types, topics, creators</li>
      <li>Enable exploration (help users discover new interests)</li>
    </ul>
  </li>
  <li><strong>Freshness</strong>
    <ul>
      <li>New items should appear within minutes of publication</li>
      <li>System should adapt to changing user interests</li>
      <li>Handle trending topics and viral content</li>
    </ul>
  </li>
  <li><strong>Cold Start Handling</strong>
    <ul>
      <li>New users with no history</li>
      <li>New items with no engagement data</li>
      <li>Graceful degradation when data is sparse</li>
    </ul>
  </li>
</ol>

<h3 id="non-functional-requirements">Non-Functional Requirements</h3>

<ol>
  <li><strong>Latency</strong>
    <ul>
      <li>p50 &lt; 20ms (median request)</li>
      <li>p95 &lt; 40ms (95th percentile)</li>
      <li>p99 &lt; 50ms (99th percentile)</li>
      <li>Why so strict? Candidate generation is just one stage; ranking, re-ranking, and other processing add more latency</li>
    </ul>
  </li>
  <li><strong>Throughput</strong>
    <ul>
      <li>100M daily active users</li>
      <li>Assume 100 requests per user per day (feed refreshes, scrolls)</li>
      <li>10 billion requests per day</li>
      <li>~115k QPS average, ~500k QPS peak</li>
    </ul>
  </li>
  <li><strong>Scale</strong>
    <ul>
      <li>100M+ active users</li>
      <li>10M+ active items (videos, posts, products)</li>
      <li>Billions of historical interactions</li>
      <li>Petabytes of training data</li>
    </ul>
  </li>
  <li><strong>Availability</strong>
    <ul>
      <li>99.9% uptime (43 minutes downtime per month)</li>
      <li>Graceful degradation when components fail</li>
      <li>No single points of failure</li>
    </ul>
  </li>
  <li><strong>Cost Efficiency</strong>
    <ul>
      <li>Minimize compute costs (GPU/CPU)</li>
      <li>Optimize storage (embeddings, features)</li>
      <li>Reduce data transfer (network bandwidth)</li>
    </ul>
  </li>
</ol>

<h3 id="out-of-scope-clarify-these">Out of Scope (Clarify These)</h3>

<ul>
  <li>Ranking stage (scoring the 1000 candidates to get top 20)</li>
  <li>Re-ranking and diversity post-processing</li>
  <li>A/B testing infrastructure</li>
  <li>Training pipeline and data collection</li>
  <li>Content moderation and safety</li>
  <li>Business logic (e.g., promoted content, ads)</li>
</ul>

<hr />

<h2 id="high-level-architecture">High-Level Architecture</h2>

<p>The recommendation system follows a <strong>funnel architecture</strong>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>10M Items
    ↓ Candidate Generation (This Post)
1000 Candidates
    ↓ Ranking (Lightweight Model)
100 Candidates
    ↓ Re-ranking (Heavy Model + Business Logic)
20 Final Results
</code></pre></div></div>

<p><strong>Why a funnel?</strong></p>
<ul>
  <li><strong>Cannot score all items:</strong> 10M items × 50ms per item = 5.8 days per request</li>
  <li><strong>Quality vs. Speed tradeoff:</strong> Fast approximate methods first, expensive accurate methods last</li>
  <li><strong>Resource optimization:</strong> Apply expensive computations only to promising candidates</li>
</ul>

<p>Our focus: <strong>10M → 1000 in &lt; 50ms</strong></p>

<h3 id="component-architecture">Component Architecture</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>User Request
  ├─ user_id: 12345
  ├─ context: {device: mobile, time: evening, location: US-CA}
  └─ num_candidates: 1000
    ↓
┌─────────────────────────────────────────────┐
│         Feature Lookup (5ms)                 │
│  • User Embedding (Redis)                   │
│  • User Profile (Cassandra)                 │
│  • Recent Activity (Redis Stream)           │
└──────────────┬──────────────────────────────┘
               ↓
┌─────────────────────────────────────────────┐
│    Retrieval Strategies (Parallel, 30ms)    │
│  ┌────────────────┐  ┌──────────────────┐  │
│  │ Collaborative  │  │  Content-Based   │  │
│  │  Filtering     │  │    Filtering     │  │
│  │  (ANN Search)  │  │  (Tag Matching)  │  │
│  │   400 items    │  │    300 items     │  │
│  └────────────────┘  └──────────────────┘  │
│  ┌────────────────┐  ┌──────────────────┐  │
│  │   Trending     │  │     Social       │  │
│  │   (Sorted)     │  │  (Friends' Feed) │  │
│  │   200 items    │  │    100 items     │  │
│  └────────────────┘  └──────────────────┘  │
└──────────────┬──────────────────────────────┘
               ↓
┌─────────────────────────────────────────────┐
│    Merge &amp; Deduplicate (5ms)                │
│  • Combine all sources                      │
│  • Remove duplicates                        │
│  • Basic filtering (already seen, blocked)  │
└──────────────┬──────────────────────────────┘
               ↓
     Return ~1000 candidates
</code></pre></div></div>

<p><strong>Latency Budget (50ms total):</strong></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Feature lookup:        5ms
Retrieval (parallel): 30ms
Merge/dedup:          5ms
Network overhead:     10ms
Total:               50ms ✓
</code></pre></div></div>

<hr />

<h2 id="core-component-1-user-and-item-embeddings">Core Component 1: User and Item Embeddings</h2>

<h3 id="what-are-embeddings">What are Embeddings?</h3>

<p><strong>Embeddings</strong> are dense vector representations that capture semantic meaning in a continuous space.</p>

<p><strong>Example:</strong></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># User embedding (128 dimensions)
</span><span class="n">user_12345</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.23</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.45</span><span class="p">,</span> <span class="mf">0.67</span><span class="p">,</span> <span class="p">...,</span> <span class="mf">0.12</span><span class="p">]</span>  <span class="c1"># 128 numbers
</span>
<span class="c1"># Item embeddings
</span><span class="n">item_5678</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.19</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.41</span><span class="p">,</span> <span class="mf">0.72</span><span class="p">,</span> <span class="p">...,</span> <span class="mf">0.15</span><span class="p">]</span>   <span class="c1"># Similar to user!
</span><span class="n">item_9999</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.78</span><span class="p">,</span> <span class="mf">0.92</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.34</span><span class="p">,</span> <span class="p">...,</span> <span class="o">-</span><span class="mf">0.88</span><span class="p">]</span>  <span class="c1"># Very different
</span>
<span class="c1"># Similarity = dot product
</span><span class="n">similarity</span> <span class="o">=</span> <span class="nf">sum</span><span class="p">(</span><span class="n">u</span> <span class="o">*</span> <span class="n">i</span> <span class="k">for</span> <span class="n">u</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">zip</span><span class="p">(</span><span class="n">user_12345</span><span class="p">,</span> <span class="n">item_5678</span><span class="p">))</span>
<span class="c1"># High similarity → good recommendation!
</span></code></pre></div></div>

<p><strong>Why embeddings work:</strong></p>
<ul>
  <li><strong>Semantic similarity:</strong> Similar users/items have similar vectors</li>
  <li><strong>Efficient computation:</strong> Dot product is fast (O(d) for d dimensions)</li>
  <li><strong>Learned representations:</strong> Neural networks learn meaningful patterns</li>
  <li><strong>Dense vs. sparse:</strong> 128 floats vs. millions of categorical features</li>
</ul>

<h3 id="two-tower-architecture">Two-Tower Architecture</h3>

<p>The most common architecture for retrieval is the <strong>two-tower model</strong>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>User Features              Item Features
  ├─ Demographics           ├─ Title/Description
  ├─ Historical Behavior    ├─ Category/Tags
  ├─ Recent Activity        ├─ Creator Info
  └─ Context               └─ Metadata
      ↓                         ↓
  ┌─────────┐             ┌─────────┐
  │  User   │             │  Item   │
  │  Tower  │             │  Tower  │
  │  (NN)   │             │  (NN)   │
  └────┬────┘             └────┬────┘
       │                       │
       └───────────┬───────────┘
                   ↓
            Dot Product
                   ↓
           Similarity Score
</code></pre></div></div>

<p><strong>Implementation:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">torch</span>
<span class="kn">import</span> <span class="n">torch.nn</span> <span class="k">as</span> <span class="n">nn</span>

<span class="k">class</span> <span class="nc">TwoTowerModel</span><span class="p">(</span><span class="n">nn</span><span class="p">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">user_feature_dim</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">item_feature_dim</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">embedding_dim</span><span class="o">=</span><span class="mi">128</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">()</span>
        
        <span class="c1"># User tower: transform user features to embedding
</span>        <span class="n">self</span><span class="p">.</span><span class="n">user_tower</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">Sequential</span><span class="p">(</span>
            <span class="n">nn</span><span class="p">.</span><span class="nc">Linear</span><span class="p">(</span><span class="n">user_feature_dim</span><span class="p">,</span> <span class="mi">256</span><span class="p">),</span>
            <span class="n">nn</span><span class="p">.</span><span class="nc">ReLU</span><span class="p">(),</span>
            <span class="n">nn</span><span class="p">.</span><span class="nc">Dropout</span><span class="p">(</span><span class="mf">0.2</span><span class="p">),</span>
            <span class="n">nn</span><span class="p">.</span><span class="nc">Linear</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">),</span>
            <span class="n">nn</span><span class="p">.</span><span class="nc">ReLU</span><span class="p">(),</span>
            <span class="n">nn</span><span class="p">.</span><span class="nc">Dropout</span><span class="p">(</span><span class="mf">0.2</span><span class="p">),</span>
            <span class="n">nn</span><span class="p">.</span><span class="nc">Linear</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="n">embedding_dim</span><span class="p">)</span>
        <span class="p">)</span>
        
        <span class="c1"># Item tower: transform item features to embedding
</span>        <span class="n">self</span><span class="p">.</span><span class="n">item_tower</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">Sequential</span><span class="p">(</span>
            <span class="n">nn</span><span class="p">.</span><span class="nc">Linear</span><span class="p">(</span><span class="n">item_feature_dim</span><span class="p">,</span> <span class="mi">256</span><span class="p">),</span>
            <span class="n">nn</span><span class="p">.</span><span class="nc">ReLU</span><span class="p">(),</span>
            <span class="n">nn</span><span class="p">.</span><span class="nc">Dropout</span><span class="p">(</span><span class="mf">0.2</span><span class="p">),</span>
            <span class="n">nn</span><span class="p">.</span><span class="nc">Linear</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">),</span>
            <span class="n">nn</span><span class="p">.</span><span class="nc">ReLU</span><span class="p">(),</span>
            <span class="n">nn</span><span class="p">.</span><span class="nc">Dropout</span><span class="p">(</span><span class="mf">0.2</span><span class="p">),</span>
            <span class="n">nn</span><span class="p">.</span><span class="nc">Linear</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="n">embedding_dim</span><span class="p">)</span>
        <span class="p">)</span>
        
        <span class="c1"># L2 normalization layer
</span>        <span class="n">self</span><span class="p">.</span><span class="n">normalize</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">/</span> <span class="p">(</span><span class="n">torch</span><span class="p">.</span><span class="nf">norm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">user_features</span><span class="p">,</span> <span class="n">item_features</span><span class="p">):</span>
        <span class="c1"># Generate embeddings
</span>        <span class="n">user_emb</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">user_tower</span><span class="p">(</span><span class="n">user_features</span><span class="p">)</span>  <span class="c1"># (batch, 128)
</span>        <span class="n">item_emb</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">item_tower</span><span class="p">(</span><span class="n">item_features</span><span class="p">)</span>  <span class="c1"># (batch, 128)
</span>        
        <span class="c1"># Normalize to unit vectors (cosine similarity = dot product)
</span>        <span class="n">user_emb</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">normalize</span><span class="p">(</span><span class="n">user_emb</span><span class="p">)</span>
        <span class="n">item_emb</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">normalize</span><span class="p">(</span><span class="n">item_emb</span><span class="p">)</span>
        
        <span class="c1"># Compute similarity (dot product)
</span>        <span class="n">score</span> <span class="o">=</span> <span class="p">(</span><span class="n">user_emb</span> <span class="o">*</span> <span class="n">item_emb</span><span class="p">).</span><span class="nf">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># (batch,)
</span>        
        <span class="k">return</span> <span class="n">score</span><span class="p">,</span> <span class="n">user_emb</span><span class="p">,</span> <span class="n">item_emb</span>
    
    <span class="k">def</span> <span class="nf">get_user_embedding</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">user_features</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Get just the user embedding (for serving)</span><span class="sh">"""</span>
        <span class="k">with</span> <span class="n">torch</span><span class="p">.</span><span class="nf">no_grad</span><span class="p">():</span>
            <span class="n">user_emb</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">user_tower</span><span class="p">(</span><span class="n">user_features</span><span class="p">)</span>
            <span class="n">user_emb</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">normalize</span><span class="p">(</span><span class="n">user_emb</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">user_emb</span>
    
    <span class="k">def</span> <span class="nf">get_item_embedding</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">item_features</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Get just the item embedding (for indexing)</span><span class="sh">"""</span>
        <span class="k">with</span> <span class="n">torch</span><span class="p">.</span><span class="nf">no_grad</span><span class="p">():</span>
            <span class="n">item_emb</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">item_tower</span><span class="p">(</span><span class="n">item_features</span><span class="p">)</span>
            <span class="n">item_emb</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">normalize</span><span class="p">(</span><span class="n">item_emb</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">item_emb</span>
</code></pre></div></div>

<h3 id="training-the-model">Training the Model</h3>

<p><strong>Training Data:</strong></p>
<ul>
  <li><strong>Positive examples:</strong> (user, item) pairs where user engaged with item (click, watch, purchase)</li>
  <li><strong>Negative examples:</strong> (user, item) pairs where user didn’t engage</li>
</ul>

<p><strong>Loss Function:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">contrastive_loss</span><span class="p">(</span><span class="n">positive_scores</span><span class="p">,</span> <span class="n">negative_scores</span><span class="p">,</span> <span class="n">margin</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    Encourage positive pairs to have high scores,
    negative pairs to have low scores
    </span><span class="sh">"""</span>
    <span class="c1"># Positive examples should have score &gt; 0
</span>    <span class="n">positive_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">relu</span><span class="p">(</span><span class="n">margin</span> <span class="o">-</span> <span class="n">positive_scores</span><span class="p">).</span><span class="nf">mean</span><span class="p">()</span>
    
    <span class="c1"># Negative examples should have score &lt; 0
</span>    <span class="n">negative_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">relu</span><span class="p">(</span><span class="n">margin</span> <span class="o">+</span> <span class="n">negative_scores</span><span class="p">).</span><span class="nf">mean</span><span class="p">()</span>
    
    <span class="k">return</span> <span class="n">positive_loss</span> <span class="o">+</span> <span class="n">negative_loss</span>


<span class="k">def</span> <span class="nf">triplet_loss</span><span class="p">(</span><span class="n">anchor_emb</span><span class="p">,</span> <span class="n">positive_emb</span><span class="p">,</span> <span class="n">negative_emb</span><span class="p">,</span> <span class="n">margin</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    Distance to positive should be less than distance to negative
    </span><span class="sh">"""</span>
    <span class="n">pos_distance</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">norm</span><span class="p">(</span><span class="n">anchor_emb</span> <span class="o">-</span> <span class="n">positive_emb</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">neg_distance</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">norm</span><span class="p">(</span><span class="n">anchor_emb</span> <span class="o">-</span> <span class="n">negative_emb</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="n">loss</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">relu</span><span class="p">(</span><span class="n">pos_distance</span> <span class="o">-</span> <span class="n">neg_distance</span> <span class="o">+</span> <span class="n">margin</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">loss</span><span class="p">.</span><span class="nf">mean</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">batch_softmax_loss</span><span class="p">(</span><span class="n">user_emb</span><span class="p">,</span> <span class="n">item_emb_positive</span><span class="p">,</span> <span class="n">item_emb_negatives</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    Treat as multi-class classification: which item did user engage with?
    
    user_emb: (batch, dim)
    item_emb_positive: (batch, dim)
    item_emb_negatives: (batch, num_negatives, dim)
    </span><span class="sh">"""</span>
    <span class="c1"># Positive score
</span>    <span class="n">pos_score</span> <span class="o">=</span> <span class="p">(</span><span class="n">user_emb</span> <span class="o">*</span> <span class="n">item_emb_positive</span><span class="p">).</span><span class="nf">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># (batch,)
</span>    
    <span class="c1"># Negative scores
</span>    <span class="c1"># user_emb: (batch, 1, dim), item_emb_negatives: (batch, num_neg, dim)
</span>    <span class="n">neg_scores</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">bmm</span><span class="p">(</span>
        <span class="n">item_emb_negatives</span><span class="p">,</span> 
        <span class="n">user_emb</span><span class="p">.</span><span class="nf">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">).</span><span class="nf">squeeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># (batch, num_neg)
</span>    
    <span class="c1"># Concatenate: first column is positive, rest are negatives
</span>    <span class="n">all_scores</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">cat</span><span class="p">([</span><span class="n">pos_score</span><span class="p">.</span><span class="nf">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">neg_scores</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># (batch, 1+num_neg)
</span>    
    <span class="c1"># Target: index 0 (positive item)
</span>    <span class="n">targets</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">zeros</span><span class="p">(</span><span class="n">all_scores</span><span class="p">.</span><span class="nf">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="p">.</span><span class="nb">long</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">all_scores</span><span class="p">.</span><span class="n">device</span><span class="p">)</span>
    
    <span class="c1"># Cross-entropy loss
</span>    <span class="n">loss</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">CrossEntropyLoss</span><span class="p">()(</span><span class="n">all_scores</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">loss</span>
</code></pre></div></div>

<p><strong>Training Loop:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">train_two_tower_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">train_loader</span><span class="p">,</span> <span class="n">num_epochs</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.001</span><span class="p">):</span>
    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">optim</span><span class="p">.</span><span class="nc">Adam</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="nf">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">num_epochs</span><span class="p">):</span>
        <span class="n">model</span><span class="p">.</span><span class="nf">train</span><span class="p">()</span>
        <span class="n">total_loss</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">train_loader</span><span class="p">:</span>
            <span class="c1"># Unpack batch
</span>            <span class="n">user_features</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="sh">'</span><span class="s">user_features</span><span class="sh">'</span><span class="p">]</span>
            <span class="n">positive_item_features</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="sh">'</span><span class="s">positive_item_features</span><span class="sh">'</span><span class="p">]</span>
            <span class="n">negative_item_features</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="sh">'</span><span class="s">negative_item_features</span><span class="sh">'</span><span class="p">]</span>  <span class="c1"># (batch, num_neg, dim)
</span>            
            <span class="c1"># Forward pass
</span>            <span class="n">_</span><span class="p">,</span> <span class="n">user_emb</span><span class="p">,</span> <span class="n">pos_item_emb</span> <span class="o">=</span> <span class="nf">model</span><span class="p">(</span><span class="n">user_features</span><span class="p">,</span> <span class="n">positive_item_features</span><span class="p">)</span>
            
            <span class="c1"># Get negative embeddings
</span>            <span class="n">batch_size</span><span class="p">,</span> <span class="n">num_negatives</span><span class="p">,</span> <span class="n">feature_dim</span> <span class="o">=</span> <span class="n">negative_item_features</span><span class="p">.</span><span class="n">shape</span>
            <span class="n">neg_item_features_flat</span> <span class="o">=</span> <span class="n">negative_item_features</span><span class="p">.</span><span class="nf">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">feature_dim</span><span class="p">)</span>
            <span class="n">neg_item_emb_flat</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="nf">get_item_embedding</span><span class="p">(</span><span class="n">neg_item_features_flat</span><span class="p">)</span>
            <span class="n">neg_item_emb</span> <span class="o">=</span> <span class="n">neg_item_emb_flat</span><span class="p">.</span><span class="nf">view</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">num_negatives</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            
            <span class="c1"># Compute loss
</span>            <span class="n">loss</span> <span class="o">=</span> <span class="nf">batch_softmax_loss</span><span class="p">(</span><span class="n">user_emb</span><span class="p">,</span> <span class="n">pos_item_emb</span><span class="p">,</span> <span class="n">neg_item_emb</span><span class="p">)</span>
            
            <span class="c1"># Backward pass
</span>            <span class="n">optimizer</span><span class="p">.</span><span class="nf">zero_grad</span><span class="p">()</span>
            <span class="n">loss</span><span class="p">.</span><span class="nf">backward</span><span class="p">()</span>
            <span class="n">optimizer</span><span class="p">.</span><span class="nf">step</span><span class="p">()</span>
            
            <span class="n">total_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="p">.</span><span class="nf">item</span><span class="p">()</span>
        
        <span class="n">avg_loss</span> <span class="o">=</span> <span class="n">total_loss</span> <span class="o">/</span> <span class="nf">len</span><span class="p">(</span><span class="n">train_loader</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Epoch </span><span class="si">{</span><span class="n">epoch</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s">/</span><span class="si">{</span><span class="n">num_epochs</span><span class="si">}</span><span class="s">, Loss: </span><span class="si">{</span><span class="n">avg_loss</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">model</span>
</code></pre></div></div>

<p><strong>Negative Sampling Strategies:</strong></p>

<ol>
  <li><strong>Random Negatives:</strong> Sample random items user didn’t interact with
    <ul>
      <li>Pro: Simple, covers broad space</li>
      <li>Con: Often too easy (user clearly not interested)</li>
    </ul>
  </li>
  <li><strong>Hard Negatives:</strong> Sample items user almost engaged with (scrolled past, clicked but didn’t purchase)
    <ul>
      <li>Pro: More informative, improves model discrimination</li>
      <li>Con: Harder to obtain, may need separate model to identify</li>
    </ul>
  </li>
  <li><strong>Batch Negatives:</strong> Use positive items from other users in batch as negatives
    <ul>
      <li>Pro: No additional sampling needed, efficient</li>
      <li>Con: Not truly negative (another user liked it)</li>
    </ul>
  </li>
  <li><strong>Mixed Strategy:</strong> Combine all three
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">negatives</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">negatives</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="nf">sample_random</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">10</span><span class="p">))</span>
<span class="n">negatives</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="nf">sample_hard</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">5</span><span class="p">))</span>
<span class="n">negatives</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="nf">batch_negatives</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="n">user</span><span class="p">))</span>
</code></pre></div>    </div>
  </li>
</ol>

<h3 id="why-two-tower-works">Why Two-Tower Works</h3>

<p><strong>Key advantage:</strong> User and item embeddings are <strong>decoupled</strong>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Traditional approach:
  user × item → score
  Problem: Need to compute for all 10M items online

Two-tower approach:
  user → user_embedding (online, 1ms)
  item → item_embedding (offline, precompute for all items)
  Retrieval: Find items with embeddings similar to user_embedding (ANN, 20ms)
</code></pre></div></div>

<p><strong>Precomputation:</strong></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Offline: Compute all item embeddings once
</span><span class="n">all_item_embeddings</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">all_items</span><span class="p">:</span>
    <span class="n">item_features</span> <span class="o">=</span> <span class="nf">get_item_features</span><span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="nb">id</span><span class="p">)</span>
    <span class="n">item_emb</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="nf">get_item_embedding</span><span class="p">(</span><span class="n">item_features</span><span class="p">)</span>
    <span class="n">all_item_embeddings</span><span class="p">[</span><span class="n">item</span><span class="p">.</span><span class="nb">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">item_emb</span>

<span class="c1"># Online: Just compute user embedding and search
</span><span class="n">user_features</span> <span class="o">=</span> <span class="nf">get_user_features</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
<span class="n">user_emb</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="nf">get_user_embedding</span><span class="p">(</span><span class="n">user_features</span><span class="p">)</span>
<span class="n">similar_item_ids</span> <span class="o">=</span> <span class="nf">ann_search</span><span class="p">(</span><span class="n">user_emb</span><span class="p">,</span> <span class="n">all_item_embeddings</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>
</code></pre></div></div>

<hr />

<h2 id="core-component-2-approximate-nearest-neighbor-ann-search">Core Component 2: Approximate Nearest Neighbor (ANN) Search</h2>

<h3 id="the-problem">The Problem</h3>

<p>Given a user embedding, find the top-k items with most similar embeddings.</p>

<p><strong>Naive approach (exact search):</strong></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">exact_nearest_neighbors</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">all_embeddings</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
    <span class="n">similarities</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item_id</span><span class="p">,</span> <span class="n">item_emb</span> <span class="ow">in</span> <span class="n">all_embeddings</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
        <span class="n">similarity</span> <span class="o">=</span> <span class="nf">dot_product</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">item_emb</span><span class="p">)</span>
        <span class="n">similarities</span><span class="p">.</span><span class="nf">append</span><span class="p">((</span><span class="n">item_id</span><span class="p">,</span> <span class="n">similarity</span><span class="p">))</span>
    
    <span class="n">similarities</span><span class="p">.</span><span class="nf">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">similarities</span><span class="p">[:</span><span class="n">k</span><span class="p">]</span>
</code></pre></div></div>

<p><strong>Problem:</strong> O(n) where n = 10M items</p>
<ul>
  <li>10M dot products × 128 dimensions = 1.28B operations</li>
  <li>At 1B ops/sec: 1.28 seconds per query</li>
  <li>Way too slow for 50ms latency target!</li>
</ul>

<h3 id="approximate-nearest-neighbor-ann">Approximate Nearest Neighbor (ANN)</h3>

<p><strong>Trade accuracy for speed:</strong> Find items that are <em>approximately</em> nearest, not <em>exactly</em> nearest.</p>

<p><strong>Typical tradeoff:</strong></p>
<ul>
  <li>Exact search: 100% recall, 1000ms latency</li>
  <li>ANN search: 95% recall, 20ms latency</li>
</ul>

<p><strong>Key algorithms:</strong></p>
<ol>
  <li><strong>HNSW</strong> (Hierarchical Navigable Small World) - Best overall</li>
  <li><strong>ScaNN</strong> (Google) - Excellent for large scale</li>
  <li><strong>FAISS</strong> (Facebook) - Multiple algorithms, well-optimized</li>
  <li><strong>Annoy</strong> (Spotify) - Simple, good for smaller datasets</li>
</ol>

<h3 id="hnsw-hierarchical-navigable-small-world">HNSW (Hierarchical Navigable Small World)</h3>

<p><strong>Core idea:</strong> Build a multi-layer graph where:</p>
<ul>
  <li>Top layers: Long-range connections (coarse search)</li>
  <li>Bottom layers: Short-range connections (fine search)</li>
</ul>

<p><strong>Visualization:</strong></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Layer 2: •─────────────•        (Sparse, long jumps)

Layer 1: •──•──•────•──•──•     (Medium density)

Layer 0: •─•─•─•─•─•─•─•─•─•    (Dense, precise)
</code></pre></div></div>

<p><strong>Search algorithm:</strong></p>
<ol>
  <li>Start at top layer</li>
  <li>Greedily move to closest neighbor</li>
  <li>When can’t improve, descend to lower layer</li>
  <li>Repeat until bottom layer</li>
  <li>Return k nearest neighbors</li>
</ol>

<p><strong>Implementation with FAISS:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">faiss</span>
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>

<span class="k">class</span> <span class="nc">HNSWIndex</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">dimension</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">M</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">ef_construction</span><span class="o">=</span><span class="mi">200</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Args:
            dimension: Embedding dimension
            M: Number of bi-directional links per layer (higher = more accurate, more memory)
            ef_construction: Size of dynamic candidate list during construction (higher = better quality, slower build)
        </span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="n">dimension</span> <span class="o">=</span> <span class="n">dimension</span>
        <span class="n">self</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">faiss</span><span class="p">.</span><span class="nc">IndexHNSWFlat</span><span class="p">(</span><span class="n">dimension</span><span class="p">,</span> <span class="n">M</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="n">hnsw</span><span class="p">.</span><span class="n">efConstruction</span> <span class="o">=</span> <span class="n">ef_construction</span>
        <span class="n">self</span><span class="p">.</span><span class="n">item_ids</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">item_ids</span><span class="p">,</span> <span class="n">embeddings</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Add items to index
        
        Args:
            item_ids: List of item IDs
            embeddings: numpy array of shape (n, dimension)
        </span><span class="sh">"""</span>
        <span class="c1"># FAISS requires float32
</span>        <span class="n">embeddings</span> <span class="o">=</span> <span class="n">embeddings</span><span class="p">.</span><span class="nf">astype</span><span class="p">(</span><span class="sh">'</span><span class="s">float32</span><span class="sh">'</span><span class="p">)</span>
        
        <span class="c1"># Add to index
</span>        <span class="n">self</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">embeddings</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">item_ids</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">item_ids</span><span class="p">)</span>
        
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Index now contains </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="n">ntotal</span><span class="si">}</span><span class="s"> items</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">search</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">query_embedding</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">ef_search</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Search for k nearest neighbors
        
        Args:
            query_embedding: numpy array of shape (dimension,) or (1, dimension)
            k: Number of neighbors to return
            ef_search: Size of dynamic candidate list during search (higher = more accurate, slower)
        
        Returns:
            item_ids: List of k item IDs
            distances: List of k distances
        </span><span class="sh">"""</span>
        <span class="c1"># Set search parameter
</span>        <span class="n">self</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="n">hnsw</span><span class="p">.</span><span class="n">efSearch</span> <span class="o">=</span> <span class="n">ef_search</span>
        
        <span class="c1"># Reshape query
</span>        <span class="k">if</span> <span class="n">query_embedding</span><span class="p">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">query_embedding</span> <span class="o">=</span> <span class="n">query_embedding</span><span class="p">.</span><span class="nf">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="n">query_embedding</span> <span class="o">=</span> <span class="n">query_embedding</span><span class="p">.</span><span class="nf">astype</span><span class="p">(</span><span class="sh">'</span><span class="s">float32</span><span class="sh">'</span><span class="p">)</span>
        
        <span class="c1"># Search
</span>        <span class="n">distances</span><span class="p">,</span> <span class="n">indices</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">query_embedding</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
        
        <span class="c1"># Map indices to item IDs
</span>        <span class="n">item_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">item_ids</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        
        <span class="k">return</span> <span class="n">item_ids</span><span class="p">,</span> <span class="n">distances</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Save index to disk</span><span class="sh">"""</span>
        <span class="n">faiss</span><span class="p">.</span><span class="nf">write_index</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">index</span><span class="p">,</span> <span class="n">filepath</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Load index from disk</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">faiss</span><span class="p">.</span><span class="nf">read_index</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>

<span class="c1"># Usage
</span><span class="n">index</span> <span class="o">=</span> <span class="nc">HNSWIndex</span><span class="p">(</span><span class="n">dimension</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">M</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">ef_construction</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>

<span class="c1"># Build index offline
</span><span class="n">item_embeddings</span> <span class="o">=</span> <span class="nf">get_all_item_embeddings</span><span class="p">()</span>  <span class="c1"># Shape: (10M, 128)
</span><span class="n">item_ids</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">range</span><span class="p">(</span><span class="mi">10_000_000</span><span class="p">))</span>
<span class="n">index</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">item_ids</span><span class="p">,</span> <span class="n">item_embeddings</span><span class="p">)</span>
<span class="n">index</span><span class="p">.</span><span class="nf">save</span><span class="p">(</span><span class="sh">"</span><span class="s">item_index.faiss</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># Search online
</span><span class="n">user_embedding</span> <span class="o">=</span> <span class="nf">get_user_embedding</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>  <span class="c1"># Shape: (128,)
</span><span class="n">candidate_ids</span><span class="p">,</span> <span class="n">distances</span> <span class="o">=</span> <span class="n">index</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">user_embedding</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">ef_search</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="c1"># ~20ms for 10M items!
</span></code></pre></div></div>

<h3 id="parameter-tuning">Parameter Tuning</h3>

<p><strong>Build-time parameters (offline):</strong></p>

<table>
  <thead>
    <tr>
      <th>Parameter</th>
      <th>Effect</th>
      <th>Recommendation</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>M</td>
      <td>Connections per node</td>
      <td>16-64 (32 is good default)</td>
    </tr>
    <tr>
      <td>ef_construction</td>
      <td>Build quality</td>
      <td>200-400 for production</td>
    </tr>
  </tbody>
</table>

<p><strong>Search-time parameters (online):</strong></p>

<table>
  <thead>
    <tr>
      <th>Parameter</th>
      <th>Effect</th>
      <th>Recommendation</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>ef_search</td>
      <td>Search quality</td>
      <td>1.5-2× k for good recall</td>
    </tr>
  </tbody>
</table>

<p><strong>Tuning process:</strong></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">tune_ann_parameters</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">queries</span><span class="p">,</span> <span class="n">ground_truth</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    Find optimal ef_search that balances recall and latency
    </span><span class="sh">"""</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">ef_search</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">800</span><span class="p">]:</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="n">recalls</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">query</span><span class="p">,</span> <span class="n">truth</span> <span class="ow">in</span> <span class="nf">zip</span><span class="p">(</span><span class="n">queries</span><span class="p">,</span> <span class="n">ground_truth</span><span class="p">):</span>
            <span class="n">results_ids</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">index</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">ef_search</span><span class="o">=</span><span class="n">ef_search</span><span class="p">)</span>
            <span class="n">results_set</span> <span class="o">=</span> <span class="nf">set</span><span class="p">(</span><span class="n">results_ids</span><span class="p">)</span>
            <span class="n">truth_set</span> <span class="o">=</span> <span class="nf">set</span><span class="p">(</span><span class="n">truth</span><span class="p">)</span>
            <span class="n">recall</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">results_set</span> <span class="o">&amp;</span> <span class="n">truth_set</span><span class="p">)</span> <span class="o">/</span> <span class="nf">len</span><span class="p">(</span><span class="n">truth_set</span><span class="p">)</span>
            <span class="n">recalls</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">recall</span><span class="p">)</span>
        
        <span class="n">avg_recall</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">mean</span><span class="p">(</span><span class="n">recalls</span><span class="p">)</span>
        <span class="n">latency</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">/</span> <span class="nf">len</span><span class="p">(</span><span class="n">queries</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>  <span class="c1"># ms
</span>        
        <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
            <span class="sh">'</span><span class="s">ef_search</span><span class="sh">'</span><span class="p">:</span> <span class="n">ef_search</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">recall</span><span class="sh">'</span><span class="p">:</span> <span class="n">avg_recall</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">latency_ms</span><span class="sh">'</span><span class="p">:</span> <span class="n">latency</span>
        <span class="p">})</span>
        
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">ef_search=</span><span class="si">{</span><span class="n">ef_search</span><span class="si">}</span><span class="s">: recall=</span><span class="si">{</span><span class="n">avg_recall</span><span class="si">:</span><span class="p">.</span><span class="mi">3</span><span class="n">f</span><span class="si">}</span><span class="s">, latency=</span><span class="si">{</span><span class="n">latency</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s">ms</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">results</span>

<span class="c1"># Example output:
# ef_search=50:  recall=0.850, latency=12.3ms
# ef_search=100: recall=0.920, latency=18.7ms  ← Good balance
# ef_search=200: recall=0.960, latency=31.2ms
# ef_search=400: recall=0.985, latency=54.8ms  ← Diminishing returns
</span></code></pre></div></div>

<p><strong>Production choice:</strong> ef_search=100 gives 92% recall @ 20ms</p>

<h3 id="alternative-product-quantization">Alternative: Product Quantization</h3>

<p>For even larger scale, use <strong>product quantization</strong> to compress embeddings:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Reduce memory footprint: 128 floats (512 bytes) → 64 bytes
# 10M items: 5GB → 640MB
</span>
<span class="n">index</span> <span class="o">=</span> <span class="n">faiss</span><span class="p">.</span><span class="nc">IndexIVFPQ</span><span class="p">(</span>
    <span class="n">faiss</span><span class="p">.</span><span class="nc">IndexFlatL2</span><span class="p">(</span><span class="n">dimension</span><span class="p">),</span>
    <span class="n">dimension</span><span class="p">,</span>
    <span class="n">nlist</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>      <span class="c1"># Number of clusters
</span>    <span class="n">M</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>            <span class="c1"># Number of subquantizers
</span>    <span class="n">nbits</span><span class="o">=</span><span class="mi">8</span>          <span class="c1"># Bits per subquantizer
</span><span class="p">)</span>

<span class="c1"># Train quantizer
</span><span class="n">index</span><span class="p">.</span><span class="nf">train</span><span class="p">(</span><span class="n">training_embeddings</span><span class="p">)</span>

<span class="c1"># Add items
</span><span class="n">index</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">item_embeddings</span><span class="p">)</span>

<span class="c1"># Search (slightly less accurate, much more memory-efficient)
</span><span class="n">distances</span><span class="p">,</span> <span class="n">indices</span> <span class="o">=</span> <span class="n">index</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>
</code></pre></div></div>

<hr />

<h2 id="core-component-3-multiple-retrieval-strategies">Core Component 3: Multiple Retrieval Strategies</h2>

<p>Relying on a single retrieval method limits quality. <strong>Diversify sources:</strong></p>

<h3 id="strategy-1-collaborative-filtering-40-of-candidates">Strategy 1: Collaborative Filtering (40% of candidates)</h3>

<p><strong>Idea:</strong> “Users who liked X also liked Y”</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">collaborative_filtering_retrieval</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">400</span><span class="p">):</span>
    <span class="c1"># Get user embedding
</span>    <span class="n">user_emb</span> <span class="o">=</span> <span class="nf">get_user_embedding</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
    
    <span class="c1"># ANN search in item embedding space
</span>    <span class="n">candidate_ids</span> <span class="o">=</span> <span class="n">ann_index</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">user_emb</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">candidate_ids</span>
</code></pre></div></div>

<p><strong>Pros:</strong></p>
<ul>
  <li>Captures implicit patterns</li>
  <li>Discovers non-obvious connections</li>
  <li>Scales well with data</li>
</ul>

<p><strong>Cons:</strong></p>
<ul>
  <li>Cold start for new users/items</li>
  <li>Popularity bias (recommends popular items disproportionately)</li>
</ul>

<h3 id="strategy-2-content-based-filtering-30-of-candidates">Strategy 2: Content-Based Filtering (30% of candidates)</h3>

<p><strong>Idea:</strong> Recommend items similar to what user liked before</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">content_based_retrieval</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">300</span><span class="p">):</span>
    <span class="c1"># Get user's liked items
</span>    <span class="n">liked_items</span> <span class="o">=</span> <span class="nf">get_user_history</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
    
    <span class="c1"># For each liked item, find similar items
</span>    <span class="n">candidates</span> <span class="o">=</span> <span class="nf">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">item_id</span> <span class="ow">in</span> <span class="n">liked_items</span><span class="p">:</span>
        <span class="c1"># Find items with similar tags, categories, creators
</span>        <span class="n">similar</span> <span class="o">=</span> <span class="nf">find_similar_content</span><span class="p">(</span><span class="n">item_id</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">candidates</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">similar</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">candidates</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">k</span><span class="p">:</span>
            <span class="k">break</span>
    
    <span class="k">return</span> <span class="nf">list</span><span class="p">(</span><span class="n">candidates</span><span class="p">)[:</span><span class="n">k</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">find_similar_content</span><span class="p">(</span><span class="n">item_id</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">item</span> <span class="o">=</span> <span class="nf">get_item</span><span class="p">(</span><span class="n">item_id</span><span class="p">)</span>
    
    <span class="c1"># Match by tags
</span>    <span class="n">similar_by_tags</span> <span class="o">=</span> <span class="nf">query_database</span><span class="p">(</span>
        <span class="sa">f</span><span class="sh">"</span><span class="s">SELECT item_id FROM items WHERE tags &amp;&amp; </span><span class="si">{</span><span class="n">item</span><span class="p">.</span><span class="n">tags</span><span class="si">}</span><span class="s"> ORDER BY similarity DESC LIMIT </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="sh">"</span>
    <span class="p">)</span>
    
    <span class="k">return</span> <span class="n">similar_by_tags</span>
</code></pre></div></div>

<p><strong>Pros:</strong></p>
<ul>
  <li>Explainable (“because you liked X”)</li>
  <li>Works for new users with stated preferences</li>
  <li>No popularity bias</li>
</ul>

<p><strong>Cons:</strong></p>
<ul>
  <li>Limited discovery (filter bubble)</li>
  <li>Requires good item metadata</li>
  <li>May over-specialize</li>
</ul>

<h3 id="strategy-3-trending-20-of-candidates">Strategy 3: Trending (20% of candidates)</h3>

<p><strong>Idea:</strong> What’s popular right now</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">trending_retrieval</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">time_window_hours</span><span class="o">=</span><span class="mi">24</span><span class="p">):</span>
    <span class="c1"># Redis sorted set by engagement score
</span>    <span class="n">trending_items</span> <span class="o">=</span> <span class="n">redis</span><span class="p">.</span><span class="nf">zrevrange</span><span class="p">(</span>
        <span class="sa">f</span><span class="sh">"</span><span class="s">trending:</span><span class="si">{</span><span class="n">time_window_hours</span><span class="si">}</span><span class="s">h</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">end</span><span class="o">=</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">withscores</span><span class="o">=</span><span class="bp">True</span>
    <span class="p">)</span>
    
    <span class="k">return</span> <span class="p">[</span><span class="n">item_id</span> <span class="k">for</span> <span class="n">item_id</span><span class="p">,</span> <span class="n">score</span> <span class="ow">in</span> <span class="n">trending_items</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">update_trending_scores</span><span class="p">():</span>
    <span class="sh">"""</span><span class="s">Background job runs every 5 minutes</span><span class="sh">"""</span>
    <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
    <span class="n">window</span> <span class="o">=</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">3600</span>  <span class="c1"># 24 hours
</span>    
    <span class="k">for</span> <span class="n">item_id</span><span class="p">,</span> <span class="n">engagement_data</span> <span class="ow">in</span> <span class="nf">recent_engagements</span><span class="p">():</span>
        <span class="c1"># Weighted by recency and engagement type
</span>        <span class="n">score</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">engagement_data</span><span class="p">[</span><span class="sh">'</span><span class="s">views</span><span class="sh">'</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.0</span> <span class="o">+</span>
            <span class="n">engagement_data</span><span class="p">[</span><span class="sh">'</span><span class="s">clicks</span><span class="sh">'</span><span class="p">]</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">+</span>
            <span class="n">engagement_data</span><span class="p">[</span><span class="sh">'</span><span class="s">likes</span><span class="sh">'</span><span class="p">]</span> <span class="o">*</span> <span class="mf">3.0</span> <span class="o">+</span>
            <span class="n">engagement_data</span><span class="p">[</span><span class="sh">'</span><span class="s">shares</span><span class="sh">'</span><span class="p">]</span> <span class="o">*</span> <span class="mf">5.0</span>
        <span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="p">.</span><span class="nf">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">engagement_data</span><span class="p">[</span><span class="sh">'</span><span class="s">timestamp</span><span class="sh">'</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="mi">6</span> <span class="o">*</span> <span class="mi">3600</span><span class="p">))</span>  <span class="c1"># Decay over 6 hours
</span>        
        <span class="n">redis</span><span class="p">.</span><span class="nf">zadd</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">trending:24h</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="n">item_id</span><span class="p">:</span> <span class="n">score</span><span class="p">})</span>
</code></pre></div></div>

<p><strong>Pros:</strong></p>
<ul>
  <li>Discovers viral content</li>
  <li>No cold start</li>
  <li>High CTR (users like trending items)</li>
</ul>

<p><strong>Cons:</strong></p>
<ul>
  <li>Same for all users (not personalized)</li>
  <li>Can amplify low-quality viral content</li>
  <li>Rich-get-richer effect</li>
</ul>

<h3 id="strategy-4-social-10-of-candidates">Strategy 4: Social (10% of candidates)</h3>

<p><strong>Idea:</strong> What are my friends engaging with</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">social_retrieval</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="c1"># Get user's friends
</span>    <span class="n">friends</span> <span class="o">=</span> <span class="nf">get_friends</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    
    <span class="c1"># Get their recent activity
</span>    <span class="n">recent_engagements</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">friend_id</span> <span class="ow">in</span> <span class="n">friends</span><span class="p">:</span>
        <span class="n">activities</span> <span class="o">=</span> <span class="nf">get_recent_activities</span><span class="p">(</span><span class="n">friend_id</span><span class="p">,</span> <span class="n">hours</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">activity</span> <span class="ow">in</span> <span class="n">activities</span><span class="p">:</span>
            <span class="n">item_id</span> <span class="o">=</span> <span class="n">activity</span><span class="p">[</span><span class="sh">'</span><span class="s">item_id</span><span class="sh">'</span><span class="p">]</span>
            <span class="n">recent_engagements</span><span class="p">[</span><span class="n">item_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">recent_engagements</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">item_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    
    <span class="c1"># Sort by frequency
</span>    <span class="n">sorted_items</span> <span class="o">=</span> <span class="nf">sorted</span><span class="p">(</span>
        <span class="n">recent_engagements</span><span class="p">.</span><span class="nf">items</span><span class="p">(),</span>
        <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span>
    <span class="p">)</span>
    
    <span class="k">return</span> <span class="p">[</span><span class="n">item_id</span> <span class="k">for</span> <span class="n">item_id</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">sorted_items</span><span class="p">[:</span><span class="n">k</span><span class="p">]]</span>
</code></pre></div></div>

<p><strong>Pros:</strong></p>
<ul>
  <li>Highly relevant (social proof)</li>
  <li>Encourages engagement/sharing</li>
  <li>Natural diversity</li>
</ul>

<p><strong>Cons:</strong></p>
<ul>
  <li>Requires social graph</li>
  <li>Privacy concerns</li>
  <li>Cold start for users with few friends</li>
</ul>

<h3 id="merging-strategies">Merging Strategies</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">retrieve_candidates</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">total_k</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
    <span class="c1"># Run all strategies in parallel
</span>    <span class="k">with</span> <span class="nc">ThreadPoolExecutor</span><span class="p">()</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
        <span class="n">cf_future</span> <span class="o">=</span> <span class="n">executor</span><span class="p">.</span><span class="nf">submit</span><span class="p">(</span><span class="n">collaborative_filtering_retrieval</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>
        <span class="n">cb_future</span> <span class="o">=</span> <span class="n">executor</span><span class="p">.</span><span class="nf">submit</span><span class="p">(</span><span class="n">content_based_retrieval</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
        <span class="n">tr_future</span> <span class="o">=</span> <span class="n">executor</span><span class="p">.</span><span class="nf">submit</span><span class="p">(</span><span class="n">trending_retrieval</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
        <span class="n">sc_future</span> <span class="o">=</span> <span class="n">executor</span><span class="p">.</span><span class="nf">submit</span><span class="p">(</span><span class="n">social_retrieval</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
        
        <span class="c1"># Wait for all to complete
</span>        <span class="n">cf_candidates</span> <span class="o">=</span> <span class="n">cf_future</span><span class="p">.</span><span class="nf">result</span><span class="p">()</span>
        <span class="n">cb_candidates</span> <span class="o">=</span> <span class="n">cb_future</span><span class="p">.</span><span class="nf">result</span><span class="p">()</span>
        <span class="n">tr_candidates</span> <span class="o">=</span> <span class="n">tr_future</span><span class="p">.</span><span class="nf">result</span><span class="p">()</span>
        <span class="n">sc_candidates</span> <span class="o">=</span> <span class="n">sc_future</span><span class="p">.</span><span class="nf">result</span><span class="p">()</span>
    
    <span class="c1"># Merge and deduplicate
</span>    <span class="n">all_candidates</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">seen</span> <span class="o">=</span> <span class="nf">set</span><span class="p">()</span>
    
    <span class="k">for</span> <span class="n">candidate</span> <span class="ow">in</span> <span class="n">cf_candidates</span> <span class="o">+</span> <span class="n">cb_candidates</span> <span class="o">+</span> <span class="n">tr_candidates</span> <span class="o">+</span> <span class="n">sc_candidates</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">candidate</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
            <span class="n">all_candidates</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">candidate</span><span class="p">)</span>
            <span class="n">seen</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">candidate</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">all_candidates</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">total_k</span><span class="p">:</span>
            <span class="k">break</span>
    
    <span class="k">return</span> <span class="n">all_candidates</span>
</code></pre></div></div>

<p><strong>Weighting sources:</strong>
Instead of fixed counts, use probability-based sampling:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">weighted_merge</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">total_k</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    sources: {
        </span><span class="sh">'</span><span class="s">cf</span><span class="sh">'</span><span class="s">: [item1, item2, ...],
        </span><span class="sh">'</span><span class="s">cb</span><span class="sh">'</span><span class="s">: [item3, item4, ...],
</span><span class="gp">        ...</span>
    <span class="p">}</span>
    <span class="n">weights</span><span class="p">:</span> <span class="p">{</span><span class="sh">'</span><span class="s">cf</span><span class="sh">'</span><span class="p">:</span> <span class="mf">0.4</span><span class="p">,</span> <span class="sh">'</span><span class="s">cb</span><span class="sh">'</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span> <span class="sh">'</span><span class="s">tr</span><span class="sh">'</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span> <span class="sh">'</span><span class="s">sc</span><span class="sh">'</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">}</span>
    <span class="sh">"""</span>
    <span class="n">merged</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">seen</span> <span class="o">=</span> <span class="nf">set</span><span class="p">()</span>
    
    <span class="c1"># For each position, sample a source based on weights
</span>    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">total_k</span> <span class="o">*</span> <span class="mi">2</span><span class="p">):</span>  <span class="c1"># Oversample to account for duplicates
</span>        <span class="c1"># Sample source
</span>        <span class="n">source</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">choice</span><span class="p">(</span>
            <span class="nf">list</span><span class="p">(</span><span class="n">weights</span><span class="p">.</span><span class="nf">keys</span><span class="p">()),</span>
            <span class="n">p</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span><span class="n">weights</span><span class="p">.</span><span class="nf">values</span><span class="p">())</span>
        <span class="p">)</span>
        
        <span class="c1"># Pop next item from that source
</span>        <span class="k">if</span> <span class="n">sources</span><span class="p">[</span><span class="n">source</span><span class="p">]:</span>
            <span class="n">item</span> <span class="o">=</span> <span class="n">sources</span><span class="p">[</span><span class="n">source</span><span class="p">].</span><span class="nf">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">item</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                <span class="n">merged</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="n">seen</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">merged</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">total_k</span><span class="p">:</span>
            <span class="k">break</span>
    
    <span class="k">return</span> <span class="n">merged</span>
</code></pre></div></div>

<hr />

<h2 id="core-component-4-caching-strategy">Core Component 4: Caching Strategy</h2>

<p>To achieve &lt; 50ms latency, aggressive caching is essential.</p>

<h3 id="three-level-cache-architecture">Three-Level Cache Architecture</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Request
  ↓
L1: Candidate Cache (Redis, TTL=5min)
  ├─ Hit → Return cached candidates (5ms)
  └─ Miss ↓
L2: User Embedding Cache (Redis, TTL=1hour)
  ├─ Hit → Skip embedding computation (3ms saved)
  └─ Miss ↓
L3: Precomputed Candidates (Redis, TTL=10min, top 10% users only)
  ├─ Hit → Return precomputed (2ms)
  └─ Miss → Full computation (40ms)
</code></pre></div></div>

<h3 id="implementation">Implementation</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">CandidateCache</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">redis_client</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">redis</span> <span class="o">=</span> <span class="n">redis_client</span>
        
        <span class="c1"># TTLs
</span>        <span class="n">self</span><span class="p">.</span><span class="n">candidate_ttl</span> <span class="o">=</span> <span class="mi">300</span>  <span class="c1"># 5 minutes
</span>        <span class="n">self</span><span class="p">.</span><span class="n">embedding_ttl</span> <span class="o">=</span> <span class="mi">3600</span>  <span class="c1"># 1 hour
</span>        <span class="n">self</span><span class="p">.</span><span class="n">precomputed_ttl</span> <span class="o">=</span> <span class="mi">600</span>  <span class="c1"># 10 minutes
</span>    
    <span class="k">def</span> <span class="nf">get_candidates</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Try L1 → L2 → L3 → Compute
        </span><span class="sh">"""</span>
        <span class="c1"># L1: Candidate cache
</span>        <span class="n">cache_key</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">candidates:</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="sh">"</span>
        <span class="n">cached</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">redis</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cached</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[L1 HIT] Returning cached candidates</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">cached</span><span class="p">)</span>
        
        <span class="c1"># L2: Embedding cache
</span>        <span class="n">emb_key</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">user_emb:</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="sh">"</span>
        <span class="n">user_emb_cached</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">redis</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">emb_key</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">user_emb_cached</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[L2 HIT] Using cached embedding</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">user_emb</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">frombuffer</span><span class="p">(</span><span class="n">user_emb_cached</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[L2 MISS] Computing embedding</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">user_features</span> <span class="o">=</span> <span class="nf">get_user_features</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">user_emb</span> <span class="o">=</span> <span class="nf">compute_user_embedding</span><span class="p">(</span><span class="n">user_features</span><span class="p">)</span>
            <span class="c1"># Cache embedding
</span>            <span class="n">self</span><span class="p">.</span><span class="n">redis</span><span class="p">.</span><span class="nf">setex</span><span class="p">(</span><span class="n">emb_key</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">embedding_ttl</span><span class="p">,</span> <span class="n">user_emb</span><span class="p">.</span><span class="nf">tobytes</span><span class="p">())</span>
        
        <span class="c1"># Retrieve candidates
</span>        <span class="n">candidates</span> <span class="o">=</span> <span class="nf">retrieve_candidates_with_embedding</span><span class="p">(</span><span class="n">user_emb</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
        
        <span class="c1"># Cache candidates
</span>        <span class="n">self</span><span class="p">.</span><span class="n">redis</span><span class="p">.</span><span class="nf">setex</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">candidate_ttl</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">candidates</span><span class="p">))</span>
        
        <span class="k">return</span> <span class="n">candidates</span>
    
    <span class="k">def</span> <span class="nf">precompute_for_active_users</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">user_ids</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Background job: precompute candidates for top 10% active users
        Runs every 10 minutes
        </span><span class="sh">"""</span>
        <span class="k">for</span> <span class="n">user_id</span> <span class="ow">in</span> <span class="n">user_ids</span><span class="p">:</span>
            <span class="n">candidates</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">get_candidates</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            
            <span class="n">precomp_key</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">precomputed:</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="sh">"</span>
            <span class="n">self</span><span class="p">.</span><span class="n">redis</span><span class="p">.</span><span class="nf">setex</span><span class="p">(</span>
                <span class="n">precomp_key</span><span class="p">,</span>
                <span class="n">self</span><span class="p">.</span><span class="n">precomputed_ttl</span><span class="p">,</span>
                <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">candidates</span><span class="p">)</span>
            <span class="p">)</span>
        
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Precomputed candidates for </span><span class="si">{</span><span class="nf">len</span><span class="p">(</span><span class="n">user_ids</span><span class="p">)</span><span class="si">}</span><span class="s"> active users</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="cache-warming-strategy">Cache Warming Strategy</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">identify_active_users</span><span class="p">(</span><span class="n">lookback_hours</span><span class="o">=</span><span class="mi">24</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    Find top 10% active users for precomputation
    </span><span class="sh">"""</span>
    <span class="c1"># Query analytics database
</span>    <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"""</span><span class="s">
    SELECT user_id, COUNT(*) as activity_count
    FROM user_activities
    WHERE timestamp &gt; NOW() - INTERVAL </span><span class="sh">'</span><span class="si">{</span><span class="n">lookback_hours</span><span class="si">}</span><span class="sh">'</span><span class="s"> HOUR
    GROUP BY user_id
    ORDER BY activity_count DESC
    LIMIT </span><span class="si">{</span><span class="nf">int</span><span class="p">(</span><span class="n">total_users</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">)</span><span class="si">}</span><span class="s">
    </span><span class="sh">"""</span>
    
    <span class="n">active_users</span> <span class="o">=</span> <span class="nf">execute_query</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="sh">'</span><span class="s">user_id</span><span class="sh">'</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">active_users</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">warm_cache_scheduler</span><span class="p">():</span>
    <span class="sh">"""</span><span class="s">
    Runs every 10 minutes
    </span><span class="sh">"""</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">active_users</span> <span class="o">=</span> <span class="nf">identify_active_users</span><span class="p">()</span>
        <span class="n">cache</span><span class="p">.</span><span class="nf">precompute_for_active_users</span><span class="p">(</span><span class="n">active_users</span><span class="p">)</span>
        
        <span class="n">time</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mi">600</span><span class="p">)</span>  <span class="c1"># 10 minutes
</span></code></pre></div></div>

<h3 id="cache-invalidation">Cache Invalidation</h3>

<p><strong>Problem:</strong> When should we invalidate cached candidates?</p>

<p><strong>Triggers:</strong></p>
<ol>
  <li><strong>User action:</strong> User engages with item → invalidate their candidates</li>
  <li><strong>Time-based:</strong> Fixed TTL (5 minutes)</li>
  <li><strong>New item published:</strong> Invalidate trending cache</li>
  <li><strong>Model update:</strong> Invalidate all embeddings and candidates</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">on_user_engagement</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">item_id</span><span class="p">,</span> <span class="n">action</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    Called when user clicks/likes/shares item
    </span><span class="sh">"""</span>
    <span class="c1"># Invalidate candidate cache (stale now)
</span>    <span class="c1"># Redis DEL does not support globs; use SCAN + DEL for safety
</span>    <span class="n">cursor</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">pattern</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">candidates:</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s">:*</span><span class="sh">"</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">cursor</span><span class="p">,</span> <span class="n">keys</span> <span class="o">=</span> <span class="n">redis</span><span class="p">.</span><span class="nf">scan</span><span class="p">(</span><span class="n">cursor</span><span class="o">=</span><span class="n">cursor</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="n">pattern</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">keys</span><span class="p">:</span>
            <span class="n">redis</span><span class="p">.</span><span class="nf">delete</span><span class="p">(</span><span class="o">*</span><span class="n">keys</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cursor</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">break</span>
    
    <span class="c1"># Don't invalidate embedding cache (more stable)
</span>    <span class="c1"># Will naturally expire after 1 hour
</span>    
    <span class="c1"># Log event for retraining
</span>    <span class="nf">log_engagement_event</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">item_id</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="cache-hit-rate-monitoring">Cache Hit Rate Monitoring</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">CacheMetrics</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">hits</span> <span class="o">=</span> <span class="p">{</span><span class="sh">'</span><span class="s">L1</span><span class="sh">'</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="sh">'</span><span class="s">L2</span><span class="sh">'</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="sh">'</span><span class="s">L3</span><span class="sh">'</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">misses</span> <span class="o">=</span> <span class="p">{</span><span class="sh">'</span><span class="s">L1</span><span class="sh">'</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="sh">'</span><span class="s">L2</span><span class="sh">'</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="sh">'</span><span class="s">L3</span><span class="sh">'</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">record_hit</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">level</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">hits</span><span class="p">[</span><span class="n">level</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
    
    <span class="k">def</span> <span class="nf">record_miss</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">level</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">misses</span><span class="p">[</span><span class="n">level</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
    
    <span class="k">def</span> <span class="nf">get_stats</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">level</span> <span class="ow">in</span> <span class="p">[</span><span class="sh">'</span><span class="s">L1</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">L2</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">L3</span><span class="sh">'</span><span class="p">]:</span>
            <span class="n">total</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">hits</span><span class="p">[</span><span class="n">level</span><span class="p">]</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">misses</span><span class="p">[</span><span class="n">level</span><span class="p">]</span>
            <span class="n">hit_rate</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">hits</span><span class="p">[</span><span class="n">level</span><span class="p">]</span> <span class="o">/</span> <span class="n">total</span> <span class="k">if</span> <span class="n">total</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">stats</span><span class="p">[</span><span class="n">level</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">'</span><span class="s">hit_rate</span><span class="sh">'</span><span class="p">:</span> <span class="n">hit_rate</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">hits</span><span class="sh">'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">hits</span><span class="p">[</span><span class="n">level</span><span class="p">],</span>
                <span class="sh">'</span><span class="s">misses</span><span class="sh">'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">misses</span><span class="p">[</span><span class="n">level</span><span class="p">]</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="n">stats</span>

<span class="c1"># Expected hit rates:
# L1 (candidates): 60-70% (users refresh feed multiple times)
# L2 (embeddings): 80-90% (embeddings stable for ~1 hour)
# L3 (precomputed): 10-15% (only for top 10% users)
</span></code></pre></div></div>

<hr />

<h2 id="handling-cold-start">Handling Cold Start</h2>

<h3 id="new-user-problem">New User Problem</h3>

<p><strong>Challenge:</strong> User with no history → no personalization signals</p>

<p><strong>Solution Hierarchy:</strong></p>

<p><strong>Level 1: Onboarding Survey</strong></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">handle_new_user_onboarding</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">selected_interests</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    User selects 3-5 interests during signup
    </span><span class="sh">"""</span>
    <span class="c1"># Map interests to item tags
</span>    <span class="n">interest_tags</span> <span class="o">=</span> <span class="nf">map_interests_to_tags</span><span class="p">(</span><span class="n">selected_interests</span><span class="p">)</span>
    
    <span class="c1"># Find items matching these tags
</span>    <span class="n">candidates</span> <span class="o">=</span> <span class="nf">query_items_by_tags</span><span class="p">(</span><span class="n">interest_tags</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
    
    <span class="c1"># Cache for fast retrieval
</span>    <span class="n">redis</span><span class="p">.</span><span class="nf">setex</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">new_user_candidates:</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="mi">3600</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">candidates</span><span class="p">))</span>
    
    <span class="k">return</span> <span class="n">candidates</span>
</code></pre></div></div>

<p><strong>Level 2: Demographic-based Defaults</strong></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_demographic_defaults</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="nf">get_user_profile</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
    
    <span class="c1"># Lookup popular items for this demographic
</span>    <span class="n">cache_key</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">popular_items:</span><span class="si">{</span><span class="n">user</span><span class="p">.</span><span class="n">age_group</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">user</span><span class="p">.</span><span class="n">location</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">user</span><span class="p">.</span><span class="n">language</span><span class="si">}</span><span class="sh">"</span>
    
    <span class="n">cached</span> <span class="o">=</span> <span class="n">redis</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cached</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">cached</span><span class="p">)</span>
    
    <span class="c1"># Query most popular items for similar users
</span>    <span class="n">popular</span> <span class="o">=</span> <span class="nf">query_popular_items</span><span class="p">(</span>
        <span class="n">age_group</span><span class="o">=</span><span class="n">user</span><span class="p">.</span><span class="n">age_group</span><span class="p">,</span>
        <span class="n">location</span><span class="o">=</span><span class="n">user</span><span class="p">.</span><span class="n">location</span><span class="p">,</span>
        <span class="n">language</span><span class="o">=</span><span class="n">user</span><span class="p">.</span><span class="n">language</span><span class="p">,</span>
        <span class="n">k</span><span class="o">=</span><span class="mi">1000</span>
    <span class="p">)</span>
    
    <span class="n">redis</span><span class="p">.</span><span class="nf">setex</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="mi">3600</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">popular</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">popular</span>
</code></pre></div></div>

<p><strong>Level 3: Explore-Heavy Mix</strong></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">new_user_retrieval</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    For new users, use more exploration
    </span><span class="sh">"""</span>
    <span class="c1"># 50% popular items (safe choices)
</span>    <span class="n">popular</span> <span class="o">=</span> <span class="nf">get_popular_items</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
    
    <span class="c1"># 30% based on stated interests
</span>    <span class="n">interests</span> <span class="o">=</span> <span class="nf">get_user_interests</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
    <span class="n">interest_based</span> <span class="o">=</span> <span class="nf">get_items_by_interests</span><span class="p">(</span><span class="n">interests</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
    
    <span class="c1"># 20% random exploration
</span>    <span class="n">random_items</span> <span class="o">=</span> <span class="nf">sample_random_items</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="nf">merge_and_shuffle</span><span class="p">(</span><span class="n">popular</span><span class="p">,</span> <span class="n">interest_based</span><span class="p">,</span> <span class="n">random_items</span><span class="p">)</span>
</code></pre></div></div>

<p><strong>Rapid Learning:</strong></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">update_new_user_preferences</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">engagement</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    Weight early engagements heavily to quickly build profile
    </span><span class="sh">"""</span>
    <span class="n">engagement_count</span> <span class="o">=</span> <span class="nf">get_engagement_count</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">engagement_count</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
        <span class="c1"># First 10 engagements: 5x weight
</span>        <span class="n">weight</span> <span class="o">=</span> <span class="mf">5.0</span>
    <span class="k">elif</span> <span class="n">engagement_count</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">:</span>
        <span class="c1"># Next 40 engagements: 2x weight
</span>        <span class="n">weight</span> <span class="o">=</span> <span class="mf">2.0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Normal weight
</span>        <span class="n">weight</span> <span class="o">=</span> <span class="mf">1.0</span>
    
    <span class="nf">update_user_profile</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">engagement</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="n">weight</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="new-item-problem">New Item Problem</h3>

<p><strong>Challenge:</strong> Item with no engagement history → no collaborative signal</p>

<p><strong>Solution 1: Content-Based Features</strong></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_new_item_candidates_for_users</span><span class="p">(</span><span class="n">item_id</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    Find users who might like this new item based on content
    </span><span class="sh">"""</span>
    <span class="n">item</span> <span class="o">=</span> <span class="nf">get_item</span><span class="p">(</span><span class="n">item_id</span><span class="p">)</span>
    
    <span class="c1"># Extract content features
</span>    <span class="n">tags</span> <span class="o">=</span> <span class="n">item</span><span class="p">.</span><span class="n">tags</span>
    <span class="n">category</span> <span class="o">=</span> <span class="n">item</span><span class="p">.</span><span class="n">category</span>
    <span class="n">creator</span> <span class="o">=</span> <span class="n">item</span><span class="p">.</span><span class="n">creator_id</span>
    
    <span class="c1"># Find users interested in these features
</span>    <span class="n">candidate_users</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="c1"># Users who liked similar tags
</span>    <span class="n">candidate_users</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span>
        <span class="nf">get_users_by_tag_preferences</span><span class="p">(</span><span class="n">tags</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>
    <span class="p">)</span>
    
    <span class="c1"># Users who follow this creator
</span>    <span class="n">candidate_users</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span>
        <span class="nf">get_creator_followers</span><span class="p">(</span><span class="n">creator</span><span class="p">)</span>
    <span class="p">)</span>
    
    <span class="k">return</span> <span class="nf">list</span><span class="p">(</span><span class="nf">set</span><span class="p">(</span><span class="n">candidate_users</span><span class="p">))</span>
</code></pre></div></div>

<p><strong>Solution 2: Small-Scale Exploration</strong></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">bootstrap_new_item</span><span class="p">(</span><span class="n">item_id</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    Show new item to small random sample to gather initial signals
    </span><span class="sh">"""</span>
    <span class="c1"># Sample 1% of users randomly
</span>    <span class="n">sample_size</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">total_users</span> <span class="o">*</span> <span class="mf">0.01</span><span class="p">)</span>
    <span class="n">sampled_users</span> <span class="o">=</span> <span class="n">random</span><span class="p">.</span><span class="nf">sample</span><span class="p">(</span><span class="n">all_users</span><span class="p">,</span> <span class="n">sample_size</span><span class="p">)</span>
    
    <span class="c1"># Add this item to their candidate pools with high position
</span>    <span class="k">for</span> <span class="n">user_id</span> <span class="ow">in</span> <span class="n">sampled_users</span><span class="p">:</span>
        <span class="nf">inject_item_into_candidates</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">item_id</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
    
    <span class="c1"># Monitor for 1 hour
</span>    <span class="c1"># If engagement rate &gt; threshold, continue showing
</span>    <span class="c1"># If engagement rate &lt; threshold, reduce exposure
</span></code></pre></div></div>

<p><strong>Solution 3: Multi-Armed Bandit</strong></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ThompsonSamplingBandit</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Balance exploration (new items) vs exploitation (proven items)
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">successes</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># item_id -&gt; success count
</span>        <span class="n">self</span><span class="p">.</span><span class="n">failures</span> <span class="o">=</span> <span class="p">{}</span>   <span class="c1"># item_id -&gt; failure count
</span>    
    <span class="k">def</span> <span class="nf">select_item</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">candidate_items</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Sample items based on estimated CTR with uncertainty
        </span><span class="sh">"""</span>
        <span class="n">selected</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">item_id</span> <span class="ow">in</span> <span class="n">candidate_items</span><span class="p">:</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">successes</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">item_id</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># Prior: 1 success
</span>            <span class="n">beta</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">failures</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">item_id</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>     <span class="c1"># Prior: 1 failure
</span>            
            <span class="c1"># Sample from Beta distribution
</span>            <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">beta</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">)</span>
            
            <span class="n">selected</span><span class="p">.</span><span class="nf">append</span><span class="p">((</span><span class="n">item_id</span><span class="p">,</span> <span class="n">theta</span><span class="p">))</span>
        
        <span class="c1"># Sort by sampled theta and return top k
</span>        <span class="n">selected</span><span class="p">.</span><span class="nf">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">item_id</span> <span class="k">for</span> <span class="n">item_id</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">selected</span><span class="p">[:</span><span class="n">k</span><span class="p">]]</span>
    
    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">item_id</span><span class="p">,</span> <span class="n">success</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Update counts after showing item
        </span><span class="sh">"""</span>
        <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">successes</span><span class="p">[</span><span class="n">item_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">successes</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">item_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">failures</span><span class="p">[</span><span class="n">item_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">failures</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">item_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
</code></pre></div></div>

<hr />

<h2 id="real-world-examples">Real-World Examples</h2>

<h3 id="youtube-recommendations">YouTube Recommendations</h3>

<p><strong>Architecture (circa 2016):</strong></p>
<ul>
  <li>Two-stage: Candidate generation → Ranking</li>
  <li>Candidate generation: Deep neural network with collaborative filtering</li>
  <li>Features: Watch history, search history, demographics</li>
  <li>800k candidates → Hundreds for ranking</li>
  <li>Uses TensorFlow for training</li>
</ul>

<p><strong>Key innovations:</strong></p>
<ul>
  <li>“Example age” feature (prefer fresh content)</li>
  <li>Normalized watch time (account for video length)</li>
  <li>Asymmetric co-watch (A→B doesn’t mean B→A)</li>
</ul>

<h3 id="pinterest-pinsage">Pinterest (PinSage)</h3>

<p><strong>Architecture:</strong></p>
<ul>
  <li>Graph neural network (GNN) on Pin-Board graph</li>
  <li>3 billion nodes, 18 billion edges</li>
  <li>Random walk sampling for neighborhoods</li>
  <li>Two-tower model: Pin embeddings, User embeddings</li>
  <li>Production deployment on GPUs</li>
</ul>

<p><strong>Key innovations:</strong></p>
<ul>
  <li>Importance pooling (weight neighbors by importance)</li>
  <li>Hard negative sampling (visually similar but topically different)</li>
  <li>Multi-task learning (save, click, hide)</li>
</ul>

<h3 id="spotify-recommendations">Spotify Recommendations</h3>

<p><strong>Architecture:</strong></p>
<ul>
  <li>Collaborative filtering (matrix factorization)</li>
  <li>Content-based (audio features via CNNs)</li>
  <li>Natural language processing (playlist names, song metadata)</li>
  <li>Reinforcement learning (sequential recommendations)</li>
</ul>

<p><strong>Key innovations:</strong></p>
<ul>
  <li>Audio embedding from raw waveforms</li>
  <li>Contextual bandits for playlist curation</li>
  <li>Session-based recommendations</li>
</ul>

<hr />

<h2 id="monitoring-and-evaluation">Monitoring and Evaluation</h2>

<h3 id="online-metrics">Online Metrics</h3>

<p><strong>User Engagement:</strong></p>
<ul>
  <li>Click-through rate (CTR)</li>
  <li>Watch time / Dwell time</li>
  <li>Like / Share rate</li>
  <li>Session length</li>
  <li>Return rate (DAU / MAU)</li>
</ul>

<p><strong>Diversity Metrics:</strong></p>
<ul>
  <li>Intra-list diversity (avg pairwise distance)</li>
  <li>Coverage (% of catalog recommended)</li>
  <li>Concentration (Gini coefficient)</li>
</ul>

<p><strong>System Metrics:</strong></p>
<ul>
  <li>Candidate generation latency (p50, p95, p99)</li>
  <li>Cache hit rates (L1, L2, L3)</li>
  <li>ANN recall@k</li>
  <li>QPS per server</li>
</ul>

<h3 id="offline-metrics">Offline Metrics</h3>

<p><strong>Retrieval Quality:</strong></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">evaluate_retrieval</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">test_set</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    Evaluate on held-out test set
    </span><span class="sh">"""</span>
    <span class="n">recalls</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">precisions</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">ground_truth_items</span> <span class="ow">in</span> <span class="n">test_set</span><span class="p">:</span>
        <span class="c1"># Generate candidates
</span>        <span class="n">candidates</span> <span class="o">=</span> <span class="nf">retrieve_candidates</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
        
        <span class="c1"># Recall: What % of ground truth items were retrieved?
</span>        <span class="n">recall</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="nf">set</span><span class="p">(</span><span class="n">candidates</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nf">set</span><span class="p">(</span><span class="n">ground_truth_items</span><span class="p">))</span> <span class="o">/</span> <span class="nf">len</span><span class="p">(</span><span class="n">ground_truth_items</span><span class="p">)</span>
        <span class="n">recalls</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">recall</span><span class="p">)</span>
        
        <span class="c1"># Precision: What % of candidates are relevant?
</span>        <span class="n">precision</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="nf">set</span><span class="p">(</span><span class="n">candidates</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nf">set</span><span class="p">(</span><span class="n">ground_truth_items</span><span class="p">))</span> <span class="o">/</span> <span class="nf">len</span><span class="p">(</span><span class="n">candidates</span><span class="p">)</span>
        <span class="n">precisions</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">precision</span><span class="p">)</span>
    
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Recall@1000: </span><span class="si">{</span><span class="n">np</span><span class="p">.</span><span class="nf">mean</span><span class="p">(</span><span class="n">recalls</span><span class="p">)</span><span class="si">:</span><span class="p">.</span><span class="mi">3</span><span class="n">f</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Precision@1000: </span><span class="si">{</span><span class="n">np</span><span class="p">.</span><span class="nf">mean</span><span class="p">(</span><span class="n">precisions</span><span class="p">)</span><span class="si">:</span><span class="p">.</span><span class="mi">3</span><span class="n">f</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<p><strong>Target: Recall@1000 &gt; 0.90</strong> (retrieve 90% of items user would engage with)</p>

<h3 id="ab-testing">A/B Testing</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ABExperiment</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">control_config</span><span class="p">,</span> <span class="n">treatment_config</span><span class="p">,</span> <span class="n">traffic_split</span><span class="o">=</span><span class="mf">0.05</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">self</span><span class="p">.</span><span class="n">control</span> <span class="o">=</span> <span class="n">control_config</span>
        <span class="n">self</span><span class="p">.</span><span class="n">treatment</span> <span class="o">=</span> <span class="n">treatment_config</span>
        <span class="n">self</span><span class="p">.</span><span class="n">traffic_split</span> <span class="o">=</span> <span class="n">traffic_split</span>
    
    <span class="k">def</span> <span class="nf">assign_variant</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Consistent hashing for stable assignment
        </span><span class="sh">"""</span>
        <span class="n">hash_val</span> <span class="o">=</span> <span class="n">hashlib</span><span class="p">.</span><span class="nf">md5</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">.</span><span class="nf">encode</span><span class="p">()).</span><span class="nf">hexdigest</span><span class="p">()</span>
        <span class="n">hash_int</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">hash_val</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
        
        <span class="nf">if </span><span class="p">(</span><span class="n">hash_int</span> <span class="o">%</span> <span class="mi">100</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">traffic_split</span> <span class="o">*</span> <span class="mi">100</span><span class="p">):</span>
            <span class="k">return</span> <span class="sh">'</span><span class="s">treatment</span><span class="sh">'</span>
        <span class="k">return</span> <span class="sh">'</span><span class="s">control</span><span class="sh">'</span>
    
    <span class="k">def</span> <span class="nf">get_config</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
        <span class="n">variant</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">assign_variant</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">treatment</span> <span class="k">if</span> <span class="n">variant</span> <span class="o">==</span> <span class="sh">'</span><span class="s">treatment</span><span class="sh">'</span> <span class="k">else</span> <span class="n">self</span><span class="p">.</span><span class="n">control</span>

<span class="c1"># Example: Test new retrieval mix
</span><span class="n">experiment</span> <span class="o">=</span> <span class="nc">ABExperiment</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">retrieval_mix_v2</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">control_config</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">cf</span><span class="sh">'</span><span class="p">:</span> <span class="mf">0.4</span><span class="p">,</span> <span class="sh">'</span><span class="s">cb</span><span class="sh">'</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span> <span class="sh">'</span><span class="s">tr</span><span class="sh">'</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span> <span class="sh">'</span><span class="s">sc</span><span class="sh">'</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
    <span class="n">treatment_config</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">cf</span><span class="sh">'</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="sh">'</span><span class="s">cb</span><span class="sh">'</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span> <span class="sh">'</span><span class="s">tr</span><span class="sh">'</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span> <span class="sh">'</span><span class="s">sc</span><span class="sh">'</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>  <span class="c1"># More CF, less CB
</span>    <span class="n">traffic_split</span><span class="o">=</span><span class="mf">0.05</span>  <span class="c1"># 5% treatment, 95% control
</span><span class="p">)</span>

<span class="c1"># Usage
</span><span class="n">config</span> <span class="o">=</span> <span class="n">experiment</span><span class="p">.</span><span class="nf">get_config</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
<span class="n">candidates</span> <span class="o">=</span> <span class="nf">retrieve_with_mix</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>

<span class="c1"># Measure:
# - CTR improvement: +2.3% ✓
# - Diversity: -1.2% (acceptable)
# - Latency: No change
# Decision: Ship to 100%
</span></code></pre></div></div>

<hr />

<h2 id="key-takeaways">Key Takeaways</h2>

<p>✅ <strong>Funnel architecture</strong> (millions → thousands → dozens) is essential for scale<br />
✅ <strong>Two-tower models</strong> decouple user/item embeddings for efficient retrieval<br />
✅ <strong>ANN search</strong> (HNSW, ScaNN) provides 95%+ recall @ 20ms vs 1000ms exact search<br />
✅ <strong>Multiple retrieval strategies</strong> (CF, content, trending, social) improve diversity<br />
✅ <strong>Aggressive caching</strong> (3-level) achieves sub-50ms latency<br />
✅ <strong>Cold start</strong> requires explicit strategies (onboarding, demographics, exploration)<br />
✅ <strong>Monitoring</strong> both online metrics (CTR, diversity) and offline metrics (recall@k)</p>

<hr />

<h2 id="further-reading">Further Reading</h2>

<p><strong>Papers:</strong></p>
<ul>
  <li><a href="https://research.google/pubs/pub45530/">Deep Neural Networks for YouTube Recommendations</a></li>
  <li><a href="https://arxiv.org/abs/1806.01973">PinSage: Graph Convolutional Neural Networks</a></li>
  <li><a href="https://arxiv.org/abs/1603.09320">HNSW: Efficient and Robust Approximate Nearest Neighbor Search</a></li>
</ul>

<p><strong>Libraries:</strong></p>
<ul>
  <li><a href="https://github.com/facebookresearch/faiss">Faiss (Facebook)</a></li>
  <li><a href="https://github.com/google-research/google-research/tree/master/scann">ScaNN (Google)</a></li>
  <li><a href="https://github.com/spotify/annoy">Annoy (Spotify)</a></li>
</ul>

<p><strong>Books:</strong></p>
<ul>
  <li><em>Recommender Systems Handbook</em> (Ricci et al.)</li>
  <li><em>Practical Recommender Systems</em> (Kim Falk)</li>
</ul>

<p><strong>Courses:</strong></p>
<ul>
  <li><a href="http://web.stanford.edu/class/cs246/">Stanford CS246: Mining Massive Datasets</a></li>
  <li><a href="https://recsys.acm.org/">RecSys Conference Tutorials</a></li>
</ul>

<hr />

<h2 id="conclusion">Conclusion</h2>

<p>Recommendation systems are one of the most impactful applications of machine learning, directly affecting user experience for billions of people daily. The candidate generation stage is where the magic begins efficiently narrowing millions of possibilities to a manageable set of high-quality candidates.</p>

<p>The key insights:</p>
<ol>
  <li><strong>Embeddings</strong> capture semantic similarity in continuous space</li>
  <li><strong>ANN search</strong> makes similarity search practical at scale</li>
  <li><strong>Diversity</strong> in retrieval strategies prevents filter bubbles</li>
  <li><strong>Caching</strong> is not optional it’s essential for latency</li>
  <li><strong>Cold start</strong> requires thoughtful product and engineering solutions</li>
</ol>

<p>As you build recommendation systems, remember: the best system balances multiple objectives (relevance, diversity, freshness, serendipity) while maintaining the strict latency and cost constraints of production environments.</p>

<p>Now go build something that helps users discover content they’ll love! 🚀</p>

<hr />

<p><strong>Originally published at:</strong> <a href="https://www.arunbaby.com/ml-system-design/0001-recommendation-system/">arunbaby.com/ml-system-design/0001-recommendation-system</a></p>

<p><em>If you found this helpful, consider sharing it with others who might benefit.</em></p>

        
      </section>

      <footer class="page__meta">
        
        
  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      <a href="/tags/#embeddings" class="page__taxonomy-item p-category" rel="tag">embeddings</a><span class="sep">, </span>
    
      <a href="/tags/#recommendation-systems" class="page__taxonomy-item p-category" rel="tag">recommendation-systems</a><span class="sep">, </span>
    
      <a href="/tags/#retrieval" class="page__taxonomy-item p-category" rel="tag">retrieval</a>
    
    </span>
  </p>




  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      <a href="/categories/#ml-system-design" class="page__taxonomy-item p-category" rel="tag">ml-system-design</a>
    
    </span>
  </p>


        
      </footer>

      <div class="page__related page__related--full">
  <h2 class="page__related-title">Related across topics</h2>
  <style>
    /* Make section span full content width and use 2 equal columns */
    .page__related--full { float: inline-start; width: 100%; padding: 0; }
    .cross-related-grid { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 2rem; }
    @media (max-width: 768px) { .cross-related-grid { grid-template-columns: 1fr; } }
    /* Ensure archive cards stretch nicely in the grid */
    .cross-related-grid .list__item, .cross-related-grid .grid__item { width: auto; float: none; margin: 0; }
  </style>
  <div class="cross-related-grid">
    



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/dsa/0001-two-sum/" rel="permalink">Two Sum
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          27 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">The hash table trick that makes O(n²) become O(n) and why this pattern appears everywhere from feature stores to embedding lookups.
</p>
  </article>
</div>




<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/speech-tech/0001-streaming-asr/" rel="permalink">Streaming ASR Architecture
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          12 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Why batch ASR won’t work for voice assistants, and how streaming models transcribe speech as you speak in under 200ms.
</p>
  </article>
</div>

  </div>
</div>

      <section class="page__share">
  <h4 class="page__share-title">Share on</h4>

  <a href="https://twitter.com/intent/tweet?via=arunbaby0&text=Recommendation+System%3A+Candidate+Retrieval%20https%3A%2F%2Fwww.arunbaby.com%2Fml-system-design%2F0001-recommendation-system%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fwww.arunbaby.com%2Fml-system-design%2F0001-recommendation-system%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://www.arunbaby.com/ml-system-design/0001-recommendation-system/" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="#" class="pagination--pager disabled">Previous</a>
    
    
      <a href="/ml-system-design/0002-classification-pipeline/" class="pagination--pager" title="Classification Pipeline Design">Next</a>
    
  </nav>


    </div>

    
  </article>

  
  
</div>

      
    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';" role="search">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    
      
        
          <li><a href="https://twitter.com/arunbaby0" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
        
      
        
          <li><a href="https://github.com/arunbaby0" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
        
          <li><a href="https://www.linkedin.com/in/arunbaby0/" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i> LinkedIn</a></li>
        
      
        
          <li><a href="https://scholar.google.co.in/citations?user=6fSYWhkAAAAJ" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-graduation-cap" aria-hidden="true"></i> Google Scholar</a></li>
        
      
    

    
      <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 1990 - 2143 <a href="https://www.arunbaby.com">Arun Baby</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>




  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-0JRJPEC9SS"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-0JRJPEC9SS', { 'anonymize_ip': false});
</script>








  </body>
</html>
