<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.26.2 by Michael Rose
  Copyright 2013-2024 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->

<html lang="en-US" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Evaluate Division (Graph/Union-Find) - Arun Baby</title>
<meta name="description" content="“Modeling algebraic equations as graph path problems.”">


  <meta name="author" content="Arun Baby">
  
  <meta property="article:author" content="Arun Baby">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Arun Baby">
<meta property="og:title" content="Evaluate Division (Graph/Union-Find)">
<meta property="og:url" content="https://www.arunbaby.com/dsa/0034-evaluate-division/">


  <meta property="og:description" content="“Modeling algebraic equations as graph path problems.”">



  <meta property="og:image" content="https://www.arunbaby.com/assets/images/profile-photo.png">



  <meta name="twitter:site" content="@arunbaby0">
  <meta name="twitter:title" content="Evaluate Division (Graph/Union-Find)">
  <meta name="twitter:description" content="“Modeling algebraic equations as graph path problems.”">
  <meta name="twitter:url" content="https://www.arunbaby.com/dsa/0034-evaluate-division/">

  
    <meta name="twitter:card" content="summary">
    
      <meta name="twitter:image" content="https://www.arunbaby.com/assets/images/profile-photo.png">
    
  

  



  <meta property="article:published_time" content="2025-12-29T13:53:22+05:30">





  

  


<link rel="canonical" href="https://www.arunbaby.com/dsa/0034-evaluate-division/">












<!-- end _includes/seo.html -->



  <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Arun Baby Feed">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
  
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css"></noscript>



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single" dir="ltr">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
           
          <span class="site-subtitle">Arun Baby</span>
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a
                href="/about/"
                
                
              >About</a>
            </li><li class="masthead__menu-item">
              <a
                href="/dsa/"
                
                
              >DSA</a>
            </li><li class="masthead__menu-item">
              <a
                href="/ml-system-design/"
                
                
              >ML Systems</a>
            </li><li class="masthead__menu-item">
              <a
                href="/speech-tech/"
                
                
              >Speech Tech</a>
            </li><li class="masthead__menu-item">
              <a
                href="/ai-agents/"
                
                
              >AI Agents</a>
            </li><li class="masthead__menu-item">
              <a
                href="/publications/"
                
                
              >Publications</a>
            </li><li class="masthead__menu-item">
              <a
                href="/statuses/"
                
                
              >Statuses</a>
            </li><li class="masthead__menu-item">
              <a
                href="/contact/"
                
                
              >Contact</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <i class="fas fa-search"></i>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      





<div id="main" role="main" class="no-author-sidebar">
  
  <div class="sidebar sticky">
  
  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Evaluate Division (Graph/Union-Find)">
    <meta itemprop="description" content="“Modeling algebraic equations as graph path problems.”">
    <meta itemprop="datePublished" content="2025-12-29T13:53:22+05:30">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">
            <a href="https://www.arunbaby.com/dsa/0034-evaluate-division/" itemprop="url">Evaluate Division (Graph/Union-Find)
</a>
          </h1>
          

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          24 minute read
        
      </span>
    
  </p>


        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right sticky">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> On this page</h4></header>
              <ul class="toc__menu"><li><a href="#1-problem-statement">1. Problem Statement</a></li><li><a href="#2-graph-modeling-insight">2. Graph Modeling Insight</a></li><li><a href="#3-approach-1-dfs--bfs-path-finding">3. Approach 1: DFS / BFS (Path Finding)</a></li><li><a href="#4-approach-2-union-find-disjoint-set-union">4. Approach 2: Union-Find (Disjoint Set Union)</a></li><li><a href="#5-approach-3-floyd-warshall-all-pairs-shortest-path">5. Approach 3: Floyd-Warshall (All-Pairs Shortest Path)</a></li><li><a href="#6-deep-dive-handling-contradictions">6. Deep Dive: Handling Contradictions</a></li><li><a href="#7-deep-dive-currency-arbitrage-application">7. Deep Dive: Currency Arbitrage Application</a></li><li><a href="#8-deep-dive-dynamic-updates">8. Deep Dive: Dynamic Updates</a></li><li><a href="#9-deep-dive-precision-issues">9. Deep Dive: Precision Issues</a></li><li><a href="#10-real-world-applications">10. Real-World Applications</a></li><li><a href="#11-edge-cases">11. Edge Cases</a></li><li><a href="#12-interview-tips">12. Interview Tips</a></li><li><a href="#13-summary">13. Summary</a></li><li><a href="#14-deep-dive-bi-directional-bfs-for-faster-queries">14. Deep Dive: Bi-Directional BFS for Faster Queries</a></li><li><a href="#15-deep-dive-offline-queries-with-union-find">15. Deep Dive: Offline Queries with Union-Find</a></li><li><a href="#16-deep-dive-detecting-contradictions-in-detail">16. Deep Dive: Detecting Contradictions in Detail</a></li><li><a href="#17-deep-dive-graph-simplification-transitive-reduction">17. Deep Dive: Graph Simplification (Transitive Reduction)</a></li><li><a href="#18-leetcode-variations">18. LeetCode Variations</a></li><li><a href="#19-performance-benchmarking">19. Performance Benchmarking</a></li><li><a href="#20-advanced-handling-log-probabilities">20. Advanced: Handling Log-Probabilities</a></li><li><a href="#21-advanced-multi-source-bfs">21. Advanced: Multi-Source BFS</a></li><li><a href="#22-production-considerations">22. Production Considerations</a></li><li><a href="#23-summary-of-graph-algorithms-for-division">23. Summary of Graph Algorithms for Division</a></li><li><a href="#24-deep-dive-iterative-dfs-implementation">24. Deep Dive: Iterative DFS Implementation</a></li><li><a href="#25-deep-dive-optimizing-with-strongly-connected-components-scc">25. Deep Dive: Optimizing with Strongly Connected Components (SCC)</a></li><li><a href="#26-deep-dive-unit-testing-strategies">26. Deep Dive: Unit Testing Strategies</a></li><li><a href="#27-deep-dive-error-handling-and-logging">27. Deep Dive: Error Handling and Logging</a></li><li><a href="#28-code-full-union-find-implementation-with-path-compression">28. Code: Full Union-Find Implementation with Path Compression</a></li><li><a href="#29-system-design-building-a-currency-conversion-api">29. System Design: Building a Currency Conversion API</a></li><li><a href="#30-final-thoughts">30. Final Thoughts</a></li></ul>
            </nav>
          </aside>
        
        <p><strong>“Modeling algebraic equations as graph path problems.”</strong></p>

<h2 id="1-problem-statement">1. Problem Statement</h2>

<p>You are given an array of variable pairs <code class="language-plaintext highlighter-rouge">equations</code> and an array of real numbers <code class="language-plaintext highlighter-rouge">values</code>, where <code class="language-plaintext highlighter-rouge">equations[i] = [Ai, Bi]</code> and <code class="language-plaintext highlighter-rouge">values[i]</code> represent the equation $A_i / B_i = values[i]$.</p>

<p>Each $A_i$ or $B_i$ is a string that represents a single variable.</p>

<p>You are also given some <code class="language-plaintext highlighter-rouge">queries</code>, where <code class="language-plaintext highlighter-rouge">queries[j] = [Cj, Dj]</code> represents the $j$-th query where you must find the answer for $C_j / D_j = ?$.</p>

<p>Return the answers to all queries. If a single answer cannot be determined, return <code class="language-plaintext highlighter-rouge">-1.0</code>.</p>

<p><strong>Example:</strong></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Input: 
equations = [["a","b"],["b","c"]]
values = [2.0, 3.0]
queries = [["a","c"],["b","a"],["a","e"],["a","a"],["x","x"]]

Output: [6.00000, 0.50000, -1.00000, 1.00000, -1.00000]

Explanation: 
Given: a / b = 2.0, b / c = 3.0
queries are: 
1. a / c = ? 
   a / c = (a / b) * (b / c) = 2.0 * 3.0 = 6.0
2. b / a = ? 
   b / a = 1 / (a / b) = 1 / 2.0 = 0.5
3. a / e = ? 
   'e' is undefined =&gt; -1.0
4. a / a = ? 
   a / a = 1.0
5. x / x = ? 
   'x' is undefined =&gt; -1.0
</code></pre></div></div>

<p><strong>Constraints:</strong></p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">1 &lt;= equations.length &lt;= 20</code></li>
  <li><code class="language-plaintext highlighter-rouge">equations[i].length == 2</code></li>
  <li><code class="language-plaintext highlighter-rouge">1 &lt;= queries.length &lt;= 20</code></li>
  <li>The input is always valid. You may assume that evaluating the queries will not result in division by zero and that there is no contradiction.</li>
</ul>

<h2 id="2-graph-modeling-insight">2. Graph Modeling Insight</h2>

<p>This problem can be modeled as a <strong>Directed Weighted Graph</strong>.</p>

<ul>
  <li><strong>Nodes:</strong> Variables (e.g., “a”, “b”, “c”).</li>
  <li><strong>Edges:</strong> Relationships derived from equations.
    <ul>
      <li>If <code class="language-plaintext highlighter-rouge">a / b = 2.0</code>, there is an edge <code class="language-plaintext highlighter-rouge">a -&gt; b</code> with weight <code class="language-plaintext highlighter-rouge">2.0</code>.</li>
      <li>Implicitly, there is also an edge <code class="language-plaintext highlighter-rouge">b -&gt; a</code> with weight <code class="language-plaintext highlighter-rouge">1 / 2.0 = 0.5</code>.</li>
    </ul>
  </li>
</ul>

<p><strong>Query Interpretation:</strong></p>
<ul>
  <li>Finding <code class="language-plaintext highlighter-rouge">a / c</code> is equivalent to finding a <strong>path</strong> from node <code class="language-plaintext highlighter-rouge">a</code> to node <code class="language-plaintext highlighter-rouge">c</code>.</li>
  <li>The result is the <strong>product of edge weights</strong> along the path.
    <ul>
      <li>Path: <code class="language-plaintext highlighter-rouge">a -&gt; b -&gt; c</code></li>
      <li>Weight: <code class="language-plaintext highlighter-rouge">weight(a-&gt;b) * weight(b-&gt;c) = 2.0 * 3.0 = 6.0</code>.</li>
    </ul>
  </li>
</ul>

<h2 id="3-approach-1-dfs--bfs-path-finding">3. Approach 1: DFS / BFS (Path Finding)</h2>

<p>Since the constraints are small (<code class="language-plaintext highlighter-rouge">N &lt;= 20</code>), a simple graph traversal (DFS or BFS) for each query is efficient enough.</p>

<p><strong>Algorithm:</strong></p>
<ol>
  <li><strong>Build the Graph:</strong> Use an adjacency list. <code class="language-plaintext highlighter-rouge">graph[u] = [(v, weight), ...]</code>.</li>
  <li><strong>Process Queries:</strong> For each query <code class="language-plaintext highlighter-rouge">(start, end)</code>:
    <ul>
      <li>If <code class="language-plaintext highlighter-rouge">start</code> or <code class="language-plaintext highlighter-rouge">end</code> is not in the graph, return <code class="language-plaintext highlighter-rouge">-1.0</code>.</li>
      <li>If <code class="language-plaintext highlighter-rouge">start == end</code>, return <code class="language-plaintext highlighter-rouge">1.0</code>.</li>
      <li>Perform DFS/BFS to find a path from <code class="language-plaintext highlighter-rouge">start</code> to <code class="language-plaintext highlighter-rouge">end</code>.</li>
      <li>Maintain a <code class="language-plaintext highlighter-rouge">visited</code> set to avoid cycles.</li>
      <li>Accumulate the product of weights along the path.</li>
    </ul>
  </li>
</ol>

<p><strong>DFS Implementation (Python):</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>

<span class="k">class</span> <span class="nc">Solution</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">calcEquation</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">equations</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span> <span class="n">values</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">queries</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="c1"># 1. Build the graph
</span>        <span class="n">graph</span> <span class="o">=</span> <span class="nf">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
        <span class="nf">for </span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span> <span class="n">val</span> <span class="ow">in</span> <span class="nf">zip</span><span class="p">(</span><span class="n">equations</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
            <span class="n">graph</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
            <span class="n">graph</span><span class="p">[</span><span class="n">b</span><span class="p">][</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">val</span>
        
        <span class="k">def</span> <span class="nf">dfs</span><span class="p">(</span><span class="n">curr</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">visited</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">curr</span> <span class="o">==</span> <span class="n">target</span><span class="p">:</span>
                <span class="k">return</span> <span class="mf">1.0</span>
            
            <span class="n">visited</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">curr</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">neighbor</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="n">graph</span><span class="p">[</span><span class="n">curr</span><span class="p">].</span><span class="nf">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">neighbor</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">:</span>
                    <span class="n">res</span> <span class="o">=</span> <span class="nf">dfs</span><span class="p">(</span><span class="n">neighbor</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">visited</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">res</span> <span class="o">!=</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">weight</span> <span class="o">*</span> <span class="n">res</span>
            
            <span class="k">return</span> <span class="o">-</span><span class="mf">1.0</span>

        <span class="c1"># 2. Process queries
</span>        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">queries</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">graph</span> <span class="ow">or</span> <span class="n">d</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">graph</span><span class="p">:</span>
                <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="n">d</span><span class="p">:</span>
                <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">dfs</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="nf">set</span><span class="p">()))</span>
        
        <span class="k">return</span> <span class="n">results</span>
</code></pre></div></div>

<p><strong>Complexity Analysis:</strong></p>
<ul>
  <li><strong>Time:</strong> $O(Q \cdot (N + E))$, where $Q$ is queries, $N$ is variables, $E$ is equations. In worst case, we traverse the whole graph for each query.</li>
  <li><strong>Space:</strong> $O(N + E)$ to store the graph.</li>
</ul>

<h2 id="4-approach-2-union-find-disjoint-set-union">4. Approach 2: Union-Find (Disjoint Set Union)</h2>

<p>For larger datasets or online queries, <strong>Union-Find</strong> is more efficient. We can group connected variables into components.</p>

<p><strong>Key Idea:</strong></p>
<ul>
  <li>In a connected component, all variables can be expressed relative to a common <strong>root</strong>.</li>
  <li>If <code class="language-plaintext highlighter-rouge">a</code> and <code class="language-plaintext highlighter-rouge">b</code> are in the same component with root <code class="language-plaintext highlighter-rouge">r</code>:
    <ul>
      <li>We store <code class="language-plaintext highlighter-rouge">a / r</code> and <code class="language-plaintext highlighter-rouge">b / r</code>.</li>
      <li>Then <code class="language-plaintext highlighter-rouge">a / b = (a / r) / (b / r)</code>.</li>
    </ul>
  </li>
</ul>

<p><strong>Data Structure:</strong></p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">parent[x]</code>: The parent of node <code class="language-plaintext highlighter-rouge">x</code>.</li>
  <li><code class="language-plaintext highlighter-rouge">weight[x]</code>: The value of <code class="language-plaintext highlighter-rouge">x / parent[x]</code>.</li>
</ul>

<p><strong>Path Compression with Weights:</strong>
When we call <code class="language-plaintext highlighter-rouge">find(x)</code>, we recursively find the root. As we collapse the path, we update <code class="language-plaintext highlighter-rouge">weight[x]</code> to point directly to the root.</p>

<ul>
  <li>If <code class="language-plaintext highlighter-rouge">x -&gt; y</code> (weight $w_1$) and <code class="language-plaintext highlighter-rouge">y -&gt; root</code> (weight $w_2$):</li>
  <li>New edge <code class="language-plaintext highlighter-rouge">x -&gt; root</code> will have weight $w_1 \times w_2$.</li>
</ul>

<p><strong>Union Operation:</strong>
Given <code class="language-plaintext highlighter-rouge">a / b = val</code>:</p>
<ul>
  <li>Find root of <code class="language-plaintext highlighter-rouge">a</code> ($rootA$) and root of <code class="language-plaintext highlighter-rouge">b</code> ($rootB$).</li>
  <li>If $rootA \neq rootB$, merge them.</li>
  <li>We want to set <code class="language-plaintext highlighter-rouge">parent[rootA] = rootB</code>.</li>
  <li>We need to find <code class="language-plaintext highlighter-rouge">weight[rootA] = rootA / rootB</code>.</li>
  <li>We know:
    <ul>
      <li><code class="language-plaintext highlighter-rouge">a / b = val</code></li>
      <li><code class="language-plaintext highlighter-rouge">a / rootA = weight[a]</code></li>
      <li><code class="language-plaintext highlighter-rouge">b / rootB = weight[b]</code></li>
    </ul>
  </li>
  <li>Derivation:
    <ul>
      <li><code class="language-plaintext highlighter-rouge">rootA / rootB = (rootA / a) * (a / b) * (b / rootB)</code></li>
      <li><code class="language-plaintext highlighter-rouge">rootA / rootB = (1 / weight[a]) * val * weight[b]</code></li>
    </ul>
  </li>
</ul>

<p><strong>Implementation:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Solution</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">calcEquation</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">equations</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span> <span class="n">values</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">queries</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">weight</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># weight[x] = x / parent[x]
</span>        
        <span class="k">def</span> <span class="nf">find</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">parent</span><span class="p">:</span>
                <span class="n">parent</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
                <span class="n">weight</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
            
            <span class="k">if</span> <span class="n">parent</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">!=</span> <span class="n">x</span><span class="p">:</span>
                <span class="n">orig_parent</span> <span class="o">=</span> <span class="n">parent</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
                <span class="n">root</span> <span class="o">=</span> <span class="nf">find</span><span class="p">(</span><span class="n">orig_parent</span><span class="p">)</span>
                <span class="c1"># Update weight: x/root = (x/orig_parent) * (orig_parent/root)
</span>                <span class="n">weight</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">weight</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">*</span> <span class="n">weight</span><span class="p">[</span><span class="n">orig_parent</span><span class="p">]</span>
                <span class="n">parent</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">root</span>
            
            <span class="k">return</span> <span class="n">parent</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
        
        <span class="k">def</span> <span class="nf">union</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
            <span class="n">rootA</span> <span class="o">=</span> <span class="nf">find</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
            <span class="n">rootB</span> <span class="o">=</span> <span class="nf">find</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">rootA</span> <span class="o">!=</span> <span class="n">rootB</span><span class="p">:</span>
                <span class="c1"># Merge rootA into rootB
</span>                <span class="n">parent</span><span class="p">[</span><span class="n">rootA</span><span class="p">]</span> <span class="o">=</span> <span class="n">rootB</span>
                <span class="c1"># weight[rootA] = rootA / rootB
</span>                <span class="c1"># val = a / b
</span>                <span class="c1"># weight[a] = a / rootA
</span>                <span class="c1"># weight[b] = b / rootB
</span>                <span class="c1"># rootA / rootB = (rootA / a) * (a / b) * (b / rootB)
</span>                <span class="c1">#               = (1/weight[a]) * val * weight[b]
</span>                <span class="n">weight</span><span class="p">[</span><span class="n">rootA</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">*</span> <span class="n">weight</span><span class="p">[</span><span class="n">b</span><span class="p">])</span> <span class="o">/</span> <span class="n">weight</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
        
        <span class="c1"># 1. Build Union-Find Structure
</span>        <span class="nf">for </span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span> <span class="n">val</span> <span class="ow">in</span> <span class="nf">zip</span><span class="p">(</span><span class="n">equations</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">a</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">parent</span><span class="p">:</span>
                <span class="n">parent</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span>
                <span class="n">weight</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="k">if</span> <span class="n">b</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">parent</span><span class="p">:</span>
                <span class="n">parent</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span>
                <span class="n">weight</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="nf">union</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
            
        <span class="c1"># 2. Process Queries
</span>        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">queries</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">parent</span> <span class="ow">or</span> <span class="n">d</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">parent</span><span class="p">:</span>
                <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span>
                <span class="k">continue</span>
            
            <span class="n">rootC</span> <span class="o">=</span> <span class="nf">find</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="n">rootD</span> <span class="o">=</span> <span class="nf">find</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">rootC</span> <span class="o">!=</span> <span class="n">rootD</span><span class="p">:</span>
                <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># c / d = (c / root) / (d / root)
</span>                <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">weight</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">/</span> <span class="n">weight</span><span class="p">[</span><span class="n">d</span><span class="p">])</span>
                
        <span class="k">return</span> <span class="n">results</span>
</code></pre></div></div>

<p><strong>Complexity Analysis:</strong></p>
<ul>
  <li><strong>Time:</strong> $O((N + Q) \cdot \alpha(N))$, where $\alpha$ is the Inverse Ackermann function (nearly constant). This is much faster than DFS for many queries.</li>
  <li><strong>Space:</strong> $O(N)$ to store parent and weight maps.</li>
</ul>

<h2 id="5-approach-3-floyd-warshall-all-pairs-shortest-path">5. Approach 3: Floyd-Warshall (All-Pairs Shortest Path)</h2>

<p>If the number of variables is small and the graph is dense, we can precompute all possible divisions using Floyd-Warshall.</p>

<p><strong>Algorithm:</strong></p>
<ol>
  <li>Initialize a 2D matrix <code class="language-plaintext highlighter-rouge">dist</code> where <code class="language-plaintext highlighter-rouge">dist[a][b] = val</code> if <code class="language-plaintext highlighter-rouge">a/b = val</code>.</li>
  <li>Iterate through all intermediate nodes <code class="language-plaintext highlighter-rouge">k</code>.</li>
  <li>Update <code class="language-plaintext highlighter-rouge">dist[i][j]</code> if a path exists through <code class="language-plaintext highlighter-rouge">k</code>: <code class="language-plaintext highlighter-rouge">dist[i][j] = dist[i][k] * dist[k][j]</code>.</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Solution</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">calcEquation</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">equations</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span> <span class="n">values</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">queries</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="c1"># Map variables to indices 0..N-1
</span>        <span class="nb">vars</span> <span class="o">=</span> <span class="nf">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">equations</span><span class="p">:</span>
            <span class="nb">vars</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
            <span class="nb">vars</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        
        <span class="n">var_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="nb">vars</span><span class="p">)}</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="nb">vars</span><span class="p">)</span>
        
        <span class="c1"># Initialize matrix with -1.0 (unknown)
</span>        <span class="n">graph</span> <span class="o">=</span> <span class="p">[[</span><span class="o">-</span><span class="mf">1.0</span><span class="p">]</span> <span class="o">*</span> <span class="n">n</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">graph</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
            
        <span class="nf">for </span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span> <span class="n">val</span> <span class="ow">in</span> <span class="nf">zip</span><span class="p">(</span><span class="n">equations</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
            <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">var_map</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">var_map</span><span class="p">[</span><span class="n">b</span><span class="p">]</span>
            <span class="n">graph</span><span class="p">[</span><span class="n">u</span><span class="p">][</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
            <span class="n">graph</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="n">u</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">val</span>
            
        <span class="c1"># Floyd-Warshall
</span>        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">graph</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mf">1.0</span> <span class="ow">and</span> <span class="n">graph</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">:</span>
                        <span class="n">graph</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">graph</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">graph</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
                        
        <span class="c1"># Queries
</span>        <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">queries</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">var_map</span> <span class="ow">or</span> <span class="n">d</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">var_map</span><span class="p">:</span>
                <span class="n">res</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">graph</span><span class="p">[</span><span class="n">var_map</span><span class="p">[</span><span class="n">c</span><span class="p">]][</span><span class="n">var_map</span><span class="p">[</span><span class="n">d</span><span class="p">]])</span>
        <span class="k">return</span> <span class="n">res</span>
</code></pre></div></div>

<p><strong>Complexity:</strong> $O(N^3)$. Good for $N \le 100$, but bad for large $N$.</p>

<h2 id="6-deep-dive-handling-contradictions">6. Deep Dive: Handling Contradictions</h2>

<p>What if the input contains <code class="language-plaintext highlighter-rouge">a / b = 2.0</code> and <code class="language-plaintext highlighter-rouge">b / a = 3.0</code>? Or <code class="language-plaintext highlighter-rouge">a / b = 2.0</code>, <code class="language-plaintext highlighter-rouge">b / c = 2.0</code>, <code class="language-plaintext highlighter-rouge">a / c = 5.0</code>?</p>

<ul>
  <li><strong>DFS/BFS:</strong> Might find multiple paths with different products.</li>
  <li><strong>Union-Find:</strong> When calling <code class="language-plaintext highlighter-rouge">union(a, b, val)</code>, if <code class="language-plaintext highlighter-rouge">a</code> and <code class="language-plaintext highlighter-rouge">b</code> are already in the same set, we can check consistency.
    <ul>
      <li>Existing relation: <code class="language-plaintext highlighter-rouge">a / b = weight[a] / weight[b]</code>.</li>
      <li>New relation: <code class="language-plaintext highlighter-rouge">val</code>.</li>
      <li>If <code class="language-plaintext highlighter-rouge">abs((weight[a] / weight[b]) - val) &gt; epsilon</code>, we have a contradiction.</li>
    </ul>
  </li>
</ul>

<p><strong>Real-world implication:</strong> In currency exchange systems, this indicates an <strong>arbitrage opportunity</strong> (or a data error).</p>

<h2 id="7-deep-dive-currency-arbitrage-application">7. Deep Dive: Currency Arbitrage Application</h2>

<p>This problem is isomorphic to finding arbitrage in currency exchange markets.</p>
<ul>
  <li>Nodes: Currencies (USD, EUR, JPY).</li>
  <li>Edges: Exchange rates.</li>
  <li>Cycle: <code class="language-plaintext highlighter-rouge">USD -&gt; EUR -&gt; JPY -&gt; USD</code>.</li>
  <li>If the product of weights along a cycle is $&gt; 1.0$, you can make infinite money (theoretically).</li>
</ul>

<p><strong>Algorithm for Arbitrage Detection:</strong></p>
<ul>
  <li>Use <strong>Bellman-Ford</strong> or <strong>SPFA</strong> (Shortest Path Faster Algorithm).</li>
  <li>Since we are dealing with products, we can convert to sums using logarithms:
    <ul>
      <li>$\log(a / b) = \log(a) - \log(b)$.</li>
      <li>$w_{new} = -\log(w_{old})$.</li>
      <li>Finding a path with product $&gt; 1$ becomes finding a negative weight cycle in the log-graph.</li>
    </ul>
  </li>
</ul>

<h2 id="8-deep-dive-dynamic-updates">8. Deep Dive: Dynamic Updates</h2>

<p>What if equations are added dynamically?</p>
<ul>
  <li><strong>DFS/BFS:</strong> Slow, need to re-traverse for every query.</li>
  <li><strong>Floyd-Warshall:</strong> Can update in $O(N^2)$ for each new edge.</li>
  <li><strong>Union-Find:</strong> Best for incremental updates. <code class="language-plaintext highlighter-rouge">union</code> is nearly $O(1)$.</li>
</ul>

<h2 id="9-deep-dive-precision-issues">9. Deep Dive: Precision Issues</h2>

<p>Floating point arithmetic can accumulate errors.</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">a / b = 3.0</code>, <code class="language-plaintext highlighter-rouge">b / c = 1.0 / 3.0</code>.</li>
  <li><code class="language-plaintext highlighter-rouge">a / c</code> should be <code class="language-plaintext highlighter-rouge">1.0</code>.</li>
  <li>In float, it might be <code class="language-plaintext highlighter-rouge">0.99999999</code>.</li>
</ul>

<p><strong>Mitigation:</strong></p>
<ul>
  <li>Use a small epsilon (<code class="language-plaintext highlighter-rouge">1e-9</code>) for comparisons.</li>
  <li>Or simply return the calculated float as is (problem statement usually allows small error).</li>
</ul>

<h2 id="10-real-world-applications">10. Real-World Applications</h2>

<ol>
  <li><strong>Unit Conversion:</strong>
    <ul>
      <li>Input: <code class="language-plaintext highlighter-rouge">1 m = 100 cm</code>, <code class="language-plaintext highlighter-rouge">1 km = 1000 m</code>, <code class="language-plaintext highlighter-rouge">1 in = 2.54 cm</code>.</li>
      <li>Query: <code class="language-plaintext highlighter-rouge">1 km = ? in</code>.</li>
      <li>The graph finds the conversion chain.</li>
    </ul>
  </li>
  <li><strong>Currency Exchange:</strong>
    <ul>
      <li>Calculating cross-rates between illiquid currency pairs via a liquid intermediary (e.g., USD).</li>
    </ul>
  </li>
  <li><strong>Chemical Stoichiometry:</strong>
    <ul>
      <li>Balancing chemical equations or converting between moles of different reactants.</li>
    </ul>
  </li>
  <li><strong>Social Network Influence:</strong>
    <ul>
      <li>If influence is multiplicative (probability of infection), this models propagation paths.</li>
    </ul>
  </li>
</ol>

<h2 id="11-edge-cases">11. Edge Cases</h2>

<ol>
  <li><strong>Disconnected Graph:</strong> Query <code class="language-plaintext highlighter-rouge">a / e</code> where <code class="language-plaintext highlighter-rouge">e</code> is in a different component. Return <code class="language-plaintext highlighter-rouge">-1.0</code>.</li>
  <li><strong>Unknown Variable:</strong> Query <code class="language-plaintext highlighter-rouge">x / x</code> where <code class="language-plaintext highlighter-rouge">x</code> was never seen. Return <code class="language-plaintext highlighter-rouge">-1.0</code>.</li>
  <li><strong>Zero Division:</strong> Constraints say <code class="language-plaintext highlighter-rouge">values[i] &gt; 0.0</code>, so no division by zero.</li>
  <li><strong>Self Loop:</strong> <code class="language-plaintext highlighter-rouge">a / a</code> should always be <code class="language-plaintext highlighter-rouge">1.0</code> if <code class="language-plaintext highlighter-rouge">a</code> exists.</li>
</ol>

<h2 id="12-interview-tips">12. Interview Tips</h2>

<ul>
  <li><strong>Clarify Input:</strong> Are values always positive? (Yes). Are there contradictions? (No, usually).</li>
  <li><strong>Choose the Right Tool:</strong>
    <ul>
      <li>Small $N$, many queries? <strong>Floyd-Warshall</strong>.</li>
      <li>Large $N$, sparse graph? <strong>DFS/BFS</strong>.</li>
      <li>Dynamic updates or massive queries? <strong>Union-Find</strong>.</li>
    </ul>
  </li>
  <li><strong>Space Complexity:</strong> Mention that Union-Find is very space-efficient.</li>
</ul>

<h2 id="13-summary">13. Summary</h2>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Approach</th>
      <th style="text-align: left">Time Complexity</th>
      <th style="text-align: left">Space Complexity</th>
      <th style="text-align: left">Best For</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left"><strong>DFS / BFS</strong></td>
      <td style="text-align: left">$O(Q \cdot (N+E))$</td>
      <td style="text-align: left">$O(N+E)$</td>
      <td style="text-align: left">Sparse graphs, few queries</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Union-Find</strong></td>
      <td style="text-align: left">$O((N+Q) \cdot \alpha(N))$</td>
      <td style="text-align: left">$O(N)$</td>
      <td style="text-align: left">Many queries, dynamic updates</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Floyd-Warshall</strong></td>
      <td style="text-align: left">$O(N^3 + Q)$</td>
      <td style="text-align: left">$O(N^2)$</td>
      <td style="text-align: left">Dense graphs, small $N$</td>
    </tr>
  </tbody>
</table>

<h2 id="14-deep-dive-bi-directional-bfs-for-faster-queries">14. Deep Dive: Bi-Directional BFS for Faster Queries</h2>

<p>For very large graphs where $N$ is large (e.g., 100,000 nodes), a standard BFS might visit too many nodes. <strong>Bi-Directional BFS</strong> can significantly reduce the search space.</p>

<p><strong>Concept:</strong></p>
<ul>
  <li>Start BFS from <code class="language-plaintext highlighter-rouge">source</code> (forward) and <code class="language-plaintext highlighter-rouge">target</code> (backward) simultaneously.</li>
  <li>When the two searches meet at a node <code class="language-plaintext highlighter-rouge">meet_node</code>, we have found a path.</li>
  <li>Path weight = <code class="language-plaintext highlighter-rouge">weight(source -&gt; meet_node) * weight(meet_node -&gt; target)</code>.</li>
  <li>Note: <code class="language-plaintext highlighter-rouge">weight(meet_node -&gt; target)</code> is <code class="language-plaintext highlighter-rouge">1 / weight(target -&gt; meet_node)</code>.</li>
</ul>

<p><strong>Implementation:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">collections</span> <span class="kn">import</span> <span class="n">deque</span>

<span class="k">def</span> <span class="nf">calcEquationBiDir</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">start</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">graph</span> <span class="ow">or</span> <span class="n">end</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">graph</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">-</span><span class="mf">1.0</span>
    <span class="k">if</span> <span class="n">start</span> <span class="o">==</span> <span class="n">end</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">1.0</span>
    
    <span class="c1"># Queue stores (node, current_product)
</span>    <span class="n">q_fwd</span> <span class="o">=</span> <span class="nf">deque</span><span class="p">([(</span><span class="n">start</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)])</span>
    <span class="n">q_bwd</span> <span class="o">=</span> <span class="nf">deque</span><span class="p">([(</span><span class="n">end</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)])</span>
    
    <span class="n">visited_fwd</span> <span class="o">=</span> <span class="p">{</span><span class="n">start</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">}</span>
    <span class="n">visited_bwd</span> <span class="o">=</span> <span class="p">{</span><span class="n">end</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">}</span>
    
    <span class="k">while</span> <span class="n">q_fwd</span> <span class="ow">and</span> <span class="n">q_bwd</span><span class="p">:</span>
        <span class="c1"># Expand forward
</span>        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">q_fwd</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nf">len</span><span class="p">(</span><span class="n">q_bwd</span><span class="p">):</span>
            <span class="n">curr</span><span class="p">,</span> <span class="n">prod</span> <span class="o">=</span> <span class="n">q_fwd</span><span class="p">.</span><span class="nf">popleft</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">curr</span> <span class="ow">in</span> <span class="n">visited_bwd</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">prod</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">visited_bwd</span><span class="p">[</span><span class="n">curr</span><span class="p">])</span>
            
            <span class="k">for</span> <span class="n">neighbor</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="n">graph</span><span class="p">[</span><span class="n">curr</span><span class="p">].</span><span class="nf">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">neighbor</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">visited_fwd</span><span class="p">:</span>
                    <span class="n">visited_fwd</span><span class="p">[</span><span class="n">neighbor</span><span class="p">]</span> <span class="o">=</span> <span class="n">prod</span> <span class="o">*</span> <span class="n">weight</span>
                    <span class="n">q_fwd</span><span class="p">.</span><span class="nf">append</span><span class="p">((</span><span class="n">neighbor</span><span class="p">,</span> <span class="n">prod</span> <span class="o">*</span> <span class="n">weight</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Expand backward
</span>            <span class="n">curr</span><span class="p">,</span> <span class="n">prod</span> <span class="o">=</span> <span class="n">q_bwd</span><span class="p">.</span><span class="nf">popleft</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">curr</span> <span class="ow">in</span> <span class="n">visited_fwd</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">visited_fwd</span><span class="p">[</span><span class="n">curr</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">prod</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">neighbor</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="n">graph</span><span class="p">[</span><span class="n">curr</span><span class="p">].</span><span class="nf">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">neighbor</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">visited_bwd</span><span class="p">:</span>
                    <span class="n">visited_bwd</span><span class="p">[</span><span class="n">neighbor</span><span class="p">]</span> <span class="o">=</span> <span class="n">prod</span> <span class="o">*</span> <span class="n">weight</span>
                    <span class="n">q_bwd</span><span class="p">.</span><span class="nf">append</span><span class="p">((</span><span class="n">neighbor</span><span class="p">,</span> <span class="n">prod</span> <span class="o">*</span> <span class="n">weight</span><span class="p">))</span>
                    
    <span class="k">return</span> <span class="o">-</span><span class="mf">1.0</span>
</code></pre></div></div>

<p><strong>Why it works:</strong></p>
<ul>
  <li>Standard BFS search space: $b^d$ (branching factor $b$, depth $d$).</li>
  <li>Bi-Directional BFS search space: $2 \cdot b^{d/2}$.</li>
  <li>For $b=10, d=6$: $10^6$ vs $2 \cdot 10^3 = 2000$. Massive speedup!</li>
</ul>

<h2 id="15-deep-dive-offline-queries-with-union-find">15. Deep Dive: Offline Queries with Union-Find</h2>

<p>If we have a massive batch of queries and the graph is static, we can optimize using <strong>Offline Processing</strong>.</p>

<p><strong>Idea:</strong></p>
<ul>
  <li>Sort queries or process them in a way that minimizes overhead.</li>
  <li>With Union-Find, we can answer queries in nearly $O(1)$ time after building the structure.</li>
  <li>If we have dynamic updates intermixed with queries, we can use <strong>Time-Travel Union-Find</strong> (persistent data structure) or process updates and queries chronologically.</li>
</ul>

<p><strong>Batch Processing:</strong></p>
<ol>
  <li>Read all equations.</li>
  <li>Build Union-Find.</li>
  <li>Read all queries.</li>
  <li>Answer using <code class="language-plaintext highlighter-rouge">weight[c] / weight[d]</code>.</li>
</ol>

<p>This is already what Approach 2 does, but “Offline” implies we have all data upfront.</p>

<h2 id="16-deep-dive-detecting-contradictions-in-detail">16. Deep Dive: Detecting Contradictions in Detail</h2>

<p>As mentioned, contradictions are critical in real-world data (e.g., sensor data fusion, financial data).</p>

<p><strong>Algorithm for Consistency Checking:</strong></p>
<ol>
  <li>Maintain a <code class="language-plaintext highlighter-rouge">Union-Find</code> structure.</li>
  <li>For every new equation <code class="language-plaintext highlighter-rouge">a / b = val</code>:
    <ul>
      <li>If <code class="language-plaintext highlighter-rouge">a</code> and <code class="language-plaintext highlighter-rouge">b</code> are already connected:
        <ul>
          <li>Calculate existing ratio <code class="language-plaintext highlighter-rouge">existing_val = weight[a] / weight[b]</code>.</li>
          <li>If <code class="language-plaintext highlighter-rouge">abs(existing_val - val) &gt; 1e-9</code>: <strong>Contradiction Found!</strong>
            <ul>
              <li>Return <code class="language-plaintext highlighter-rouge">False</code> or raise Error.</li>
            </ul>
          </li>
        </ul>
      </li>
      <li>Else:
        <ul>
          <li><code class="language-plaintext highlighter-rouge">union(a, b, val)</code>.</li>
        </ul>
      </li>
    </ul>
  </li>
</ol>

<p><strong>Code Example:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ConsistencyChecker</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">weight</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">find</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">parent</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">parent</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
            <span class="n">self</span><span class="p">.</span><span class="n">weight</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">parent</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">!=</span> <span class="n">x</span><span class="p">:</span>
            <span class="n">orig_parent</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">parent</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
            <span class="n">root</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">orig_parent</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">weight</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">*=</span> <span class="n">self</span><span class="p">.</span><span class="n">weight</span><span class="p">[</span><span class="n">orig_parent</span><span class="p">]</span>
            <span class="n">self</span><span class="p">.</span><span class="n">parent</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">root</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">parent</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">add_equation</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="n">rootA</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="n">rootB</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">rootA</span> <span class="o">!=</span> <span class="n">rootB</span><span class="p">:</span>
            <span class="c1"># Merge
</span>            <span class="n">self</span><span class="p">.</span><span class="n">parent</span><span class="p">[</span><span class="n">rootA</span><span class="p">]</span> <span class="o">=</span> <span class="n">rootB</span>
            <span class="n">self</span><span class="p">.</span><span class="n">weight</span><span class="p">[</span><span class="n">rootA</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">*</span> <span class="n">self</span><span class="p">.</span><span class="n">weight</span><span class="p">[</span><span class="n">b</span><span class="p">])</span> <span class="o">/</span> <span class="n">self</span><span class="p">.</span><span class="n">weight</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Check consistency
</span>            <span class="c1"># a / b should be val
</span>            <span class="c1"># We have a / b = (a/root) / (b/root) = weight[a] / weight[b]
</span>            <span class="n">existing_val</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">weight</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">/</span> <span class="n">self</span><span class="p">.</span><span class="n">weight</span><span class="p">[</span><span class="n">b</span><span class="p">]</span>
            <span class="k">if</span> <span class="nf">abs</span><span class="p">(</span><span class="n">existing_val</span> <span class="o">-</span> <span class="n">val</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-5</span><span class="p">:</span>
                <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Contradiction: </span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="s">/</span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="s"> new=</span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s">, old=</span><span class="si">{</span><span class="n">existing_val</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">False</span>
            <span class="k">return</span> <span class="bp">True</span>
</code></pre></div></div>

<h2 id="17-deep-dive-graph-simplification-transitive-reduction">17. Deep Dive: Graph Simplification (Transitive Reduction)</h2>

<p>In some applications, we want to store the <strong>minimum</strong> number of equations needed to derive all others. This is the opposite of transitive closure.</p>

<p><strong>Problem:</strong> Given <code class="language-plaintext highlighter-rouge">a-&gt;b</code>, <code class="language-plaintext highlighter-rouge">b-&gt;c</code>, <code class="language-plaintext highlighter-rouge">a-&gt;c</code>, remove <code class="language-plaintext highlighter-rouge">a-&gt;c</code> because it’s redundant.</p>

<p><strong>Algorithm:</strong></p>
<ol>
  <li>For every edge <code class="language-plaintext highlighter-rouge">u -&gt; v</code>:
    <ul>
      <li>Temporarily remove <code class="language-plaintext highlighter-rouge">u -&gt; v</code>.</li>
      <li>Run BFS/DFS to see if <code class="language-plaintext highlighter-rouge">v</code> is still reachable from <code class="language-plaintext highlighter-rouge">u</code>.</li>
      <li>If yes, <code class="language-plaintext highlighter-rouge">u -&gt; v</code> is redundant. Permanently remove it.</li>
      <li>If no, put it back.</li>
    </ul>
  </li>
</ol>

<p><strong>Note:</strong> This is expensive ($O(E \cdot (N+E))$). Only do this if read-heavy and storage-constrained.</p>

<h2 id="18-leetcode-variations">18. LeetCode Variations</h2>

<p><strong>1. Similar to: 399. Evaluate Division</strong></p>
<ul>
  <li>This is the exact problem.</li>
</ul>

<p><strong>2. 230. Kth Smallest Element in a BST</strong></p>
<ul>
  <li>Not graph, but involves traversing structures.</li>
</ul>

<p><strong>3. 133. Clone Graph</strong></p>
<ul>
  <li>Graph traversal basics.</li>
</ul>

<p><strong>4. 684. Redundant Connection</strong></p>
<ul>
  <li>Union-Find application to detect cycles.</li>
</ul>

<p><strong>5. 1135. Connecting Cities With Minimum Cost</strong></p>
<ul>
  <li>MST (Minimum Spanning Tree) using Kruskal’s (Union-Find) or Prim’s.</li>
</ul>

<h2 id="19-performance-benchmarking">19. Performance Benchmarking</h2>

<p>Let’s compare DFS vs. Union-Find on a large dataset.</p>

<p><strong>Scenario:</strong></p>
<ul>
  <li>$N = 10,000$ variables.</li>
  <li>$E = 10,000$ equations (sparse).</li>
  <li>$Q = 10,000$ queries.</li>
</ul>

<p><strong>DFS:</strong></p>
<ul>
  <li>Each query takes $O(N)$.</li>
  <li>Total: $10,000 \times 10,000 = 10^8$ operations.</li>
  <li>Time: ~10-20 seconds (Python).</li>
</ul>

<p><strong>Union-Find:</strong></p>
<ul>
  <li>Build: $O(E \cdot \alpha(N)) \approx 10,000$.</li>
  <li>Query: $O(Q \cdot \alpha(N)) \approx 10,000$.</li>
  <li>Total: $2 \cdot 10^4$ operations.</li>
  <li>Time: &lt; 0.1 seconds.</li>
</ul>

<p><strong>Conclusion:</strong> Union-Find is <strong>orders of magnitude faster</strong> for dense query workloads.</p>

<h2 id="20-advanced-handling-log-probabilities">20. Advanced: Handling Log-Probabilities</h2>

<p>In probability graphs (e.g., Bayesian Networks), edges represent conditional probabilities $P(B|A)$.</p>
<ul>
  <li>
    <table>
      <tbody>
        <tr>
          <td>Path $A \to B \to C$ implies $P(C</td>
          <td>A) = P(C</td>
          <td>B) \cdot P(B</td>
          <td>A)$.</td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>This is exactly Evaluate Division.</li>
  <li>To avoid underflow with small probabilities, use <strong>Log-Probabilities</strong>.
    <ul>
      <li>
        <table>
          <tbody>
            <tr>
              <td>$\log(P(C</td>
              <td>A)) = \log(P(C</td>
              <td>B)) + \log(P(B</td>
              <td>A))$.</td>
            </tr>
          </tbody>
        </table>
      </li>
      <li>Multiplication becomes Addition.</li>
      <li>Division becomes Subtraction.</li>
      <li>Shortest Path algorithms (Dijkstra) work naturally on sums.</li>
    </ul>
  </li>
</ul>

<h2 id="21-advanced-multi-source-bfs">21. Advanced: Multi-Source BFS</h2>

<p>If we want to find <code class="language-plaintext highlighter-rouge">a / x</code> for <em>all</em> <code class="language-plaintext highlighter-rouge">x</code> reachable from <code class="language-plaintext highlighter-rouge">a</code>.</p>
<ul>
  <li>Run BFS starting from <code class="language-plaintext highlighter-rouge">a</code>.</li>
  <li><code class="language-plaintext highlighter-rouge">dist[start] = 1.0</code>.</li>
  <li>For neighbor <code class="language-plaintext highlighter-rouge">v</code> of <code class="language-plaintext highlighter-rouge">u</code>: <code class="language-plaintext highlighter-rouge">dist[v] = dist[u] * weight(u-&gt;v)</code>.</li>
  <li>This gives the ratio relative to <code class="language-plaintext highlighter-rouge">a</code> for the entire connected component.</li>
</ul>

<h2 id="22-production-considerations">22. Production Considerations</h2>

<ol>
  <li><strong>Precision:</strong> Use <code class="language-plaintext highlighter-rouge">decimal.Decimal</code> in Python or <code class="language-plaintext highlighter-rouge">BigDecimal</code> in Java for financial applications to avoid floating point drift.</li>
  <li><strong>Concurrency:</strong> If the graph is updated by multiple threads, use <strong>Read-Write Locks</strong>. Queries (Reads) can run in parallel; Updates (Writes) need exclusive access.</li>
  <li><strong>Caching:</strong> Cache query results <code class="language-plaintext highlighter-rouge">(a, b) -&gt; val</code>. Invalidate cache if <code class="language-plaintext highlighter-rouge">a</code> or <code class="language-plaintext highlighter-rouge">b</code> or any node on the path is updated. (Hard to track dependencies, usually better to just re-query Union-Find).</li>
</ol>

<h2 id="23-summary-of-graph-algorithms-for-division">23. Summary of Graph Algorithms for Division</h2>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Algorithm</th>
      <th style="text-align: left">Use Case</th>
      <th style="text-align: left">Pros</th>
      <th style="text-align: left">Cons</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left"><strong>DFS</strong></td>
      <td style="text-align: left">Simple, One-off</td>
      <td style="text-align: left">Easy to code</td>
      <td style="text-align: left">Slow for many queries</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>BFS</strong></td>
      <td style="text-align: left">Shortest Path</td>
      <td style="text-align: left">Finds path with min hops (less error)</td>
      <td style="text-align: left">Memory intensive</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Union-Find</strong></td>
      <td style="text-align: left">Batch Queries</td>
      <td style="text-align: left">Extremely fast, handles dynamic updates</td>
      <td style="text-align: left">Harder to implement</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Floyd-Warshall</strong></td>
      <td style="text-align: left">Dense Graph</td>
      <td style="text-align: left">All-pairs precomputed</td>
      <td style="text-align: left">$O(N^3)$ slow build</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Bi-Dir BFS</strong></td>
      <td style="text-align: left">Large Graph</td>
      <td style="text-align: left">Faster than BFS</td>
      <td style="text-align: left">Complex state management</td>
    </tr>
  </tbody>
</table>

<table>
  <tbody>
    <tr>
      <td><strong>Bi-Dir BFS</strong></td>
      <td>Large Graph</td>
      <td>Faster than BFS</td>
      <td>Complex state management</td>
    </tr>
  </tbody>
</table>

<h2 id="24-deep-dive-iterative-dfs-implementation">24. Deep Dive: Iterative DFS Implementation</h2>

<p>Recursive DFS can hit recursion limits (default 1000 in Python) for deep graphs. An iterative approach using a stack is safer for production.</p>

<p><strong>Implementation:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">calcEquationIterative</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">start</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">graph</span> <span class="ow">or</span> <span class="n">end</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">graph</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">-</span><span class="mf">1.0</span>
    <span class="k">if</span> <span class="n">start</span> <span class="o">==</span> <span class="n">end</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">1.0</span>
    
    <span class="n">stack</span> <span class="o">=</span> <span class="p">[(</span><span class="n">start</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)]</span>
    <span class="n">visited</span> <span class="o">=</span> <span class="p">{</span><span class="n">start</span><span class="p">}</span>
    
    <span class="k">while</span> <span class="n">stack</span><span class="p">:</span>
        <span class="n">curr</span><span class="p">,</span> <span class="n">prod</span> <span class="o">=</span> <span class="n">stack</span><span class="p">.</span><span class="nf">pop</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">curr</span> <span class="o">==</span> <span class="n">end</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">prod</span>
        
        <span class="k">for</span> <span class="n">neighbor</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="n">graph</span><span class="p">[</span><span class="n">curr</span><span class="p">].</span><span class="nf">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">neighbor</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">:</span>
                <span class="n">visited</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">neighbor</span><span class="p">)</span>
                <span class="n">stack</span><span class="p">.</span><span class="nf">append</span><span class="p">((</span><span class="n">neighbor</span><span class="p">,</span> <span class="n">prod</span> <span class="o">*</span> <span class="n">weight</span><span class="p">))</span>
                
    <span class="k">return</span> <span class="o">-</span><span class="mf">1.0</span>
</code></pre></div></div>

<p><strong>Trade-off:</strong> Iterative DFS is slightly harder to read but robust against StackOverflowErrors.</p>

<h2 id="25-deep-dive-optimizing-with-strongly-connected-components-scc">25. Deep Dive: Optimizing with Strongly Connected Components (SCC)</h2>

<p>If the graph has cycles (e.g., currency exchange), we can condense Strongly Connected Components into single “super-nodes” to speed up queries.</p>

<p><strong>Tarjan’s Algorithm:</strong></p>
<ol>
  <li>Find all SCCs.</li>
  <li>If <code class="language-plaintext highlighter-rouge">a</code> and <code class="language-plaintext highlighter-rouge">b</code> are in the same SCC, there is definitely a path (and potentially a cycle).</li>
  <li>If we only care about reachability (not values), this reduces the graph size significantly.</li>
  <li>For Evaluate Division, cycles must have product 1.0. If not, it’s a contradiction.</li>
</ol>

<p><strong>Algorithm:</strong></p>
<ul>
  <li>Run Tarjan’s to find SCCs.</li>
  <li>Verify all cycles in SCCs have product 1.0.</li>
  <li>Build a DAG of SCCs.</li>
  <li>Query becomes: Path in DAG + Path within SCC.</li>
</ul>

<h2 id="26-deep-dive-unit-testing-strategies">26. Deep Dive: Unit Testing Strategies</h2>

<p>How do we test this graph logic?</p>

<p><strong>Test Case 1: Simple Chain</strong></p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">a/b=2</code>, <code class="language-plaintext highlighter-rouge">b/c=3</code> -&gt; <code class="language-plaintext highlighter-rouge">a/c=6</code>.</li>
</ul>

<p><strong>Test Case 2: Inverse</strong></p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">a/b=2</code> -&gt; <code class="language-plaintext highlighter-rouge">b/a=0.5</code>.</li>
</ul>

<p><strong>Test Case 3: Disconnected</strong></p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">a/b=2</code>, <code class="language-plaintext highlighter-rouge">c/d=3</code> -&gt; <code class="language-plaintext highlighter-rouge">a/c=-1</code>.</li>
</ul>

<p><strong>Test Case 4: Cycle (Consistent)</strong></p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">a/b=2</code>, <code class="language-plaintext highlighter-rouge">b/c=3</code>, <code class="language-plaintext highlighter-rouge">c/a=1/6</code>.</li>
</ul>

<p><strong>Test Case 5: Cycle (Inconsistent)</strong></p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">a/b=2</code>, <code class="language-plaintext highlighter-rouge">b/c=3</code>, <code class="language-plaintext highlighter-rouge">c/a=2</code> (Product 12 != 1).</li>
</ul>

<p><strong>Python Unittest:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">unittest</span>

<span class="k">class</span> <span class="nc">TestEvaluateDivision</span><span class="p">(</span><span class="n">unittest</span><span class="p">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">test_simple_chain</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">eq</span> <span class="o">=</span> <span class="p">[[</span><span class="sh">"</span><span class="s">a</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">b</span><span class="sh">"</span><span class="p">],</span> <span class="p">[</span><span class="sh">"</span><span class="s">b</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">c</span><span class="sh">"</span><span class="p">]]</span>
        <span class="n">val</span> <span class="o">=</span> <span class="p">[</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">]</span>
        <span class="n">q</span> <span class="o">=</span> <span class="p">[[</span><span class="sh">"</span><span class="s">a</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">c</span><span class="sh">"</span><span class="p">]]</span>
        <span class="n">sol</span> <span class="o">=</span> <span class="nc">Solution</span><span class="p">()</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">sol</span><span class="p">.</span><span class="nf">calcEquation</span><span class="p">(</span><span class="n">eq</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">assertAlmostEqual</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mf">6.0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_disconnected</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">eq</span> <span class="o">=</span> <span class="p">[[</span><span class="sh">"</span><span class="s">a</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">b</span><span class="sh">"</span><span class="p">],</span> <span class="p">[</span><span class="sh">"</span><span class="s">c</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">d</span><span class="sh">"</span><span class="p">]]</span>
        <span class="n">val</span> <span class="o">=</span> <span class="p">[</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">]</span>
        <span class="n">q</span> <span class="o">=</span> <span class="p">[[</span><span class="sh">"</span><span class="s">a</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">c</span><span class="sh">"</span><span class="p">]]</span>
        <span class="n">sol</span> <span class="o">=</span> <span class="nc">Solution</span><span class="p">()</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">sol</span><span class="p">.</span><span class="nf">calcEquation</span><span class="p">(</span><span class="n">eq</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">assertEqual</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="27-deep-dive-error-handling-and-logging">27. Deep Dive: Error Handling and Logging</h2>

<p>In a production system (e.g., a currency conversion microservice), “return -1.0” is not enough.</p>

<p><strong>Requirements:</strong></p>
<ol>
  <li><strong>Structured Logging:</strong> Log <em>why</em> it failed. “Node ‘JPY’ not found” vs “No path from ‘USD’ to ‘BTC’”.</li>
  <li><strong>Metrics:</strong> Track <code class="language-plaintext highlighter-rouge">cache_hit_rate</code> (if using Union-Find or caching), <code class="language-plaintext highlighter-rouge">query_latency</code>, <code class="language-plaintext highlighter-rouge">error_rate</code>.</li>
  <li><strong>Alerting:</strong> If <code class="language-plaintext highlighter-rouge">inconsistent_data_error</code> spikes, alert the data team.</li>
</ol>

<p><strong>Example Log:</strong></p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"level"</span><span class="p">:</span><span class="w"> </span><span class="s2">"WARN"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"event"</span><span class="p">:</span><span class="w"> </span><span class="s2">"conversion_failed"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"source"</span><span class="p">:</span><span class="w"> </span><span class="s2">"USD"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"target"</span><span class="p">:</span><span class="w"> </span><span class="s2">"BTC"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"reason"</span><span class="p">:</span><span class="w"> </span><span class="s2">"disconnected_component"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"timestamp"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2023-10-27T10:00:00Z"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h2 id="28-code-full-union-find-implementation-with-path-compression">28. Code: Full Union-Find Implementation with Path Compression</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">UnionFind</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">weight</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">parent</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">parent</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
            <span class="n">self</span><span class="p">.</span><span class="n">weight</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

    <span class="k">def</span> <span class="nf">find</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">parent</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">parent</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">!=</span> <span class="n">x</span><span class="p">:</span>
            <span class="n">orig_parent</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">parent</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
            <span class="n">root</span><span class="p">,</span> <span class="n">root_weight</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">orig_parent</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">weight</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">*=</span> <span class="n">root_weight</span>
            <span class="n">self</span><span class="p">.</span><span class="n">parent</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">root</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">parent</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">self</span><span class="p">.</span><span class="n">weight</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">union</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="n">rootA</span><span class="p">,</span> <span class="n">wA</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="n">rootB</span><span class="p">,</span> <span class="n">wB</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rootA</span> <span class="o">!=</span> <span class="n">rootB</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">parent</span><span class="p">[</span><span class="n">rootA</span><span class="p">]</span> <span class="o">=</span> <span class="n">rootB</span>
            <span class="n">self</span><span class="p">.</span><span class="n">weight</span><span class="p">[</span><span class="n">rootA</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">*</span> <span class="n">wB</span><span class="p">)</span> <span class="o">/</span> <span class="n">wA</span>

    <span class="k">def</span> <span class="nf">query</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">a</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">parent</span> <span class="ow">or</span> <span class="n">b</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">parent</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mf">1.0</span>
        <span class="n">rootA</span><span class="p">,</span> <span class="n">wA</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="n">rootB</span><span class="p">,</span> <span class="n">wB</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rootA</span> <span class="o">!=</span> <span class="n">rootB</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mf">1.0</span>
        <span class="k">return</span> <span class="n">wA</span> <span class="o">/</span> <span class="n">wB</span>
</code></pre></div></div>

<h2 id="29-system-design-building-a-currency-conversion-api">29. System Design: Building a Currency Conversion API</h2>

<p><strong>Scenario:</strong> Design a microservice that handles 10,000 QPS (queries per second) for currency conversions.</p>

<p><strong>Requirements:</strong></p>
<ol>
  <li><strong>Low Latency:</strong> &lt; 10ms p99.</li>
  <li><strong>High Availability:</strong> 99.99% uptime.</li>
  <li><strong>Dynamic Updates:</strong> Exchange rates update every minute.</li>
  <li><strong>Arbitrage Detection:</strong> Alert if cycles exist with product != 1.0.</li>
</ol>

<p><strong>Architecture:</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌─────────────┐
│   Client    │
└──────┬──────┘
       │
       ▼
┌─────────────────────────────────┐
│   API Gateway (Rate Limiting)   │
└──────────────┬──────────────────┘
               │
               ▼
┌──────────────────────────────────┐
│  Conversion Service (Stateless)  │
│  - Load Balancer (3 instances)   │
└──────────────┬───────────────────┘
               │
        ┌──────┴──────┐
        ▼             ▼
┌──────────────┐  ┌──────────────┐
│  Redis Cache │  │  Union-Find  │
│  (Hot Pairs) │  │  In-Memory   │
└──────────────┘  └──────┬───────┘
                         │
                         ▼
                  ┌──────────────┐
                  │  PostgreSQL  │
                  │  (Equations) │
                  └──────────────┘
</code></pre></div></div>

<p><strong>Implementation Details:</strong></p>

<p><strong>1. Data Model (PostgreSQL):</strong></p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">exchange_rates</span> <span class="p">(</span>
    <span class="n">id</span> <span class="nb">SERIAL</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
    <span class="n">from_currency</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
    <span class="n">to_currency</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
    <span class="n">rate</span> <span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
    <span class="nb">timestamp</span> <span class="nb">TIMESTAMP</span> <span class="k">DEFAULT</span> <span class="n">NOW</span><span class="p">(),</span>
    <span class="k">UNIQUE</span><span class="p">(</span><span class="n">from_currency</span><span class="p">,</span> <span class="n">to_currency</span><span class="p">)</span>
<span class="p">);</span>

<span class="k">CREATE</span> <span class="k">INDEX</span> <span class="n">idx_currencies</span> <span class="k">ON</span> <span class="n">exchange_rates</span><span class="p">(</span><span class="n">from_currency</span><span class="p">,</span> <span class="n">to_currency</span><span class="p">);</span>
</code></pre></div></div>

<p><strong>2. In-Memory Union-Find:</strong></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">CurrencyConverter</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">uf</span> <span class="o">=</span> <span class="nc">UnionFind</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">last_update</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">lock</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">RLock</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">reload_from_db</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="c1"># Fetch all rates
</span>            <span class="n">rates</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="nf">query</span><span class="p">(</span><span class="sh">"</span><span class="s">SELECT from_currency, to_currency, rate FROM exchange_rates</span><span class="sh">"</span><span class="p">)</span>
            
            <span class="c1"># Rebuild Union-Find
</span>            <span class="n">self</span><span class="p">.</span><span class="n">uf</span> <span class="o">=</span> <span class="nc">UnionFind</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">from_curr</span><span class="p">,</span> <span class="n">to_curr</span><span class="p">,</span> <span class="n">rate</span> <span class="ow">in</span> <span class="n">rates</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="n">uf</span><span class="p">.</span><span class="nf">union</span><span class="p">(</span><span class="n">from_curr</span><span class="p">,</span> <span class="n">to_curr</span><span class="p">,</span> <span class="n">rate</span><span class="p">)</span>
            
            <span class="n">self</span><span class="p">.</span><span class="n">last_update</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">convert</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">from_curr</span><span class="p">,</span> <span class="n">to_curr</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="c1"># Check cache first
</span>        <span class="n">cache_key</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">from_curr</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">to_curr</span><span class="si">}</span><span class="sh">"</span>
        <span class="n">cached_rate</span> <span class="o">=</span> <span class="n">redis</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">cached_rate</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">amount</span> <span class="o">*</span> <span class="nf">float</span><span class="p">(</span><span class="n">cached_rate</span><span class="p">)</span>
        
        <span class="c1"># Query Union-Find
</span>        <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="n">rate</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">uf</span><span class="p">.</span><span class="nf">query</span><span class="p">(</span><span class="n">from_curr</span><span class="p">,</span> <span class="n">to_curr</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">rate</span> <span class="o">==</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">No conversion path from </span><span class="si">{</span><span class="n">from_curr</span><span class="si">}</span><span class="s"> to </span><span class="si">{</span><span class="n">to_curr</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="c1"># Cache for 60 seconds
</span>        <span class="n">redis</span><span class="p">.</span><span class="nf">setex</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="n">rate</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">amount</span> <span class="o">*</span> <span class="n">rate</span>
</code></pre></div></div>

<p><strong>3. Background Worker (Rate Updates):</strong></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">schedule</span>

<span class="k">def</span> <span class="nf">update_rates</span><span class="p">():</span>
    <span class="c1"># Fetch from external API (e.g., fixer.io)
</span>    <span class="n">new_rates</span> <span class="o">=</span> <span class="nf">fetch_external_rates</span><span class="p">()</span>
    
    <span class="c1"># Update DB
</span>    <span class="k">for</span> <span class="n">from_curr</span><span class="p">,</span> <span class="n">to_curr</span><span class="p">,</span> <span class="n">rate</span> <span class="ow">in</span> <span class="n">new_rates</span><span class="p">:</span>
        <span class="n">db</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="sh">"""</span><span class="s">
            INSERT INTO exchange_rates (from_currency, to_currency, rate)
            VALUES (%s, %s, %s)
            ON CONFLICT (from_currency, to_currency) 
            DO UPDATE SET rate = EXCLUDED.rate, timestamp = NOW()
        </span><span class="sh">"""</span><span class="p">,</span> <span class="p">(</span><span class="n">from_curr</span><span class="p">,</span> <span class="n">to_curr</span><span class="p">,</span> <span class="n">rate</span><span class="p">))</span>
    
    <span class="c1"># Reload in-memory structure
</span>    <span class="n">converter</span><span class="p">.</span><span class="nf">reload_from_db</span><span class="p">()</span>
    
    <span class="c1"># Detect arbitrage
</span>    <span class="nf">detect_arbitrage</span><span class="p">()</span>

<span class="n">schedule</span><span class="p">.</span><span class="nf">every</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">minutes</span><span class="p">.</span><span class="nf">do</span><span class="p">(</span><span class="n">update_rates</span><span class="p">)</span>
</code></pre></div></div>

<p><strong>4. Arbitrage Detection:</strong></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">detect_arbitrage</span><span class="p">():</span>
    <span class="c1"># Find all cycles
</span>    <span class="c1"># For each cycle, check if product != 1.0
</span>    <span class="c1"># This is expensive, run asynchronously
</span>    
    <span class="n">currencies</span> <span class="o">=</span> <span class="nf">get_all_currencies</span><span class="p">()</span>
    <span class="n">graph</span> <span class="o">=</span> <span class="nf">build_graph</span><span class="p">()</span>
    
    <span class="k">for</span> <span class="n">start</span> <span class="ow">in</span> <span class="n">currencies</span><span class="p">:</span>
        <span class="c1"># DFS to find cycles
</span>        <span class="n">visited</span> <span class="o">=</span> <span class="nf">set</span><span class="p">()</span>
        <span class="n">path</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">product</span> <span class="o">=</span> <span class="mf">1.0</span>
        
        <span class="k">def</span> <span class="nf">dfs</span><span class="p">(</span><span class="n">curr</span><span class="p">,</span> <span class="n">prod</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">curr</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">curr</span> <span class="o">==</span> <span class="n">start</span> <span class="ow">and</span> <span class="nf">abs</span><span class="p">(</span><span class="n">prod</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.01</span><span class="p">:</span>
                    <span class="nf">alert</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Arbitrage detected: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s">, product=</span><span class="si">{</span><span class="n">prod</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">return</span>
            
            <span class="n">visited</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">curr</span><span class="p">)</span>
            <span class="n">path</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">curr</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">neighbor</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="n">graph</span><span class="p">[</span><span class="n">curr</span><span class="p">].</span><span class="nf">items</span><span class="p">():</span>
                <span class="nf">dfs</span><span class="p">(</span><span class="n">neighbor</span><span class="p">,</span> <span class="n">prod</span> <span class="o">*</span> <span class="n">weight</span><span class="p">)</span>
            
            <span class="n">path</span><span class="p">.</span><span class="nf">pop</span><span class="p">()</span>
            <span class="n">visited</span><span class="p">.</span><span class="nf">remove</span><span class="p">(</span><span class="n">curr</span><span class="p">)</span>
        
        <span class="nf">dfs</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
</code></pre></div></div>

<p><strong>5. Monitoring &amp; Metrics:</strong></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">prometheus_client</span> <span class="kn">import</span> <span class="n">Counter</span><span class="p">,</span> <span class="n">Histogram</span>

<span class="n">conversion_requests</span> <span class="o">=</span> <span class="nc">Counter</span><span class="p">(</span><span class="sh">'</span><span class="s">conversion_requests_total</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Total conversion requests</span><span class="sh">'</span><span class="p">)</span>
<span class="n">conversion_latency</span> <span class="o">=</span> <span class="nc">Histogram</span><span class="p">(</span><span class="sh">'</span><span class="s">conversion_latency_seconds</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Conversion latency</span><span class="sh">'</span><span class="p">)</span>
<span class="n">cache_hits</span> <span class="o">=</span> <span class="nc">Counter</span><span class="p">(</span><span class="sh">'</span><span class="s">cache_hits_total</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Cache hits</span><span class="sh">'</span><span class="p">)</span>
<span class="n">cache_misses</span> <span class="o">=</span> <span class="nc">Counter</span><span class="p">(</span><span class="sh">'</span><span class="s">cache_misses_total</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Cache misses</span><span class="sh">'</span><span class="p">)</span>

<span class="nd">@conversion_latency.time</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">convert_with_metrics</span><span class="p">(</span><span class="n">from_curr</span><span class="p">,</span> <span class="n">to_curr</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
    <span class="n">conversion_requests</span><span class="p">.</span><span class="nf">inc</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="n">redis</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">from_curr</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">to_curr</span><span class="si">}</span><span class="sh">"</span><span class="p">):</span>
        <span class="n">cache_hits</span><span class="p">.</span><span class="nf">inc</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cache_misses</span><span class="p">.</span><span class="nf">inc</span><span class="p">()</span>
    
    <span class="k">return</span> <span class="n">converter</span><span class="p">.</span><span class="nf">convert</span><span class="p">(</span><span class="n">from_curr</span><span class="p">,</span> <span class="n">to_curr</span><span class="p">,</span> <span class="n">amount</span><span class="p">)</span>
</code></pre></div></div>

<p><strong>Performance:</strong></p>
<ul>
  <li><strong>Cold Query:</strong> ~5ms (Union-Find lookup + DB roundtrip).</li>
  <li><strong>Warm Query:</strong> ~0.5ms (Redis cache hit).</li>
  <li><strong>Throughput:</strong> 10,000 QPS easily handled with 3 instances.</li>
</ul>

<h2 id="30-final-thoughts">30. Final Thoughts</h2>

<p>Evaluate Division is a classic example of how a math problem can be transformed into a graph problem. The choice of algorithm (DFS vs. Union-Find) depends heavily on the constraints (number of queries vs. updates). Mastering Union-Find with path compression and weight tracking is a powerful tool for your algorithmic toolkit.</p>

<hr />

<p><strong>Originally published at:</strong> <a href="https://www.arunbaby.com/dsa/0034-evaluate-division/">arunbaby.com/dsa/0034-evaluate-division</a></p>

<p><em>If you found this helpful, consider sharing it with others who might benefit.</em></p>


        
      </section>

      <footer class="page__meta">
        
        
  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      <a href="/tags/#bfs" class="page__taxonomy-item p-category" rel="tag">bfs</a><span class="sep">, </span>
    
      <a href="/tags/#dfs" class="page__taxonomy-item p-category" rel="tag">dfs</a><span class="sep">, </span>
    
      <a href="/tags/#graph" class="page__taxonomy-item p-category" rel="tag">graph</a><span class="sep">, </span>
    
      <a href="/tags/#math" class="page__taxonomy-item p-category" rel="tag">math</a><span class="sep">, </span>
    
      <a href="/tags/#union-find" class="page__taxonomy-item p-category" rel="tag">union-find</a>
    
    </span>
  </p>




  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      <a href="/categories/#dsa" class="page__taxonomy-item p-category" rel="tag">dsa</a>
    
    </span>
  </p>


        
      </footer>

      

      <section class="page__share">
  <h4 class="page__share-title">Share on</h4>

  <a href="https://twitter.com/intent/tweet?via=arunbaby0&text=Evaluate+Division+%28Graph%2FUnion-Find%29%20https%3A%2F%2Fwww.arunbaby.com%2Fdsa%2F0034-evaluate-division%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fwww.arunbaby.com%2Fdsa%2F0034-evaluate-division%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://www.arunbaby.com/dsa/0034-evaluate-division/" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/dsa/0033-clone-graph/" class="pagination--pager" title="Clone Graph (DFS/BFS)">Previous</a>
    
    
      <a href="/dsa/0035-surrounded-regions/" class="pagination--pager" title="Surrounded Regions (DFS/BFS)">Next</a>
    
  </nav>


    </div>

    
  </article>

  
  
</div>

      
    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';" role="search">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    
      
        
          <li><a href="https://twitter.com/arunbaby0" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
        
      
        
          <li><a href="https://github.com/arunbaby0" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
        
          <li><a href="https://www.linkedin.com/in/arunbaby0/" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i> LinkedIn</a></li>
        
      
        
          <li><a href="https://scholar.google.co.in/citations?user=6fSYWhkAAAAJ" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-graduation-cap" aria-hidden="true"></i> Google Scholar</a></li>
        
      
    

    
      <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 1990 - 2143 <a href="https://www.arunbaby.com">Arun Baby</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>




  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-0JRJPEC9SS"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-0JRJPEC9SS', { 'anonymize_ip': false});
</script>








  </body>
</html>
