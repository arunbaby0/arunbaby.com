<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.26.2 by Michael Rose
  Copyright 2013-2024 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->

<html lang="en-US" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Structured Output Patterns - Arun Baby</title>
<meta name="description" content="“Make agents predictable: enforce schemas, validate outputs, and recover automatically when the model slips.”">


  <meta name="author" content="Arun Baby">
  
  <meta property="article:author" content="Arun Baby">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Arun Baby">
<meta property="og:title" content="Structured Output Patterns">
<meta property="og:url" content="https://www.arunbaby.com/ai-agents/0035-structured-output-patterns/">


  <meta property="og:description" content="“Make agents predictable: enforce schemas, validate outputs, and recover automatically when the model slips.”">



  <meta property="og:image" content="https://www.arunbaby.com/assets/images/profile-photo.png">



  <meta name="twitter:site" content="@arunbaby0">
  <meta name="twitter:title" content="Structured Output Patterns">
  <meta name="twitter:description" content="“Make agents predictable: enforce schemas, validate outputs, and recover automatically when the model slips.”">
  <meta name="twitter:url" content="https://www.arunbaby.com/ai-agents/0035-structured-output-patterns/">

  
    <meta name="twitter:card" content="summary">
    
      <meta name="twitter:image" content="https://www.arunbaby.com/assets/images/profile-photo.png">
    
  

  



  <meta property="article:published_time" content="2025-12-20T23:06:50+05:30">





  

  


<link rel="canonical" href="https://www.arunbaby.com/ai-agents/0035-structured-output-patterns/">












<!-- end _includes/seo.html -->



  <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Arun Baby Feed">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
  
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css"></noscript>



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single" dir="ltr">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
           
          <span class="site-subtitle">Arun Baby</span>
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a
                href="/about/"
                
                
              >About</a>
            </li><li class="masthead__menu-item">
              <a
                href="/dsa/"
                
                
              >DSA</a>
            </li><li class="masthead__menu-item">
              <a
                href="/ml-system-design/"
                
                
              >ML Systems</a>
            </li><li class="masthead__menu-item">
              <a
                href="/speech-tech/"
                
                
              >Speech Tech</a>
            </li><li class="masthead__menu-item">
              <a
                href="/ai-agents/"
                
                
              >AI Agents</a>
            </li><li class="masthead__menu-item">
              <a
                href="/publications/"
                
                
              >Publications</a>
            </li><li class="masthead__menu-item">
              <a
                href="/statuses/"
                
                
              >Statuses</a>
            </li><li class="masthead__menu-item">
              <a
                href="/contact/"
                
                
              >Contact</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <i class="fas fa-search"></i>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      





<div id="main" role="main" class="">
  
  <div class="sidebar sticky">
  
    


<div itemscope itemtype="https://schema.org/Person" class="h-card">

  
    <div class="author__avatar">
      <a href="https://www.arunbaby.com/">
        <img src="/assets/images/profile-photo.png" alt="Arun Baby" itemprop="image" class="u-photo">
      </a>
    </div>
  

  <div class="author__content">
    <h3 class="author__name p-name" itemprop="name">
      <a class="u-url" rel="me" href="https://www.arunbaby.com/" itemprop="url">Arun Baby</a>
    </h3>
    
      <div class="author__bio p-note" itemprop="description">
        <p>Becoming <strong>Unlabelable</strong></p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name" class="p-locality">India</span>
        </li>
      

      
        
          
            <li><a href="https://twitter.com/arunbaby0" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i><span class="label">Twitter</span></a></li>
          
        
          
            <li><a href="https://github.com/arunbaby0" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
          
        
          
            <li><a href="https://www.linkedin.com/in/arunbaby0/" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span class="label">LinkedIn</span></a></li>
          
        
          
            <li><a href="https://scholar.google.co.in/citations?user=6fSYWhkAAAAJ" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fas fa-fw fa-graduation-cap" aria-hidden="true"></i><span class="label">Google Scholar</span></a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer me">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Structured Output Patterns">
    <meta itemprop="description" content="“Make agents predictable: enforce schemas, validate outputs, and recover automatically when the model slips.”">
    <meta itemprop="datePublished" content="2025-12-20T23:06:50+05:30">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">
            <a href="https://www.arunbaby.com/ai-agents/0035-structured-output-patterns/" itemprop="url">Structured Output Patterns
</a>
          </h1>
          

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          20 minute read
        
      </span>
    
  </p>


        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right sticky">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> On this page</h4></header>
              <ul class="toc__menu"><li><a href="#1-introduction-the-ai-contract">1. Introduction: The “AI Contract”</a><ul><li><a href="#11-the-history-of-the-ai-contract">1.1 The History of the AI Contract</a></li><li><a href="#12-the-precisioncreativity-trade-off">1.2 The Precision/Creativity Trade-off</a></li><li><a href="#13-why-json-won-the-ai-war">1.3 Why JSON Won the AI War</a></li></ul></li><li><a href="#2-roadmap--junior-engineer-goals">2. Roadmap &amp; Junior Engineer Goals</a><ul><li><a href="#step-1-the-scraper">Step 1: The Scraper</a></li><li><a href="#step-2-the-action-taker">Step 2: The Action-Taker</a></li><li><a href="#step-3-the-architect">Step 3: The Architect</a></li></ul></li><li><a href="#3-implementing-a-drafting-loop-for-json">3. Implementing a “Drafting” Loop for JSON</a></li><li><a href="#4-the-schema-first-vs-prompt-first-debate">4. The “Schema-First” vs. “Prompt-First” Debate</a></li><li><a href="#5-handling-token-overflows-in-json">5. Handling “Token Overflows” in JSON</a></li><li><a href="#6-security-the-json-bomb-and-denial-of-service">6. Security: The “JSON Bomb” and Denial of Service</a></li><li><a href="#7-advanced-pattern-the-cot--json-hybrid">7. Advanced Pattern: The “CoT + JSON” Hybrid</a></li><li><a href="#8-schema-design-patterns-for-agents">8. Schema Design Patterns for Agents</a><ul><li><a href="#31-the-envelope-pattern">3.1 The “Envelope” Pattern</a></li><li><a href="#32-the-polymorphic-tool">3.2 The “Polymorphic” Tool</a></li><li><a href="#33-the-recursive-schema-pattern">3.3 The “Recursive Schema” Pattern</a></li></ul></li><li><a href="#9-token-efficiency-the-math-of-json-keys">9. Token Efficiency: The Math of JSON Keys</a><ul><li><a href="#41-the-compression-ratio">4.1 The Compression Ratio</a></li><li><a href="#42-the-schema-mapping-solution">4.2 The “Schema-Mapping” Solution</a></li></ul></li><li><a href="#10-case-study-the-messy-legal-contract-parser">10. Case Study: The “Messy Legal Contract” Parser</a></li><li><a href="#11-json-mode-vs-function-calling-which-one-to-use">11. JSON Mode vs. Function Calling: Which one to use?</a><ul><li><a href="#81-json-mode-the-soft-constraint">8.1 JSON Mode (The “Soft” Constraint)</a></li><li><a href="#112-function-calling-the-hard-constraint">11.2 Function Calling (The “Hard” Constraint)</a></li></ul></li><li><a href="#12-schema-evolution-handling-versioning-in-production">12. Schema Evolution: Handling Versioning in Production</a><ul><li><a href="#91-the-backwards-compatibility-rule">9.1 The “Backwards Compatibility” Rule</a></li><li><a href="#92-the-schema-registry-pattern">9.2 The “Schema Registry” Pattern</a></li></ul></li><li><a href="#13-grammar-based-sampling-the-outlines-revolution">13. Grammar-Based Sampling: The “Outlines” Revolution</a></li><li><a href="#14-the-json-schema-masterclass-field-descriptions">14. The JSON Schema Masterclass: Field Descriptions</a></li><li><a href="#15-security-type-safety--json-bombs">15. Security: Type Safety &amp; JSON Bombs</a></li><li><a href="#16-multi-modal-structured-output">16. Multi-Modal Structured Output</a></li><li><a href="#17-the-plan-schema-structuring-agent-thought-dags">17. The “Plan” Schema: Structuring Agent Thought (DAGs)</a></li><li><a href="#18-data-integrity-the-double-verification-pattern">18. Data Integrity: The “Double Verification” Pattern</a></li><li><a href="#19-performance-detail-handling-dates--decimals">19. Performance Detail: Handling Dates &amp; Decimals</a></li><li><a href="#20-the-self-documenting-agent">20. The “Self-Documenting” Agent</a></li><li><a href="#21-security-sanitizing-json-values-parameter-injection">21. Security: Sanitizing JSON Values (Parameter Injection)</a></li><li><a href="#22-future-trends-native-structural-encoding">22. Future Trends: Native Structural Encoding</a><ul><li><a href="#251-speculative-decoding-for-json">25.1 Speculative Decoding for JSON</a></li><li><a href="#252-multi-scale-schemas">25.2 Multi-Scale Schemas</a></li></ul></li><li><a href="#23-the-unit-test-for-schemas-how-to-test-your-agent">23. The “Unit Test” for Schemas: How to Test Your Agent</a></li><li><a href="#24-faq-advanced-troubleshooting">24. FAQ: Advanced Troubleshooting</a></li><li><a href="#25-complex-example-the-e-commerce-support-ticket-schema">25. Complex Example: The “E-commerce Support Ticket” Schema</a><ul><li><a href="#301-why-this-works">30.1 Why this works</a></li></ul></li><li><a href="#26-the-future-schema-driven-small-language-models-slms">26. The Future: “Schema-Driven” Small Language Models (SLMs)</a></li><li><a href="#27-handling-non-latin-characters-and-localization-in-json">27. Handling Non-Latin Characters and Localization in JSON</a></li><li><a href="#28-benchmarking-model-accuracy-for-json">28. Benchmarking Model Accuracy for JSON</a></li><li><a href="#29-json-vs-python-code-generation-when-to-use-which">29. JSON vs. Python Code Generation: When to Use Which?</a></li><li><a href="#30-the-self-correction-loop-in-detail">30. The “Self-Correction” Loop in Detail</a></li><li><a href="#31-large-scale-schema-management-prompt-governance">31. Large Scale Schema Management (Prompt Governance)</a></li><li><a href="#32-monitoring-schema-drift-the-silent-failure">32. Monitoring “Schema Drift”: The Silent Failure</a></li><li><a href="#33-key-takeaways--junior-engineer-roadmap">33. Key Takeaways &amp; Junior Engineer Roadmap</a><ul><li><a href="#step-1-the-scraper-1">Step 1: The Scraper</a></li><li><a href="#step-2-the-action-taker-1">Step 2: The Action-Taker</a></li><li><a href="#step-3-the-architect-1">Step 3: The Architect</a></li></ul></li><li><a href="#34-double-logic-link-interfaces-and-mapping">34. Double Logic Link: Interfaces and Mapping</a></li></ul>
            </nav>
          </aside>
        
        <p><strong>“Make agents predictable: enforce schemas, validate outputs, and recover automatically when the model slips.”</strong></p>

<h2 id="1-introduction-the-ai-contract">1. Introduction: The “AI Contract”</h2>

<h3 id="11-the-history-of-the-ai-contract">1.1 The History of the AI Contract</h3>
<p>In the early days of LLMs (2020-2022), developers spent 80% of their time writing “Garbage Disposal” code—complex regex functions designed to clean up the conversation. You would ask for a list of fruits and get: <em>“Sure, I love fruits! Here they are: 1. Apple, 2. Banana… hope this helps!”</em>. This was the “Dark Ages” of agentic engineering. Today, we handle this through <strong>Hard Constraints</strong>.</p>

<h3 id="12-the-precisioncreativity-trade-off">1.2 The Precision/Creativity Trade-off</h3>
<p>There is a fundamental tension in LLMs. The more you force them to follow a structure (Precision), the less “Creative” they become. For an agent checking a bank balance, you want 100.0% precision and 0.0% creativity. Structured output is the dial you use to turn down the model’s “hallucination engine” and turn up its “logic engine.”</p>

<h3 id="13-why-json-won-the-ai-war">1.3 Why JSON Won the AI War</h3>
<p>While LLMs can output XML or YAML, <strong>JSON</strong> is the undisputed champion. It is token-efficient, natively supported by all major model providers (OpenAI, Gemini), and perfectly matches the <code class="language-plaintext highlighter-rouge">dict</code> and <code class="language-plaintext highlighter-rouge">class</code> structures of modern programming languages like Python and TypeScript.</p>

<hr />

<h2 id="2-roadmap--junior-engineer-goals">2. Roadmap &amp; Junior Engineer Goals</h2>

<p>Structured output is the “Final Frontier” of agentic reliability.</p>

<h3 id="step-1-the-scraper">Step 1: The Scraper</h3>
<p>Learn to use Pydantic to extract data from messy text. This is the “Hello World” of structured output.</p>

<h3 id="step-2-the-action-taker">Step 2: The Action-Taker</h3>
<p>Connect your Pydantic schemas to actual Python functions. When the agent outputs a <code class="language-plaintext highlighter-rouge">ChargeCard</code> object, the money actually moves. This requires <strong>High-Stakes Validation</strong>.</p>

<h3 id="step-3-the-architect">Step 3: The Architect</h3>
<p>Design a recursive, self-healing system where agents can update their own schemas and communicate via complex DAGs.</p>

<hr />

<h2 id="3-implementing-a-drafting-loop-for-json">3. Implementing a “Drafting” Loop for JSON</h2>

<p>Sometimes a single turn is not enough to get a complex JSON right.</p>

<p><strong>The Workflow:</strong></p>
<ol>
  <li><strong>Draft:</strong> Agent A outputs a draft JSON.</li>
  <li><strong>Audit:</strong> An automated script checks for “Null” fields or type mismatches.</li>
  <li><strong>Refactor:</strong> The script sends a prompt back: <em>“Your JSON had 2 empty fields. Based on the source text, can you fill those in? Here is your previous attempt: [JSON]”</em></li>
  <li><strong>Final:</strong> The agent outputs the complete, verified JSON.</li>
</ol>

<hr />

<h2 id="4-the-schema-first-vs-prompt-first-debate">4. The “Schema-First” vs. “Prompt-First” Debate</h2>

<p>Should you define your logic in the JSON Schema or the System Prompt?</p>

<ul>
  <li><strong>Schema-First:</strong> Put all constraints in the <code class="language-plaintext highlighter-rouge">description</code> fields of the Pydantic model.</li>
  <li><strong>Prompt-First:</strong> Put the logic in the main instruction block and keep the schema “Dumb.”</li>
  <li><strong>Verdict:</strong> <strong>Schema-First</strong> is more reliable. Language Models pay more attention to tokens that are close to where they are writing. By putting the instruction in the field description, you ensure the model “remembers” it as it generates the value.</li>
</ul>

<hr />

<h2 id="5-handling-token-overflows-in-json">5. Handling “Token Overflows” in JSON</h2>

<p>What if the LLM’s JSON is 5,000 tokens but your <code class="language-plaintext highlighter-rouge">max_tokens</code> is 4,000? The JSON will be cut off at the end, usually looking like <code class="language-plaintext highlighter-rouge">... "key": "val</code>.</p>

<p><strong>The Fix: Partial Parsing.</strong>
Use a library like <code class="language-plaintext highlighter-rouge">partialjson</code> or <code class="language-plaintext highlighter-rouge">json-stream</code>. These can parse a “Broken” JSON string and return as many valid keys as were successfully generated before the cutoff. This prevents the entire request from being a total loss.</p>

<hr />

<h2 id="6-security-the-json-bomb-and-denial-of-service">6. Security: The “JSON Bomb” and Denial of Service</h2>

<p>Malicious agents (or poisoned data) can output thousands of nested brackets: <code class="language-plaintext highlighter-rouge">[[[[[[[[...]]]]]]]]</code>.</p>

<p><strong>The Defense:</strong></p>
<ol>
  <li><strong>Max Depth:</strong> Set a hard limit (e.g., 5 levels) in your JSON recursive parser.</li>
  <li><strong>Schema Enforcement:</strong> Never use <code class="language-plaintext highlighter-rouge">Dict[str, Any]</code> in your production code. Always define every field.</li>
</ol>

<hr />

<h2 id="7-advanced-pattern-the-cot--json-hybrid">7. Advanced Pattern: The “CoT + JSON” Hybrid</h2>

<p>One of the biggest mistakes developers make is asking for <em>pure</em> JSON (essentially asking for the result without the thinking). When you force a model to output only JSON, you are training it to skip its “Reasoning” step.</p>

<p><strong>The Fix: The Reasoning Envelope.</strong>
Include a <code class="language-plaintext highlighter-rouge">thought_process</code> field as the <strong>first</strong> key in your schema. Because LLMs process tokens sequentially, this forces the model to “explain” its logic <em>before</em> it picks the final value for the data fields.</p>

<p><strong>Example Schema:</strong></p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
 </span><span class="nl">"thought_process"</span><span class="p">:</span><span class="w"> </span><span class="s2">"The user mentioned they are 25 but were born in 1998, which is consistent. They live in Paris, which is in France."</span><span class="p">,</span><span class="w">
 </span><span class="nl">"age"</span><span class="p">:</span><span class="w"> </span><span class="mi">25</span><span class="p">,</span><span class="w">
 </span><span class="nl">"country_code"</span><span class="p">:</span><span class="w"> </span><span class="s2">"FR"</span><span class="p">,</span><span class="w">
 </span><span class="nl">"confidence_score"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.95</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<p>By allowing this “Internal Monologue,” you increase the accuracy of the structured data by up to 30%, especially for complex extraction tasks.</p>

<hr />

<h2 id="8-schema-design-patterns-for-agents">8. Schema Design Patterns for Agents</h2>

<h3 id="31-the-envelope-pattern">3.1 The “Envelope” Pattern</h3>
<p>Wrap your data in a metadata layer. This allows your code to distinguish between an “Agent Answer” and an “Agent Error” using the same consistent JSON structure.</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
 </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"success"</span><span class="p">,</span><span class="w">
 </span><span class="nl">"payload"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="err">...</span><span class="w"> </span><span class="p">},</span><span class="w">
 </span><span class="nl">"error_msg"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
 </span><span class="nl">"execution_time_ms"</span><span class="p">:</span><span class="w"> </span><span class="mi">450</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h3 id="32-the-polymorphic-tool">3.2 The “Polymorphic” Tool</h3>
<p>Instead of having 10 different tools (which bloats the context window), use one <code class="language-plaintext highlighter-rouge">perform_action</code> tool that takes a <code class="language-plaintext highlighter-rouge">Union</code> of different types (e.g., <code class="language-plaintext highlighter-rouge">CreateUser</code>, <code class="language-plaintext highlighter-rouge">UpdateUser</code>).</p>

<h3 id="33-the-recursive-schema-pattern">3.3 The “Recursive Schema” Pattern</h3>
<p>For tasks like summarizing a document’s table of contents, use a schema that allows a node to have child nodes.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Header</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
 <span class="n">title</span><span class="p">:</span> <span class="nb">str</span>
 <span class="n">sub_headers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="sh">"</span><span class="s">Header</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Recursive!
</span></code></pre></div></div>
<p>This is essential for capturing hierarchical information without losing the parent-child relationships.</p>

<hr />

<h2 id="9-token-efficiency-the-math-of-json-keys">9. Token Efficiency: The Math of JSON Keys</h2>

<p>In a traditional API, key names like <code class="language-plaintext highlighter-rouge">user_authentication_timestamp_registered</code> are fine—they add clarity. In AI agents, <strong>Keys cost money.</strong></p>

<h3 id="41-the-compression-ratio">4.1 The Compression Ratio</h3>
<p>If you are processing 1 million requests a day:</p>
<ul>
  <li>Key <code class="language-plaintext highlighter-rouge">"account_balance_in_usd"</code> = 25 tokens.</li>
  <li>Key <code class="language-plaintext highlighter-rouge">"bal"</code> = 3 tokens.</li>
  <li><strong>Savings:</strong> 22 tokens per request. Over 1M requests, that’s <strong>22 Million tokens</strong> saved. At $10 per million tokens, you just saved $220/day with a single rename.</li>
</ul>

<h3 id="42-the-schema-mapping-solution">4.2 The “Schema-Mapping” Solution</h3>
<p>You can use a “Compressed Schema” for the LLM (with 1-letter keys) and then have a small Python function that maps <code class="language-plaintext highlighter-rouge">a -&gt; "account_name"</code>, <code class="language-plaintext highlighter-rouge">b -&gt; "balance"</code> before the data hits your database. This gives you the best of both worlds: extreme token efficiency and human-readable code.</p>

<hr />

<p>Use <strong>Pydantic</strong> classes to define your schemas. Pydantic handles the translation to JSON-Schema (which the LLM actually sees) and ensures that the model’s output is parsed into a clean Python object with full type safety.</p>

<p><strong>The Mini-Prompt Power:</strong>
The <code class="language-plaintext highlighter-rouge">Field(description="...")</code> parameter in Pydantic is your most powerful tool.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">UserProfile</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
 <span class="n">mood</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">One of [HAPPY, SAD, ANGRY]. Default to HAPPY if unclear.</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>
<p>The LLM provider (like OpenAI or Anthropic) takes these descriptions and injects them directly into the “System Instructions.” This is often more effective than writing a separate 5-page PDF of instructions because the instruction sits <strong>exactly where the model is deciding what to write</strong>.</p>

<hr />

<hr />

<h2 id="10-case-study-the-messy-legal-contract-parser">10. Case Study: The “Messy Legal Contract” Parser</h2>

<p>Structured output is the only way to convert unstructured PDFs into a SQL database. A legal agent reads a 100-page lease, extracts clauses into a recursive JSON structure, validates them against the source, and directly executes <code class="language-plaintext highlighter-rouge">INSERT</code> statements into a database.</p>

<hr />

<hr />

<h2 id="11-json-mode-vs-function-calling-which-one-to-use">11. JSON Mode vs. Function Calling: Which one to use?</h2>

<p>This is a common point of confusion for junior engineers. Both features force the model to output JSON, but they do it in different ways.</p>

<h3 id="81-json-mode-the-soft-constraint">8.1 JSON Mode (The “Soft” Constraint)</h3>
<p>In “JSON Mode,” you simply tell the model: <em>“You must output valid JSON.”</em> You then provide your schema in the system prompt.</p>
<ul>
  <li><strong>Pros:</strong> Flexible. The model can be slightly more conversational if allowed.</li>
  <li><strong>Cons:</strong> The model can still hallucinate a key or misspell a field name. You are responsible for all validation logic in your code.</li>
</ul>

<h3 id="112-function-calling-the-hard-constraint">11.2 Function Calling (The “Hard” Constraint)</h3>
<p>In Function Calling, the schema is passed as a <strong>Separate Parameter</strong> in the API call (the <code class="language-plaintext highlighter-rouge">tools</code> or <code class="language-plaintext highlighter-rouge">functions</code> array).</p>
<ul>
  <li><strong>Pros:</strong> The model is trained specifically to fill these “Slots.” Many providers also use constrained sampling (see <strong>Grammar-Based Sampling</strong> in Section 13) to keep outputs valid.</li>
  <li><strong>Cons:</strong> Slightly more restrictive. If your schema is too complex, the model might get confused and fail to “call” the function at all.</li>
</ul>

<p><strong>Verdict:</strong> Use <strong>Function Calling</strong> for 3rd-party tool use or database updates. Use <strong>JSON Mode</strong> for internal reasoning or data extraction where the exact key names are less critical than the data types.</p>

<hr />

<h2 id="12-schema-evolution-handling-versioning-in-production">12. Schema Evolution: Handling Versioning in Production</h2>

<p>What happens when you need to add a <code class="language-plaintext highlighter-rouge">middle_name</code> field to a user profile that’s used by 1,000 agents currently running?</p>

<h3 id="91-the-backwards-compatibility-rule">9.1 The “Backwards Compatibility” Rule</h3>
<p>Never delete a mandatory field. If you must remove a field, make it optional first, wait for all agents to update, and then remove it 30 days later.</p>

<h3 id="92-the-schema-registry-pattern">9.2 The “Schema Registry” Pattern</h3>
<p>In a large team, store your Pydantic models in a central library.</p>
<ul>
  <li><strong>Version 1:</strong> <code class="language-plaintext highlighter-rouge">class UserV1(BaseModel): name: str</code></li>
  <li><strong>Version 2:</strong> <code class="language-plaintext highlighter-rouge">class UserV2(BaseModel): name: str, age: int</code>
By keeping both versions in code, you can use a <strong>Transformation Agent</strong> to “Up-convert” any older checkpoints (State Management) from V1 to V2 as they are loaded.</li>
</ul>

<hr />

<h2 id="13-grammar-based-sampling-the-outlines-revolution">13. Grammar-Based Sampling: The “Outlines” Revolution</h2>

<p>For open-source models, you can use <strong>Grammar-Based Sampling</strong> (Outlines/Guidance). This modifies the model’s logits at every token, making it <strong>mathematically impossible</strong> for the model to output invalid JSON. This moves your reliability from 99% to 100%.</p>

<hr />

<h2 id="14-the-json-schema-masterclass-field-descriptions">14. The JSON Schema Masterclass: Field Descriptions</h2>

<p>The <code class="language-plaintext highlighter-rouge">description</code> field in your Pydantic model is a <strong>Mini-Prompt</strong>. Most LLM providers inject these descriptions into the system instructions. A precise description like <em>“Integer between 1 and 100. If unknown, return -1”</em> is more effective than a 5-page PDF of instructions.</p>

<hr />

<h2 id="15-security-type-safety--json-bombs">15. Security: Type Safety &amp; JSON Bombs</h2>

<p>Don’t trust the agent’s JSON.</p>
<ul>
  <li><strong>Sanitization:</strong> Guard against XSS markers in string values.</li>
  <li><strong>Recursion Limits:</strong> Set a max depth in your parser to prevent “Recursive JSON Bombs” from crashing your server.</li>
  <li><strong>Strict Typing:</strong> Use Pydantic’s <code class="language-plaintext highlighter-rouge">strict=True</code> to prevent the model from successfully outputting <code class="language-plaintext highlighter-rouge">"10"</code> when an <code class="language-plaintext highlighter-rouge">int</code> 10 is required.</li>
</ul>

<hr />

<h2 id="16-multi-modal-structured-output">16. Multi-Modal Structured Output</h2>

<p>Link AI Vision to UI Graphics. An agent looks at a photo, outputs the <code class="language-plaintext highlighter-rouge">[x, y]</code> coordinates of an object in JSON, and your React frontend uses that data to render an interactive label over the image.</p>

<hr />

<hr />

<h2 id="17-the-plan-schema-structuring-agent-thought-dags">17. The “Plan” Schema: Structuring Agent Thought (DAGs)</h2>

<p>For complex agents, you don’t just want one step. You want a <strong>Plan</strong>.</p>

<p><strong>The DAG Schema:</strong></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Step</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
 <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span>
 <span class="n">tool</span><span class="p">:</span> <span class="nb">str</span>
 <span class="n">args</span><span class="p">:</span> <span class="nb">dict</span>
 <span class="n">dependencies</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">class</span> <span class="nc">Plan</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
 <span class="n">steps</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Step</span><span class="p">]</span>
</code></pre></div></div>
<p>By structuring the plan as a <strong>Directed Acyclic Graph (DAG)</strong>, your orchestrator can look at the <code class="language-plaintext highlighter-rouge">dependencies</code> list and execute steps 1, 3, and 5 in parallel if they don’t depend on each other. This reduces your total task latency by up to 50%.</p>

<hr />

<h2 id="18-data-integrity-the-double-verification-pattern">18. Data Integrity: The “Double Verification” Pattern</h2>

<p>Even with structured output, the LLM can still “Lie” (Hallucinate) within the JSON.</p>

<p><strong>The Workflow:</strong></p>
<ol>
  <li><strong>Agent A (The Extractor):</strong> Takes an image and outputs <code class="language-plaintext highlighter-rouge">{ "price": 99.99 }</code>.</li>
  <li><strong>Agent B (The Auditor):</strong> Takes the <em>same</em> image and the <em>JSON</em> from Agent A.</li>
  <li><strong>Task:</strong> “Verify that the price in the JSON matches the image exactly. If not, output a corrected JSON.”</li>
  <li><strong>Result:</strong> This “Cross-Check” is the highest form of reliability in current AI engineering.</li>
</ol>

<hr />

<h2 id="19-performance-detail-handling-dates--decimals">19. Performance Detail: Handling Dates &amp; Decimals</h2>

<p>LLMs are notoriously bad at formatting Dates and Decimals inside JSON.</p>
<ul>
  <li><strong>Fix:</strong> Force the agent to output dates as ISO-8601 strings and let your Python code handle the conversion to <code class="language-plaintext highlighter-rouge">datetime</code> objects.</li>
  <li><strong>Fix:</strong> Use <code class="language-plaintext highlighter-rouge">float</code> with 2 decimal place constraints in your schema to prevent the model from outputting scientific notation for currency.</li>
</ul>

<hr />

<h2 id="20-the-self-documenting-agent">20. The “Self-Documenting” Agent</h2>

<p>Ask your agent to output a JSON object that describes its own capabilities. This allows your frontend to dynamically render “Help Tooltips” or “Command Menus” without you having to hardcode them.</p>

<hr />

<hr />

<h2 id="21-security-sanitizing-json-values-parameter-injection">21. Security: Sanitizing JSON Values (Parameter Injection)</h2>

<p>Just because the output is JSON doesn’t mean it’s safe.</p>

<p><strong>The Vulnerability:</strong>
Imagine your agent outputs a JSON that you then pass directly into a SQL query:</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="nl">"user_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"123; DROP TABLE users;"</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<p><strong>The Fix: Strict Validation.</strong>
In Pydantic, use <code class="language-plaintext highlighter-rouge">UUID</code> or <code class="language-plaintext highlighter-rouge">EmailStr</code> types instead of raw strings. This forces the parser to reject anything that doesn’t follow the exact format, killing injection attacks before they touch your database.</p>

<hr />

<h2 id="22-future-trends-native-structural-encoding">22. Future Trends: Native Structural Encoding</h2>

<p>We are moving away from “Prompting” for JSON and toward <strong>Native Constraints</strong>.</p>

<h3 id="251-speculative-decoding-for-json">25.1 Speculative Decoding for JSON</h3>
<p>Models are being trained to predict the <em>structure</em> of a JSON block much faster than the <em>content</em>. This allows for ultra-fast “Structural Prefills” where the model generates the keys almost instantly.</p>

<h3 id="252-multi-scale-schemas">25.2 Multi-Scale Schemas</h3>
<p>Instead of one giant 1MB schema, agents will use <strong>Adaptive Schemas</strong>. The orchestrator detects the task and sends only the specific “Branch” of the schema needed, saving 90% on input tokens.</p>

<hr />

<h2 id="23-the-unit-test-for-schemas-how-to-test-your-agent">23. The “Unit Test” for Schemas: How to Test Your Agent</h2>

<p>How do you know if your Pydantic model is “Agent-Friendly”?</p>

<p><strong>The Mock Test:</strong></p>
<ol>
  <li><strong>Generate:</strong> Use a top-tier model (GPT-4o) to generate 100 “Edge Case” JSONs that follow your schema.</li>
  <li><strong>Validate:</strong> Try to parse those JSONs into your Pydantic objects.</li>
  <li><strong>Refine:</strong> If the model struggles to generate valid data for a specific field, the field’s <code class="language-plaintext highlighter-rouge">description</code> is likely too vague. Update the description and repeat.</li>
</ol>

<hr />

<h2 id="24-faq-advanced-troubleshooting">24. FAQ: Advanced Troubleshooting</h2>

<p><strong>Q: My agent keeps outputting ‘JSON’ as a string inside the value. Why?</strong>
A: This is a “Conversational Drift” error. The model is confusing the <em>format</em> of the output with the <em>content</em>.</p>
<ul>
  <li><strong>Fix:</strong> Add a negative constraint: <em>“Do not include the word ‘JSON’ inside the data values unless specifically requested.”</em></li>
</ul>

<p><strong>Q: How do I handle circular dependencies in my schema?</strong>
A: <strong>Don’t.</strong> Circular dependencies (e.g., A contains B, B contains A) will crash almost any JSON parser. Instead, use “References” (IDs) and have the agent output a flat list of objects that link to each other.</p>

<p><strong>Q: Is YAML better for small models?</strong>
A: Sometimes. YAML is more human-readable and takes fewer tokens (no braces). However, because YAML relies on indentation, even a single space error can break the entire file. For <strong>reliability</strong>, JSON is still the winner.</p>

<p><strong>Q: Can I use structured output to generate code?</strong>
A: Yes. Instead of raw text, have the agent output a JSON object: <code class="language-plaintext highlighter-rouge">{ "language": "python", "code": "...", "unit_tests": "..." }</code>. This allows you to programmatically isolate the code and run it in a sandbox.</p>

<p><strong>Q: Why does my agent hallucinate keys that aren’t in the schema?</strong>
A: This is often caused by “Leakage” from the model’s training data. If the model has seen a thousand “Invoice” schemas on GitHub, it will try to add <code class="language-plaintext highlighter-rouge">tax_rate</code> to your schema even if you didn’t ask for it. Force it to stop with <code class="language-plaintext highlighter-rouge">extra='forbid'</code> (see the security + strict typing guidance in Section 15).</p>

<hr />

<h2 id="25-complex-example-the-e-commerce-support-ticket-schema">25. Complex Example: The “E-commerce Support Ticket” Schema</h2>

<p>Let’s look at a production-grade schema for a ticket-routing agent.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Ticket</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
 <span class="n">thought</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(...,</span> <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">Reasoning about the user</span><span class="sh">'</span><span class="s">s intent</span><span class="sh">"</span><span class="p">)</span>
 <span class="n">priority</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">le</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
 <span class="n">category</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="sh">"</span><span class="s">Billing</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">Technical</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">Shipping</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">General</span><span class="sh">"</span><span class="p">]</span>
 <span class="n">entities</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">Extracted IDs, emails, etc</span><span class="sh">"</span><span class="p">)</span>
 <span class="n">next_step</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(...,</span> <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">Action to take: [REPLY, ESCALATE, WAIT]</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="301-why-this-works">30.1 Why this works</h3>
<ol>
  <li><strong>Reasoning First:</strong> The <code class="language-plaintext highlighter-rouge">thought</code> key forces the model to categorize correctly.</li>
  <li><strong>Range Constraints:</strong> <code class="language-plaintext highlighter-rouge">ge=1, le=5</code> prevents the model from outputting <code class="language-plaintext highlighter-rouge">priority: 99</code>.</li>
  <li><strong>Strict Categories:</strong> <code class="language-plaintext highlighter-rouge">Literal</code> ensures the database doesn’t crash on a “Billing support” category it doesn’t recognize.</li>
</ol>

<hr />

<h2 id="26-the-future-schema-driven-small-language-models-slms">26. The Future: “Schema-Driven” Small Language Models (SLMs)</h2>

<p>We are seeing a trend where 1.5B and 7B parameter models (like Phi-3 or Llama-3-8B) are being fine-tuned <strong>specifically</strong> on structured output.</p>

<ul>
  <li><strong>The Result:</strong> A 7B model that is 100% accurate at JSON formatting can replace a 1T model (GPT-4) for 90% of extraction tasks.</li>
  <li><strong>The Strategy:</strong> As a junior engineer, always start with a big model to “Design the Schema,” but then try to “Downgrade” to a smaller model to save 99% of your costs once the schema is stable.</li>
</ul>

<hr />

<h2 id="27-handling-non-latin-characters-and-localization-in-json">27. Handling Non-Latin Characters and Localization in JSON</h2>

<p>LLMs can sometimes struggle with JSON formatting when the content is in Chinese, Arabic, or Emoji.</p>

<ul>
  <li><strong>The Problem:</strong> Unicode characters can take multiple tokens, sometimes “confusing” the model’s bracket-matching logic.</li>
  <li><strong>The Fix:</strong> Use <code class="language-plaintext highlighter-rouge">ensure_ascii=False</code> when testing your local parsers, and ensure your system prompt explicitly allows UTF-8 in string values.</li>
</ul>

<hr />

<h2 id="28-benchmarking-model-accuracy-for-json">28. Benchmarking Model Accuracy for JSON</h2>

<p>Not all models are created equal for structured data.</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Model</th>
      <th style="text-align: left">JSON Accuracy (Complex Nested)</th>
      <th style="text-align: left">Tool Call Reliability</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left"><strong>GPT-4o</strong></td>
      <td style="text-align: left">99%</td>
      <td style="text-align: left">Excellent</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Claude 3.5 Sonnet</strong></td>
      <td style="text-align: left">98.5%</td>
      <td style="text-align: left">Exceptional</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Llama-3-70B</strong></td>
      <td style="text-align: left">95%</td>
      <td style="text-align: left">Good</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Mistral Large 2</strong></td>
      <td style="text-align: left">94%</td>
      <td style="text-align: left">Good</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Gemini 1.5 Pro</strong></td>
      <td style="text-align: left">97%</td>
      <td style="text-align: left">Excellent (Large Context)</td>
    </tr>
  </tbody>
</table>

<ul>
  <li><strong>Pro Tip:</strong> If your agent is failing to output JSON, it’s often more effective to <strong>Change the Model</strong> than to write a 10-page prompt.</li>
</ul>

<hr />

<h2 id="29-json-vs-python-code-generation-when-to-use-which">29. JSON vs. Python Code Generation: When to Use Which?</h2>

<p>Sometimes, JSON isn’t enough. If you need the agent to perform a complex calculation (e.g., <em>“Calculate the mortgage interest over 30 years with a variable rate”</em>), a JSON object with a <code class="language-plaintext highlighter-rouge">result</code> field will likely be wrong.</p>

<ul>
  <li><strong>The Python Pattern:</strong> Instead of asking for JSON, ask the agent to output a <strong>Python Script</strong>.</li>
  <li><strong>The Workflow:</strong>
    <ol>
      <li>Agent writes a Python function.</li>
      <li>The orchestrator runs the code in a <strong>Secure Sandbox</strong>.</li>
      <li>The result of the code is the “Answer.”</li>
    </ol>
  </li>
  <li><strong>Verdict:</strong> Use <strong>JSON</strong> for data state and tool parameters. Use <strong>Code Generation</strong> for math, logic, and data transformation.</li>
</ul>

<hr />

<h2 id="30-the-self-correction-loop-in-detail">30. The “Self-Correction” Loop in Detail</h2>

<p>As a junior engineer, your first <code class="language-plaintext highlighter-rouge">while</code> loop should be a <strong>JSON Recovery Loop</strong>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">retries</span> <span class="o">=</span> <span class="mi">3</span>
<span class="k">while</span> <span class="n">retries</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
 <span class="k">try</span><span class="p">:</span>
 <span class="n">raw_output</span> <span class="o">=</span> <span class="n">llm</span><span class="p">.</span><span class="nf">generate</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
 <span class="n">data</span> <span class="o">=</span> <span class="n">UserSchema</span><span class="p">.</span><span class="nf">model_validate_json</span><span class="p">(</span><span class="n">raw_output</span><span class="p">)</span>
 <span class="k">return</span> <span class="n">data</span> <span class="c1"># Success!
</span> <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
 <span class="c1"># Pass the SPECIFIC pydantic error back to the model
</span> <span class="n">prompt</span> <span class="o">+=</span> <span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="s">Error in your last JSON: </span><span class="si">{</span><span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s">. Please correct it.</span><span class="sh">"</span>
 <span class="n">retries</span> <span class="o">-=</span> <span class="mi">1</span>
</code></pre></div></div>
<p>This simple loop increases your system’s reliability from 90% to 99.9%. By providing the model with the exact line and type of the error, you are giving it the “Map” it needs to fix itself.</p>

<hr />

<h2 id="31-large-scale-schema-management-prompt-governance">31. Large Scale Schema Management (Prompt Governance)</h2>

<p>In a company with 50 different agents, you cannot just copy-paste schemas. You need a <strong>Schema Registry</strong>.</p>

<ol>
  <li><strong>Central Library:</strong> Store your Pydantic models in a shared Git repo.</li>
  <li><strong>Versioning:</strong> Tag your schemas (e.g., <code class="language-plaintext highlighter-rouge">invoice_schema_v2</code>).</li>
  <li><strong>Automatic Testing:</strong> Every time you update the schema, run a script that tests 5 different LLMs against it to ensure no regressions in accuracy.</li>
</ol>

<hr />

<h2 id="32-monitoring-schema-drift-the-silent-failure">32. Monitoring “Schema Drift”: The Silent Failure</h2>

<p>Sometimes, an LLM provider updates their model and it starts adding extra whitespace or different escaping characters to its JSON.</p>

<p><strong>The Fix: The “Consistency” Dashboard.</strong>
Track the “Parsing Failure Rate” in your observability tool. If the rate jumps from 0.1% to 2% on a Tuesday morning, you know that the model provider has changed something behind the scenes, and you need to update your <strong>Retry Logic</strong> or your <strong>Validation Schema</strong>.</p>

<hr />

<h2 id="33-key-takeaways--junior-engineer-roadmap">33. Key Takeaways &amp; Junior Engineer Roadmap</h2>

<p>Structured output is the “Final Frontier” of agentic reliability.</p>

<h3 id="step-1-the-scraper-1">Step 1: The Scraper</h3>
<p>Learn to use Pydantic to extract data from messy text. This is the “Hello World” of structured output.</p>

<h3 id="step-2-the-action-taker-1">Step 2: The Action-Taker</h3>
<p>Connect your Pydantic schemas to actual Python functions. When the agent outputs a <code class="language-plaintext highlighter-rouge">ChargeCard</code> object, the money actually moves. This requires <strong>High-Stakes Validation</strong>.</p>

<h3 id="step-3-the-architect-1">Step 3: The Architect</h3>
<p>Design a recursive, self-healing system where agents can update their own schemas and communicate via complex DAGs.</p>

<p><strong>Final Project Idea:</strong> build a “News Investigator.”</p>
<ol>
  <li><strong>Input:</strong> A broad topic (e.g., “AI Regulation”).</li>
  <li><strong>Agent:</strong> Searches the web, parses 10 articles into a structured <code class="language-plaintext highlighter-rouge">ResearchNode</code> schema.</li>
  <li><strong>Orchestrator:</strong> Validates the nodes, identifies missing info, and sends a “Delta Schema” back to the agent to fill in the gaps.</li>
  <li><strong>Output:</strong> A 100% verified, structured Knowledge Graph.</li>
</ol>

<p><strong>Congratulations!</strong> You’ve completed the communication trilogy. You now know how to design roles, manage state, and communicate precisely.</p>

<hr />

<h2 id="34-double-logic-link-interfaces-and-mapping">34. Double Logic Link: Interfaces and Mapping</h2>

<p>In the DSA track, we solve <strong>Design Twitter</strong>. This is about defining <strong>Interfaces</strong>. A Tweet is a structured object. If your API doesn’t follow the schema, the system crashes. Structured output is the “Interface of the Agent.”</p>

<p>In the ML track, we look at <strong>Recommendation Systems</strong>. RecSys takes messy user history and maps it into <strong>Structured Embeddings</strong>. Structured output is how we map a user’s natural language bio into structured “Interest Categories” that a RecSys can consume.</p>

        
      </section>

      <footer class="page__meta">
        
        
  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      <a href="/tags/#function-calling" class="page__taxonomy-item p-category" rel="tag">function-calling</a><span class="sep">, </span>
    
      <a href="/tags/#json-mode" class="page__taxonomy-item p-category" rel="tag">json-mode</a><span class="sep">, </span>
    
      <a href="/tags/#pydantic" class="page__taxonomy-item p-category" rel="tag">pydantic</a><span class="sep">, </span>
    
      <a href="/tags/#schema-design" class="page__taxonomy-item p-category" rel="tag">schema-design</a><span class="sep">, </span>
    
      <a href="/tags/#structured-output" class="page__taxonomy-item p-category" rel="tag">structured-output</a>
    
    </span>
  </p>




  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      <a href="/categories/#ai-agents" class="page__taxonomy-item p-category" rel="tag">ai-agents</a>
    
    </span>
  </p>


        
      </footer>

      <div class="page__related page__related--full">
  <h2 class="page__related-title">Related across topics</h2>
  <style>
    /* Make section span full content width and use 2 equal columns */
    .page__related--full { float: inline-start; width: 100%; padding: 0; }
    .cross-related-grid { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 2rem; }
    @media (max-width: 768px) { .cross-related-grid { grid-template-columns: 1fr; } }
    /* Ensure archive cards stretch nicely in the grid */
    .cross-related-grid .list__item, .cross-related-grid .grid__item { width: auto; float: none; margin: 0; }
  </style>
  <div class="cross-related-grid">
    



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/dsa/0035-surrounded-regions/" rel="permalink">Surrounded Regions (DFS/BFS)
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          20 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">“Capturing regions by identifying safe boundaries.”
</p>
  </article>
</div>




<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/ml-system-design/0035-boundary-detection-in-ml/" rel="permalink">Boundary Detection in ML
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          19 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">“Defining where one object ends and another begins.”
</p>
  </article>
</div>




<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/speech-tech/0035-speech-boundary-detection/" rel="permalink">Speech Boundary Detection
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          19 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">“Knowing when to listen and when to stop.”
</p>
  </article>
</div>

  </div>
</div>

      <section class="page__share">
  <h4 class="page__share-title">Share on</h4>

  <a href="https://twitter.com/intent/tweet?via=arunbaby0&text=Structured+Output+Patterns%20https%3A%2F%2Fwww.arunbaby.com%2Fai-agents%2F0035-structured-output-patterns%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fwww.arunbaby.com%2Fai-agents%2F0035-structured-output-patterns%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://www.arunbaby.com/ai-agents/0035-structured-output-patterns/" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/ai-agents/0034-observability-tracing/" class="pagination--pager" title="Observability and Tracing">Previous</a>
    
    
      <a href="/ai-agents/0036-web-browsing-agents/" class="pagination--pager" title="Web Browsing Agents">Next</a>
    
  </nav>


    </div>

    
  </article>

  
  
</div>

      
    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';" role="search">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    
      
        
          <li><a href="https://twitter.com/arunbaby0" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
        
      
        
          <li><a href="https://github.com/arunbaby0" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
        
          <li><a href="https://www.linkedin.com/in/arunbaby0/" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i> LinkedIn</a></li>
        
      
        
          <li><a href="https://scholar.google.co.in/citations?user=6fSYWhkAAAAJ" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-graduation-cap" aria-hidden="true"></i> Google Scholar</a></li>
        
      
    

    
      <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 1990 - 2143 <a href="https://www.arunbaby.com">Arun Baby</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>




  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-0JRJPEC9SS"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-0JRJPEC9SS', { 'anonymize_ip': false});
</script>








  </body>
</html>
