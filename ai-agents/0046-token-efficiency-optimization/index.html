<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.26.2 by Michael Rose
  Copyright 2013-2024 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->

<html lang="en-US" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Token Efficiency Optimization - Arun Baby</title>
<meta name="description" content="“Every token has a cost—make each one count.”">


  <meta name="author" content="Arun Baby">
  
  <meta property="article:author" content="Arun Baby">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Arun Baby">
<meta property="og:title" content="Token Efficiency Optimization">
<meta property="og:url" content="https://www.arunbaby.com/ai-agents/0046-token-efficiency-optimization/">


  <meta property="og:description" content="“Every token has a cost—make each one count.”">



  <meta property="og:image" content="https://www.arunbaby.com/assets/images/profile-photo.png">



  <meta name="twitter:site" content="@arunbaby0">
  <meta name="twitter:title" content="Token Efficiency Optimization">
  <meta name="twitter:description" content="“Every token has a cost—make each one count.”">
  <meta name="twitter:url" content="https://www.arunbaby.com/ai-agents/0046-token-efficiency-optimization/">

  
    <meta name="twitter:card" content="summary">
    
      <meta name="twitter:image" content="https://www.arunbaby.com/assets/images/profile-photo.png">
    
  

  



  <meta property="article:published_time" content="2025-12-21T22:46:31+05:30">





  

  


<link rel="canonical" href="https://www.arunbaby.com/ai-agents/0046-token-efficiency-optimization/">












<!-- end _includes/seo.html -->



  <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Arun Baby Feed">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
  
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css"></noscript>



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single" dir="ltr">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
           
          <span class="site-subtitle">Arun Baby</span>
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a
                href="/about/"
                
                
              >About</a>
            </li><li class="masthead__menu-item">
              <a
                href="/dsa/"
                
                
              >DSA</a>
            </li><li class="masthead__menu-item">
              <a
                href="/ml-system-design/"
                
                
              >ML Systems</a>
            </li><li class="masthead__menu-item">
              <a
                href="/speech-tech/"
                
                
              >Speech Tech</a>
            </li><li class="masthead__menu-item">
              <a
                href="/ai-agents/"
                
                
              >AI Agents</a>
            </li><li class="masthead__menu-item">
              <a
                href="/publications/"
                
                
              >Publications</a>
            </li><li class="masthead__menu-item">
              <a
                href="/statuses/"
                
                
              >Statuses</a>
            </li><li class="masthead__menu-item">
              <a
                href="/contact/"
                
                
              >Contact</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <i class="fas fa-search"></i>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      





<div id="main" role="main" class="no-author-sidebar">
  
  <div class="sidebar sticky">
  
  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Token Efficiency Optimization">
    <meta itemprop="description" content="“Every token has a cost—make each one count.”">
    <meta itemprop="datePublished" content="2025-12-21T22:46:31+05:30">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">
            <a href="https://www.arunbaby.com/ai-agents/0046-token-efficiency-optimization/" itemprop="url">Token Efficiency Optimization
</a>
          </h1>
          

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          26 minute read
        
      </span>
    
  </p>


        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right sticky">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> On this page</h4></header>
              <ul class="toc__menu"><li><a href="#1-introduction">1. Introduction</a><ul><li><a href="#why-token-efficiency-matters">Why Token Efficiency Matters</a></li><li><a href="#the-token-efficiency-triad">The Token Efficiency Triad</a></li></ul></li><li><a href="#2-core-concepts">2. Core Concepts</a><ul><li><a href="#21-understanding-tokenization">2.1 Understanding Tokenization</a></li><li><a href="#22-token-cost-breakdown">2.2 Token Cost Breakdown</a></li></ul></li><li><a href="#3-optimization-strategies">3. Optimization Strategies</a><ul><li><a href="#31-system-prompt-optimization">3.1 System Prompt Optimization</a></li><li><a href="#32-tool-definition-optimization">3.2 Tool Definition Optimization</a></li><li><a href="#33-context-window-management">3.3 Context Window Management</a></li><li><a href="#34-response-optimization">3.4 Response Optimization</a></li></ul></li><li><a href="#4-advanced-techniques">4. Advanced Techniques</a><ul><li><a href="#41-semantic-caching">4.1 Semantic Caching</a></li><li><a href="#42-prompt-compilation">4.2 Prompt Compilation</a></li><li><a href="#43-model-routing">4.3 Model Routing</a></li></ul></li><li><a href="#5-monitoring-and-analytics">5. Monitoring and Analytics</a></li><li><a href="#6-connection-to-transfer-learning">6. Connection to Transfer Learning</a></li><li><a href="#7-real-world-case-study-stripes-agent-token-optimization">7. Real-World Case Study: Stripe’s Agent Token Optimization</a></li><li><a href="#8-key-takeaways">8. Key Takeaways</a></li></ul>
            </nav>
          </aside>
        
        <p><strong>“Every token has a cost—make each one count.”</strong></p>

<h2 id="1-introduction">1. Introduction</h2>

<p>Token efficiency is the art and science of achieving the same AI agent capabilities while using fewer tokens. In production systems processing millions of requests, token optimization isn’t just about cost savings—it directly impacts latency, throughput, and user experience.</p>

<h3 id="why-token-efficiency-matters">Why Token Efficiency Matters</h3>

<p>Consider a production agent handling 1 million requests per day:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Naive Implementation:
- Average tokens per request: 4,000 (input) + 1,000 (output) = 5,000
- Monthly tokens: 5,000 × 1M × 30 = 150 billion tokens
- Cost (GPT-4): ~$4.5M/month

Optimized Implementation:
- Average tokens per request: 1,500 (input) + 500 (output) = 2,000
- Monthly tokens: 2,000 × 1M × 30 = 60 billion tokens
- Cost: ~$1.8M/month
- Savings: $2.7M/month (60% reduction)
</code></pre></div></div>

<h3 id="the-token-efficiency-triad">The Token Efficiency Triad</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌─────────────────────────────────────────────────────────────────┐
│                    Token Efficiency Triad                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│                        ┌─────────┐                              │
│                        │  COST   │                              │
│                        └────┬────┘                              │
│                             │                                   │
│                             │                                   │
│              ┌──────────────┼──────────────┐                    │
│              │              │              │                    │
│              ▼              ▼              ▼                    │
│        ┌─────────┐    ┌─────────┐    ┌─────────┐               │
│        │ LATENCY │    │ QUALITY │    │THROUGHPUT│               │
│        └─────────┘    └─────────┘    └─────────┘               │
│                                                                 │
│   Balance: Reduce tokens without sacrificing quality            │
│   Fewer tokens = faster responses = higher throughput           │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
</code></pre></div></div>

<h2 id="2-core-concepts">2. Core Concepts</h2>

<h3 id="21-understanding-tokenization">2.1 Understanding Tokenization</h3>

<p>Tokens are the atomic units of LLM processing. Understanding how text becomes tokens is essential for optimization:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">tiktoken</span>

<span class="k">def</span> <span class="nf">analyze_tokenization</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">gpt-4</span><span class="sh">"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Analyze how text is tokenized.
    
    Key insights for optimization:
    - Common words = fewer tokens
    - Rare words/names = more tokens
    - Whitespace matters
    - Formatting has cost
    </span><span class="sh">"""</span>
    <span class="n">encoding</span> <span class="o">=</span> <span class="n">tiktoken</span><span class="p">.</span><span class="nf">encoding_for_model</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="n">encoding</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    
    <span class="c1"># Analyze token efficiency
</span>    <span class="n">chars_per_token</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="o">/</span> <span class="nf">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
    
    <span class="c1"># Find expensive tokens (single chars = inefficient)
</span>    <span class="n">token_lengths</span> <span class="o">=</span> <span class="p">[</span><span class="nf">len</span><span class="p">(</span><span class="n">encoding</span><span class="p">.</span><span class="nf">decode</span><span class="p">([</span><span class="n">t</span><span class="p">]))</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">]</span>
    <span class="n">inefficient_count</span> <span class="o">=</span> <span class="nf">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">token_lengths</span> <span class="k">if</span> <span class="n">l</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">text_length</span><span class="sh">"</span><span class="p">:</span> <span class="nf">len</span><span class="p">(</span><span class="n">text</span><span class="p">),</span>
        <span class="sh">"</span><span class="s">token_count</span><span class="sh">"</span><span class="p">:</span> <span class="nf">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">),</span>
        <span class="sh">"</span><span class="s">chars_per_token</span><span class="sh">"</span><span class="p">:</span> <span class="n">chars_per_token</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">inefficient_tokens</span><span class="sh">"</span><span class="p">:</span> <span class="n">inefficient_count</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">efficiency_score</span><span class="sh">"</span><span class="p">:</span> <span class="n">chars_per_token</span> <span class="o">/</span> <span class="mf">4.0</span><span class="p">,</span>  <span class="c1"># 4 is typical
</span>        <span class="sh">"</span><span class="s">tokens</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">encoding</span><span class="p">.</span><span class="nf">decode</span><span class="p">([</span><span class="n">t</span><span class="p">])</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">]</span>
    <span class="p">}</span>


<span class="c1"># Example analysis
</span><span class="n">examples</span> <span class="o">=</span> <span class="p">[</span>
    <span class="sh">"</span><span class="s">The quick brown fox jumps</span><span class="sh">"</span><span class="p">,</span>           <span class="c1"># Common words: efficient
</span>    <span class="sh">"</span><span class="s">Supercalifragilisticexpialidocious</span><span class="sh">"</span><span class="p">,</span>  <span class="c1"># Rare word: inefficient
</span>    <span class="sh">"</span><span class="s">   lots   of   spaces   </span><span class="sh">"</span><span class="p">,</span>            <span class="c1"># Whitespace: wasteful
</span>    <span class="sh">"</span><span class="s">JSON: {</span><span class="se">\"</span><span class="s">key</span><span class="se">\"</span><span class="s">: </span><span class="se">\"</span><span class="s">value</span><span class="se">\"</span><span class="s">}</span><span class="sh">"</span><span class="p">,</span>          <span class="c1"># Punctuation: moderate
</span><span class="p">]</span>

<span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">examples</span><span class="p">:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="nf">analyze_tokenization</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"'</span><span class="si">{</span><span class="n">text</span><span class="p">[</span><span class="si">:</span><span class="mi">30</span><span class="p">]</span><span class="si">}</span><span class="s">...</span><span class="sh">'"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  Tokens: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="sh">'</span><span class="s">token_count</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s">, Efficiency: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="sh">'</span><span class="s">efficiency_score</span><span class="sh">'</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="22-token-cost-breakdown">2.2 Token Cost Breakdown</h3>

<p>Understanding where tokens are spent in an agent:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span>
<span class="kn">import</span> <span class="n">tiktoken</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">TokenBudget</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Track token allocation across agent components.</span><span class="sh">"""</span>
    
    <span class="n">system_prompt</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">context_window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">tool_definitions</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">conversation_history</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">current_input</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">reasoning_output</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">tool_calls</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">final_response</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">total_input</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="nf">return </span><span class="p">(</span>
            <span class="n">self</span><span class="p">.</span><span class="n">system_prompt</span> <span class="o">+</span> 
            <span class="n">self</span><span class="p">.</span><span class="n">context_window</span> <span class="o">+</span> 
            <span class="n">self</span><span class="p">.</span><span class="n">tool_definitions</span> <span class="o">+</span> 
            <span class="n">self</span><span class="p">.</span><span class="n">conversation_history</span> <span class="o">+</span> 
            <span class="n">self</span><span class="p">.</span><span class="n">current_input</span>
        <span class="p">)</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">total_output</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">reasoning_output</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">tool_calls</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">final_response</span>
    
    <span class="k">def</span> <span class="nf">get_breakdown</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">Get percentage breakdown of token usage.</span><span class="sh">"""</span>
        <span class="n">total</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">total_input</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">total_output</span>
        <span class="k">if</span> <span class="n">total</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">system_prompt</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">system_prompt</span> <span class="o">/</span> <span class="n">total</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">context_window</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">context_window</span> <span class="o">/</span> <span class="n">total</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">tool_definitions</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">tool_definitions</span> <span class="o">/</span> <span class="n">total</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">conversation_history</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">conversation_history</span> <span class="o">/</span> <span class="n">total</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">current_input</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">current_input</span> <span class="o">/</span> <span class="n">total</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">reasoning_output</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">reasoning_output</span> <span class="o">/</span> <span class="n">total</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">tool_calls</span> <span class="o">/</span> <span class="n">total</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">final_response</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">final_response</span> <span class="o">/</span> <span class="n">total</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
        <span class="p">}</span>


<span class="k">class</span> <span class="nc">TokenAnalyzer</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Analyze token usage across agent interactions.</span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">gpt-4</span><span class="sh">"</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="n">tiktoken</span><span class="p">.</span><span class="nf">encoding_for_model</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">count_tokens</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">encoding</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>
    
    <span class="k">def</span> <span class="nf">analyze_agent_request</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">system_prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span>
        <span class="n">history</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span>
        <span class="n">user_input</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TokenBudget</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">Analyze token usage for an agent request.</span><span class="sh">"""</span>
        
        <span class="n">budget</span> <span class="o">=</span> <span class="nc">TokenBudget</span><span class="p">()</span>
        
        <span class="c1"># System prompt
</span>        <span class="n">budget</span><span class="p">.</span><span class="n">system_prompt</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">count_tokens</span><span class="p">(</span><span class="n">system_prompt</span><span class="p">)</span>
        
        <span class="c1"># Tool definitions
</span>        <span class="kn">import</span> <span class="n">json</span>
        <span class="n">tools_str</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span>
        <span class="n">budget</span><span class="p">.</span><span class="n">tool_definitions</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">count_tokens</span><span class="p">(</span><span class="n">tools_str</span><span class="p">)</span>
        
        <span class="c1"># Conversation history
</span>        <span class="n">history_tokens</span> <span class="o">=</span> <span class="nf">sum</span><span class="p">(</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">count_tokens</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">history</span>
        <span class="p">)</span>
        <span class="n">budget</span><span class="p">.</span><span class="n">conversation_history</span> <span class="o">=</span> <span class="n">history_tokens</span>
        
        <span class="c1"># Current input
</span>        <span class="n">budget</span><span class="p">.</span><span class="n">current_input</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">count_tokens</span><span class="p">(</span><span class="n">user_input</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">budget</span>
    
    <span class="k">def</span> <span class="nf">identify_optimization_opportunities</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span> 
        <span class="n">budget</span><span class="p">:</span> <span class="n">TokenBudget</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">Identify where tokens can be saved.</span><span class="sh">"""</span>
        <span class="n">opportunities</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">breakdown</span> <span class="o">=</span> <span class="n">budget</span><span class="p">.</span><span class="nf">get_breakdown</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">breakdown</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">system_prompt</span><span class="sh">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">:</span>
            <span class="n">opportunities</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span>
                <span class="sa">f</span><span class="sh">"</span><span class="s">System prompt uses </span><span class="si">{</span><span class="n">breakdown</span><span class="p">[</span><span class="sh">'</span><span class="s">system_prompt</span><span class="sh">'</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s">% of tokens. </span><span class="sh">"</span>
                <span class="sh">"</span><span class="s">Consider compressing or using dynamic loading.</span><span class="sh">"</span>
            <span class="p">)</span>
        
        <span class="k">if</span> <span class="n">breakdown</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_definitions</span><span class="sh">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">:</span>
            <span class="n">opportunities</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span>
                <span class="sa">f</span><span class="sh">"</span><span class="s">Tool definitions use </span><span class="si">{</span><span class="n">breakdown</span><span class="p">[</span><span class="sh">'</span><span class="s">tool_definitions</span><span class="sh">'</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s">% of tokens. </span><span class="sh">"</span>
                <span class="sh">"</span><span class="s">Consider dynamic tool selection or compression.</span><span class="sh">"</span>
            <span class="p">)</span>
        
        <span class="k">if</span> <span class="n">breakdown</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">conversation_history</span><span class="sh">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">40</span><span class="p">:</span>
            <span class="n">opportunities</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span>
                <span class="sa">f</span><span class="sh">"</span><span class="s">History uses </span><span class="si">{</span><span class="n">breakdown</span><span class="p">[</span><span class="sh">'</span><span class="s">conversation_history</span><span class="sh">'</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s">% of tokens. </span><span class="sh">"</span>
                <span class="sh">"</span><span class="s">Consider summarization or sliding window.</span><span class="sh">"</span>
            <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">opportunities</span>
</code></pre></div></div>

<h2 id="3-optimization-strategies">3. Optimization Strategies</h2>

<h3 id="31-system-prompt-optimization">3.1 System Prompt Optimization</h3>

<p>The system prompt is sent with every request—even small improvements multiply significantly:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">SystemPromptOptimizer</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Optimize system prompts for token efficiency.
    
    Strategies:
    1. Remove redundancy
    2. Use abbreviations for repeated terms
    3. Compress examples
    4. Dynamic prompt loading
    </span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">analyzer</span><span class="p">:</span> <span class="n">TokenAnalyzer</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">analyzer</span> <span class="o">=</span> <span class="n">analyzer</span>
    
    <span class="k">def</span> <span class="nf">compress_prompt</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">
        Compress system prompt while maintaining functionality.
        </span><span class="sh">"""</span>
        <span class="n">optimizations</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_remove_redundant_instructions</span><span class="p">,</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_compress_whitespace</span><span class="p">,</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_abbreviate_common_terms</span><span class="p">,</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_compress_examples</span><span class="p">,</span>
        <span class="p">]</span>
        
        <span class="n">result</span> <span class="o">=</span> <span class="n">prompt</span>
        <span class="k">for</span> <span class="n">optimization</span> <span class="ow">in</span> <span class="n">optimizations</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="nf">optimization</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">result</span>
    
    <span class="k">def</span> <span class="nf">_remove_redundant_instructions</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">Remove commonly redundant phrases.</span><span class="sh">"""</span>
        <span class="n">redundant_phrases</span> <span class="o">=</span> <span class="p">[</span>
            <span class="sh">"</span><span class="s">Please make sure to</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">It is important that you</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">You should always</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">Remember to always</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">Be sure to</span><span class="sh">"</span><span class="p">,</span>
        <span class="p">]</span>
        
        <span class="n">result</span> <span class="o">=</span> <span class="n">prompt</span>
        <span class="k">for</span> <span class="n">phrase</span> <span class="ow">in</span> <span class="n">redundant_phrases</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="n">phrase</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">result</span>
    
    <span class="k">def</span> <span class="nf">_compress_whitespace</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">Compress excessive whitespace.</span><span class="sh">"""</span>
        <span class="kn">import</span> <span class="n">re</span>
        <span class="c1"># Multiple spaces to single
</span>        <span class="n">result</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">sub</span><span class="p">(</span><span class="sa">r</span><span class="sh">'</span><span class="s"> +</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s"> </span><span class="sh">'</span><span class="p">,</span> <span class="n">prompt</span><span class="p">)</span>
        <span class="c1"># Multiple newlines to single
</span>        <span class="n">result</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">sub</span><span class="p">(</span><span class="sa">r</span><span class="sh">'</span><span class="s">\n\s*\n</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="se">\n</span><span class="sh">'</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">_abbreviate_common_terms</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">Use abbreviations for repeated terms.</span><span class="sh">"""</span>
        <span class="c1"># Define at start, use abbreviations throughout
</span>        <span class="n">abbreviations</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">conversation</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">conv</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">response</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">resp</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">information</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">info</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">fn</span><span class="sh">"</span><span class="p">,</span>
        <span class="p">}</span>
        
        <span class="c1"># Only abbreviate if term appears 3+ times
</span>        <span class="k">for</span> <span class="n">term</span><span class="p">,</span> <span class="n">abbrev</span> <span class="ow">in</span> <span class="n">abbreviations</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">prompt</span><span class="p">.</span><span class="nf">lower</span><span class="p">().</span><span class="nf">count</span><span class="p">(</span><span class="n">term</span><span class="p">.</span><span class="nf">lower</span><span class="p">())</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                <span class="c1"># Add definition at start
</span>                <span class="n">prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[</span><span class="si">{</span><span class="n">abbrev</span><span class="si">}</span><span class="s">=</span><span class="si">{</span><span class="n">term</span><span class="si">}</span><span class="s">] </span><span class="sh">"</span> <span class="o">+</span> <span class="n">prompt</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">abbrev</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">prompt</span>
    
    <span class="k">def</span> <span class="nf">_compress_examples</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">Compress example sections.</span><span class="sh">"""</span>
        <span class="c1"># Reduce verbose examples to minimal form
</span>        <span class="c1"># Implementation depends on prompt structure
</span>        <span class="k">return</span> <span class="n">prompt</span>
    
    <span class="k">def</span> <span class="nf">create_tiered_prompt</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">base_prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">advanced_instructions</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">complexity_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.7</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">callable</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">
        Create a dynamic prompt that adds detail only when needed.
        
        Simple queries get minimal prompt.
        Complex queries get full instructions.
        </span><span class="sh">"""</span>
        
        <span class="k">def</span> <span class="nf">get_prompt</span><span class="p">(</span><span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">complexity_score</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">complexity_score</span> <span class="o">&lt;</span> <span class="n">complexity_threshold</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">base_prompt</span>
            <span class="k">return</span> <span class="n">base_prompt</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n\n</span><span class="sh">"</span> <span class="o">+</span> <span class="n">advanced_instructions</span>
        
        <span class="k">return</span> <span class="n">get_prompt</span>


<span class="c1"># Example: Before and After
</span><span class="n">VERBOSE_PROMPT</span> <span class="o">=</span> <span class="sh">"""</span><span class="s">
You are a helpful AI assistant. Your job is to help users with their questions 
and tasks. Please make sure to always be polite and professional. It is important 
that you provide accurate information. You should always think carefully before 
responding. Remember to always format your responses clearly.

When answering questions:
1. First, understand what the user is asking
2. Then, think about the best way to answer
3. Finally, provide a clear and helpful response

Be sure to:
- Be accurate
- Be helpful  
- Be clear
</span><span class="sh">"""</span>

<span class="n">OPTIMIZED_PROMPT</span> <span class="o">=</span> <span class="sh">"""</span><span class="s">
AI assistant. Be accurate, helpful, clear.
Format responses well. Think before responding.
</span><span class="sh">"""</span>

<span class="c1"># Token savings
</span><span class="n">analyzer</span> <span class="o">=</span> <span class="nc">TokenAnalyzer</span><span class="p">()</span>
<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Verbose: </span><span class="si">{</span><span class="n">analyzer</span><span class="p">.</span><span class="nf">count_tokens</span><span class="p">(</span><span class="n">VERBOSE_PROMPT</span><span class="p">)</span><span class="si">}</span><span class="s"> tokens</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Optimized: </span><span class="si">{</span><span class="n">analyzer</span><span class="p">.</span><span class="nf">count_tokens</span><span class="p">(</span><span class="n">OPTIMIZED_PROMPT</span><span class="p">)</span><span class="si">}</span><span class="s"> tokens</span><span class="sh">"</span><span class="p">)</span>
<span class="c1"># Verbose: ~100 tokens, Optimized: ~20 tokens = 80% reduction
</span></code></pre></div></div>

<h3 id="32-tool-definition-optimization">3.2 Tool Definition Optimization</h3>

<p>Tool schemas can be surprisingly token-heavy:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">List</span>

<span class="k">class</span> <span class="nc">ToolSchemaOptimizer</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Optimize tool definitions for token efficiency.
    </span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">analyzer</span><span class="p">:</span> <span class="n">TokenAnalyzer</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">analyzer</span> <span class="o">=</span> <span class="n">analyzer</span>
    
    <span class="k">def</span> <span class="nf">optimize_schema</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">tool</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">
        Optimize a single tool schema.
        </span><span class="sh">"""</span>
        <span class="n">optimized</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">tool</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="nf">_compress_description</span><span class="p">(</span><span class="n">tool</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)),</span>
        <span class="p">}</span>
        
        <span class="k">if</span> <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">tool</span><span class="p">:</span>
            <span class="n">optimized</span><span class="p">[</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_optimize_parameters</span><span class="p">(</span><span class="n">tool</span><span class="p">[</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">])</span>
        
        <span class="k">return</span> <span class="n">optimized</span>
    
    <span class="k">def</span> <span class="nf">_compress_description</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">description</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">Compress tool description.</span><span class="sh">"""</span>
        <span class="c1"># Remove obvious statements
</span>        <span class="n">description</span> <span class="o">=</span> <span class="n">description</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="sh">"</span><span class="s">This function </span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
        <span class="n">description</span> <span class="o">=</span> <span class="n">description</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="sh">"</span><span class="s">This tool </span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
        <span class="n">description</span> <span class="o">=</span> <span class="n">description</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="sh">"</span><span class="s">Use this to </span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
        
        <span class="c1"># Truncate if too long
</span>        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">description</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
            <span class="c1"># Keep first sentence
</span>            <span class="n">end</span> <span class="o">=</span> <span class="n">description</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">'</span><span class="s">.</span><span class="sh">'</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">end</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">description</span> <span class="o">=</span> <span class="n">description</span><span class="p">[:</span><span class="n">end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="n">description</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">_optimize_parameters</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">Optimize parameter schemas.</span><span class="sh">"""</span>
        <span class="k">if</span> <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">params</span>
        
        <span class="n">optimized_props</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">prop</span> <span class="ow">in</span> <span class="n">params</span><span class="p">[</span><span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">].</span><span class="nf">items</span><span class="p">():</span>
            <span class="n">optimized_props</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="n">prop</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">),</span>
            <span class="p">}</span>
            
            <span class="c1"># Only include description if necessary
</span>            <span class="k">if</span> <span class="n">desc</span> <span class="p">:</span><span class="o">=</span> <span class="n">prop</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">):</span>
                <span class="c1"># Very short description only
</span>                <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">desc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">30</span><span class="p">:</span>
                    <span class="n">desc</span> <span class="o">=</span> <span class="n">desc</span><span class="p">[:</span><span class="mi">30</span><span class="p">].</span><span class="nf">rsplit</span><span class="p">(</span><span class="sh">'</span><span class="s"> </span><span class="sh">'</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">optimized_props</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">desc</span>
            
            <span class="c1"># Include enum if present (important for correctness)
</span>            <span class="k">if</span> <span class="sh">"</span><span class="s">enum</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">prop</span><span class="p">:</span>
                <span class="n">optimized_props</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="sh">"</span><span class="s">enum</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">prop</span><span class="p">[</span><span class="sh">"</span><span class="s">enum</span><span class="sh">"</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="n">optimized_props</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="n">params</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">select_relevant_tools</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">all_tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span>
        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">max_tools</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">
        Dynamically select only relevant tools.
        
        Instead of sending 50 tools with every request,
        send only the 5 most likely to be needed.
        </span><span class="sh">"""</span>
        <span class="c1"># Score tools by relevance to query
</span>        <span class="n">scored_tools</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">tool</span> <span class="ow">in</span> <span class="n">all_tools</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_relevance_score</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
            <span class="n">scored_tools</span><span class="p">.</span><span class="nf">append</span><span class="p">((</span><span class="n">score</span><span class="p">,</span> <span class="n">tool</span><span class="p">))</span>
        
        <span class="c1"># Sort by relevance and take top N
</span>        <span class="n">scored_tools</span><span class="p">.</span><span class="nf">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">tool</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">tool</span> <span class="ow">in</span> <span class="n">scored_tools</span><span class="p">[:</span><span class="n">max_tools</span><span class="p">]]</span>
    
    <span class="k">def</span> <span class="nf">_relevance_score</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">tool</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">Score tool relevance to query.</span><span class="sh">"""</span>
        <span class="n">query_lower</span> <span class="o">=</span> <span class="n">query</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span>
        
        <span class="c1"># Simple keyword matching (could use embeddings for better results)
</span>        <span class="n">name_match</span> <span class="o">=</span> <span class="n">tool</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">].</span><span class="nf">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">query_lower</span>
        <span class="n">desc_words</span> <span class="o">=</span> <span class="nf">set</span><span class="p">(</span><span class="n">tool</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">).</span><span class="nf">lower</span><span class="p">().</span><span class="nf">split</span><span class="p">())</span>
        <span class="n">query_words</span> <span class="o">=</span> <span class="nf">set</span><span class="p">(</span><span class="n">query_lower</span><span class="p">.</span><span class="nf">split</span><span class="p">())</span>
        <span class="n">word_overlap</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">desc_words</span> <span class="o">&amp;</span> <span class="n">query_words</span><span class="p">)</span> <span class="o">/</span> <span class="nf">max</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">query_words</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="nf">return </span><span class="p">(</span><span class="mf">2.0</span> <span class="k">if</span> <span class="n">name_match</span> <span class="k">else</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">+</span> <span class="n">word_overlap</span>


<span class="c1"># Example: Token savings from tool optimization
</span><span class="n">VERBOSE_TOOL</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">search_database</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">This function allows you to search the database for records matching </span><span class="sh">"</span>
                   <span class="sh">"</span><span class="s">your query. Use this tool when you need to find information in the </span><span class="sh">"</span>
                   <span class="sh">"</span><span class="s">database. The function will return a list of matching records.</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">query</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">The search query to use when searching the database. </span><span class="sh">"</span>
                              <span class="sh">"</span><span class="s">This should be a natural language description of what </span><span class="sh">"</span>
                              <span class="sh">"</span><span class="s">you</span><span class="sh">'</span><span class="s">re looking for.</span><span class="sh">"</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">limit</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">integer</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">The maximum number of results to return from the search. </span><span class="sh">"</span>
                              <span class="sh">"</span><span class="s">Defaults to 10 if not specified.</span><span class="sh">"</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">query</span><span class="sh">"</span><span class="p">]</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">OPTIMIZED_TOOL</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">search_database</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Search database for matching records</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">query</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Search terms</span><span class="sh">"</span><span class="p">},</span>
            <span class="sh">"</span><span class="s">limit</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">integer</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Max results</span><span class="sh">"</span><span class="p">}</span>
        <span class="p">},</span>
        <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">query</span><span class="sh">"</span><span class="p">]</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># ~80 tokens → ~30 tokens = 60% reduction per tool
# With 20 tools: 1600 → 600 tokens saved per request
</span></code></pre></div></div>

<h3 id="33-context-window-management">3.3 Context Window Management</h3>

<p>History management is crucial for multi-turn conversations:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">import</span> <span class="n">heapq</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Message</span><span class="p">:</span>
    <span class="n">role</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">tokens</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">importance</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">turn_number</span><span class="p">:</span> <span class="nb">int</span>


<span class="k">class</span> <span class="nc">ConversationManager</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Manage conversation history for token efficiency.
    
    Strategies:
    1. Sliding window (keep last N turns)
    2. Summarization (compress old history)
    3. Importance-based retention
    4. Hybrid approaches
    </span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">max_history_tokens</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4000</span><span class="p">,</span>
        <span class="n">strategy</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">hybrid</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">analyzer</span><span class="p">:</span> <span class="n">TokenAnalyzer</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">max_tokens</span> <span class="o">=</span> <span class="n">max_history_tokens</span>
        <span class="n">self</span><span class="p">.</span><span class="n">strategy</span> <span class="o">=</span> <span class="n">strategy</span>
        <span class="n">self</span><span class="p">.</span><span class="n">analyzer</span> <span class="o">=</span> <span class="n">analyzer</span> <span class="ow">or</span> <span class="nc">TokenAnalyzer</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Message</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">summary</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">self</span><span class="p">.</span><span class="n">turn_count</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="k">def</span> <span class="nf">add_message</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">role</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">importance</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Add a message to history.</span><span class="sh">"""</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">analyzer</span><span class="p">.</span><span class="nf">count_tokens</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
        
        <span class="n">message</span> <span class="o">=</span> <span class="nc">Message</span><span class="p">(</span>
            <span class="n">role</span><span class="o">=</span><span class="n">role</span><span class="p">,</span>
            <span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">,</span>
            <span class="n">tokens</span><span class="o">=</span><span class="n">tokens</span><span class="p">,</span>
            <span class="n">importance</span><span class="o">=</span><span class="n">importance</span><span class="p">,</span>
            <span class="n">turn_number</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">turn_count</span>
        <span class="p">)</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">role</span> <span class="o">==</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">turn_count</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="c1"># Manage history size
</span>        <span class="n">self</span><span class="p">.</span><span class="nf">_enforce_token_limit</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">_enforce_token_limit</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Apply strategy to stay within token limit.</span><span class="sh">"""</span>
        <span class="n">current_tokens</span> <span class="o">=</span> <span class="nf">sum</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">tokens</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">messages</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">current_tokens</span> <span class="o">&lt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">max_tokens</span><span class="p">:</span>
            <span class="k">return</span>
        
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">strategy</span> <span class="o">==</span> <span class="sh">"</span><span class="s">sliding_window</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_sliding_window_prune</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">self</span><span class="p">.</span><span class="n">strategy</span> <span class="o">==</span> <span class="sh">"</span><span class="s">importance</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_importance_prune</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">self</span><span class="p">.</span><span class="n">strategy</span> <span class="o">==</span> <span class="sh">"</span><span class="s">summarize</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_summarize_old_messages</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">self</span><span class="p">.</span><span class="n">strategy</span> <span class="o">==</span> <span class="sh">"</span><span class="s">hybrid</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_hybrid_prune</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">_sliding_window_prune</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Keep only the most recent messages.</span><span class="sh">"""</span>
        <span class="k">while</span> <span class="nf">sum</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">tokens</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">messages</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">self</span><span class="p">.</span><span class="n">max_tokens</span><span class="p">:</span>
            <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">messages</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># Keep at least system + last exchange
</span>                <span class="n">self</span><span class="p">.</span><span class="n">messages</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>
    
    <span class="k">def</span> <span class="nf">_importance_prune</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Remove least important messages first.</span><span class="sh">"""</span>
        <span class="c1"># Create heap of (importance, index) - lower importance = higher priority for removal
</span>        <span class="n">removable</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">importance</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> 
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">messages</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">m</span><span class="p">.</span><span class="n">role</span> <span class="o">!=</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span>  <span class="c1"># Never remove system prompt
</span>        <span class="p">]</span>
        <span class="n">heapq</span><span class="p">.</span><span class="nf">heapify</span><span class="p">(</span><span class="n">removable</span><span class="p">)</span>
        
        <span class="nf">while </span><span class="p">(</span><span class="nf">sum</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">tokens</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">messages</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">self</span><span class="p">.</span><span class="n">max_tokens</span> 
               <span class="ow">and</span> <span class="n">removable</span><span class="p">):</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">heapq</span><span class="p">.</span><span class="nf">heappop</span><span class="p">(</span><span class="n">removable</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">messages</span><span class="p">):</span>
                <span class="n">self</span><span class="p">.</span><span class="n">messages</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
        
        <span class="c1"># Remove None entries
</span>        <span class="n">self</span><span class="p">.</span><span class="n">messages</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">messages</span> <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">_summarize_old_messages</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Summarize older parts of the conversation.</span><span class="sh">"""</span>
        <span class="c1"># Keep recent messages, summarize the rest
</span>        <span class="n">recent_tokens</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">recent_start</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">messages</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">messages</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">recent_tokens</span> <span class="o">+=</span> <span class="n">self</span><span class="p">.</span><span class="n">messages</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tokens</span>
            <span class="k">if</span> <span class="n">recent_tokens</span> <span class="o">&gt;</span> <span class="n">self</span><span class="p">.</span><span class="n">max_tokens</span> <span class="o">*</span> <span class="mf">0.6</span><span class="p">:</span>  <span class="c1"># 60% for recent
</span>                <span class="n">recent_start</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">break</span>
        
        <span class="k">if</span> <span class="n">recent_start</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Summarize messages before recent_start
</span>            <span class="n">old_messages</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">messages</span><span class="p">[:</span><span class="n">recent_start</span><span class="p">]</span>
            <span class="n">self</span><span class="p">.</span><span class="n">summary</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_create_summary</span><span class="p">(</span><span class="n">old_messages</span><span class="p">)</span>
            
            <span class="c1"># Keep only recent + summary
</span>            <span class="n">summary_tokens</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">analyzer</span><span class="p">.</span><span class="nf">count_tokens</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">summary</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
                <span class="nc">Message</span><span class="p">(</span>
                    <span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span>
                    <span class="n">content</span><span class="o">=</span><span class="sa">f</span><span class="sh">"</span><span class="s">[Previous conversation summary: </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">summary</span><span class="si">}</span><span class="s">]</span><span class="sh">"</span><span class="p">,</span>
                    <span class="n">tokens</span><span class="o">=</span><span class="n">summary_tokens</span><span class="p">,</span>
                    <span class="n">importance</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
                    <span class="n">turn_number</span><span class="o">=-</span><span class="mi">1</span>
                <span class="p">)</span>
            <span class="p">]</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">messages</span><span class="p">[</span><span class="n">recent_start</span><span class="p">:]</span>
    
    <span class="k">def</span> <span class="nf">_hybrid_prune</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Combine strategies for best results.</span><span class="sh">"""</span>
        <span class="c1"># 1. First, summarize very old messages (&gt;10 turns ago)
</span>        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">turn_count</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">old_cutoff</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">turn_count</span> <span class="o">-</span> <span class="mi">10</span>
            <span class="n">old_messages</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">messages</span> <span class="k">if</span> <span class="n">m</span><span class="p">.</span><span class="n">turn_number</span> <span class="o">&lt;</span> <span class="n">old_cutoff</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">old_messages</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_summarize_old_messages</span><span class="p">()</span>
        
        <span class="c1"># 2. Then, remove low-importance messages
</span>        <span class="k">if</span> <span class="nf">sum</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">tokens</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">messages</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">self</span><span class="p">.</span><span class="n">max_tokens</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_importance_prune</span><span class="p">()</span>
        
        <span class="c1"># 3. Finally, sliding window if still over
</span>        <span class="k">if</span> <span class="nf">sum</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">tokens</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">messages</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">self</span><span class="p">.</span><span class="n">max_tokens</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_sliding_window_prune</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">_create_summary</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Message</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">Create a summary of messages (would call LLM in practice).</span><span class="sh">"""</span>
        <span class="c1"># Placeholder - in production, call an LLM with summarization prompt
</span>        <span class="n">topics</span> <span class="o">=</span> <span class="nf">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">:</span>
            <span class="c1"># Extract key topics (simplified)
</span>            <span class="n">words</span> <span class="o">=</span> <span class="n">m</span><span class="p">.</span><span class="n">content</span><span class="p">.</span><span class="nf">lower</span><span class="p">().</span><span class="nf">split</span><span class="p">()</span>
            <span class="n">topics</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">word</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">words</span> <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Discussed: </span><span class="si">{</span><span class="sh">'</span><span class="s">, </span><span class="sh">'</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="nf">list</span><span class="p">(</span><span class="n">topics</span><span class="p">)[</span><span class="si">:</span><span class="mi">10</span><span class="p">])</span><span class="si">}</span><span class="sh">"</span>
    
    <span class="k">def</span> <span class="nf">get_messages_for_request</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
        <span class="sh">"""</span><span class="s">Get messages formatted for API request.</span><span class="sh">"""</span>
        <span class="k">return</span> <span class="p">[{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="n">m</span><span class="p">.</span><span class="n">role</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">m</span><span class="p">.</span><span class="n">content</span><span class="p">}</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">messages</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">get_token_usage</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">Get current token usage breakdown.</span><span class="sh">"""</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">total</span><span class="sh">"</span><span class="p">:</span> <span class="nf">sum</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">tokens</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">messages</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">by_role</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="n">role</span><span class="p">:</span> <span class="nf">sum</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">tokens</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">messages</span> <span class="k">if</span> <span class="n">m</span><span class="p">.</span><span class="n">role</span> <span class="o">==</span> <span class="n">role</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">role</span> <span class="ow">in</span> <span class="p">[</span><span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">]</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">message_count</span><span class="sh">"</span><span class="p">:</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">messages</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">has_summary</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">summary</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
        <span class="p">}</span>
</code></pre></div></div>

<h3 id="34-response-optimization">3.4 Response Optimization</h3>

<p>Control output length and format:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ResponseOptimizer</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Optimize output token usage.
    </span><span class="sh">"""</span>
    
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">create_concise_prompt</span><span class="p">(</span><span class="n">base_prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">Add conciseness instructions.</span><span class="sh">"""</span>
        <span class="k">return</span> <span class="sa">f</span><span class="sh">"""</span><span class="si">{</span><span class="n">base_prompt</span><span class="si">}</span><span class="s">

RESPONSE GUIDELINES:
- Be concise: max 150 words for simple queries, 300 for complex
- Use lists over paragraphs when possible
- Omit unnecessary preamble (</span><span class="sh">"</span><span class="s">I</span><span class="sh">'</span><span class="s">d be happy to help...</span><span class="sh">"</span><span class="s">)
- Skip restating the question
</span><span class="sh">"""</span>
    
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">set_output_limits</span><span class="p">(</span><span class="n">query_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">Set appropriate max_tokens based on query type.</span><span class="sh">"""</span>
        <span class="n">limits</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">yes_no</span><span class="sh">"</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">factual</span><span class="sh">"</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">explanation</span><span class="sh">"</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">analysis</span><span class="sh">"</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">code</span><span class="sh">"</span><span class="p">:</span> <span class="mi">800</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">creative</span><span class="sh">"</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">max_tokens</span><span class="sh">"</span><span class="p">:</span> <span class="n">limits</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">query_type</span><span class="p">,</span> <span class="mi">500</span><span class="p">)}</span>
    
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">structured_output_prompt</span><span class="p">(</span><span class="n">fields</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">Request structured output to control length.</span><span class="sh">"""</span>
        <span class="k">return</span> <span class="sa">f</span><span class="sh">"""</span><span class="s">
Respond with ONLY a JSON object containing these fields:
</span><span class="si">{</span><span class="nf">chr</span><span class="p">(</span><span class="mi">10</span><span class="p">).</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="s">- </span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="sh">'</span><span class="s"> for field in fields)</span><span class="si">}</span><span class="s">

No additional text or explanation.
</span><span class="sh">"""</span>


<span class="k">class</span> <span class="nc">AdaptiveTokenManager</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Dynamically adjust token usage based on context.
    </span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">budget_per_request</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4000</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">budget</span> <span class="o">=</span> <span class="n">budget_per_request</span>
        <span class="n">self</span><span class="p">.</span><span class="n">request_history</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">allocate_tokens</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">fixed_costs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>  <span class="c1"># system_prompt, tools, etc.
</span>        <span class="n">variable_costs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>  <span class="c1"># history, context
</span>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">
        Allocate tokens across components within budget.
        </span><span class="sh">"""</span>
        <span class="n">total_fixed</span> <span class="o">=</span> <span class="nf">sum</span><span class="p">(</span><span class="n">fixed_costs</span><span class="p">.</span><span class="nf">values</span><span class="p">())</span>
        <span class="n">total_variable</span> <span class="o">=</span> <span class="nf">sum</span><span class="p">(</span><span class="n">variable_costs</span><span class="p">.</span><span class="nf">values</span><span class="p">())</span>
        <span class="n">total</span> <span class="o">=</span> <span class="n">total_fixed</span> <span class="o">+</span> <span class="n">total_variable</span>
        
        <span class="k">if</span> <span class="n">total</span> <span class="o">&lt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">budget</span><span class="p">:</span>
            <span class="c1"># Under budget - no changes needed
</span>            <span class="k">return</span> <span class="p">{</span><span class="o">**</span><span class="n">fixed_costs</span><span class="p">,</span> <span class="o">**</span><span class="n">variable_costs</span><span class="p">}</span>
        
        <span class="c1"># Over budget - scale down variable costs
</span>        <span class="n">available_for_variable</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">budget</span> <span class="o">-</span> <span class="n">total_fixed</span>
        <span class="n">scale_factor</span> <span class="o">=</span> <span class="n">available_for_variable</span> <span class="o">/</span> <span class="nf">max</span><span class="p">(</span><span class="n">total_variable</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="n">allocated</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">(</span><span class="n">fixed_costs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">variable_costs</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="n">allocated</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">value</span> <span class="o">*</span> <span class="n">scale_factor</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">allocated</span>
    
    <span class="k">def</span> <span class="nf">get_compression_recommendation</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">current_usage</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">
        Recommend compression strategies based on usage patterns.
        </span><span class="sh">"""</span>
        <span class="n">recommendations</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="n">total</span> <span class="o">=</span> <span class="nf">sum</span><span class="p">(</span><span class="n">current_usage</span><span class="p">.</span><span class="nf">values</span><span class="p">())</span>
        
        <span class="k">for</span> <span class="n">component</span><span class="p">,</span> <span class="n">tokens</span> <span class="ow">in</span> <span class="n">current_usage</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="n">percentage</span> <span class="o">=</span> <span class="n">tokens</span> <span class="o">/</span> <span class="n">total</span> <span class="o">*</span> <span class="mi">100</span>
            
            <span class="k">if</span> <span class="n">component</span> <span class="o">==</span> <span class="sh">"</span><span class="s">system_prompt</span><span class="sh">"</span> <span class="ow">and</span> <span class="n">percentage</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">:</span>
                <span class="n">recommendations</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span>
                    <span class="sa">f</span><span class="sh">"</span><span class="s">System prompt uses </span><span class="si">{</span><span class="n">percentage</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s">%. </span><span class="sh">"</span>
                    <span class="sh">"</span><span class="s">Consider: dynamic loading, prompt compression</span><span class="sh">"</span>
                <span class="p">)</span>
            
            <span class="k">if</span> <span class="n">component</span> <span class="o">==</span> <span class="sh">"</span><span class="s">tool_definitions</span><span class="sh">"</span> <span class="ow">and</span> <span class="n">percentage</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
                <span class="n">recommendations</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span>
                    <span class="sa">f</span><span class="sh">"</span><span class="s">Tools use </span><span class="si">{</span><span class="n">percentage</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s">%. </span><span class="sh">"</span>
                    <span class="sh">"</span><span class="s">Consider: dynamic tool selection, schema compression</span><span class="sh">"</span>
                <span class="p">)</span>
            
            <span class="k">if</span> <span class="n">component</span> <span class="o">==</span> <span class="sh">"</span><span class="s">conversation_history</span><span class="sh">"</span> <span class="ow">and</span> <span class="n">percentage</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">:</span>
                <span class="n">recommendations</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span>
                    <span class="sa">f</span><span class="sh">"</span><span class="s">History uses </span><span class="si">{</span><span class="n">percentage</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s">%. </span><span class="sh">"</span>
                    <span class="sh">"</span><span class="s">Consider: summarization, importance pruning</span><span class="sh">"</span>
                <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">recommendations</span>
</code></pre></div></div>

<h2 id="4-advanced-techniques">4. Advanced Techniques</h2>

<h3 id="41-semantic-caching">4.1 Semantic Caching</h3>

<p>Cache similar queries to avoid redundant LLM calls:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">import</span> <span class="n">hashlib</span>
<span class="kn">import</span> <span class="n">time</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">CacheEntry</span><span class="p">:</span>
    <span class="n">query_embedding</span><span class="p">:</span> <span class="n">np</span><span class="p">.</span><span class="n">ndarray</span>
    <span class="n">response</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">tokens_saved</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">created_at</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">hit_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>


<span class="k">class</span> <span class="nc">SemanticCache</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Cache responses based on semantic similarity.
    
    If a new query is semantically similar to a cached query,
    return the cached response instead of calling the LLM.
    </span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">similarity_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">,</span>
        <span class="n">max_entries</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">,</span>
        <span class="n">ttl_seconds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3600</span>
    <span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">similarity_threshold</span>
        <span class="n">self</span><span class="p">.</span><span class="n">max_entries</span> <span class="o">=</span> <span class="n">max_entries</span>
        <span class="n">self</span><span class="p">.</span><span class="n">ttl</span> <span class="o">=</span> <span class="n">ttl_seconds</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cache</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">CacheEntry</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">embedder</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_load_embedder</span><span class="p">()</span>
        
        <span class="c1"># Stats
</span>        <span class="n">self</span><span class="p">.</span><span class="n">hits</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">misses</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">tokens_saved</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="k">def</span> <span class="nf">_load_embedder</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Load embedding model for semantic similarity.</span><span class="sh">"""</span>
        <span class="c1"># Could use sentence-transformers, OpenAI embeddings, etc.
</span>        <span class="kn">from</span> <span class="n">sentence_transformers</span> <span class="kn">import</span> <span class="n">SentenceTransformer</span>
        <span class="k">return</span> <span class="nc">SentenceTransformer</span><span class="p">(</span><span class="sh">'</span><span class="s">all-MiniLM-L6-v2</span><span class="sh">'</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">
        Check if a similar query exists in cache.
        </span><span class="sh">"""</span>
        <span class="n">query_embedding</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">embedder</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        
        <span class="n">best_match</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">best_similarity</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="c1"># Check TTL
</span>            <span class="k">if</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">entry</span><span class="p">.</span><span class="n">created_at</span> <span class="o">&gt;</span> <span class="n">self</span><span class="p">.</span><span class="n">ttl</span><span class="p">:</span>
                <span class="k">continue</span>
            
            <span class="c1"># Compute similarity
</span>            <span class="n">similarity</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_cosine_similarity</span><span class="p">(</span>
                <span class="n">query_embedding</span><span class="p">,</span> 
                <span class="n">entry</span><span class="p">.</span><span class="n">query_embedding</span>
            <span class="p">)</span>
            
            <span class="k">if</span> <span class="n">similarity</span> <span class="o">&gt;</span> <span class="n">best_similarity</span> <span class="ow">and</span> <span class="n">similarity</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">threshold</span><span class="p">:</span>
                <span class="n">best_similarity</span> <span class="o">=</span> <span class="n">similarity</span>
                <span class="n">best_match</span> <span class="o">=</span> <span class="n">entry</span>
        
        <span class="k">if</span> <span class="n">best_match</span><span class="p">:</span>
            <span class="n">best_match</span><span class="p">.</span><span class="n">hit_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">self</span><span class="p">.</span><span class="n">hits</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">self</span><span class="p">.</span><span class="n">tokens_saved</span> <span class="o">+=</span> <span class="n">best_match</span><span class="p">.</span><span class="n">tokens_saved</span>
            <span class="k">return</span> <span class="n">best_match</span><span class="p">.</span><span class="n">response</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">misses</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="bp">None</span>
    
    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">response</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">tokens_used</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">):</span>
        <span class="sh">"""</span><span class="s">Add a query-response pair to cache.</span><span class="sh">"""</span>
        <span class="c1"># Evict old entries if at capacity
</span>        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cache</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">max_entries</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_evict</span><span class="p">()</span>
        
        <span class="n">query_embedding</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">embedder</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">hashlib</span><span class="p">.</span><span class="nf">md5</span><span class="p">(</span><span class="n">query</span><span class="p">.</span><span class="nf">encode</span><span class="p">()).</span><span class="nf">hexdigest</span><span class="p">()</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nc">CacheEntry</span><span class="p">(</span>
            <span class="n">query_embedding</span><span class="o">=</span><span class="n">query_embedding</span><span class="p">,</span>
            <span class="n">response</span><span class="o">=</span><span class="n">response</span><span class="p">,</span>
            <span class="n">tokens_saved</span><span class="o">=</span><span class="n">tokens_used</span><span class="p">,</span>
            <span class="n">created_at</span><span class="o">=</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_cosine_similarity</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">a</span><span class="p">:</span> <span class="n">np</span><span class="p">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">np</span><span class="p">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="p">.</span><span class="nf">dot</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">linalg</span><span class="p">.</span><span class="nf">norm</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="n">linalg</span><span class="p">.</span><span class="nf">norm</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>
    
    <span class="k">def</span> <span class="nf">_evict</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Evict least valuable entries.</span><span class="sh">"""</span>
        <span class="c1"># Score by: recency + hit_count
</span>        <span class="n">scored</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="n">created_at</span> <span class="o">+</span> <span class="n">entry</span><span class="p">.</span><span class="n">hit_count</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="nf">items</span><span class="p">()</span>
        <span class="p">]</span>
        <span class="n">scored</span><span class="p">.</span><span class="nf">sort</span><span class="p">()</span>
        
        <span class="c1"># Remove bottom 10%
</span>        <span class="n">remove_count</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nf">len</span><span class="p">(</span><span class="n">scored</span><span class="p">)</span> <span class="o">//</span> <span class="mi">10</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">scored</span><span class="p">[:</span><span class="n">remove_count</span><span class="p">]:</span>
            <span class="k">del</span> <span class="n">self</span><span class="p">.</span><span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">get_stats</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">hit_rate</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">hits</span> <span class="o">/</span> <span class="nf">max</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">hits</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">misses</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">tokens_saved</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">tokens_saved</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">cache_size</span><span class="sh">"</span><span class="p">:</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cache</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">estimated_cost_saved</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">tokens_saved</span> <span class="o">*</span> <span class="mf">0.00003</span>  <span class="c1"># GPT-4 pricing
</span>        <span class="p">}</span>
</code></pre></div></div>

<h3 id="42-prompt-compilation">4.2 Prompt Compilation</h3>

<p>Pre-process and optimize prompts offline:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">PromptCompiler</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Compile prompts for maximum efficiency.
    
    - Remove redundancy
    - Optimize formatting
    - Create compressed representations
    </span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">analyzer</span><span class="p">:</span> <span class="n">TokenAnalyzer</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">analyzer</span> <span class="o">=</span> <span class="n">analyzer</span>
    
    <span class="k">def</span> <span class="nf">compile</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">prompt_template</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="sh">"</span><span class="s">CompiledPrompt</span><span class="sh">"</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">
        Compile a prompt template for efficient runtime use.
        </span><span class="sh">"""</span>
        <span class="c1"># Analyze the template
</span>        <span class="n">original_tokens</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">analyzer</span><span class="p">.</span><span class="nf">count_tokens</span><span class="p">(</span><span class="n">prompt_template</span><span class="p">)</span>
        
        <span class="c1"># Apply optimizations
</span>        <span class="n">optimized</span> <span class="o">=</span> <span class="n">prompt_template</span>
        <span class="n">optimizations_applied</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># 1. Whitespace normalization
</span>        <span class="kn">import</span> <span class="n">re</span>
        <span class="n">optimized</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">sub</span><span class="p">(</span><span class="sa">r</span><span class="sh">'</span><span class="s">\s+</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s"> </span><span class="sh">'</span><span class="p">,</span> <span class="n">optimized</span><span class="p">)</span>
        <span class="n">optimized</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">sub</span><span class="p">(</span><span class="sa">r</span><span class="sh">'</span><span class="s">\n\s*\n</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="se">\n</span><span class="sh">'</span><span class="p">,</span> <span class="n">optimized</span><span class="p">)</span>
        <span class="n">optimizations_applied</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">whitespace_normalized</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="c1"># 2. Remove filler phrases
</span>        <span class="n">fillers</span> <span class="o">=</span> <span class="p">[</span>
            <span class="sh">"</span><span class="s">Please </span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">Kindly </span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">I would like you to </span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">Your task is to </span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">You are expected to </span><span class="sh">"</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">filler</span> <span class="ow">in</span> <span class="n">fillers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">optimized</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="n">filler</span><span class="p">):</span>
                <span class="n">optimized</span> <span class="o">=</span> <span class="n">optimized</span><span class="p">[</span><span class="nf">len</span><span class="p">(</span><span class="n">filler</span><span class="p">):]</span>
                <span class="n">optimized</span> <span class="o">=</span> <span class="n">optimized</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">upper</span><span class="p">()</span> <span class="o">+</span> <span class="n">optimized</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">optimizations_applied</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">fillers_removed</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="c1"># 3. Compress examples if present
</span>        <span class="c1"># (Implementation would depend on example format)
</span>        
        <span class="n">final_tokens</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">analyzer</span><span class="p">.</span><span class="nf">count_tokens</span><span class="p">(</span><span class="n">optimized</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="nc">CompiledPrompt</span><span class="p">(</span>
            <span class="n">original</span><span class="o">=</span><span class="n">prompt_template</span><span class="p">,</span>
            <span class="n">optimized</span><span class="o">=</span><span class="n">optimized</span><span class="p">,</span>
            <span class="n">original_tokens</span><span class="o">=</span><span class="n">original_tokens</span><span class="p">,</span>
            <span class="n">optimized_tokens</span><span class="o">=</span><span class="n">final_tokens</span><span class="p">,</span>
            <span class="n">savings_percent</span><span class="o">=</span><span class="p">(</span><span class="n">original_tokens</span> <span class="o">-</span> <span class="n">final_tokens</span><span class="p">)</span> <span class="o">/</span> <span class="n">original_tokens</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="n">optimizations</span><span class="o">=</span><span class="n">optimizations_applied</span>
        <span class="p">)</span>


<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">CompiledPrompt</span><span class="p">:</span>
    <span class="n">original</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">optimized</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">original_tokens</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">optimized_tokens</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">savings_percent</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">optimizations</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="o">**</span><span class="n">variables</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">Render the compiled prompt with variables.</span><span class="sh">"""</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">optimized</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="sh">"</span><span class="s">{</span><span class="sh">"</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="sh">"</span><span class="s">}</span><span class="sh">"</span><span class="p">,</span> <span class="nf">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">result</span>
</code></pre></div></div>

<h3 id="43-model-routing">4.3 Model Routing</h3>

<p>Use cheaper models when possible:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>

<span class="k">class</span> <span class="nc">ModelTier</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">FAST_CHEAP</span> <span class="o">=</span> <span class="sh">"</span><span class="s">gpt-3.5-turbo</span><span class="sh">"</span>      <span class="c1"># $0.002/1K tokens
</span>    <span class="n">BALANCED</span> <span class="o">=</span> <span class="sh">"</span><span class="s">gpt-4-turbo</span><span class="sh">"</span>           <span class="c1"># $0.01/1K tokens
</span>    <span class="n">POWERFUL</span> <span class="o">=</span> <span class="sh">"</span><span class="s">gpt-4</span><span class="sh">"</span>                 <span class="c1"># $0.03/1K tokens
</span>    <span class="n">REASONING</span> <span class="o">=</span> <span class="sh">"</span><span class="s">o1-preview</span><span class="sh">"</span>           <span class="c1"># $0.06/1K tokens
</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">QueryClassification</span><span class="p">:</span>
    <span class="n">tier</span><span class="p">:</span> <span class="n">ModelTier</span>
    <span class="n">confidence</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">reasoning</span><span class="p">:</span> <span class="nb">str</span>


<span class="k">class</span> <span class="nc">ModelRouter</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Route queries to appropriate model tiers.
    
    Simple queries → cheap models
    Complex queries → powerful models
    </span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">classifier</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_load_classifier</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">_load_classifier</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Load query complexity classifier.</span><span class="sh">"""</span>
        <span class="c1"># Could be a small fine-tuned model or rule-based
</span>        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">classify_query</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">QueryClassification</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">
        Determine appropriate model tier for query.
        </span><span class="sh">"""</span>
        <span class="c1"># Heuristic-based classification
</span>        <span class="n">query_lower</span> <span class="o">=</span> <span class="n">query</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span>
        
        <span class="c1"># Simple queries → fast/cheap
</span>        <span class="n">simple_patterns</span> <span class="o">=</span> <span class="p">[</span>
            <span class="sh">"</span><span class="s">what is</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">who is</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">when did</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">where is</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">yes or no</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">true or false</span><span class="sh">"</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="nf">any</span><span class="p">(</span><span class="n">p</span> <span class="ow">in</span> <span class="n">query_lower</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">simple_patterns</span><span class="p">)</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
            <span class="k">return</span> <span class="nc">QueryClassification</span><span class="p">(</span>
                <span class="n">tier</span><span class="o">=</span><span class="n">ModelTier</span><span class="p">.</span><span class="n">FAST_CHEAP</span><span class="p">,</span>
                <span class="n">confidence</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span>
                <span class="n">reasoning</span><span class="o">=</span><span class="sh">"</span><span class="s">Simple factual query</span><span class="sh">"</span>
            <span class="p">)</span>
        
        <span class="c1"># Code or analysis → powerful
</span>        <span class="n">complex_patterns</span> <span class="o">=</span> <span class="p">[</span>
            <span class="sh">"</span><span class="s">analyze</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">compare</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">explain why</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">write code</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">debug</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">optimize</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">design</span><span class="sh">"</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="nf">any</span><span class="p">(</span><span class="n">p</span> <span class="ow">in</span> <span class="n">query_lower</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">complex_patterns</span><span class="p">):</span>
            <span class="k">return</span> <span class="nc">QueryClassification</span><span class="p">(</span>
                <span class="n">tier</span><span class="o">=</span><span class="n">ModelTier</span><span class="p">.</span><span class="n">POWERFUL</span><span class="p">,</span>
                <span class="n">confidence</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
                <span class="n">reasoning</span><span class="o">=</span><span class="sh">"</span><span class="s">Complex analysis required</span><span class="sh">"</span>
            <span class="p">)</span>
        
        <span class="c1"># Multi-step reasoning → reasoning model
</span>        <span class="n">reasoning_patterns</span> <span class="o">=</span> <span class="p">[</span>
            <span class="sh">"</span><span class="s">step by step</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">prove</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">derive</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">solve this problem</span><span class="sh">"</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="nf">any</span><span class="p">(</span><span class="n">p</span> <span class="ow">in</span> <span class="n">query_lower</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">reasoning_patterns</span><span class="p">):</span>
            <span class="k">return</span> <span class="nc">QueryClassification</span><span class="p">(</span>
                <span class="n">tier</span><span class="o">=</span><span class="n">ModelTier</span><span class="p">.</span><span class="n">REASONING</span><span class="p">,</span>
                <span class="n">confidence</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
                <span class="n">reasoning</span><span class="o">=</span><span class="sh">"</span><span class="s">Multi-step reasoning required</span><span class="sh">"</span>
            <span class="p">)</span>
        
        <span class="c1"># Default to balanced
</span>        <span class="k">return</span> <span class="nc">QueryClassification</span><span class="p">(</span>
            <span class="n">tier</span><span class="o">=</span><span class="n">ModelTier</span><span class="p">.</span><span class="n">BALANCED</span><span class="p">,</span>
            <span class="n">confidence</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span>
            <span class="n">reasoning</span><span class="o">=</span><span class="sh">"</span><span class="s">Moderate complexity</span><span class="sh">"</span>
        <span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">estimate_savings</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">queries</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">baseline_model</span><span class="p">:</span> <span class="n">ModelTier</span> <span class="o">=</span> <span class="n">ModelTier</span><span class="p">.</span><span class="n">POWERFUL</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">Estimate savings from intelligent routing.</span><span class="sh">"""</span>
        <span class="n">model_costs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">ModelTier</span><span class="p">.</span><span class="n">FAST_CHEAP</span><span class="p">:</span> <span class="mf">0.002</span><span class="p">,</span>
            <span class="n">ModelTier</span><span class="p">.</span><span class="n">BALANCED</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">,</span>
            <span class="n">ModelTier</span><span class="p">.</span><span class="n">POWERFUL</span><span class="p">:</span> <span class="mf">0.03</span><span class="p">,</span>
            <span class="n">ModelTier</span><span class="p">.</span><span class="n">REASONING</span><span class="p">:</span> <span class="mf">0.06</span><span class="p">,</span>
        <span class="p">}</span>
        
        <span class="n">baseline_cost</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">queries</span><span class="p">)</span> <span class="o">*</span> <span class="n">model_costs</span><span class="p">[</span><span class="n">baseline_model</span><span class="p">]</span>
        
        <span class="n">routed_cost</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">tier_counts</span> <span class="o">=</span> <span class="p">{</span><span class="n">tier</span><span class="p">:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">tier</span> <span class="ow">in</span> <span class="n">ModelTier</span><span class="p">}</span>
        
        <span class="k">for</span> <span class="n">query</span> <span class="ow">in</span> <span class="n">queries</span><span class="p">:</span>
            <span class="n">classification</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">classify_query</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
            <span class="n">routed_cost</span> <span class="o">+=</span> <span class="n">model_costs</span><span class="p">[</span><span class="n">classification</span><span class="p">.</span><span class="n">tier</span><span class="p">]</span>
            <span class="n">tier_counts</span><span class="p">[</span><span class="n">classification</span><span class="p">.</span><span class="n">tier</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">baseline_cost</span><span class="sh">"</span><span class="p">:</span> <span class="n">baseline_cost</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">routed_cost</span><span class="sh">"</span><span class="p">:</span> <span class="n">routed_cost</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">savings</span><span class="sh">"</span><span class="p">:</span> <span class="n">baseline_cost</span> <span class="o">-</span> <span class="n">routed_cost</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">savings_percent</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="n">baseline_cost</span> <span class="o">-</span> <span class="n">routed_cost</span><span class="p">)</span> <span class="o">/</span> <span class="n">baseline_cost</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">tier_distribution</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="n">t</span><span class="p">.</span><span class="n">value</span><span class="p">:</span> <span class="n">c</span> <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">tier_counts</span><span class="p">.</span><span class="nf">items</span><span class="p">()}</span>
        <span class="p">}</span>
</code></pre></div></div>

<h2 id="5-monitoring-and-analytics">5. Monitoring and Analytics</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span>
<span class="kn">from</span> <span class="n">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="n">json</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">TokenUsageEvent</span><span class="p">:</span>
    <span class="n">timestamp</span><span class="p">:</span> <span class="n">datetime</span>
    <span class="n">request_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">model</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">input_tokens</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">output_tokens</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">cached</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">cost</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">latency_ms</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">components</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>  <span class="c1"># Breakdown by component
</span>

<span class="k">class</span> <span class="nc">TokenUsageMonitor</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Monitor and analyze token usage patterns.
    </span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">events</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">TokenUsageEvent</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">alerts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">log_event</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">TokenUsageEvent</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Log a token usage event.</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="n">events</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_check_alerts</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_check_alerts</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">TokenUsageEvent</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Check for anomalies that should trigger alerts.</span><span class="sh">"""</span>
        <span class="c1"># High single-request cost
</span>        <span class="k">if</span> <span class="n">event</span><span class="p">.</span><span class="n">cost</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span>  <span class="c1"># $1 per request is high
</span>            <span class="n">self</span><span class="p">.</span><span class="n">alerts</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">high_cost_request</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">request_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">event</span><span class="p">.</span><span class="n">request_id</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">cost</span><span class="sh">"</span><span class="p">:</span> <span class="n">event</span><span class="p">.</span><span class="n">cost</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">timestamp</span><span class="sh">"</span><span class="p">:</span> <span class="n">event</span><span class="p">.</span><span class="n">timestamp</span>
            <span class="p">})</span>
        
        <span class="c1"># Low cache hit rate (check over window)
</span>        <span class="n">recent</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">events</span><span class="p">[</span><span class="o">-</span><span class="mi">100</span><span class="p">:]</span> <span class="k">if</span> <span class="n">e</span><span class="p">.</span><span class="n">cached</span><span class="p">]</span>
        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">events</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">100</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">recent</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">alerts</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">low_cache_hit_rate</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">rate</span><span class="sh">"</span><span class="p">:</span> <span class="nf">len</span><span class="p">(</span><span class="n">recent</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">timestamp</span><span class="sh">"</span><span class="p">:</span> <span class="n">event</span><span class="p">.</span><span class="n">timestamp</span>
            <span class="p">})</span>
    
    <span class="k">def</span> <span class="nf">get_analytics</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">period_hours</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">24</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">Get analytics for a time period.</span><span class="sh">"""</span>
        <span class="n">cutoff</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="nf">now</span><span class="p">().</span><span class="nf">timestamp</span><span class="p">()</span> <span class="o">-</span> <span class="n">period_hours</span> <span class="o">*</span> <span class="mi">3600</span>
        <span class="n">period_events</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">events</span> 
            <span class="k">if</span> <span class="n">e</span><span class="p">.</span><span class="n">timestamp</span><span class="p">.</span><span class="nf">timestamp</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">cutoff</span>
        <span class="p">]</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">period_events</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>
        
        <span class="n">total_input</span> <span class="o">=</span> <span class="nf">sum</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">input_tokens</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">period_events</span><span class="p">)</span>
        <span class="n">total_output</span> <span class="o">=</span> <span class="nf">sum</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">output_tokens</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">period_events</span><span class="p">)</span>
        <span class="n">total_cost</span> <span class="o">=</span> <span class="nf">sum</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">cost</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">period_events</span><span class="p">)</span>
        
        <span class="c1"># Component breakdown
</span>        <span class="n">component_totals</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">period_events</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">comp</span><span class="p">,</span> <span class="n">tokens</span> <span class="ow">in</span> <span class="n">event</span><span class="p">.</span><span class="n">components</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
                <span class="n">component_totals</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span> <span class="o">=</span> <span class="n">component_totals</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">tokens</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">period_hours</span><span class="sh">"</span><span class="p">:</span> <span class="n">period_hours</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">request_count</span><span class="sh">"</span><span class="p">:</span> <span class="nf">len</span><span class="p">(</span><span class="n">period_events</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">total_tokens</span><span class="sh">"</span><span class="p">:</span> <span class="n">total_input</span> <span class="o">+</span> <span class="n">total_output</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">total_cost</span><span class="sh">"</span><span class="p">:</span> <span class="n">total_cost</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">avg_tokens_per_request</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="n">total_input</span> <span class="o">+</span> <span class="n">total_output</span><span class="p">)</span> <span class="o">/</span> <span class="nf">len</span><span class="p">(</span><span class="n">period_events</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">avg_cost_per_request</span><span class="sh">"</span><span class="p">:</span> <span class="n">total_cost</span> <span class="o">/</span> <span class="nf">len</span><span class="p">(</span><span class="n">period_events</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">cache_hit_rate</span><span class="sh">"</span><span class="p">:</span> <span class="nf">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">period_events</span> <span class="k">if</span> <span class="n">e</span><span class="p">.</span><span class="n">cached</span><span class="p">)</span> <span class="o">/</span> <span class="nf">len</span><span class="p">(</span><span class="n">period_events</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">component_breakdown</span><span class="sh">"</span><span class="p">:</span> <span class="n">component_totals</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">component_percentages</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="o">/</span> <span class="p">(</span><span class="n">total_input</span> <span class="o">+</span> <span class="n">total_output</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> 
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">component_totals</span><span class="p">.</span><span class="nf">items</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">get_optimization_report</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">Generate optimization recommendations report.</span><span class="sh">"""</span>
        <span class="n">analytics</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">get_analytics</span><span class="p">(</span><span class="mi">24</span><span class="p">)</span>
        
        <span class="n">recommendations</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># Analyze component breakdown
</span>        <span class="n">comp_pct</span> <span class="o">=</span> <span class="n">analytics</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">component_percentages</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
        
        <span class="k">if</span> <span class="n">comp_pct</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">system_prompt</span><span class="sh">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">:</span>
            <span class="n">recommendations</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span>
                <span class="sh">"</span><span class="s">❌ System prompt uses &gt;20% of tokens. </span><span class="sh">"</span>
                <span class="sh">"</span><span class="s">Recommendation: Compress or use dynamic prompts.</span><span class="sh">"</span>
            <span class="p">)</span>
        
        <span class="k">if</span> <span class="n">comp_pct</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_definitions</span><span class="sh">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">:</span>
            <span class="n">recommendations</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span>
                <span class="sh">"</span><span class="s">❌ Tool definitions use &gt;15% of tokens. </span><span class="sh">"</span>
                <span class="sh">"</span><span class="s">Recommendation: Dynamic tool selection.</span><span class="sh">"</span>
            <span class="p">)</span>
        
        <span class="k">if</span> <span class="n">analytics</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">cache_hit_rate</span><span class="sh">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">:</span>
            <span class="n">recommendations</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span>
                <span class="sh">"</span><span class="s">❌ Cache hit rate &lt;10%. </span><span class="sh">"</span>
                <span class="sh">"</span><span class="s">Recommendation: Implement semantic caching.</span><span class="sh">"</span>
            <span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">recommendations</span><span class="p">:</span>
            <span class="n">recommendations</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">✅ Token usage is well optimized!</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="n">report</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"""</span><span class="s">
Token Efficiency Report (Last 24h)
==================================
Total Requests: </span><span class="si">{</span><span class="n">analytics</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">request_count</span><span class="sh">'</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="p">,</span><span class="si">}</span><span class="s">
Total Cost: $</span><span class="si">{</span><span class="n">analytics</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">total_cost</span><span class="sh">'</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="p">,.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">
Avg Tokens/Request: </span><span class="si">{</span><span class="n">analytics</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">avg_tokens_per_request</span><span class="sh">'</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="p">,.</span><span class="mi">0</span><span class="n">f</span><span class="si">}</span><span class="s">
Cache Hit Rate: </span><span class="si">{</span><span class="n">analytics</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">cache_hit_rate</span><span class="sh">'</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s">%

Component Breakdown:
</span><span class="si">{</span><span class="nf">chr</span><span class="p">(</span><span class="mi">10</span><span class="p">).</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  - </span><span class="si">{</span><span class="n">k</span><span class="si">}:</span> <span class="si">{</span><span class="n">v</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="o">%</span><span class="sh">"</span><span class="s"> for k, v in comp_pct.items())</span><span class="si">}</span><span class="s">

Recommendations:
</span><span class="si">{</span><span class="nf">chr</span><span class="p">(</span><span class="mi">10</span><span class="p">).</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  </span><span class="si">{</span><span class="n">r</span><span class="si">}</span><span class="sh">"</span><span class="s"> for r in recommendations)</span><span class="si">}</span><span class="s">
</span><span class="sh">"""</span>
        <span class="k">return</span> <span class="n">report</span>
</code></pre></div></div>

<h2 id="6-connection-to-transfer-learning">6. Connection to Transfer Learning</h2>

<p>Token efficiency optimization shares principles with transfer learning:</p>

<table>
  <thead>
    <tr>
      <th>Concept</th>
      <th>Transfer Learning</th>
      <th>Token Efficiency</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Core insight</td>
      <td>Reuse learned knowledge</td>
      <td>Reuse computed responses (caching)</td>
    </tr>
    <tr>
      <td>Efficiency gain</td>
      <td>Less training data needed</td>
      <td>Fewer tokens needed</td>
    </tr>
    <tr>
      <td>Selection</td>
      <td>Choose relevant source domain</td>
      <td>Choose relevant tools/context</td>
    </tr>
    <tr>
      <td>Compression</td>
      <td>LoRA adapters (1% params)</td>
      <td>Prompt compression (80% reduction)</td>
    </tr>
    <tr>
      <td>Hierarchical</td>
      <td>Freeze early layers</td>
      <td>Cache common prefixes</td>
    </tr>
  </tbody>
</table>

<p>Both recognize that <strong>redundancy can be eliminated</strong> by identifying what needs to be recomputed vs. what can be reused.</p>

<h2 id="7-real-world-case-study-stripes-agent-token-optimization">7. Real-World Case Study: Stripe’s Agent Token Optimization</h2>

<p>Stripe’s customer service agents handle millions of queries:</p>

<p><strong>Before optimization:</strong></p>
<ul>
  <li>Average 6,000 tokens per interaction</li>
  <li>40% on tool definitions</li>
  <li>30% on history</li>
  <li>Cost: ~$500K/month</li>
</ul>

<p><strong>After optimization:</strong></p>
<ol>
  <li>Dynamic tool selection: only 3-5 relevant tools per query</li>
  <li>History summarization after 5 turns</li>
  <li>Semantic caching for common queries (40% hit rate)</li>
  <li>Model routing: 60% queries to GPT-3.5</li>
</ol>

<p><strong>Results:</strong></p>
<ul>
  <li>Average 2,100 tokens per interaction (65% reduction)</li>
  <li>Cache saves 400K requests/day</li>
  <li>Model routing saves 50% on compute</li>
  <li>Cost: ~$120K/month (76% reduction)</li>
</ul>

<h2 id="8-key-takeaways">8. Key Takeaways</h2>

<ol>
  <li><strong>Measure first</strong> - Use token analysis to identify where tokens are spent</li>
  <li><strong>Optimize the constants</strong> - System prompt and tool definitions are sent with every request</li>
  <li><strong>Manage history aggressively</strong> - Summarize, prune, use sliding windows</li>
  <li><strong>Cache semantically</strong> - Similar queries don’t need new LLM calls</li>
  <li><strong>Route intelligently</strong> - Use expensive models only when needed</li>
  <li><strong>Compress iteratively</strong> - Each 10% reduction compounds over millions of requests</li>
  <li><strong>Monitor continuously</strong> - Token usage patterns change as agents evolve</li>
</ol>

<p>Token efficiency is not a one-time optimization but an ongoing practice. The best production agents continuously measure, optimize, and adapt their token usage strategies.</p>

<hr />

<p><strong>Originally published at:</strong> <a href="https://www.arunbaby.com/ai-agents/0046-token-efficiency-optimization/">arunbaby.com/ai-agents/0046-token-efficiency-optimization</a></p>

<p><em>If you found this helpful, consider sharing it with others who might benefit.</em></p>

        
      </section>

      <footer class="page__meta">
        
        
  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      <a href="/tags/#agent-optimization" class="page__taxonomy-item p-category" rel="tag">agent-optimization</a><span class="sep">, </span>
    
      <a href="/tags/#context-management" class="page__taxonomy-item p-category" rel="tag">context-management</a><span class="sep">, </span>
    
      <a href="/tags/#cost-reduction" class="page__taxonomy-item p-category" rel="tag">cost-reduction</a><span class="sep">, </span>
    
      <a href="/tags/#llm-efficiency" class="page__taxonomy-item p-category" rel="tag">llm-efficiency</a><span class="sep">, </span>
    
      <a href="/tags/#production-agents" class="page__taxonomy-item p-category" rel="tag">production-agents</a><span class="sep">, </span>
    
      <a href="/tags/#prompt-engineering" class="page__taxonomy-item p-category" rel="tag">prompt-engineering</a><span class="sep">, </span>
    
      <a href="/tags/#token-optimization" class="page__taxonomy-item p-category" rel="tag">token-optimization</a>
    
    </span>
  </p>




  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      <a href="/categories/#ai-agents" class="page__taxonomy-item p-category" rel="tag">ai-agents</a>
    
    </span>
  </p>


        
      </footer>

      <div class="page__related page__related--full">
  <h2 class="page__related-title">Related across topics</h2>
  <style>
    /* Make section span full content width and use 2 equal columns */
    .page__related--full { float: inline-start; width: 100%; padding: 0; }
    .cross-related-grid { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 2rem; }
    @media (max-width: 768px) { .cross-related-grid { grid-template-columns: 1fr; } }
    /* Ensure archive cards stretch nicely in the grid */
    .cross-related-grid .list__item, .cross-related-grid .grid__item { width: auto; float: none; margin: 0; }
  </style>
  <div class="cross-related-grid">
    



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/dsa/0046-binary-tree-max-path-sum/" rel="permalink">Binary Tree Maximum Path Sum
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          17 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">“Every path has a peak—find the one with the maximum sum.”
</p>
  </article>
</div>




<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/ml-system-design/0046-transfer-learning/" rel="permalink">Transfer Learning Systems
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          26 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">“Why learn from scratch when you can stand on the shoulders of giants?”
</p>
  </article>
</div>




<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/speech-tech/0046-cross-lingual-speech-transfer/" rel="permalink">Cross-Lingual Speech Transfer
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          21 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">“Teach a model one language and it learns to hear them all.”
</p>
  </article>
</div>

  </div>
</div>

      <section class="page__share">
  <h4 class="page__share-title">Share on</h4>

  <a href="https://twitter.com/intent/tweet?via=arunbaby0&text=Token+Efficiency+Optimization%20https%3A%2F%2Fwww.arunbaby.com%2Fai-agents%2F0046-token-efficiency-optimization%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fwww.arunbaby.com%2Fai-agents%2F0046-token-efficiency-optimization%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://www.arunbaby.com/ai-agents/0046-token-efficiency-optimization/" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/ai-agents/0045-data-leakage-prevention/" class="pagination--pager" title="Data Leakage Prevention">Previous</a>
    
    
      <a href="/ai-agents/0047-cost-management-for-agents/" class="pagination--pager" title="Cost Management for AI Agents">Next</a>
    
  </nav>


    </div>

    
  </article>

  
  
</div>

      
    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';" role="search">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    
      
        
          <li><a href="https://twitter.com/arunbaby0" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
        
      
        
          <li><a href="https://github.com/arunbaby0" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
        
          <li><a href="https://www.linkedin.com/in/arunbaby0/" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i> LinkedIn</a></li>
        
      
        
          <li><a href="https://scholar.google.co.in/citations?user=6fSYWhkAAAAJ" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-graduation-cap" aria-hidden="true"></i> Google Scholar</a></li>
        
      
    

    
      <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 1990 - 2143 <a href="https://www.arunbaby.com">Arun Baby</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>




  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-0JRJPEC9SS"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-0JRJPEC9SS', { 'anonymize_ip': false});
</script>








  </body>
</html>
